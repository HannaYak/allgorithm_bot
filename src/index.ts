import { Telegraf, Markup, session, Scenes } from 'telegraf';
import express from 'express';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import { eq, or, inArray, and, desc, asc } from 'drizzle-orm';
import * as schema from '../drizzle/schema'; 
import 'dotenv/config';
import Stripe from 'stripe';
import { DateTime } from 'luxon';
import * as SD from './speedDating';



// --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---

async function broadcastToEvent(eventId: number, message: string) {
  const bookings = await db.query.bookings.findMany({
    where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true))
  });

  // –°–û–ó–î–ê–ï–ú Set –∏–º–µ–Ω–Ω–æ –∏–∑ Telegram ID
  const uniqueTgIds = new Set<number>();
  
  for (const b of bookings) {
    const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
    if (u?.telegramId) uniqueTgIds.add(u.telegramId);
  }

  // –†–∞—Å—Å—ã–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ¬´–∞–¥—Ä–µ—Å–∞–º¬ª
  for (const tgId of uniqueTgIds) {
    bot.telegram.sendMessage(tgId, message, { parse_mode: 'HTML' })
      .catch((err) => console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ ${tgId}:`, err));
  }
}

if (!process.env.DATABASE_URL) throw new Error('DATABASE_URL is missing');
const client = postgres(process.env.DATABASE_URL);
const db = drizzle(client, { schema });

if (!process.env.STRIPE_SECRET_KEY) throw new Error('STRIPE_SECRET_KEY is missing');
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2023-10-16' });

const GAME_PRICES: Record<string, string> = {
  'talk_toast': 'price_1SUTjrHhXyjuCWwfhQ7zwxLQ', 
  'stock_know': 'price_1SUTkoHhXyjuCWwfxD89YIpP',
  'speed_dating': 'price_1SUTlVHhXyjuCWwfU1IzNMlf',
  'talk_toast_review': 'price_1SiDMGHhXyjuCWwfzysRSphU',
  'stock_know_review': 'price_1SiDKoHhXyjuCWwfwg24Y7mF',
};
const STRIPE_COUPON_ID = '8RiQPzVX'; 
const ADMIN_ID = 5456905649; 
const PROCESSED_AUTO_ACTIONS = new Set<string>(); 

const BEAUTY_NAMES: Record<string, string> = {
  'talk_toast': 'Talk & Toast ü•Ç',
  'stock_know': 'Stock & Know üß†',
  'speed_dating': '–ë—ã—Å—Ç—Ä—ã–µ —Å–≤–∏–¥–∞–Ω–∏—è üíò',
  'talk_toast_review': 'Talk & Toast üé• (—Å–æ —Å—ä—ë–º–∫–æ–π)',
  'stock_know_review': 'Stock & Know üé• (—Å–æ —Å—ä—ë–º–∫–æ–π)'
};

// –§—É–Ω–∫—Ü–∏—è-–ø–æ–º–æ—â–Ω–∏–∫
const getGameName = (type: string) => BEAUTY_NAMES[type] || type;

const TYPE_MAP: Record<string, string> = { 
  'talk_toast': 'tt', 
  'stock_know': 'sk', 
  'speed_dating': 'sd',
  'talk_toast_review': 'ttr',
  'stock_know_review': 'skr'
};
const REV_TYPE_MAP: Record<string, string> = { 
  'tt': 'talk_toast', 
  'sk': 'stock_know', 
  'sd': 'speed_dating',
  'ttr': 'talk_toast_review',
  'skr': 'stock_know_review'
};

// --- 2. –ö–û–ù–¢–ï–ù–¢ (–ü–û–õ–ù–´–ô) ---

const MINI_GAMES_TEXT = `üéÆ <b>4 –ú–∏–Ω–∏-–∏–≥—Ä—ã –¥–ª—è —Ä–∞–∑–º–∏–Ω–∫–∏:</b>\n\n1. <b>¬´–î–≤–µ –ø—Ä–∞–≤–¥—ã, –æ–¥–Ω–∞ –ª–æ–∂—å¬ª</b>\n2. <b>¬´–Ø –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ...¬ª</b>\n3. <b>¬´–ö—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ?¬ª</b>\n4. <b>¬´–ö–æ–Ω—Ç–∞–∫—Ç¬ª</b>`;

const CONVERSATION_TOPICS = [
  "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–æ–≥–æ-–Ω–∏–±—É–¥—å –Ω–∞ —É–∂–∏–Ω(–∏–∑ –º—ë—Ä—Ç–≤—ã—Ö –∏–ª–∏ –∂–∏–≤—ã—Ö), –∫–æ–≥–æ –±—ã —Ç—ã –≤—ã–±—Ä–∞–ª/–∞ –∏ –ø–æ—á–µ–º—É?", "–•–æ—Ç–µ–ª/–∞ –±—ã —Ç—ã –±—ã—Ç—å –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–º/–æ–π? –ï—Å–ª–∏ –¥–∞, —Ç–æ —á–µ–º?", "–ü—Ä–µ–∂–¥–µ —á–µ–º —Å–¥–µ–ª–∞—Ç—å –∑–≤–æ–Ω–æ–∫, —Ç—ã —Ä–µ–ø–µ—Ç–∏—Ä—É–µ—à—å —Å–≤–æ—é —Ä–µ–ø–ª–∏–∫—É?", "–ö–æ–≥–¥–∞ —Ç—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø–µ–ª/–∞ –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø—Ä–æ–∂–∏—Ç—å –¥–æ 100 –ª–µ—Ç, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Ä–∞–∑—É–º –∏–ª–∏ —Ç–µ–ª–æ 30-–ª–µ—Ç–Ω–µ–≥–æ, —á—Ç–æ –±—ã –≤—ã–±—Ä–∞–ª/–∞?", "–ó–∞ —á—Ç–æ —Ç—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å –Ω–∞–∏–±–æ–ª—å—à—É—é –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥, —á—Ç–æ –±—ã —Ç—ã –∏–∑–º–µ–Ω–∏–ª/–∞ –≤ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏–∏ —Å–µ–±—è?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è —Å –Ω–æ–≤—ã–º —É–º–µ–Ω–∏–µ–º, —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?", "–ï—Å–ª–∏ –±—ã –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª –º–æ–≥ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–¥—É, –æ —á–µ–º –±—ã —Ç—ã —É–∑–Ω–∞–ª?", "–ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ, —á—Ç–æ —Ç—ã –¥–∞–≤–Ω–æ –º–µ—á—Ç–∞–µ—à—å —Å–¥–µ–ª–∞—Ç—å?", "–°–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏?", "–ß—Ç–æ –≤ –¥—Ä—É–∂–±–µ –¥–ª—è —Ç–µ–±—è –Ω–∞–∏–±–æ–ª–µ–µ —Ü–µ–Ω–Ω–æ?", "–ö–∞–∫–æ–µ —Ç–≤–æ–µ —Å–∞–º–æ–µ –¥–æ—Ä–æ–≥–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ?",  "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∑–Ω–∞—á–∏—Ç –¥—Ä—É–∂–±–∞?", "–ö–∞–∫—É—é —Ä–æ–ª—å –ª—é–±–æ–≤—å –∏–≥—Ä–∞–µ—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏?",  "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ —Ñ—Ä–∞–∑—É: ¬´–Ø –±—ã —Ö–æ—Ç–µ–ª, —á—Ç–æ–±—ã –±—ã–ª –∫—Ç–æ-—Ç–æ, —Å –∫–µ–º –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å‚Ä¶¬ª", "–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–º—É—â–∞—é—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º –∏–∑ –∂–∏–∑–Ω–∏.",  "–ß—Ç–æ —Ç—ã —Ü–µ–Ω–∏—à—å –≤ –ª—é–¥—è—Ö –∏ –ø–æ—á–µ–º—É?",   "–î–æ–º –≥–æ—Ä–∏—Ç. –ß—Ç–æ —Å–ø–∞—Å–µ—à—å (–∫—Ä–æ–º–µ –∂–∏–≤—ã—Ö —Å—É—â–µ—Å—Ç–≤, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –¥–µ–Ω–µ–≥)?", "–ß—Ç–æ –≤ —ç—Ç–æ–º –≥–æ–¥—É —Å–ª—É—á–∏–ª–æ—Å—å –≤–ø–µ—Ä–≤—ã–µ?", "–ö–∞–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç—ã –ª—é–±–∏—à—å –∏ –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å –≤ —Å–µ–±–µ?", "–ß—Ç–æ –¥–ª—è –í–∞—Å –∑–Ω–∞—á–∏—Ç —Å–ª–æ–≤–æ —É—Å–ø–µ—Ö(–Ω–µ —Å—á–∏—Ç–∞—è –¥–µ–Ω—å–≥–∏)?", "–ß—Ç–æ –±—ã –≤—ã —Å–∫–∞–∑–∞–ª–∏ —Å–µ–±–µ 15-–ª–µ—Ç–Ω–µ–º—É?", "–û —á—ë–º –≤—ã –º–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å —á–∞—Å–∞–º–∏?", "–ö–∞–∫–æ–π –ª—É—á—à–∏–π —Å–æ–≤–µ—Ç –í–∞–º –¥–∞–≤–∞–ª–∏?", "–ë–µ–∑ —á–µ–≥–æ –Ω–µ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç–µ –Ω–∏ –¥–Ω—è?", "–ï—Å–ª–∏ –±—ã –ø—Ä–∏—à–ª–æ—Å—å –µ—Å—Ç—å –æ–¥–Ω–æ –±–ª—é–¥–æ –≤—Å—é –∂–∏–∑–Ω—å, —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –±—ã?", "–¢–≤–æ–π ¬´–ë–µ—Å–ø–æ–ª–µ–∑–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç¬ª?", "–ß—Ç–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ, –Ω–æ —Ç–µ–±—è –±–µ—Å–∏—Ç?", "–ú–µ—Å—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–ª–æ? –ò –∫—É–¥–∞ —Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è?", "–†–æ–ª–∏ –≤ –∑–æ–º–±–∏-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–µ: –ª–∏–¥–µ—Ä, –ø—Ä–µ–¥–∞—Ç–µ–ª—å, –ø–µ—Ä–≤–∞—è –∂–µ—Ä—Ç–≤–∞. –ö—Ç–æ —Ç—ã?", "100 –º–ª–Ω –¥–æ–ª–ª–∞—Ä–æ–≤, –Ω–æ –Ω–µ–ª—å–∑—è —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —Å–µ–±—è. –ö—É–¥–∞ –¥–µ–Ω–µ—à—å?", "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, —É —Ç–µ–±—è —Ç–æ–ª—å–∫–æ 1 —á–∞—Å (–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–º–æ—Ç—Ä–µ—Ç—å). –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—à—å—Å—è?", "–ö–µ–º –º–µ—á—Ç–∞–ª —Å—Ç–∞—Ç—å –≤ 7 –ª–µ—Ç?", "–ó–∞ —á—Ç–æ —Ç–µ–±—è –≤—ã–≥–æ–Ω—è–ª–∏ –∏–∑ –∫–ª–∞—Å—Å–∞?", "–ú–µ—Å—è—Ü –±–µ–∑ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ –∑–∞ –º–∏–ª–ª–∏–æ–Ω?", "–ö–æ—Ç –∏–ª–∏ —Å–æ–±–∞–∫–∞? –ü—Ä–æ–¥–∞–π –º–Ω–µ –≤—ã–±–æ—Ä.", "–¢–≤–æ–µ —Å–∞–º–æ–µ –Ω–µ–ø–æ–ø—É–ª—è—Ä–Ω–æ–µ –º–Ω–µ–Ω–∏–µ?(–ù–∞–ø—Ä–∏–º–µ—Ä: "–Ø –Ω–µ–Ω–∞–≤–∏–∂—É —Å–µ—Ä–∏–∞–ª '–î—Ä—É–∑—å—è'")", "–ö–∞–∫—É—é —Å–∞–º—É—é –≥–ª—É–ø—É—é –≤–µ—â—å —Ç—ã –∫—É–ø–∏–ª, –ø–æ–¥–¥–∞–≤—à–∏—Å—å —Ä–µ–∫–ª–∞–º–µ?", "–ö–∞–∫—É—é –ø–µ—Å–Ω—é —Ç—ã –≤–∫–ª—é—á–∞–µ—à—å, –∫–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—ã—à–∏—Ç, –∏ —Ç–µ–±–µ –∑–∞ –Ω–µ–µ —Å—Ç—ã–¥–Ω–æ?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥ –æ—Ç–º–µ–Ω–∏—Ç—å –æ–¥–∏–Ω –ª—é–±–æ–π –∑–∞–∫–æ–Ω (—Ñ–∏–∑–∏–∫–∏ –∏–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π), —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?", "–ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ –ª—é–¥—è—Ö —Ç—ã —Å—á–∏—Ç–∞–µ—à—å —Å–∞–º—ã–º –ø–µ—Ä–µ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–º? –ü–æ—á–µ–º—É?", "–ö–∞–∫–æ–π –ø—Ä–∞–∑–¥–Ω–∏–∫ –Ω—É–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?", "–ö–∞–∫–æ–π —Å–µ—Ä–∏–∞–ª –≤—Å–µ –æ–±–æ–∂–∞—é—Ç, –∞ —Ç—ã —Ç–µ—Ä–ø–µ—Ç—å –Ω–µ –º–æ–∂–µ—à—å?", "–¢–≤–æ—è —Å–∞–º–∞—è –±–µ—Å–ø–æ–ª–µ–∑–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥?", "–ö–∞–∫–æ–µ —Ä–µ–∞–ª–∏—Ç–∏-—à–æ—É ‚Äî —Ç–≤–æ–π ¬´—Ç–∞–π–Ω—ã–π –≥—Ä–µ—Ö¬ª?", "–¢–≤–æ–π —Å–∞–º—ã–π –¥—É—Ä–∞—Ü–∫–∏–π —Å–ø–æ—Å–æ–± –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ?", "–ö–∞–∫—É—é –¥–µ—Ç—Å–∫—É—é –ø—Ä–∏–≤—ã—á–∫—É —Ç—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª/–∞ –¥–æ —Å–∏—Ö –ø–æ—Ä?", "–ö–∞–∫—É—é —Å—É–ø–µ—Ä—Å–∏–ª—É —Ç—ã –±—ã –≤—ã–±—Ä–∞–ª/–∞ –¥–ª—è –±—ã—Ç–æ–≤—ã—Ö –Ω—É–∂–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å—É—à–∫–∞ –≤–æ–ª–æ—Å)?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø–µ—Ä–µ–µ—Ö–∞—Ç—å –≤ –ª—é–±—É—é —Å—Ç—Ä–∞–Ω—É –∑–∞–≤—Ç—Ä–∞, –∫—É–¥–∞ –±—ã —Ç–æ—á–Ω–æ –ù–ï –ø–æ–µ—Ö–∞–ª/–∞? –ü–æ—á–µ–º—É?", "–ß—Ç–æ —Ç—ã –≤—ã–±–µ—Ä–µ—à—å: –≤—Å–µ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–∞–≤–¥—É –∏–ª–∏ –≤—Å–µ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –≤—Ä–∞—Ç—å?", "–ï—Å–ª–∏ –±—ã —Ç–µ–±–µ –ø–ª–∞—Ç–∏–ª–∏ –∑–∞ —Ö–æ–±–±–∏, —á–µ–º –±—ã —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è/–ª–∞—Å—å?", "–ö–∞–∫—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏—é —Ç—ã –±—ã –æ—Å–≤–æ–∏–ª/–∞, –µ—Å–ª–∏ –±—ã —É —Ç–µ–±—è –±—ã–ª–∞ –≤—Ç–æ—Ä–∞—è –∂–∏–∑–Ω—å?", "–¢–≤–æ–π ¬´–∞–Ω—Ç–∏-—Ç–∞–ª–∞–Ω—Ç¬ª? –¢–æ, —á—Ç–æ —É —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ö—É–∂–µ –≤—Å–µ–≥–æ.", "–ö–µ–º –±—ã —Ç—ã –±—ã–ª/–∞ –≤ –±–∞–Ω–¥–µ –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π –±–∞–Ω–∫–æ–≤ (–≤–æ–¥–∏—Ç–µ–ª—å, –º–æ–∑–≥, —Ö–∞–∫–µ—Ä –∏–ª–∏ —Ç–æ—Ç, –∫—Ç–æ –≤—Å–µ—Ö –æ—Ç–≤–ª–µ–∫–∞–µ—Ç)?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ —É–¥–∞–ª–∏—Ç—å –æ–¥–Ω–æ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –º–∏—Ä–∞ –Ω–∞–≤—Å–µ–≥–¥–∞, —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –±—ã?", "–í –∫–∞–∫–æ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —ç–ø–æ—Ö–µ —Ç—ã –±—ã —Ç–æ—á–Ω–æ –Ω–µ –≤—ã–∂–∏–ª/–∞?", "–ö–∞–∫–æ–π –æ–¥–∏–Ω –∑–∞–∫–æ–Ω —Ç—ã –±—ã –≤–≤–µ–ª/–∞ –¥–ª—è –≤—Å–µ—Ö –∂–∏—Ç–µ–ª–µ–π –ó–µ–º–ª–∏ –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å?", "–ö–∞–∫–æ–µ –±–ª—é–¥–æ —Ç—ã —Å—á–∏—Ç–∞–µ—à—å —Å–∞–º—ã–º –ø–µ—Ä–µ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–º –≤ –º–∏—Ä–µ?", "–ï—Å–ª–∏ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?", "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –Ω–∞—Å —Å–ø–∞—Å–µ—Ç –∏–ª–∏ –ø–æ–≥—É–±–∏—Ç?", "–ö–∞–∫—É—é –≤–µ—â—å —Ç—ã —Ö—Ä–∞–Ω–∏—à—å –≥–æ–¥–∞–º–∏, —Ö–æ—Ç—è –æ–Ω–∞ —Ç–µ–±–µ –Ω–µ –Ω—É–∂–Ω–∞?", "–ß—Ç–æ —Ç—ã –≤—ã–±–µ—Ä–µ—à—å: –∂–∏—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ –≤ –∫–æ—Ä–æ–±–∫–µ –∏–ª–∏ –≤ –æ–≥—Ä–æ–º–Ω–æ–º –¥–æ–º–µ –∑–∞ –≥–æ—Ä–æ–¥–æ–º?", "–û–ª–ª-–∏–Ω–∫–ª—é–∑–∏–≤ –≤ –¢—É—Ä—Ü–∏–∏ –∏–ª–∏ –ø–æ—Ö–æ–¥ —Å —Ä—é–∫–∑–∞–∫–æ–º –ø–æ –ò—Å–ª–∞–Ω–¥–∏–∏?", "–°–∞–º—ã–π —É–∂–∞—Å–Ω—ã–π —Å–æ—Å–µ–¥ –≤ —Å–∞–º–æ–ª–µ—Ç–µ ‚Äî —ç—Ç–æ –∫—Ç–æ?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –∂–∏—Ç—å –≤ –ª—é–±–æ–π —ç–ø–æ—Ö–µ, –∫—Ä–æ–º–µ –Ω—ã–Ω–µ—à–Ω–µ–π, —á—Ç–æ –±—ã —Ç—ã –≤—ã–±—Ä–∞–ª/–∞?", "–¢–≤–æ–π —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –∫—É–ª—å—Ç—É—Ä–Ω—ã–π —à–æ–∫ –≤ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–µ?", "–¢—ã –±—ã —Å–æ–≥–ª–∞—Å–∏–ª—Å—è/–ª–∞—Å—å –Ω–∞ –ø–æ–ª–µ—Ç –≤ –æ–¥–∏–Ω –∫–æ–Ω–µ—Ü –Ω–∞ –ú–∞—Ä—Å? –ü–æ—á–µ–º—É?", "–ö–∞–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ –Ω–µ–∑–Ω–∞–∫–æ–º—ã—Ö –ª—é–¥—è—Ö —Ç–µ–±—è –ø–æ–¥–∫—É–ø–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ?", "–ö–∞–∫–æ–≥–æ –∞–∫—Ç–µ—Ä–∞/–∞–∫—Ç—Ä–∏—Å—É —Ç—ã –±—ã –≤—ã–±—Ä–∞–ª/–∞ –Ω–∞ —Ä–æ–ª—å —Å–µ–±—è –≤ —Ñ–∏–ª—å–º–µ –ø—Ä–æ —Å–µ–±—è?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ —É–∫—Ä–∞—Å—Ç—å –æ–¥–∏–Ω —Ç–∞–ª–∞–Ω—Ç —É –ª—é–±–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–∏–Ω —Ñ–∏–Ω–∞–ª –≤ –ª—é–±–æ–º –∏–∑–≤–µ—Å—Ç–Ω–æ–º —Ñ–∏–ª—å–º–µ/–∫–Ω–∏–≥–µ, –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ?"
];

const STOCK_QUESTIONS = [
{
    question: "–í–æ–π–Ω–∞ –º–µ–∂–¥—É –ê–Ω–≥–ª–∏–µ–π –∏ –§—Ä–∞–Ω—Ü–∏–µ–π –≤–æ—à–ª–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ ¬´–°—Ç–æ–ª–µ—Ç–Ω—è—è –≤–æ–π–Ω–∞¬ª. –û–¥–Ω–∞–∫–æ –∏—Å—Ç–æ—Ä–∏–∫–∏ –∑–Ω–∞—é—Ç, —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –¥–ª–∏–ª—Å—è —Å –ø–µ—Ä–µ—Ä—ã–≤–∞–º–∏ –¥–æ–ª—å—à–µ. –°–∫–æ–ª—å–∫–æ –ª–µ—Ç —à–ª–∞ –°—Ç–æ–ª–µ—Ç–Ω—è—è –≤–æ–π–Ω–∞?",
    hints: [
      "1. –≠—Ç–æ –∞—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä –õ–∏–≤–µ—Ä–º–æ—Ä–∏—è ‚Äî –æ–¥–Ω–æ–≥–æ –∏–∑ —Å–∞–º—ã—Ö —Ç—è–∂–µ–ª—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞.",
      "2. –ï—Å–ª–∏ –±—ã –≤–æ–π–Ω–∞ –ø—Ä–æ–¥–ª–∏–ª–∞—Å—å –µ—â—ë 4 –≥–æ–¥–∞, —Ç–æ —Å–æ—Å—Ç–∞–≤–∏–ª–∞ –±—ã —Ä–æ–≤–Ω–æ 12 –¥–µ—Å—è—Ç–∏–ª–µ—Ç–∏–π.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ –Ω–∞ 16 –ª–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º ¬´–≤–µ–∫¬ª." ],
    answer: "116",
    fact: "–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ –±—ã–ª–∞ –Ω–µ –æ–¥–Ω–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –≤–æ–π–Ω–∞, –∞ —Å–µ—Ä–∏—è –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö –∫—Ä—É–ø–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–∏—Ä–∏—è–º–∏. –ù–∞–∑–≤–∞–Ω–∏–µ ¬´–°—Ç–æ–ª–µ—Ç–Ω—è—è –≤–æ–π–Ω–∞¬ª –ø—Ä–∏–¥—É–º–∞–ª–∏ –≥–æ—Ä–∞–∑–¥–æ –ø–æ–∑–∂–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤ XIX –≤–µ–∫–µ, —á—Ç–æ–±—ã –∫–∞–∫-—Ç–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —ç—Ç–æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–µ—Ä–∏–∞–ª –∏–∑ —Å—Ä–∞–∂–µ–Ω–∏–π –≤ –æ–¥–∏–Ω —É—á–µ–±–Ω–∏–∫."
  },
{
    question: "–í –∏–≥—Ä–µ Minecraft –∫–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–æ—Ç. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–±–ª–æ–∫–∏, –µ–¥–∞) —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ–º—ã–π ¬´—Å—Ç–∞–∫¬ª (stack). –ö–∞–∫–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–∏–Ω —Å—Ç–∞–∫?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∫–ª–µ—Ç–æ–∫ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —à–∞—Ö–º–∞—Ç–Ω–æ–π –¥–æ—Å–∫–µ.",
      "2. –≠—Ç–æ —á–∏—Å–ª–æ –±–∏—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫—É–ª—å—Ç–æ–≤–æ–π –ø—Ä–∏—Å—Ç–∞–≤–∫–∏ Nintendo (Nintendo ...)",
      "3. –≠—Ç–æ 2 –≤ —à–µ—Å—Ç–æ–π —Å—Ç–µ–ø–µ–Ω–∏"
    ],
    answer: "64",
    fact: "–ß–∏—Å–ª–æ 64 —É–¥–æ–±–Ω–æ –¥–ª—è –¥–≤–æ–∏—á–Ω–æ–≥–æ –∫–æ–¥–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ (2^6), –ø–æ—ç—Ç–æ–º—É –ù–æ—Ç—á (—Å–æ–∑–¥–∞—Ç–µ–ª—å –∏–≥—Ä—ã) –≤—ã–±—Ä–∞–ª –∏–º–µ–Ω–Ω–æ –µ–≥–æ."
  },
{
    question: "–ú–æ–¥–µ–ª—å –∏–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Å–æ–ª–∏ –æ—Ç Microsoft, –≤—ã—à–µ–¥—à–∞—è –≤ 2005 –≥–æ–¥—É (Xbox ...).",
    hints: [
      "1. –°—É–º–º–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤ –ª—é–±–æ–≥–æ —á–µ—Ç—ã—Ä—ë—Ö—É–≥–æ–ª—å–Ω–∏–∫–∞ (–∫–≤–∞–¥—Ä–∞—Ç–∞ –∏–ª–∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞)",
      "2. –¢—Ä–∏ —Ä–∞–∑–∞ –ø–æ 120.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª. –°—Ç–æ–ª—å–∫–æ –≥—Ä–∞–¥—É—Å–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –æ–±–æ—Ä–æ—Ç –≤–æ–∫—Ä—É–≥ —Å–≤–æ–µ–π –æ—Å–∏."
    ],
    answer: "360",
    fact: "–í 2005 –≥–æ–¥—É Sony –≥–æ—Ç–æ–≤–∏–ª–∞—Å—å –≤—ã–ø—É—Å—Ç–∏—Ç—å PlayStation 3. –í Microsoft —Ä–µ–∑–æ–Ω–Ω–æ —Ä–∞—Å—Å—É–¥–∏–ª–∏, —á—Ç–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞–∑–æ–≤—É—Ç —Å–≤–æ—é –∫–æ–Ω—Å–æ–ª—å ¬´Xbox 2¬ª, —Ç–æ –≤ –≥–ª–∞–∑–∞—Ö –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å ¬´—Å—Ç–∞—Ä–µ–µ¬ª –∏–ª–∏ —Å–ª–∞–±–µ–µ, —á–µ–º ¬´—Ç—Ä–µ—Ç—å—è¬ª –ø–ª–æ–π–∫–∞."
  },
{
    question: "–°–∞–º–∞—è –∏–∑–≤–µ—Å—Ç–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∂–∏–Ω—Å–æ–≤ –≤ –º–∏—Ä–µ –æ—Ç Levi‚Äôs. –û–Ω–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ 1890 –≥–æ–¥—É –∏ —Å—Ç–∞–ª–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º ¬´–ø—è—Ç–∏–∫–∞—Ä–º–∞–Ω–Ω—ã—Ö¬ª –¥–∂–∏–Ω—Å–æ–≤. –ö–∞–∫–æ–π –Ω–æ–º–µ—Ä —É —ç—Ç–æ–π –º–æ–¥–µ–ª–∏?",
    hints: [
      "1.  –≠—Ç–æ –∫–æ–¥ –æ—à–∏–±–∫–∏ HTTP ¬´Not Implemented¬ª (–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).",
      "2.  –≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–≥–∏–æ–Ω–∞ –∫–ª–æ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–º —Ä—É–∫–æ–≤–æ–¥–∏–ª –≠–Ω–∞–∫–∏–Ω –°–∫–∞–π—É–æ–∫–µ—Ä (–í–µ–π–¥–µ—Ä) –≤ ¬´–ó–≤—ë–∑–¥–Ω—ã—Ö –≤–æ–π–Ω–∞—Ö¬ª.",
      "3. –°—É–º–º–∞ –≤—Å–µ—Ö —Ü–∏—Ñ—Ä —ç—Ç–æ–≥–æ —á–∏—Å–ª–∞ —Ä–∞–≤–Ω–∞ 6."
    ],
    answer: "501",
    fact: "–ú–∞–ª–µ–Ω—å–∫–∏–π –ø—è—Ç—ã–π –∫–∞—Ä–º–∞—à–µ–∫ (watch pocket) –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–∞–ª—Å—è –¥–ª—è –∫–∞—Ä–º–∞–Ω–Ω—ã—Ö —á–∞—Å–æ–≤, –∞ –Ω–µ –¥–ª—è –º–æ–Ω–µ—Ç."
  },
{
    question: "–ó–µ–º–ª—è –ø–æ–¥–µ–ª–µ–Ω–∞ –Ω–∞ —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –∏—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 24. –ù–æ –∏–∑-–∑–∞ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–≥—Ä (–≥–¥–µ-—Ç–æ –¥–æ–±–∞–≤–ª—è—é—Ç –ø–æ–ª—á–∞—Å–∞, –≥–¥–µ-—Ç–æ 45 –º–∏–Ω—É—Ç) –∏—Ö –±–æ–ª—å—à–µ. –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ–π—á–∞—Å –≤ –º–∏—Ä–µ? (–ë–ª–∏–∂–∞–π—à–µ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ).",
    hints: [
      "1. –≠—Ç–æ –∫–∞–ª–∏–±—Ä –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ —Ä–µ–≤–æ–ª—å–≤–µ—Ä–∞ (.Special), —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–π—Å—è –≤ —Ñ–∏–ª—å–º–∞—Ö –Ω—É–∞—Ä.",
      "2. –°—Ç–æ–ª—å–∫–æ '–ø–æ–ø—É–≥–∞–µ–≤' —Å–æ—Å—Ç–∞–≤–ª—è–ª–∞ –¥–ª–∏–Ω–∞ —É–¥–∞–≤–∞ –≤ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ–º —Å–æ–≤–µ—Ç—Å–∫–æ–º –º—É–ª—å—Ç—Ñ–∏–ª—å–º–µ.",
      "3.  –≠—Ç–æ —á–∏—Å–ª–æ —Ä–∞–≤–Ω–æ 19 —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ 2"
    ],
    answer: "38",
    fact: "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—Ä–∞–Ω—ã, –∫–∞–∫ –ù–µ–ø–∞–ª, –∏–º–µ—é—Ç –ø–æ—è—Å —Å —Ä–∞–∑–Ω–∏—Ü–µ–π –≤ 45 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ò–Ω–¥–∏–µ–π –∏–∑ –ø—Ä–∏–Ω—Ü–∏–ø–∞."
  },
{
    question: "–°–∫–æ–ª—å–∫–æ —Ç–æ–º–æ–≤ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —à–∫–æ–ª—å–Ω–æ–º –∏–∑–¥–∞–Ω–∏–∏ —Ä–æ–º–∞–Ω–∞ ¬´–í–æ–π–Ω–∞ –∏ –º–∏—Ä¬ª –¢–æ–ª—Å—Ç–æ–≥–æ?",
    hints: [
      "1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–∞–≥–æ—Ä–æ–¥–Ω—ã—Ö –∏—Å—Ç–∏–Ω –≤ –±—É–¥–¥–∏–∑–º–µ.",
      "2. –ê—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä –ë–µ—Ä–∏–ª–ª–∏—è.",
      "3. –°—Ç–æ–ª—å–∫–æ –≤—Å–∞–¥–Ω–∏–∫–æ–≤ –ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞ –æ–ø–∏—Å–∞–Ω–æ –≤ –û—Ç–∫—Ä–æ–≤–µ–Ω–∏–∏ –ò–æ–∞–Ω–Ω–∞ –ë–æ–≥–æ—Å–ª–æ–≤–∞."
    ],
    answer: "4",
    fact: "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª —Ä–æ–º–∞–Ω –≤—Ä—É—á–Ω—É—é 8 —Ä–∞–∑! –ê –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—á–∞–ª–æ) ‚Äî –±–æ–ª–µ–µ 20 —Ä–∞–∑. –ï–≥–æ –∂–µ–Ω–∞, –°–æ—Ñ—å—è –ê–Ω–¥—Ä–µ–µ–≤–Ω–∞, –±—ã–ª–∞ –µ–≥–æ –≥–ª–∞–≤–Ω—ã–º ¬´—Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º¬ª –∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∞ —ç—Ç–∏ —Ç—ã—Å—è—á–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞–±–µ–ª–æ, —Ä–∞–∑–±–∏—Ä–∞—è –µ–≥–æ —É–∂–∞—Å–Ω—ã–π –ø–æ—á–µ—Ä–∫ –ø—Ä–∏ —Å–≤–µ—á–∞—Ö."
  },
{
    question: "–≠—Ç–æ —á–∏—Å–ª–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è ¬´—Å–∞–º—ã–º –ø—Ä–∏—è—Ç–Ω—ã–º¬ª (nicest number) –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. –í—Å—è–∫–∏–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –æ–Ω–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ª–µ–Ω—Ç–µ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±—è–∑–∞–Ω—ã –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö ¬´Nice¬ª. –ù–∞–∑–æ–≤–∏—Ç–µ –µ–≥–æ.",
    hints: [
      "1. –≠—Ç–æ –≥–æ–¥ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è –í—É–¥—Å—Ç–æ–∫ –∏ –≥–æ–¥ –≤—ã—Å–∞–¥–∫–∏ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–∞ –õ—É–Ω—É (19...).",
      "2. –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —ç—Ç–æ —á–∏—Å–ª–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∑–Ω–∞–∫ –ò–Ω—å –∏ –Ø–Ω (—Ä—ã–±–∫–∏, –ø–ª—ã–≤—É—â–∏–µ –ø–æ –∫—Ä—É–≥—É).",
      "3. –ü–æ–ø—É–ª—è—Ä–Ω–∞—è –ø–æ–∑–∞ –≤ –ö–∞–º–∞—Å—É—Ç—Ä–µ."
    ],
    answer: "69",
    fact: "–ò–ª–æ–Ω –ú–∞—Å–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å—Ç–∞–≤–∏–ª —Ü–µ–Ω—É –Ω–∞ –º–æ–¥–µ–ª–∏ Tesla (–Ω–∞–ø—Ä–∏–º–µ—Ä, $69,420), —á—Ç–æ–±—ã –ø–æ–≤–µ—Å–µ–ª–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–æ–±—â–µ—Å—Ç–≤–æ."
  },
{
    question: "–í –∫–Ω–∏–≥–µ ¬´–ê–≤—Ç–æ—Å—Ç–æ–ø–æ–º –ø–æ –≥–∞–ª–∞–∫—Ç–∏–∫–µ¬ª —Å—É–ø–µ—Ä–∫–æ–º–ø—å—é—Ç–µ—Ä Deep Thought –¥—É–º–∞–ª 7,5 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –ª–µ—Ç, —á—Ç–æ–±—ã –¥–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ ¬´–ì–ª–∞–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∂–∏–∑–Ω–∏, –í—Å–µ–ª–µ–Ω–Ω–æ–π –∏ –≤—Å–µ–≥–æ —Ç–∞–∫–æ–≥–æ¬ª. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ –æ–Ω –≤—ã–¥–∞–ª?",
    hints: [
      "1. –≠—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ –¥–ª—è –æ–ø—Ç–∏–∫–∏. –ò–º–µ–Ω–Ω–æ –ø–æ–¥ —Ç–∞–∫–∏–º —É–≥–ª–æ–º (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö) —Å–≤–µ—Ç –ø—Ä–µ–ª–æ–º–ª—è–µ—Ç—Å—è –≤ –∫–∞–ø–ª—è—Ö –≤–æ–¥—ã, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –≥–ª–∞–∑ –º–æ–≥ —É–≤–∏–¥–µ—Ç—å —Ä–∞–¥—É–≥—É.",
      "2. –ê—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä –ú–æ–ª–∏–±–¥–µ–Ω–∞.",
      "3. –í –¥–≤–æ–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å—á–∏—Å–ª–µ–Ω–∏—è —ç—Ç–æ —á–∏—Å–ª–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –∏–¥–µ–∞–ª—å–Ω—ã–π —á–µ—Ä–µ–¥—É—é—â–∏–π—Å—è —Ä–∏—Ç–º: 101010."
    ],
    answer: "42",
    fact: "–î—É–≥–ª–∞—Å –ê–¥–∞–º—Å –ø—Ä–∏–∑–Ω–∞–ª—Å—è, —á—Ç–æ –≤—ã–±—Ä–∞–ª —á–∏—Å–ª–æ —Å–ª—É—á–∞–π–Ω–æ. –û–Ω –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç–µ–ª ¬´–æ–±—ã—á–Ω–æ–µ, –Ω–µ–±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ¬ª –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤ –æ–∫–Ω–æ —Å–∞–¥–∞."
  },
{
    question: "–ù–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ —Å–∞–º–æ–≥–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∫–µ—Ç—á—É–ø–∞ –≤ –º–∏—Ä–µ ¬´Heinz¬ª –∫—Ä–∞—Å—É–µ—Ç—Å—è —á–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ —è–∫–æ–±—ã –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ä—Ç–æ–≤ –ø—Ä–æ–¥—É–∫—Ü–∏–∏, —Ö–æ—Ç—è –Ω–∞ –º–æ–º–µ–Ω—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞ —Å–æ—Ä—Ç–æ–≤ –±—ã–ª–æ —É–∂–µ –±–æ–ª—å—à–µ 60. –°–∞–º –ì–µ–Ω—Ä–∏ –•–∞–π–Ω—Ü —Å—á–∏—Ç–∞–ª —ç—Ç–æ —á–∏—Å–ª–æ —Å—á–∞—Å—Ç–ª–∏–≤—ã–º. –ù–∞–∑–æ–≤–∏—Ç–µ –µ–≥–æ.",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ (–≤–º–µ—Å—Ç–µ —Å —Ç–µ—Ä—Ä–æ—Ä–∏—Å—Ç–∞–º–∏) –∑–∞—Ö–≤–∞—Ç–∏–ª –≥–µ—Ä–æ–π –£—ç—Å–ª–∏ –°–Ω–∞–π–ø—Å–∞ –≤ –±–æ–µ–≤–∏–∫–µ 1992 –≥–æ–¥–∞.",
      "2. –í —ç—Ç–æ–º –≥–æ–¥—É (19...) –°–æ–≤–µ—Ç—Å–∫–∏–π –°–æ—é–∑ –∑–∞–ø—É—Å—Ç–∏–ª –ø–µ—Ä–≤—ã–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø—É—Ç–Ω–∏–∫ –ó–µ–º–ª–∏, –Ω–∞—á–∞–≤ –∫–æ—Å–º–∏—á–µ—Å–∫—É—é —ç—Ä—É.",
      "3. : –≠—Ç–æ —á–∏—Å–ª–æ ‚Äî —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ø—É–ª—è—Ä–Ω–æ–π —Ä–æ—Å—Å–∏–π—Å–∫–æ–π —Ä—ç–ø-–≥—Ä—É–ø–ø—ã ¬´–ö–∞—Å—Ç–∞¬ª, –µ—Å–ª–∏ –≤—Å–ø–æ–º–Ω–∏—Ç—å –∏—Ö —Ç—Ä–µ–∫ –ø—Ä–æ ¬´... —Ä–µ–≥–∏–æ–Ω¬ª."
    ],
    answer: "57",
    fact: "–ì–µ–Ω—Ä–∏ –•–∞–π–Ω—Ü —É–≤–∏–¥–µ–ª –≤ –ø–æ–µ–∑–¥–µ —Ä–µ–∫–ª–∞–º—É –æ–±—É–≤–∏ ¬´21 —Å—Ç–∏–ª—å¬ª –∏ —Ä–µ—à–∏–ª, —á—Ç–æ —á–∏—Å–ª–æ 57 –∑–≤—É—á–∏—Ç —Å–æ–ª–∏–¥–Ω–µ–µ."
  },
{
    question: "–í –°–®–ê —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å —ç—Ç–æ–≥–æ —Ç—Ä–µ—Ö–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞, —è–≤–ª—è—é—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –¥–ª—è –∑–≤–æ–Ω—è—â–µ–≥–æ (toll-free). –ö–æ–º–ø–∞–Ω–∏—è –ø–ª–∞—Ç–∏—Ç –∑–∞ –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫. –ß—Ç–æ —ç—Ç–æ –∑–∞ –∫–æ–¥?",
    hints: [
      "1. –≠—Ç–æ –Ω–æ–º–µ—Ä –º–æ–¥–µ–ª–∏ –¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä–∞ (–¢-...), –∫–æ—Ç–æ—Ä–æ–≥–æ —Å—ã–≥—Ä–∞–ª –ê—Ä–Ω–æ–ª—å–¥ –®–≤–∞—Ä—Ü–µ–Ω–µ–≥–≥–µ—Ä.",
      "2. –°—Ç–æ–ª—å–∫–æ –ª–µ—Ç (—Ä–æ–≤–Ω–æ 8 –≤–µ–∫–æ–≤) –ø—Ä–∞–≤–∏–ª–∞ —Å–∞–º–∞—è –¥–æ–ª–≥–∞—è –¥–∏–Ω–∞—Å—Ç–∏—è –≤ –ö–∏—Ç–∞–µ ‚Äî –ß–∂–æ—É.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç—Å—è –∫–∞–∫ –≤–æ—Å–µ–º—å —Å–æ—Ç–µ–Ω."
    ],
    answer: "800",
    fact: "–∑-–∑–∞ –æ–≥—Ä–æ–º–Ω–æ–π –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –≤ –°–®–ê –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤, –∏ –≤–ª–∞—Å—Ç—è–º –ø—Ä–∏—à–ª–æ—Å—å –≤–≤–æ–¥–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–¥—ã (888, 877, 866), –Ω–æ —ç—Ç–æ—Ç ‚Äî —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π –∏ –ø—Ä–µ—Å—Ç–∏–∂–Ω—ã–π."
  },
{
    question: "–í —Ä–æ–º–∞–Ω–µ-–∞–Ω—Ç–∏—É—Ç–æ–ø–∏–∏ –î–∂–æ—Ä–¥–∂–∞ –û—Ä—É—ç–ª–ª–∞ ¬´1984¬ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä–∞—à–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –ø—ã—Ç–æ–∫, –≤ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–∫–ª—é—á—ë–Ω–Ω—ã–π —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è —Å–æ —Å–≤–æ–∏–º —Å–∞–º—ã–º –≥–ª–∞–≤–Ω—ã–º —Å—Ç—Ä–∞—Ö–æ–º. –ù–∞–∑–æ–≤–∏—Ç–µ –Ω–æ–º–µ—Ä —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã.",
    hints: [
      "1. –í –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏—Ö —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞—Ö —ç—Ç–∏–º –Ω–æ–º–µ—Ä–æ–º –æ–±–æ–∑–Ω–∞—á–∞—é—Ç –≤–≤–æ–¥–Ω—ã–µ –∫—É—Ä—Å—ã –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è ...¬ª).",
      "2. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –ø—è—Ç–Ω–∏—Å—Ç—ã—Ö —â–µ–Ω–∫–æ–≤ —Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞ –î–∏—Å–Ω–µ—è.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ ‚Äî –ø–∞–ª–∏–Ω–¥—Ä–æ–º –∏–∑ –Ω–æ–ª–µ–π –∏ –µ–¥–∏–Ω–∏—Ü."
    ],
    answer: "101",
    fact: "–°–∞–º –û—Ä—É—ç–ª–ª –Ω–∞–∑–≤–∞–ª –∫–æ–º–Ω–∞—Ç—É 101 –≤ —á–µ—Å—Ç—å –∑–∞–ª–∞ –∑–∞—Å–µ–¥–∞–Ω–∏–π –Ω–∞ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ –Ω–∞ BBC, –≥–¥–µ –µ–º—É –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å —Å–∏–¥–µ—Ç—å –Ω–∞ —Å–∫—É—á–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–∏—è—Ö."
  },
{
    question: "–°–æ–≤–µ—Ç—Å–∫–∏–π –°–æ—é–∑ (–°–°–°–†) –±—ã–ª –æ–≥—Ä–æ–º–Ω–æ–π –∏–º–ø–µ—Ä–∏–µ–π. –°–∫–æ–ª—å–∫–æ –ª–µ—Ç –ø—Ä–æ—Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ —ç—Ç–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ?",
    hints: [
      "1. –≠—Ç–æ —á–∏—Å–ª–æ —è–≤–ª—è–µ—Ç—Å—è —Å–∏–º–≤–æ–ª–æ–º –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ –†–∞–∫ (–µ—Å–ª–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –±–æ–∫–æ–º).",
      "2. –°–∞–º–∞—è –∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–∑–∞ –≤–æ —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–π –ª—é–±–≤–∏.",
      "3. –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –≤—Å–µ–≥–æ 1 –≥–æ–¥–∞ –¥–æ 70-–ª–µ—Ç–Ω–µ–≥–æ —é–±–∏–ª–µ—è."
    ],
    answer: "69",
    fact: "–ó–∞ –≤—Ä–µ–º—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞–Ω—ã —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å –ø–æ—á—Ç–∏ –Ω–∞ 2 –º–ª–Ω –∫–≤. –∫–º."
  },
{
    question: "–£ —á–µ–ª–æ–≤–µ–∫–∞ 46 —Ö—Ä–æ–º–æ—Å–æ–º. –ê —Å–∫–æ–ª—å–∫–æ —Ö—Ä–æ–º–æ—Å–æ–º —É –æ–±—ã—á–Ω–æ–π –¥–æ–º–∞—à–Ω–µ–π –∫–æ—à–∫–∏?",
    hints: [
      "1.  –ü–∞—Ä–∞–ª–ª–µ–ª—å, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –°–µ–≤–µ—Ä–Ω–∞—è –∏ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è –ø–æ—Å–ª–µ –≤–æ–π–Ω—ã.",
      "2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤ (–∫–∞—Ä–º–∞—à–∫–æ–≤) –Ω–∞ –∫–æ–ª–µ—Å–µ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–π —Ä—É–ª–µ—Ç–∫–∏.",
      "3. –≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏–∑ —Å–∞–º—ã—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–∞–ª–∏–±—Ä–æ–≤ —Ä–µ–≤–æ–ª—å–≤–µ—Ä–æ–≤ –≤ –º–∏—Ä–µ. –ò–º–µ–Ω–Ω–æ —Å —Ç–∞–∫–∏–º –æ—Ä—É–∂–∏–µ–º –≤ –∫–æ–±—É—Ä–µ —Ö–æ–¥–∏–ª–∏ –ø–æ—á—Ç–∏ –≤—Å–µ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ –ø–æ–ª–∏—Ü–µ–π—Å–∫–∏–µ –∏ –¥–µ—Ç–µ–∫—Ç–∏–≤—ã –≤ —Ñ–∏–ª—å–º–∞—Ö –Ω—É–∞—Ä."
    ],
    answer: "38",
    fact: "–£ –∫—É—Ä–∏—Ü—ã 78 —Ö—Ä–æ–º–æ—Å–æ–º, –∞ —É –ø–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫–∞ ‚Äî –±–æ–ª—å—à–µ 1200. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö—Ä–æ–º–æ—Å–æ–º –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞."
  },
{
    question: "–í —Ñ–∏–ª—å–º–∞—Ö –ø—Ä–æ –î–∂–µ–∫–∞ –í–æ—Ä–æ–±—å—è —á–∞—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –°–æ–≤–µ—Ç –ë—Ä–∞—Ç—Å—Ç–≤–∞. –ù–∞–∑–æ–≤–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –ø–∏—Ä–∞—Ç—Å–∫–∏—Ö –±–∞—Ä–æ–Ω–æ–≤ –≤—Ö–æ–¥–∏–ª–æ –≤ —ç—Ç–æ—Ç —Å–æ–≤–µ—Ç?",
    hints: [
      "1. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∫—Ä—É–≥–æ–≤ –∞–¥–∞ –æ–ø–∏—Å–∞–ª –î–∞–Ω—Ç–µ –≤ ¬´–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–º–µ–¥–∏–∏",
      "2. –°—Ç–æ–ª—å–∫–æ –ù–∞–∑–≥—É–ª–æ–≤ –∏—Å–∫–∞–ª–∏ –§—Ä–æ–¥–æ –≤–æ ¬´–í–ª–∞—Å—Ç–µ–ª–∏–Ω–µ –ö–æ–ª–µ—Ü",
      "3. –£ –∫–æ—à–∫–∏, —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–≤–µ—Ä—å—è–º, –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∂–∏–∑–Ω–µ–π"
    ],
    answer: "9",
    fact: "–ó–Ω–∞–º–µ–Ω–∏—Ç–∞—è —Ñ—Ä–∞–∑–∞ –ø—Ä–æ —Ç–æ, —á—Ç–æ –ü–∏—Ä–∞—Ç—Å–∫–∏–π –ö–æ–¥–µ–∫—Å ‚Äî —ç—Ç–æ ¬´–Ω–µ —Å–≤–æ–¥ –∑–∞–∫–æ–Ω–æ–≤, –∞ –ø—Ä–æ—Å—Ç–æ —Å–≤–æ–¥ —É–∫–∞–∑–∞–Ω–∏–π¬ª, –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –∏–º–µ–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä–Ω–∏. –£ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–∏—Ä–∞—Ç–æ–≤ –±—ã–ª–∏ —Å–≤–æ–∏ ¬´—Å—Ç–∞—Ç—å–∏¬ª (articles), –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–ª –∫–∞–∂–¥—ã–π —á–ª–µ–Ω —ç–∫–∏–ø–∞–∂–∞, –Ω–æ –æ–Ω–∏ —á–∞—Å—Ç–æ –º–µ–Ω—è–ª–∏—Å—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞–ø–∏—Ç–∞–Ω–∞ –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤."
  },
{
    question: "–°–∫–æ–ª—å–∫–æ –û—Å–∫–∞—Ä–æ–≤ –ø–æ–ª—É—á–∏–ª —Ñ–∏–ª—å–º ¬´–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ—Ä–æ–ª—è¬ª? (–≠—Ç–æ —Ä–µ–∫–æ—Ä–¥, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª—è—Ç —Å –¢–∏—Ç–∞–Ω–∏–∫–æ–º –∏ –ë–µ–Ω-–ì—É—Ä–æ–º).",
    hints: [
      "1. –ù–æ–º–µ—Ä –º–∏—Å—Å–∏–∏ –ê–ø–æ–ª–ª–æ–Ω, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–≤–æ–π —Å–µ–ª–∞ –Ω–∞ –õ—É–Ω—É.",
      "2. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –æ–¥–Ω–æ–π —Ñ—É—Ç–±–æ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –ø–æ–ª–µ.",
      "3. –ü–µ—Ä–≤–æ–µ –¥–≤—É–∑–Ω–∞—á–Ω–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ."
    ],
    answer: "11",
    fact: "–§–∏–ª—å–º —Å–æ–≤–µ—Ä—à–∏–ª —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ–º—ã–π ¬´—á–∏—Å—Ç—ã–π —Ä–∞–∑–º–∞—Ö¬ª (Clean Sweep). –û–Ω –±—ã–ª –Ω–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω –≤ 11 –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –∏ –≤—ã–∏–≥—Ä–∞–ª –≤–æ –≤—Å–µ—Ö 11. –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: —É ¬´–¢–∏—Ç–∞–Ω–∏–∫–∞¬ª –±—ã–ª–æ 14 –Ω–æ–º–∏–Ω–∞—Ü–∏–π (3 –ø—Ä–æ–∏–≥—Ä—ã—à–∞), –∞ —É ¬´–ë–µ–Ω-–ì—É—Ä–∞¬ª ‚Äî 12 –Ω–æ–º–∏–Ω–∞—Ü–∏–π (1 –ø—Ä–æ–∏–≥—Ä—ã—à)."
  },
{
    question: "–°–∫–æ–ª—å–∫–æ –∫–ª–∞–≤–∏—à (—á–µ—Ä–Ω—ã—Ö –∏ –±–µ–ª—ã—Ö –≤–º–µ—Å—Ç–µ) –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ –¥–æ —Ç–∞–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ (–≤ –º–∏–ª—è—Ö –≤ —á–∞—Å) –Ω—É–∂–Ω–æ –±—ã–ª–æ —Ä–∞–∑–æ–≥–Ω–∞—Ç—å DeLorean –≤ —Ñ–∏–ª—å–º–µ ¬´–ù–∞–∑–∞–¥ –≤ –ë—É–¥—É—â–µ–µ¬ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏.",
      "2. –≠—Ç–æ —á–∏—Å–ª–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞–¥–∏–∫–∞–ª—å–Ω—ã–º–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞–º–∏ –∫–∞–∫ –∫–æ–¥–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (H.H.), –∏–∑-–∑–∞ —á–µ–≥–æ –µ–≥–æ —á–∞—Å—Ç–æ –±–∞–Ω—è—Ç –≤ –Ω–∏–∫–Ω–µ–π–º–∞—Ö –∏–≥—Ä.",
      "3. –í–∏–∑—É–∞–ª—å–Ω–æ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –¥–≤–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏, –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ."
    ],
    answer: "88",
    fact: "–°—É—â–µ—Å—Ç–≤—É–µ—Ç —Ñ–∏—Ä–º–∞ B√∂sendorfer, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç —Ä–æ—è–ª–∏ –º–æ–¥–µ–ª–∏ ¬´Imperial¬ª —Å 97 –∫–ª–∞–≤–∏—à–∞–º–∏. –õ–∏—à–Ω–∏–µ –∫–ª–∞–≤–∏—à–∏ –≤ —Å–∞–º–æ–º –Ω–∏–∑—É –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫—Ä–∞—à–µ–Ω—ã –≤ —á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç, —á—Ç–æ–±—ã –ø–∏–∞–Ω–∏—Å—Ç –Ω–µ –∑–∞–ø—É—Ç–∞–ª—Å—è. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤ –∏—Ö –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞–∂–∏–º–∞—é—Ç, –Ω–æ –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞ ‚Äî –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–º –≤–µ—Å—å —Ä–æ—è–ª—å –∑–≤—É—á–∏—Ç –≥–ª—É–±–∂–µ –∏ –±–æ–≥–∞—á–µ."
  },
{
    question: "–í –∫–æ–ª–æ–¥–µ –∫–∞—Ä—Ç Uno –º–Ω–æ–≥–æ —Ü–≤–µ—Ç–Ω—ã—Ö –∫–∞—Ä—Ç, –Ω–æ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∫–∞—Ä—Ç –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –∫–æ–ª–æ–¥–µ (–≤–∫–ª—é—á–∞—è –¥–∂–æ–∫–µ—Ä–æ–≤ –∏ –Ω—É–ª–µ–≤–∫–∏)?",
    hints: [
      "1. –í —Å–µ—Ä–∏–∞–ª–µ ¬´–û—Å—Ç–∞—Ç—å—Å—è –≤ –∂–∏–≤—ã—Ö¬ª (Lost) –≥–µ—Ä–æ—è–º –Ω—É–∂–Ω–æ –±—ã–ª–æ –≤–≤–æ–¥–∏—Ç—å –∫–æ–¥ –≤ –∫–æ–º–ø—å—é—Ç–µ—Ä –∫–∞–∂–¥—ã–µ ... –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã —Å–ø–∞—Å—Ç–∏ –º–∏—Ä.",
      "2. –≠—Ç–æ —Å–≤—è—â–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –≤ –±—É–¥–¥–∏–∑–º–µ –∏ –∏–Ω–¥—É–∏–∑–º–µ (—Å—Ç–æ–ª—å–∫–æ –±—É—Å–∏–Ω –≤ —á–µ—Ç–∫–∞—Ö –¥–ª—è –º–∞–Ω—Ç—Ä).",
      "3. –ê—Ç–æ–º–Ω–∞—è –º–∞—Å—Å–∞ —Å–µ—Ä–µ–±—Ä–∞ (–æ–∫—Ä—É–≥–ª–µ–Ω–Ω–æ)."
    ],
    answer: "108",
    fact: "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å Uno (–∫–æ–º–ø–∞–Ω–∏—è Mattel) –≤ 2019 –≥–æ–¥—É —Å–¥–µ–ª–∞–ª–∞ —à–æ–∫–∏—Ä—É—é—â–µ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ –≤ –¢–≤–∏—Ç—Ç–µ—Ä–µ: –í—ã –ù–ï –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–∞ –∫–ª–∞—Å—Ç—å ¬´+4¬ª –Ω–∞ ¬´+2¬ª –∏–ª–∏ ¬´+4¬ª –Ω–∞ ¬´+4¬ª! –í–µ—Å—å –º–∏—Ä –¥–µ—Å—è—Ç–∏–ª–µ—Ç–∏—è–º–∏ –∏–≥—Ä–∞–ª –≤ ¬´–ø–µ—Ä–µ–≤–æ–¥–Ω–æ–≥–æ¬ª, —Å–æ–∑–¥–∞–≤–∞—è —Ü–µ–ø–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Å—Ç–∞–≤–ª—è–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –±—Ä–∞—Ç—å –ø–æ–ª–∫–æ–ª–æ–¥—ã, –Ω–æ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —ç—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ. –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–ª–∞–ª–∏ –∫–æ–º–ø–∞–Ω–∏—é –ø–æ–¥–∞–ª—å—à–µ, –∑–∞—è–≤–∏–≤: ¬´–ú—ã –∫—É–ø–∏–ª–∏ –∏–≥—Ä—É, –º—ã –∏ —Ä–µ—à–∞–µ–º, –∫–∞–∫ –≤ –Ω–µ—ë –∏–≥—Ä–∞—Ç—å¬ª."
  },
{
    question: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è ¬´–ú–∞—Ç—å –¥–æ—Ä–æ–≥¬ª –≤ –°–®–ê, –æ–¥–Ω–æ –∏–∑ –ø–µ—Ä–≤—ã—Ö —à–æ—Å—Å–µ, —Å–æ–µ–¥–∏–Ω–∏–≤—à–∏—Ö –ß–∏–∫–∞–≥–æ –∏ –õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å. –ü—Ä–æ –Ω–µ—ë –ø–æ—é—Ç –ø–µ—Å–Ω–∏, —Å–Ω–∏–º–∞—é—Ç —Ñ–∏–ª—å–º—ã (–¥–∞–∂–µ –≤ ¬´–¢–∞—á–∫–∞—Ö¬ª –æ–Ω–∞ –µ—Å—Ç—å). –ö–∞–∫–æ–π –Ω–æ–º–µ—Ä —É —ç—Ç–æ–π —Ç—Ä–∞—Å—Å—ã?",
    hints: [
      "1. –≠—Ç–æ —á–∏—Å–ª–æ –¥–∂–µ–¥–∞–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–ª–µ–∂–∞–ª–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—é —Å–æ–≥–ª–∞—Å–Ω–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–∏–∫–∞–∑—É –ò–º–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ü–∞–ª–ø–∞—Ç–∏–Ω–∞ (¬´–í—ã–ø–æ–ª–Ω–∏—Ç—å –ü—Ä–∏–∫–∞–∑...¬ª).",
      "2.  –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞, –∫–æ–≥–¥–∞ –ê–Ω–≥–ª–∏—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑ –≤—ã–∏–≥—Ä–∞–ª–∞ –ß–µ–º–ø–∏–æ–Ω–∞—Ç –º–∏—Ä–∞ –ø–æ —Ñ—É—Ç–±–æ–ª—É.",
      "3. –ï—Å–ª–∏ –∏–∑ ¬´–ß–∏—Å–ª–∞ –∑–≤–µ—Ä—è¬ª –≤—ã—á–µ—Å—Ç—å 600, –ø–æ–ª—É—á–∏—Ç—Å—è –æ—Ç–≤–µ—Ç."
    ],
    answer: "66",
    fact: "–î–æ—Ä–æ–≥–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≤—ã–≤–µ–¥–µ–Ω–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã —à–æ—Å—Å–µ –°–®–ê –≤ 1985 –≥–æ–¥—É, –Ω–æ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –ø–æ –Ω–µ–π —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç–µ—Ç."
  },
{
    question: "–°–∞—Ç—É—Ä–Ω –∑–Ω–∞–º–µ–Ω–∏—Ç —Å–≤–æ–∏–º–∏ –∫–æ–ª—å—Ü–∞–º–∏, –∞ –ü–ª—É—Ç–æ–Ω —Ç–µ–º, —á—Ç–æ –µ–≥–æ –≤—ã–≥–Ω–∞–ª–∏ –∏–∑ –ø–ª–∞–Ω–µ—Ç. –ê —Å–∫–æ–ª—å–∫–æ —Å–ø—É—Ç–Ω–∏–∫–æ–≤ —É –ú–∞—Ä—Å–∞?",
    hints: [
      "1. –ê—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä –ì–µ–ª–∏—è.",
      "2. –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á—ë—Ç–Ω–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ –≤ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ.",
      "3.  –°—Ç–æ–ª—å–∫–æ –±–∞—à–µ–Ω –±—ã–ª–æ —É –í—Å–µ–º–∏—Ä–Ω–æ–≥–æ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –≤ –ù—å—é-–ô–æ—Ä–∫–µ."
    ],
    answer: "2",
    fact: "–°–ø—É—Ç–Ω–∏–∫–∏ –∑–æ–≤—É—Ç –§–æ–±–æ—Å –∏ –î–µ–π–º–æ—Å (–°—Ç—Ä–∞—Ö –∏ –£–∂–∞—Å). –î–∂–æ–Ω–∞—Ç–∞–Ω –°–≤–∏—Ñ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª –∏—Ö –Ω–∞–ª–∏—á–∏–µ –∑–∞ 150 –ª–µ—Ç –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–µ–ª–µ—Å–∫–æ–ø–∞–º–∏."
  },
{
    question: "–ö–∞–∫–æ–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–ª –¢–≤–∏—Ç—Ç–µ—Ä –≤ –æ–¥–Ω–æ–º –ø–æ—Å—Ç–µ?",
    hints: [
      "1. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ–º–ø (—É–¥–∞—Ä–æ–≤ –≤ –º–∏–Ω—É—Ç—É) –¥–ª—è –∂–∞–Ω—Ä–æ–≤ –º—É–∑—ã–∫–∏ –¥–∞–±—Å—Ç–µ–ø –∏ —Ç—Ä–∞–Ω—Å.",
      "2. –£—Ä–æ–≤–µ–Ω—å IQ, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ –Ω–∞–∑—ã–≤–∞—é—Ç –ø–æ—Ä–æ–≥–æ–º '–≥–µ–Ω–∏–∞–ª—å–Ω–æ—Å—Ç–∏'.",
      "3. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –ø–æ–ª—å—Å–∫–∏—Ö –∞–≤—Ç–æ–º–∞–≥–∏—Å—Ç—Ä–∞–ª—è—Ö (Autostrada) –≤ –∫–º/—á."
    ],
    answer: "140",
    fact: "–≠—Ç–æ —á–∏—Å–ª–æ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ, –∞ –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π SMS-—Å–æ–æ–±—â–µ–Ω–∏–π. –í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º SMS –±—ã–ª–æ 160 —Å–∏–º–≤–æ–ª–æ–≤, –∏ —Å–æ–∑–¥–∞—Ç–µ–ª–∏ –¢–≤–∏—Ç—Ç–µ—Ä–∞ ¬´–æ—Ç–∫—É—Å–∏–ª–∏¬ª 20 –∏–∑ –Ω–∏—Ö –ø–æ–¥ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ."
  },
{
    question: "–°–∫–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–π –∏ —Ç—Ä–∞–≤ –≤—Ö–æ–¥–∏—Ç –≤ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –ø–æ–ª–∫–æ–≤–Ω–∏–∫–∞ –°–∞–Ω–¥–µ—Ä—Å–∞ (KFC)?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –ª–µ—Ç –¥–ª–∏—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–∏–∫–ª —Å–æ–ª–Ω–µ—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ö–∞–∂–¥—ã–µ 11 –ª–µ—Ç –º–∞–≥–Ω–∏—Ç–Ω—ã–µ –ø–æ–ª—é—Å–∞ –°–æ–ª–Ω—Ü–∞ –º–µ–Ω—è—é—Ç—Å—è –º–µ—Å—Ç–∞–º–∏, –≤—ã–∑—ã–≤–∞—è –≤—Å–ø–ª–µ—Å–∫–∏ —Å–µ–≤–µ—Ä–Ω—ã—Ö —Å–∏—è–Ω–∏–π –∏ –º–∞–≥–Ω–∏—Ç–Ω—ã—Ö –±—É—Ä—å –Ω–∞ –ó–µ–º–ª–µ.",
      "2. –ü—Ä–æ–∑–≤–∏—â–µ –≥–ª–∞–≤–Ω–æ–π –≥–µ—Ä–æ–∏–Ω–∏ —Å–µ—Ä–∏–∞–ª–∞ ¬´–û—á–µ–Ω—å —Å—Ç—Ä–∞–Ω–Ω—ã–µ –¥–µ–ª–∞¬ª (–û–¥–∏).",
      "3. –í—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –¥–≤–µ –±–∞—Ä–∞–±–∞–Ω–Ω—ã–µ –ø–∞–ª–æ—á–∫–∏."
    ],
    answer: "11",
    fact: "–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä—É–∫–æ–ø–∏—Å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç 1940-—Ö –≥–æ–¥–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ü–∏—Ñ—Ä–æ–≤–æ–º —Å–µ–π—Ñ–µ –≤ —à—Ç–∞–±-–∫–≤–∞—Ä—Ç–∏—Ä–µ –≤ –õ—É–∏—Å–≤–∏–ª–ª–µ. –°–µ–π—Ñ –æ–∫—Ä—É–∂–µ–Ω –¥–∞—Ç—á–∏–∫–∞–º–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∏ –±–µ—Ç–æ–Ω–æ–º —Ç–æ–ª—â–∏–Ω–æ–π –≤ –ø–æ–ª–º–µ—Ç—Ä–∞. –î–∞–∂–µ –≥–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –∑–Ω–∞–µ—Ç —Ä–µ—Ü–µ–ø—Ç–∞ —Ü–µ–ª–∏–∫–æ–º."
  },
{
    question: "–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –±—Ä–µ–Ω–¥–∞ DIOR - –ö—Ä–∏—Å—Ç–∏–∞–Ω –î–∏–æ—Ä, —É–≤–ª–µ–∫–∞–ª—Å—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–µ–π. –ê –ø–æ—Ç–æ–º—É –ø—Ä–∏—Å–≤–æ–∏–ª –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —á–∏—Å–ª–æ —Å–≤–æ–µ–π –∫—É–ª—å—Ç–æ–≤–æ–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –ø–æ–º–∞–¥–µ, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º–æ–π –ø—Ä–æ–¥–∞–≤–∞–µ–º–æ–π –≤ –º–∏—Ä–µ. –ß–∏—Å–ª–æ –±—ã–ª–æ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ, –≤–µ–¥—å –≤ –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏ –æ–Ω–æ —è–≤–ª—è–µ—Ç—Å—è —Å—á–∞—Å—Ç–ª–∏–≤—ã–º. –ù–∞–∑–æ–≤–∏—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ.",
    hints: [
      "1. –°–æ–≥–ª–∞—Å–Ω–æ –æ–ø–∞—Å–µ–Ω–∏—è–º –∏–∑-–∑–∞ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –∑–∞–ø–∏—Å–∏ –¥–∞—Ç—ã –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –≥–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã–ª –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –º–∞—Å—Å–æ–≤–æ–º—É —Å–±–æ—é –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É. –¢—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã —ç—Ç–æ–≥–æ –≥–æ–¥–∞ —Ä–∞–≤–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—é –≤ –æ—Ç–≤–µ—Ç–µ.",
      "2. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –∏–∑ —ç—Ç–∏—Ö —Ç—Ä—ë—Ö —á–∏—Å–µ–ª —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º—ã–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –¥–ª—è –≤—ã–∑–æ–≤–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–± –≤ —Å—Ç—Ä–∞–Ω–∞—Ö –º–∏—Ä–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ –≤ –ü–æ–ª—å—à–µ.",
      "3. –¢—Ä—ë—Ö–∑–Ω–∞—á–Ω—ã–π –ø–∞–ª–∏–Ω–¥—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±–æ–ª—å—à–µ –±–æ–ª—å—à–µ 900, –Ω–æ –º–µ–Ω—å—à–µ 1000 —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —á–∏—Å–ª–æ–º –≤ –æ—Ç–≤–µ—Ç–µ."
    ],
    answer: "999",
    fact: "–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, —ç—Ç–æ —á–∏—Å–ª–æ ‚Äî –¥–∞–Ω—å —É–≤–∞–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã–º –¥–≤—É–º –ø–æ–º–∞–¥–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø—É—Å—Ç–∏–ª –ö—Ä–∏—Å—Ç–∏–∞–Ω –î–∏–æ—Ä –≤ 1953 –≥–æ–¥—É. –û–Ω–∏ –Ω–∞–∑—ã–≤–∞–ª–∏—Å—å –ø—Ä–æ—Å—Ç–æ ‚Ññ9 –∏ ‚Ññ99. –ü–æ–∑–∂–µ –∏—Ö –æ–±—ä–µ–¥–∏–Ω–∏–ª–∏ –≤ –æ–¥–Ω—É ¬´–∏–¥–µ–∞–ª—å–Ω—É—é¬ª —Ñ–æ—Ä–º—É–ª—É, –∏ –æ–Ω–∞ –ø–æ–ª—É—á–∏–ª–∞ –Ω–æ–º–µ—Ä 999. –í –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏–∏ –¥–µ–≤—è—Ç–∫–∞ —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç —É—Å–ø–µ—Ö, –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç—å –∏ –±–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é. –î–∏–æ—Ä –≤–µ—Ä–∏–ª, —á—Ç–æ —Ç—Ä–∏ –¥–µ–≤—è—Ç–∫–∏ —É—Å–∏–ª–∏–≤–∞—é—Ç —ç—Ç–æ –≤–µ–∑–µ–Ω–∏–µ –≤ –∫—É–±–µ."
  },
{
    question: "–†—ç–π –ë—Ä—ç–¥–±–µ—Ä–∏ –Ω–∞–∑–≤–∞–ª —Å–≤–æ–π —Ä–æ–º–∞–Ω-–∞–Ω—Ç–∏—É—Ç–æ–ø–∏—é –≤ —á–µ—Å—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π (–ø–æ –µ–≥–æ –º–Ω–µ–Ω–∏—é) –≤–æ—Å–ø–ª–∞–º–µ–Ω—è–µ—Ç—Å—è –∏ –≥–æ—Ä–∏—Ç –±—É–º–∞–≥–∞. –ù–∞–∑–æ–≤–∏—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ.",
    hints: [
      "1. –≠—Ç–æ –∫–æ–¥ –æ—à–∏–±–∫–∏ HTTP, –∫–æ—Ç–æ—Ä—ã–π –æ–∑–Ω–∞—á–∞–µ—Ç ¬´–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –ø—Ä–∏—á–∏–Ω–∞–º¬ª (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ü–µ–Ω–∑—É—Ä–æ–π) ‚Äî –æ—á–µ–Ω—å —Å–∏–º–≤–æ–ª–∏—á–Ω–æ –¥–ª—è —ç—Ç–æ–π –∫–Ω–∏–≥–∏.",
      "2.  –°—É–º–º–∞ —Ü–∏—Ñ—Ä —ç—Ç–æ–≥–æ —á–∏—Å–ª–∞ —Ä–∞–≤–Ω–∞ 10.",
      "3. –≠—Ç–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É–∫–∞–∑–∞–Ω–∞ –ø–æ —à–∫–∞–ª–µ –§–∞—Ä–µ–Ω–≥–µ–π—Ç–∞. –ï—Å–ª–∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –µ—ë –≤ –ø—Ä–∏–≤—ã—á–Ω—ã–µ –Ω–∞–º –≥—Ä–∞–¥—É—Å—ã –¶–µ–ª—å—Å–∏—è, –ø–æ–ª—É—á–∏—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ 233¬∞. ¬∞F = (¬∞C √ó 9/5) + 32."
    ],
    answer: "451",
    fact: "–ë—Ä—ç–¥–±–µ—Ä–∏ –æ—à–∏–±—Å—è. –ë—É–º–∞–≥–∞ —Å–∞–º–æ–≤–æ—Å–ø–ª–∞–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ 450 –≥—Ä–∞–¥—É—Å–∞—Ö –¶–µ–ª—å—Å–∏—è, –∞ –ø–æ –§–∞—Ä–µ–Ω–≥–µ–π—Ç—É —ç—Ç–æ –±—ã–ª–æ –±—ã –æ–∫–æ–ª–æ 842. –ù–æ ¬´451¬ª –∑–≤—É—á–∏—Ç –∫—Ä–∞—Å–∏–≤–µ–µ."
  },
{
    question: "–ù–∞–∑–æ–≤–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–±—ã–≤–∞–ª–æ –∑–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –õ—É–Ω–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏",
    hints: [
      "1. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Å—Ç–æ—è—á–∏—Ö –∫–∞–º–Ω–µ–π –∏–ª–∏ –∂–µ –º–∞—Ç—Ü–µ–≤ –ø–æ—Å—Ç–∞–≤–∏–ª –ú–æ–∏—Å–µ–π —É –ø–æ–¥–Ω–æ–∂—å—è –°–∏–Ω–∞–π—Å–∫–æ–π –≥–æ—Ä—ã",
      "2. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Ä–∞–∑–≥–Ω–µ–≤–∞–Ω–Ω—ã—Ö –º—É–∂—á–∏–Ω —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ —Ñ–∏–ª—å–º–∞ –ø—Ä–æ —Ç—è–∂–±—ã —Å—É–¥–µ–±–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞",
      "3. –ß–∏—Å–ª–æ —Ä—ë–±–µ—Ä –∫—É–±–∞ –∏ –æ–∫—Ç–∞—ç–¥—Ä–∞"
    ],
    answer: "12",
    fact: "–í—Å–µ 12 —á–µ–ª–æ–≤–µ–∫ –±—ã–ª–∏ –∞–º–µ—Ä–∏–∫–∞–Ω—Ü–∞–º–∏ –∏ –ª–µ—Ç–∞–ª–∏ –Ω–∞ –õ—É–Ω—É –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º—ã ¬´–ê–ø–æ–ª–ª–æ–Ω¬ª –≤ –ø–µ—Ä–∏–æ–¥ —Å 1969 –ø–æ 1972 –≥–æ–¥. –ü–æ—Å–ª–µ 1972 –≥–æ–¥–∞ ‚Äî —Ç–∏—à–∏–Ω–∞. –í–æ—Ç —É–∂–µ –±–æ–ª–µ–µ 50 –ª–µ—Ç –Ω–∏ –æ–¥–Ω–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è –Ω–æ–≥–∞ –Ω–µ –∫–∞—Å–∞–ª–∞—Å—å –ª—É–Ω–Ω–æ–π –ø—ã–ª–∏."
  },
{
    question: "–°–æ–≥–ª–∞—Å–Ω–æ —Å–∞–º–æ–º—É –ø–æ–ø—É–ª—è—Ä–Ω–æ–º—É (—Ö–æ—Ç—è –∏ –Ω–∞—É—á–Ω–æ —Å–ø–æ—Ä–Ω–æ–º—É) —Ç–µ—Å—Ç—É –ª–∏—á–Ω–æ—Å—Ç–∏ –≤ –º–∏—Ä–µ ‚Äî —Ç–∏–ø–æ–ª–æ–≥–∏–∏ –ú–∞–π–µ—Ä—Å-–ë—Ä–∏–≥–≥—Å (MBTI) ‚Äî –≤—Å—ë –º–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–≤ –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ —Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤. –ö–∞–∫–æ–µ —ç—Ç–æ —á–∏—Å–ª–æ?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –Ω–æ—Å–∏–ª —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∫–æ—Ä–æ–ª—å –õ—é–¥–æ–≤–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Ç–µ—Ä—è–ª –≥–æ–ª–æ–≤—É –Ω–∞ –≥–∏–ª—å–æ—Ç–∏–Ω–µ –≤–æ –≤—Ä–µ–º—è –í–µ–ª–∏–∫–æ–π —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–π —Ä–µ–≤–æ–ª—é—Ü–∏–∏.",
      "2. –í –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω–æ–π –∫—É–ª—å—Ç—É—Ä–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ–Ω—è—Ç–∏–µ ¬´Sweet ...¬ª ‚Äî —ç—Ç–æ –≤–æ–∑—Ä–∞—Å—Ç —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–∏—è, –∫–æ–≥–¥–∞ –¥–µ–≤—É—à–∫–∞–º —É—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –ø—ã—à–Ω—ã–µ –±–∞–ª—ã, –∞ –ø–æ–¥—Ä–æ—Å—Ç–∫–∞–º –≤ –°–®–ê —Ä–∞–∑—Ä–µ—à–∞—é—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Å–µ—Å—Ç—å –∑–∞ —Ä—É–ª—å.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ —è–≤–ª—è–µ—Ç—Å—è ¬´–∏–¥–µ–∞–ª—å–Ω—ã–º –∫–≤–∞–¥—Ä–∞—Ç–æ–º¬ª –∏ —á–µ—Ç–≤–µ—Ä—Ç–æ–π —Å—Ç–µ–ø–µ–Ω—å—é –¥–≤–æ–π–∫–∏."
    ],
    answer: "16",
    fact: "–≠—Ç–æ —á–∏—Å–ª–æ —è–≤–ª—è–µ—Ç—Å—è ¬´–∏–¥–µ–∞–ª—å–Ω—ã–º –∫–≤–∞–¥—Ä–∞—Ç–æ–º¬ª –∏ —á–µ—Ç–≤–µ—Ä—Ç–æ–π —Å—Ç–µ–ø–µ–Ω—å—é –¥–≤–æ–π–∫–∏"
  },
{
    question: "–ò–º–µ–Ω–Ω–æ —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ç–æ—Ä–æ–π —Å—Ç—É–¥–∏–π–Ω—ã–π –∞–ª—å–±–æ–º –±—Ä–∏—Ç–∞–Ω—Å–∫–æ–π –ø–µ–≤–∏—Ü—ã –ê–¥–µ–ª—å (Adele), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–µ—Å –µ–π –º–∏—Ä–æ–≤—É—é —Å–ª–∞–≤—É –∏ 6 –ø—Ä–µ–º–∏–π ¬´–ì—Ä—ç–º–º–∏¬ª.",
    hints: [
      "1. –°–æ–≥–ª–∞—Å–Ω–æ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–º—É —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É –¥–æ–∫—Ç–æ—Ä–∞ –ú–∞–∫–¥—É–≥–∞–ª–ª–∞, –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –≥—Ä–∞–º–º–æ–≤ —Ç–µ—Ä—è–µ—Ç —Ç–µ–ª–æ —á–µ–ª–æ–≤–µ–∫–∞ –≤ –º–æ–º–µ–Ω—Ç —Å–º–µ—Ä—Ç–∏. –≠—Ç–æ —á–∏—Å–ª–æ –≤–æ—à–ª–æ –≤ –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ ¬´–≤–µ—Å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –¥—É—à–∏¬ª.",
      "2. –≠—Ç–æ ¬´—Å–∞–º—ã–π –≤–∑—Ä–æ—Å–ª—ã–π¬ª –≤–æ–∑—Ä–∞—Å—Ç —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–∏—è. –¢–æ–ª—å–∫–æ –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –≤ –°–®–ê —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å –∞–ª–∫–æ–≥–æ–ª—å –∏ –∑–∞—Ö–æ–¥–∏—Ç—å –≤ –∫–∞–∑–∏–Ω–æ –õ–∞—Å-–í–µ–≥–∞—Å–∞.",
      "3. –í –∞–∑–∞—Ä—Ç–Ω—ã—Ö –∏–≥—Ä–∞—Ö —ç—Ç–æ —á–∏—Å–ª–æ ‚Äî —Å–∏–º–≤–æ–ª –ø–æ–±–µ–¥—ã, –∞ –≤ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ ‚Äî —ç—Ç–æ —Å—É–º–º–∞ –≤—Å–µ—Ö —á–∏—Å–µ–ª –Ω–∞ –≥—Ä–∞–Ω—è—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∏–≥—Ä–∞–ª—å–Ω–æ–≥–æ –∫—É–±–∏–∫–∞."
    ],
    answer: "21",
    fact: "–≠—Ç–æ—Ç –∞–ª—å–±–æ–º –±—ã–ª –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–º —Ä–∞–∑—Ä—ã–≤–æ–º –ê–¥–µ–ª—å —Å –µ—ë –ø–∞—Ä–Ω–µ–º. –ù–æ —Å–∞–º–æ–µ –∑–∞–±–∞–≤–Ω–æ–µ —Å–ª—É—á–∏–ª–æ—Å—å –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ '21' —Å—Ç–∞–ª –º–∏—Ä–æ–≤—ã–º —Ö–∏—Ç–æ–º –∏ —Å–æ–±—Ä–∞–ª –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã. –ë—ã–≤—à–∏–π –≤–æ–∑–ª—é–±–ª–µ–Ω–Ω—ã–π –ø–µ–≤–∏—Ü—ã –ø–æ–∑–≤–æ–Ω–∏–ª –µ–π –∏ –Ω–∞ –ø–æ–ª–Ω–æ–º —Å–µ—Ä—å–µ–∑–µ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª –¥–æ–ª—é –æ—Ç –ø—Ä–∏–±—ã–ª–∏!"
  },
{
    question: "–≠—Ç–æ—Ç –≥–æ–¥ —Å—Ç–∞–ª –ø–µ—Ä–µ–ª–æ–º–Ω—ã–º –¥–ª—è –≤—Å–µ–π –ï–≤—Ä–æ–ø—ã. –í –ü–∞—Ä–∏–∂–µ –Ω–∞—á–∞–ª–∏—Å—å —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–µ—Å—Ç—ã –ø–æ–¥ –ª–æ–∑—É–Ω–≥–æ–º ¬´–ó–∞–ø—Ä–µ—â–∞—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ¬ª, –∞ –≤ –ü—Ä–∞–≥–µ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å ¬´—Å–æ—Ü–∏–∞–ª–∏–∑–º —Å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º –ª–∏—Ü–æ–º¬ª. –û –∫–∞–∫–æ–º —á–∏—Å–ª–µ (–≥–æ–¥–µ) –∏–¥–µ—Ç —Ä–µ—á—å?",
    hints: [
      "1. –û–¥–Ω–æ –∏–∑ —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä ‚Äî —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —á–∏—Å–ª–æ (—Å—Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏—à –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º-—Ñ–∞–∫—Ç–æ—Ä–µ). –°—á–∏—Ç–∞–µ—Ç—Å—è ¬´–∑–æ–ª–æ—Ç–æ–π —Å–µ—Ä–µ–¥–∏–Ω–æ–π¬ª –º–µ–∂–¥—É —É–¥–æ–±—Å—Ç–≤–æ–º –∏ —Ä–∞–∑–º–µ—Ä–æ–º.",
      "2. –ï—Å–ª–∏ –Ω–∞ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–º —Ç–µ—Ä–º–æ–º–µ—Ç—Ä–µ –≤—ã —É–≤–∏–¥–∏—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ –ø–æ –§–∞—Ä–µ–Ω–≥–µ–π—Ç—É, –Ω–µ –ø—É–≥–∞–π—Ç–µ—Å—å ‚Äî —ç—Ç–æ –∏–¥–µ–∞–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è –≤ –ø—Ä–∏–≤—ã—á–Ω—ã—Ö –Ω–∞–º –≥—Ä–∞–¥—É—Å–∞—Ö –¶–µ–ª—å—Å–∏—è —Ä–∞–≤–Ω–∞ —Ä–æ–≤–Ω–æ 20¬∞.",
      "3. –ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω–µ—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ –≤–≤–µ—Ä—Ö –Ω–æ–≥–∞–º–∏ (–Ω–∞ 180 –≥—Ä–∞–¥—É—Å–æ–≤), —Ç–æ –ø–æ–ª—É—á–∏—Ç–µ —á–∏—Å–ª–æ 89."
    ],
    answer: "68",
    fact: "–ò–º–µ–Ω–Ω–æ –≤ 1968 –≥–æ–¥—É –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –∏—Å—Ç–æ—Ä–∏–∫–∏ –Ω–∞–∑—ã–≤–∞—é—Ç '–ú–∞—Ç–µ—Ä—å—é –≤—Å–µ—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–π'. –î—É–≥–ª–∞—Å –≠–Ω–≥–µ–ª—å–±–∞—Ä—Ç –≤–ø–µ—Ä–≤—ã–µ –ø–æ–∫–∞–∑–∞–ª –º–∏—Ä—É –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—É—é –º—ã—à—å, –≥–∏–ø–µ—Ä—Ç–µ–∫—Å—Ç, –æ–∫–Ω–∞ –∏ –¥–∞–∂–µ –≤–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é! –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, –Ω–∞ –¥–≤–æ—Ä–µ 68-–π, –ª—é–¥–∏ —Ç–æ–ª—å–∫–æ-—Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤—ã–∫–ª–∏ –∫ —Ü–≤–µ—Ç–Ω–æ–º—É –¢–í, –∞ –∫—Ç–æ-—Ç–æ —É–∂–µ –∫–ª–∏–∫–∞–ª –º—ã—à–∫–æ–π –ø–æ —ç–∫—Ä–∞–Ω—É. –≠—Ç–æ—Ç –≥–æ–¥ –±—É–∫–≤–∞–ª—å–Ω–æ '–∑–∞–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–ª' –Ω–∞—à–µ –±—É–¥—É—â–µ–µ!"
  },
{
    question: "–≠—Ç–æ—Ç –≥–æ–¥ –≤ XX –≤–µ–∫–µ –Ω–∞–∑—ã–≤–∞—é—Ç ¬´–õ–µ—Ç–æ–º –ª—é–±–≤–∏¬ª. –í —ç—Ç–æ–º –∂–µ –≥–æ–¥—É –º–µ–¥–∏—Ü–∏–Ω–∞ —Å–¥–µ–ª–∞–ª–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ ‚Äî —á–µ–ª–æ–≤–µ–∫ –≤–ø–µ—Ä–≤—ã–µ –ø–æ–ª—É—á–∏–ª —Å–µ—Ä–¥—Ü–µ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞. –û –∫–∞–∫–æ–º —á–∏—Å–ª–µ (–≥–æ–¥–µ) –∏–¥–µ—Ç —Ä–µ—á—å?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º –≥–æ–¥—É –≥—Ä—É–ø–ø–∞ The Beatles –≤—ã–ø—É—Å—Ç–∏–ª–∞ —Å–≤–æ–π —Å–∞–º—ã–π –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–π –∞–ª—å–±–æ–º ¬´Sgt. Pepper‚Äôs Lonely Hearts Club Band¬ª, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–∏–ª –∏—Å—Ç–æ—Ä–∏—é –º—É–∑—ã–∫–∏.",
      "2. –≠—Ç–æ —á–∏—Å–ª–æ —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∑–¥–æ—Ö —É –∂–∏—Ç–µ–ª–µ–π –ï–≤—Ä–æ–ø—ã. –ò–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ø–µ–Ω—Å–∏—é –≤–æ –º–Ω–æ–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ì–µ—Ä–º–∞–Ω–∏–∏, –ù–æ—Ä–≤–µ–≥–∏–∏ –∏ –ò—Å–ª–∞–Ω–¥–∏–∏).",
      "3. –ò–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –Ω–æ—Å–∏—Ç –∑–Ω–∞–º–µ–Ω–∏—Ç–∞—è –∫–æ–º–µ—Ç–∞ –ß—É—Ä—é–º–æ–≤–∞ ‚Äî –ì–µ—Ä–∞—Å–∏–º–µ–Ω–∫–æ, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ –≤–ø–µ—Ä–≤—ã–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–∞–¥–∏–ª–æ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –∞–ø–ø–∞—Ä–∞—Ç (–∑–æ–Ω–¥ ¬´–§–∏–ª–∞¬ª). –í –Ω–æ–≤–æ—Å—Ç—è—Ö –µ—ë —á–∞—Å—Ç–æ –Ω–∞–∑—ã–≤–∞–ª–∏ ¬´–∫–æ–º–µ—Ç–∞-—É—Ç–æ—á–∫–∞¬ª –∏–∑-–∑–∞ –Ω–µ–æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º—ã."
    ],
    answer: "67",
    fact: "1967 –≥–æ–¥ —Å—Ç–∞–ª –ø–∏–∫–æ–º –∫—É–ª—å—Ç—É—Ä—ã —Ö–∏–ø–ø–∏. –õ–µ—Ç–æ–º —Ç–æ–≥–æ –≥–æ–¥–∞ –æ–∫–æ–ª–æ 100 000 —á–µ–ª–æ–≤–µ–∫ —Å–æ–±—Ä–∞–ª–∏—Å—å –≤ –°–∞–Ω-–§—Ä–∞–Ω—Ü–∏—Å–∫–æ, —á—Ç–æ–±—ã –ø—Ä–∞–∑–¥–Ω–æ–≤–∞—Ç—å –ª—é–±–æ–≤—å –∏ —Å–≤–æ–±–æ–¥—É. –ò–º–µ–Ω–Ω–æ —Ç–æ–≥–¥–∞ –ø–µ—Å–Ω—è 'All You Need Is Love' —Å—Ç–∞–ª–∞ –º–∏—Ä–æ–≤—ã–º –≥–∏–º–Ω–æ–º. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ –≤ —Ç–æ–º –∂–µ –≥–æ–¥—É –≤ –°–®–ê –≤–ø–µ—Ä–≤—ã–µ –≤–≤–µ–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É —Å–∏–≥–∞—Ä–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ –≤—Ä–µ–¥–µ –∑–¥–æ—Ä–æ–≤—å—è. –ú–∏—Ä –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —É—á–∏–ª—Å—è —Å–ø–∞—Å–∞—Ç—å —Å–µ—Ä–¥—Ü–∞ –∏ –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ –ª–µ–≥–∫–∏—Ö!"
  },
{
    question: "–ö–∞–∫–æ–µ —á–∏—Å–ª–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç ¬´–∑–æ–ª–æ—Ç–æ–π –≥–æ–¥¬ª –º–∏—Ä–æ–≤–æ–≥–æ –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∞, –∑–∞–ø—É—Å–∫ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –ø—Ä–∏—Å—Ç–∞–≤–∫–∏ PlayStation –∏ —Å–∞–º—ã–π –æ–ø–∞—Å–Ω—ã–π —Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —è–¥–µ—Ä–Ω–æ–π —Ñ–∏–∑–∏–∫–µ?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º –≥–æ–¥—É (19...) –≤—ã—à–ª–∏ —Ñ–∏–ª—å–º—ã, —Å—Ç–∞–≤—à–∏–µ –∞–±—Å–æ–ª—é—Ç–Ω–æ–π –∫–ª–∞—Å—Å–∏–∫–æ–π: ¬´–ö–æ—Ä–æ–ª—å –õ–µ–≤¬ª, ¬´–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω–æ–µ —á—Ç–∏–≤–æ¬ª, ¬´–§–æ—Ä—Ä–µ—Å—Ç –ì–∞–º–ø¬ª –∏ ¬´–ü–æ–±–µ–≥ –∏–∑ –®–æ—É—à–µ–Ω–∫–∞¬ª. –ö–∏–Ω–æ–∫—Ä–∏—Ç–∏–∫–∏ –¥–æ —Å–∏—Ö –ø–æ—Ä —Å–ø–æ—Ä—è—Ç, –±—ã–ª –ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≥–æ–¥ –∫—Ä—É—á–µ —ç—Ç–æ–≥–æ.",
      "2. –≠—Ç–æ –∞—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä –ü–ª—É—Ç–æ–Ω–∏—è. –ò–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª ¬´—Å–µ—Ä–¥—Ü–µ–º¬ª –ø–µ—Ä–≤–æ–π –≤ –º–∏—Ä–µ –∏—Å–ø—ã—Ç–∞–Ω–Ω–æ–π —è–¥–µ—Ä–Ω–æ–π –±–æ–º–±—ã –∏ —Ç–æ–π, —á—Ç–æ –±—ã–ª–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –Ω–∞ –ù–∞–≥–∞—Å–∞–∫–∏.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ –Ω–∞ —à–µ—Å—Ç—å –º–µ–Ω—å—à–µ, —á–µ–º —Å—Ç–æ. –ò–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–º–Ω–æ–∂–µ–Ω–∏—è 47 –Ω–∞ 2."
    ],
    answer: "94",
    fact: "–í –¥–µ–∫–∞–±—Ä–µ 1994 –≥–æ–¥–∞ –≤ –Ø–ø–æ–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ—Ö–æ—Ä–æ–Ω–∏–ª–æ –¥–æ–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Nintendo –∏ Sega. –ù–∞ –ø—Ä–∏–ª–∞–≤–∫–∞—Ö –ø–æ—è–≤–∏–ª–∞—Å—å –ø–µ—Ä–≤–∞—è Sony PlayStation. –ú–∞–ª–æ –∫—Ç–æ –∑–Ω–∞–µ—Ç, —á—Ç–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ Sony –∏ Nintendo –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –≤—ã–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏—Å—Ç–∞–≤–∫—É –≤–º–µ—Å—Ç–µ, –Ω–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç Nintendo '–∫–∏–Ω—É–ª–∞' –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤. Sony —Ç–∞–∫ —Ä–∞–∑–æ–∑–ª–∏–ª–∞—Å—å, —á—Ç–æ —Ä–µ—à–∏–ª–∞ –≤—ã–ø—É—Å—Ç–∏—Ç—å —Å–≤–æ—é –∫–æ–Ω—Å–æ–ª—å –≤ –æ–¥–∏–Ω–æ—á–∫—É ‚Äî –∏ –≤ –∏—Ç–æ–≥–µ –∏–∑–º–µ–Ω–∏–ª–∞ –º–∏—Ä –≥–µ–π–º–∏–Ω–≥–∞ –Ω–∞–≤—Å–µ–≥–¥–∞, —Å–¥–µ–ª–∞–≤ 94-–π –≥–æ–¥ —Ç–æ—á–∫–æ–π –æ—Ç—Å—á–µ—Ç–∞ —ç–ø–æ—Ö–∏ 3D!"
  },
{
    question: "–≠—Ç–æ —á–∏—Å–ª–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—à—É –ø–ª–∞–Ω–µ—Ç—É –ª—É—á—à–µ –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ. –û–Ω–æ –∂–µ —Å—Ç–∞–ª–æ —Å–∏–º–≤–æ–ª–æ–º –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–≥–æ –¥–æ–ª–≥–æ–ª–µ—Ç–∏—è –Ω–∞ —Ç—Ä–æ–Ω–µ –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏. –û –∫–∞–∫–æ–º —á–∏—Å–ª–µ —Ä–µ—á—å?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —É–¥–∞—Ä–æ–≤ –≤ –º–∏–Ω—É—Ç—É —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å –∑–¥–æ—Ä–æ–≤–æ–≥–æ –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫–æ—è.",
      "2. –ü–µ—Ä–≤—ã–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ —Å–∞–º–æ–ª–µ—Ç–∞. –ò–º–µ–Ω–Ω–æ —ç—Ç–∞ –º–∞—à–∏–Ω–∞ –≤ 50-—Ö –≥–æ–¥–∞—Ö —Å–¥–µ–ª–∞–ª–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–ª–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π –∏ –∏–∑–º–µ–Ω–∏–ª–∞ –º–∏—Ä –Ω–∞–≤—Å–µ–≥–¥–∞.",
      "3. –í –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ¬´–ü—Ä–∞–≤–∏–ª–æ ...¬ª. –ï—Å–ª–∏ –≤—ã —Ä–∞–∑–¥–µ–ª–∏—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ –Ω–∞ –≥–æ–¥–æ–≤—É—é –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É, —Ç–æ –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–µ –≤–∞—à –∫–∞–ø–∏—Ç–∞–ª —É–¥–≤–æ–∏—Ç—Å—è."
    ],
    answer: "70",
    fact: "–ú—ã –ø—Ä–∏–≤—ã–∫–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç—å, —á—Ç–æ –≤–æ–¥—ã –Ω–∞ –ó–µ–º–ª–µ ‚Äî 70%, –∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –µ—ë –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –º–Ω–æ–≥–æ. –ù–æ –≤–æ—Ç –≤ —á—ë–º –ø–æ–¥–≤–æ—Ö: –µ—Å–ª–∏ —Å–æ–±—Ä–∞—Ç—å –≤—Å—é-–≤—Å—é –≤–æ–¥—É –ø–ª–∞–Ω–µ—Ç—ã (–≤–∫–ª—é—á–∞—è –æ–∫–µ–∞–Ω—ã –∏ –ª–µ–¥–Ω–∏–∫–∏) –≤ –æ–¥–∏–Ω —à–∞—Ä, –µ–≥–æ –¥–∏–∞–º–µ—Ç—Ä —Å–æ—Å—Ç–∞–≤–∏—Ç –≤—Å–µ–≥–æ –æ–∫–æ–ª–æ 1385 –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤. –≠—Ç–æ –º–µ–Ω—å—à–µ, —á–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –í–∞—Ä—à–∞–≤—ã –¥–æ –ù–µ–∞–ø–æ–ª—è! –ò–∑ —ç—Ç–∏—Ö 70% –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –ª–∏—à—å –∫—Ä–æ—à–µ—á–Ω–∞—è –¥–æ–ª—è (–º–µ–Ω–µ–µ 1%) ‚Äî —ç—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–∞—è –Ω–∞–º –ø—Ä–µ—Å–Ω–∞—è –≤–æ–¥–∞. –¢–∞–∫ —á—Ç–æ –º—ã –∂–∏–≤—ë–º –Ω–∞ –æ—á–µ–Ω—å '–º–æ–∫—Ä–æ–π' –ø–ª–∞–Ω–µ—Ç–µ, –≥–¥–µ –ø–æ—á—Ç–∏ –Ω–µ—á–µ–≥–æ –ø–∏—Ç—å!"
  },
{
    question: "–≠—Ç–æ —á–∏—Å–ª–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ¬´–±—É–∫–≤¬ª –≤ –∫–æ–¥–µ –∂–∏–∑–Ω–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–∏–ª, —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö –í—Å–µ–ª–µ–Ω–Ω–æ–π.",
    hints: [
      "1. –í–µ—Å—å –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥ –ª—é–±–æ–≥–æ –∂–∏–≤–æ–≥–æ —Å—É—â–µ—Å—Ç–≤–∞ –Ω–∞ –ó–µ–º–ª–µ ‚Äî –æ—Ç –±–∞–∫—Ç–µ—Ä–∏–∏ –¥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –Ω–∞–ø–∏—Å–∞–Ω ¬´–∞–ª—Ñ–∞–≤–∏—Ç–æ–º¬ª, —Å–æ—Å—Ç–æ—è—â–∏–º —Ä–æ–≤–Ω–æ –∏–∑ —Å—Ç–æ–ª—å–∫–∏ –∞–∑–æ—Ç–∏—Å—Ç—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏–π.",
      "2. –í –Ω–∞—É–∫–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è, —á—Ç–æ –≤–æ –í—Å–µ–ª–µ–Ω–Ω–æ–π —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π (—Å–∏–ª): –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è, —ç–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–µ—Ç–∏–∑–º, —Å–∏–ª—å–Ω–æ–µ –∏ —Å–ª–∞–±–æ–µ —è–¥–µ—Ä–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.",
      "3. –ï—Å–ª–∏ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Ä–µ–º—è –∫–∞–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ, —Ç–æ –º—ã —Å –≤–∞–º–∏ –∂–∏–≤–µ–º –≤ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –º–∏—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π."
    ],
    answer: "4",
    fact: "–ê –≤—ã –∑–Ω–∞–ª–∏, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–π –∏–≥—Ä—ã '–¢–µ—Ç—Ä–∏—Å' –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω–æ —Å —ç—Ç–∏–º —á–∏—Å–ª–æ–º? –ê–ª–µ–∫—Å–µ–π –ü–∞–∂–∏—Ç–Ω–æ–≤ –ø—Ä–∏–¥—É–º–∞–ª –µ–≥–æ –æ—Ç –≥—Ä–µ—á–µ—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ '—Ç–µ—Ç—Ä–∞', —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç '—á–µ—Ç—ã—Ä–µ'. –í–µ—Å—å —Å–µ–∫—Ä–µ—Ç –∏–≥—Ä—ã –≤ —Ç–æ–º, —á—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –∫–∞–∂–¥–∞—è —Ñ–∏–≥—É—Ä–∫–∞ –≤ –¢–µ—Ç—Ä–∏—Å–µ (–∫–∞–∫ –±—ã –æ–Ω–∞ –Ω–∏ –±—ã–ª–∞ –∏–∑–æ–≥–Ω—É—Ç–∞) —Å–æ—Å—Ç–æ–∏—Ç —Ä–æ–≤–Ω–æ –∏–∑ 4 –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–æ–≤."
  },
{
    question: "–≠—Ç–æ —á–∏—Å–ª–æ ‚Äî –≥–ª–∞–≤–Ω—ã–π —Å–∏–º–≤–æ–ª –º–∏–º–æ–ª–µ—Ç–Ω–æ–≥–æ —É—Å–ø–µ—Ö–∞ –∏ —Å–∞–º–∞—è –ø–æ–ø—É–ª—è—Ä–Ω–∞—è ¬´–¥–æ–ª—è¬ª –≤ –º–∏—Ä–æ–≤–æ–º –ª–µ—Ç–æ–∏—Å—á–∏—Å–ª–µ–Ω–∏–∏. –û –∫–∞–∫–æ–º —á–∏—Å–ª–µ –∏–¥–µ—Ç —Ä–µ—á—å?",
    hints: [
      "1. –í –±–æ–ª—å—à–æ–º —Ç–µ–Ω–Ω–∏—Å–µ —ç—Ç–æ ¬´–ø–µ—Ä–≤–∞—è —Å—Ç—É–ø–µ–Ω—å¬ª –≤ —Å—á–µ—Ç–µ. –ï—Å–ª–∏ –≤—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–µ—Ä–≤—ã–π –º—è—á –≤ –≥–µ–π–º–µ, —Å—É–¥—å—è –æ–±—ä—è–≤–∏—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —á–∏—Å–ª–æ (—Å—á–µ—Ç —Å—Ç–∞–Ω–µ—Ç ¬´... ‚Äî –Ω–æ–ª—å¬ª).",
      "2. –ó–Ω–∞–º–µ–Ω–∏—Ç—ã–π —Ö—É–¥–æ–∂–Ω–∏–∫ –≠–Ω–¥–∏ –£–æ—Ä—Ö–æ–ª –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª, —á—Ç–æ –≤ –±—É–¥—É—â–µ–º —É –∫–∞–∂–¥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –±—É–¥–µ—Ç –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ ¬´–º–∏–Ω—É—Ç —Å–ª–∞–≤—ã¬ª.",
      "3. –≠—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ –ø–∏—Ä–∞–º–∏–¥—É –≤ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã –≤ ¬´–ë–∏–ª—å—è—Ä–¥¬ª (–ü—É–ª –∏–ª–∏ –†—É—Å—Å–∫–∞—è –ø–∏—Ä–∞–º–∏–¥–∞)."
    ],
    answer: "15",
    fact: "–í 1968 –≥–æ–¥—É –≠–Ω–¥–∏ –£–æ—Ä—Ö–æ–ª —Å–∫–∞–∑–∞–ª: '–í –±—É–¥—É—â–µ–º –∫–∞–∂–¥—ã–π —Å–º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –≤—Å–µ–º–∏—Ä–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –Ω–∞ 15 –º–∏–Ω—É—Ç'. –¢–æ–≥–¥–∞ —ç—Ç–æ –∫–∞–∑–∞–ª–æ—Å—å –∞–±—Å—É—Ä–¥–æ–º, –Ω–æ —Å–µ–≥–æ–¥–Ω—è, –≤ —ç–ø–æ—Ö—É TikTok, Reels –∏ Shorts, —ç—Ç–æ —Å—Ç–∞–ª–æ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é. –í–∏—Ä—É—Å–Ω–æ–µ –≤–∏–¥–µ–æ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –æ–±—ã—á–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∑–≤–µ–∑–¥–æ–π –º–∏—Ä–æ–≤–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ —Ä–æ–≤–Ω–æ –Ω–∞ —ç—Ç–æ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫, –ø–æ–∫–∞ –ª–µ–Ω—Ç–∞ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è. –£–æ—Ä—Ö–æ–ª –Ω–µ –ø—Ä–æ—Å—Ç–æ —É–≥–∞–¥–∞–ª —á–∏—Å–ª–æ, –æ–Ω –æ–ø–∏—Å–∞–ª –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∑–∞ 40 –ª–µ—Ç –¥–æ –µ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è!"
  },
{
    question: "–≠—Ç–æ —á–∏—Å–ª–æ –¥–∏–∫—Ç—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤ –∫–∞–∑–∏–Ω–æ –õ–∞—Å-–í–µ–≥–∞—Å–∞, —Ä–∏—Ç–º –Ω–∞—à–µ–π –∂–∏–∑–Ω–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –≥–æ–¥–∞ –∏ –¥–∞–∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ. –û –∫–∞–∫–æ–º —á–∏—Å–ª–µ –∏–¥–µ—Ç —Ä–µ—á—å?",
    hints: [
      "1. –≠—Ç–æ —á–∏—Å–ª–æ —Å—Ç–æ–∏—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Å–∞–º–æ–≥–æ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–≥–æ –±–æ–º–±–∞—Ä–¥–∏—Ä–æ–≤—â–∏–∫–∞ ‚Äî B-... Stratofortress. –≠—Ç–æ—Ç —Å–∞–º–æ–ª–µ—Ç –Ω–∞—Å—Ç–æ–ª—å–∫–æ –Ω–∞–¥–µ–∂–µ–Ω, —á—Ç–æ –Ω–∞ –Ω–µ–º –ª–µ—Ç–∞–ª–∏ –¥–µ–¥—ã, –ª–µ—Ç–∞—é—Ç –æ—Ç—Ü—ã –∏ –±—É–¥—É—Ç –ª–µ—Ç–∞—Ç—å –≤–Ω—É–∫–∏.",
      "2. –ü–æ–¥ —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏–∑–≤–µ—Å—Ç–µ–Ω ¬´—Å–∞–º—ã–π –æ–¥–∏–Ω–æ–∫–∏–π –∫–∏—Ç –≤ –º–∏—Ä–µ¬ª. –û–Ω –ø–æ–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ—Ç–µ ... –ì—Ü, –∫–æ—Ç–æ—Ä–∞—è –≥–æ—Ä–∞–∑–¥–æ –≤—ã—à–µ, —á–µ–º —É –¥—Ä—É–≥–∏—Ö –∫–∏—Ç–æ–≤, –ø–æ—ç—Ç–æ–º—É —Å–æ—Ä–æ–¥–∏—á–∏ –µ–≥–æ –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–ª—ã—à–∞—Ç.",
      "3. –≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ–≥–æ ¬´–≥–æ—Ä—è—â–µ–≥–æ¬ª –∫–æ–∫—Ç–µ–π–ª—è –∏–∑ —Ç—Ä–µ—Ö —Å–ª–æ–µ–≤: –∫–æ—Ñ–µ–π–Ω–æ–≥–æ –ª–∏–∫–µ—Ä–∞, —Å–ª–∏–≤–æ—á–Ω–æ–≥–æ –ª–∏–∫–µ—Ä–∞ –∏ –∞–ø–µ–ª—å—Å–∏–Ω–æ–≤–æ–≥–æ –ª–∏–∫–µ—Ä–∞ (Cointreau). –ï–≥–æ –ø—Ä–∏–Ω—è—Ç–æ –ø–∏—Ç—å –∑–∞–ª–ø–æ–º —á–µ—Ä–µ–∑ —Ç—Ä—É–±–æ—á–∫—É."
    ],
    answer: "52",
    fact: "–ó–Ω–∞–µ—Ç–µ, –ø–æ—á–µ–º—É —á–∏—Å–ª–æ 52 ‚Äî —Å–∞–º–æ–µ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –≤ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ? –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–æ—Å–æ–±–æ–≤ –ø–µ—Ä–µ–º–µ—à–∞—Ç—å –∫–æ–ª–æ–¥—É –∏–∑ 52 –∫–∞—Ä—Ç ($52!$) –Ω–∞—Å—Ç–æ–ª—å–∫–æ –æ–≥—Ä–æ–º–Ω–æ, —á—Ç–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤—ã –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É —Ö–æ—Ä–æ—à–æ —Ç–∞—Å—É–µ—Ç–µ –∫–∞—Ä—Ç—ã, –≤—ã —Å–æ–∑–¥–∞–µ—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –í—Å–µ–ª–µ–Ω–Ω–æ–π."
  }
];

// --- 3. HELPERS ---
const encodeCat = (str: string) => Buffer.from(str).toString('base64').replace(/=/g, '');
const decodeCat = (str: string) => Buffer.from(str, 'base64').toString('utf-8');

const parseEventDesc = (desc: string | null) => {
  if (!desc) return { title: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', address: '–£—Ç–æ—á–Ω—è–µ—Ç—Å—è' };
  const parts = desc.split('###');
  return { title: parts[0].trim(), address: parts[1] ? parts[1].trim() : '–°–µ–∫—Ä–µ—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è –æ—Ç–∫—Ä–æ–µ–∫—Ç—Å—è –∑–∞ 3 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ üîí' };
};

async function notifyNextInWaitlist(eventId: number, eventType: string, dateString: string) {
    const nextInLine = await db.query.bookings.findFirst({
        where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, false)),
        orderBy: [asc(schema.bookings.id)]
    });

    if (nextInLine) {
        const candidate = await db.query.users.findFirst({ where: eq(schema.users.id, nextInLine.userId) });
        if (candidate) {
            await bot.telegram.sendMessage(candidate.telegramId, 
                `üî• –•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏!\n\n–ù–∞ –∏–≥—Ä—É "${eventType}" (${dateString}) –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å –º–µ—Å—Ç–æ! ü•Ç\n\n–°–∫–æ—Ä–µ–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ "–ò–≥—Ä—ã", —á—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –µ–≥–æ!`, 
                { parse_mode: 'HTML' }).catch(() => {});
        }
    }
}



// --- 4. STATE ---

const PENDING_PAYMENTS = new Map<string, { time: DateTime, notified: boolean }>();


const STOCK_STATE = {
  isActive: false,
  currentEventId: 0, // <--- –°—é–¥–∞ –±–æ—Ç –∑–∞–ø–æ–º–Ω–∏—Ç ID –∏–≥—Ä—ã –ø–æ—Å–ª–µ —Ç–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
  currentQuestionIndex: -1,
  currentPhase: 0,
  playerAnswers: new Map<number, number>(), // userId -> –æ—Ç–≤–µ—Ç
  participants: new Map<number, { id: number, num: number, name: string }>() // userId -> –∏–Ω—Ñ–æ
};

const TALK_STATE = { currentFact: '', currentUser: '', isActive: false };

// --- 5. –ë–û–¢ –ò –°–¶–ï–ù–´ ---
const bot = new Telegraf<any>(process.env.TELEGRAM_BOT_TOKEN || '');

// 1. –ú–∞—Å—Ç–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
const registerWizard = new Scenes.WizardScene(
  'REGISTER_SCENE',
  // --- –®–ê–ì 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∑–∞–ø—Ä–æ—Å –ò–º–µ–Ω–∏ ---
  async (ctx) => {
    await ctx.replyWithHTML(
      `üëã –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!\n\n` +
      `–ù—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ —Ç–µ–±—è –≤ –±–∞–∑—É –ê–ª–≥–æ—Ä–∏—Ç–º–∞, –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–π–¥–∏ –∞–Ω–∫–µ—Ç—É –∏–∑ 3-—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–≤—Å–µ–≥–æ 30 —Å–µ–∫—É–Ω–¥). ` +
      `–ü–æ—Å–ª–µ –∞–Ω–∫–µ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –≤ "–ò–≥—Ä—ã" –∏ –ø–æ–∫—É–ø–∞–π –±–∏–ª–µ—Ç –±–µ–∑ –ø–æ–º–µ—Ö!\n\n` +
      `1. –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? (–ø–∏—à–∏ –ø—Ä—è–º —Å—é–¥–∞ —Å–≤–æ—ë –∏–º—è)`
    );
    return ctx.wizard.next();
  },

  // --- –®–ê–ì 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ –∑–∞–ø—Ä–æ—Å –í–æ–∑—Ä–∞—Å—Ç–∞ ---
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    (ctx.wizard.state as any).name = ctx.message.text;
    await ctx.reply('2. –°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ø–æ–ª–Ω—ã—Ö –ª–µ—Ç? (–í–≤–µ–¥–∏ —á–∏—Å–ª–æ)');
    return ctx.wizard.next();
  },

  // --- –®–ê–ì 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –∑–∞–ø—Ä–æ—Å –ü–æ–ª–∞ ---
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const age = parseInt(ctx.message.text);
    if (isNaN(age)) {
      return ctx.reply('‚ùå –û—à–∏–±–∫–∞! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤–æ–∑—Ä–∞—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25):');
    }
    (ctx.wizard.state as any).age = age.toString();
    await ctx.reply(
      '3. –¢–≤–æ–π –ø–æ–ª (–¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –ø–∞—Ä –Ω–∞ –∏–≥—Ä–∞—Ö):',
      Markup.keyboard([['–ú—É–∂—á–∏–Ω–∞', '–ñ–µ–Ω—â–∏–Ω–∞']]).oneTime().resize()
    );
    return ctx.wizard.next();
  },

  // --- –®–ê–ì 4: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∞, –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –∏ –†–µ–¥–∏—Ä–µ–∫—Ç ---
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const input = ctx.message.text.toLowerCase();

    // –ú–ê–ì–ò–Ø –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò: –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –ª—é–±–æ–π –≤–≤–æ–¥ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç
    let normalizedGender = '';
    if (input.includes('–º—É–∂')) normalizedGender = '–ú—É–∂—á–∏–Ω–∞';
    else if (input.includes('–∂–µ–Ω')) normalizedGender = '–ñ–µ–Ω—â–∏–Ω–∞';

    // –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –ø–æ–Ω—è–ª, —á—Ç–æ –≤–≤–µ–ª–∏
    if (!normalizedGender) {
      return ctx.reply(
        '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –ø–æ–ª –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ üëá',
        Markup.keyboard([['–ú—É–∂—á–∏–Ω–∞', '–ñ–µ–Ω—â–∏–Ω–∞']]).oneTime().resize()
      );
    }

    const data = ctx.wizard.state as any;

    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
    await db.update(schema.users).set({
      name: data.name,
      birthDate: data.age,
      gender: normalizedGender // –ó–¥–µ—Å—å –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –ª–∏–±–æ "–ú—É–∂—á–∏–Ω–∞", –ª–∏–±–æ "–ñ–µ–Ω—â–∏–Ω–∞"
    }).where(eq(schema.users.telegramId, ctx.from!.id));

    await ctx.reply(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú—ã –∑–∞–ø–∏—Å–∞–ª–∏: ${normalizedGender}`);

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —é–∑–µ—Ä–∞ –∫ –æ–ø–ª–∞—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–≥—Ä—ã
    const eventId = data.returnToEvent;

    if (eventId) {
      await ctx.reply('üöÄ –í–æ–∑–≤—Ä–∞—â–∞—é —Ç–µ–±—è –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –∏–≥—Ä—ã...');
      const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
      if (event) {//gemini –Ω–∞–ø–∏—à–∏ –º–Ω–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —á—Ç–æ —Ç—ã –ª—é–±–∏—à—å –∏ —è–±–ª–æ–∫–∏ 
        await ctx.reply(
          `–í—ã –≤—ã–±—Ä–∞–ª–∏: ${event.type} (${event.dateString})\n–ö –æ–ø–ª–∞—Ç–µ: 50 PLN`,
          Markup.inlineKeyboard([[Markup.button.callback('üí∏ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', `pay_event_${eventId}`)]])
        );
        return ctx.scene.leave();
      }
    }

    // 3. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω—è–ª –∞–Ω–∫–µ—Ç—É –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ ‚Äî –æ–±—ã—á–Ω—ã–π –≤—ã—Ö–æ–¥ –≤ –º–µ–Ω—é
    await ctx.reply('–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –ª—é–±—ã–µ –∏–≥—Ä—ã –∫–ª—É–±–∞!', getMainKeyboard());
    return ctx.scene.leave();
  }
);

const editFactWizard = new Scenes.WizardScene(
  'EDIT_FACT_SCENE',
  async (ctx) => {
    await ctx.replyWithHTML(
      `ü§´ –¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã\n\n` +
      `–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –Ω–µ–æ–±—ã—á–Ω—ã–π –∏–ª–∏ –∑–∞–±–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç –æ —Å–µ–±–µ. \n\n` +
      `–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´—è –±–æ—é—Å—å –±–∞–±–æ—á–µ–∫¬ª, ¬´–æ–¥–Ω–∞–∂–¥—ã —è –≤—ã–∏–≥—Ä–∞–ª –≤ –ª–æ—Ç–µ—Ä–µ—é¬ª –∏–ª–∏ ¬´—è —É–º–µ—é –∏–≥—Ä–∞—Ç—å –Ω–∞ –ª–æ–∂–∫–∞—Ö¬ª. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ —É–≥–∞–¥—ã–≤–∞–ª–∏, —á–µ–π —ç—Ç–æ —Ñ–∞–∫—Ç! üëá`
    );
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const fact = ctx.message.text;

    await db.update(schema.users)
      .set({ fact: fact })
      .where(eq(schema.users.telegramId, ctx.from!.id));

    await ctx.reply('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –¢–µ–ø–µ—Ä—å —Ç—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≤ –ø—É–ª–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞—à–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã. ‚ú®', getMainKeyboard());
    return ctx.scene.leave();
  }
);


  
const addEventWizard = new Scenes.WizardScene(
  'ADD_EVENT_SCENE',
  async (ctx) => {
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –∏–≥—Ä—ã (talk_toast, stock_know, speed_dating):');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    (ctx.wizard.state as any).type = ctx.message.text;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 15.01.2026 19:00):');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const dateStr = ctx.message.text;
    const checkDate = DateTime.fromFormat(dateStr, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
    if (!checkDate.isValid) return ctx.reply("‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞! –í–≤–µ–¥–∏: 15.01.2026 19:00");
    (ctx.wizard.state as any).date = dateStr;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ù–∞–∑–≤–∞–Ω–∏–µ ### –ê–¥—Ä–µ—Å');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    (ctx.wizard.state as any).desc = ctx.message.text;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –º–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const state = ctx.wizard.state as any;
    const max = parseInt(ctx.message.text);
    if (isNaN(max)) return ctx.reply('–û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.');
    await db.insert(schema.events).values({
      type: state.type,
      dateString: state.date,
      description: state.desc,
      maxPlayers: max,
      isActive: true
    });
    await ctx.reply('‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
    return ctx.scene.leave();
  }
);


const msgEventWizard = new Scenes.WizardScene(
  'MSG_EVENT_SCENE',
  async (ctx) => {
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    if (events.length === 0) {
      await ctx.reply('–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä –ø–æ–∫–∞ –Ω–µ—Ç.');
      return ctx.scene.leave();
    }
    const btns = events.map(e => [Markup.button.callback(`${e.dateString} | ${e.type}`, `select_msg_ev_${e.id}`)]);
    await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:', Markup.inlineKeyboard(btns));
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (ctx.callbackQuery && 'data' in ctx.callbackQuery) {
      const data = ctx.callbackQuery.data;
      if (data.startsWith('select_msg_ev_')) {
        const eid = parseInt(data.replace('select_msg_ev_', ''));
        (ctx.wizard.state as any).selectedEventId = eid;
        await ctx.answerCbQuery();
        await ctx.editMessageText('‚úÖ –ò–≥—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞. –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –¢–ï–ö–°–¢ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:');
        return ctx.wizard.next();
      }
    }
    return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –∫–Ω–æ–ø–∫–æ–π.');
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return ctx.reply('–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
    const eventId = (ctx.wizard.state as any).selectedEventId;
    await broadcastToEvent(eventId, `üì¢ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤:</b>\n\n${(ctx.message as any).text}`);
    await ctx.reply('‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
    return ctx.scene.leave();
  }
);

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
const stage = new Scenes.Stage<any>([registerWizard, addEventWizard, msgEventWizard, editFactWizard]);
bot.use(session()); 
bot.use(stage.middleware());

// –ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
// –í –Ω–∞—á–∞–ª–µ index.ts (–§—É–Ω–∫—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
function getMainKeyboard(showTopicButton = false) {
    const buttons = [
        ['üéÆ –ò–≥—Ä—ã', 'üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç'],
        ['üÜò –ü–æ–º–æ—â—å', 'üìú –ü—Ä–∞–≤–∏–ª–∞']
    ];
    if (showTopicButton) {
        buttons.unshift(['üé≤ –ù–æ–≤–∞—è —Ç–µ–º–∞']);
    }
    // persistent(true) ‚Äî –ú–ê–ì–ò–Ø: –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç!
    return Markup.keyboard(buttons).resize().persistent(true);
}

// --- 6. –ê–í–¢–û–ü–ò–õ–û–¢ (–ß–ò–°–¢–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –î–£–ë–õ–ï–ô) ---
setInterval(async () => {
  try {
    const now = DateTime.now().setZone('Europe/Warsaw'); 
    const activeEvents = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    
    for (const event of activeEvents) {
      const start = DateTime.fromFormat(event.dateString, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
      if (!start.isValid) continue;

      const diffHours = start.diff(now, 'hours').hours;
      const minutesSinceStart = now.diff(start, 'minutes').minutes;

      // 1. –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø (3 –î–ù–Ø –ò –£–¢–†–û)
      if (diffHours >= 71.5 && diffHours <= 72.5 && !PROCESSED_AUTO_ACTIONS.has(`remind_3d_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`remind_3d_${event.id}`);
        await broadcastToEvent(event.id, `üìÖ <b>–î–æ –≤—Å—Ç—Ä–µ—á–∏ –æ—Å—Ç–∞–ª–æ—Å—å 3 –¥–Ω—è!</b>\n\n–ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –∏–≥—Ä–µ "${event.type}". –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –±—É–¥–µ—Ç üî•. ‚ú®`);
      }
      if (now.hasSame(start, 'day') && now.hour === 10 && !PROCESSED_AUTO_ACTIONS.has(`morning_rem_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`morning_rem_${event.id}`);
        await broadcastToEvent(event.id, `‚òÄÔ∏è <b>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –¢–æ—Ç —Å–∞–º—ã–π –¥–µ–Ω—å!</b>\n\n–ñ–¥–µ–º —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è –Ω–∞ "${event.type}"! ‚ú®`);
      }

      // 2. –†–ê–°–ö–†–´–¢–ò–ï –ê–î–†–ï–°–ê (–ó–ê 3 –ß–ê–°–ê)
      if (diffHours >= 2.5 && diffHours <= 3.5 && !PROCESSED_AUTO_ACTIONS.has(`reveal_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`reveal_${event.id}`);
        const { address } = parseEventDesc(event.description);
        
        const rules = `üìç <b>–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏: ${address}</b>\n\n` +
          `1Ô∏è‚É£ <b>–ü—Ä–∏—Ö–æ–¥–∏ –∑–∞ 10‚Äì15 –º–∏–Ω—É—Ç:</b> –£—Å–ø–µ–µ—à—å —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑ –∏ —Å–Ω—è—Ç—å –∫—É—Ä—Ç–∫—É.\n` +
          `2Ô∏è‚É£ <b>–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å—Ç–æ–ª:</b> –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û —Å—Ç–æ–ª–∏–∫ –Ω–∞ –∏–º—è <b>"–ê–õ–ì–û–†–ò–¢–ú"</b>, –Ω–∏—á–µ–≥–æ –±–æ–ª–µ–µ.\n` +
          `3Ô∏è‚É£ <b>–ï—Å–ª–∏ —Ç—ã –ø–µ—Ä–≤—ã–π:</b> –ù–µ –±–µ—Å–ø–æ–∫–æ–π—Å—è, —Å–∞–¥–∏—Å—å, –∫–æ–º–ø–∞–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç, —Å—Ç–æ–∏—Ç –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å. ‚ú®\n` +
          `4Ô∏è‚É£ <b>–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏:</b> –û–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –º–µ—Å—Ç–µ. üç≤\n` +
          `5Ô∏è‚É£ <b>–ó–∞—Ä—è–¥–∫–∞:</b> –ó–∞—Ä—è–¥–∏ —Ç–µ–ª–µ—Ñ–æ–Ω! –ë–æ—Ç ‚Äî —Ç–≤–æ–π –≤–µ–¥—É—â–∏–π –∏ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞—à –≤–µ—á–µ—Ä. üîã`;

        let gameSpec = "";
        if (event.type === 'talk_toast') gameSpec = `ü•Ç <b>Talk & Toast:</b> –¢–µ–±—è –∂–¥—É—Ç –≥–ª—É–±–æ–∫–∏–µ —Ç–µ–º—ã –∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞!`;
        else if (event.type === 'stock_know') gameSpec = `üß† <b>Stock & Know:</b> –ë–∏—Ç–≤–∞ –∑–∞ –±–∞–Ω–∫! –¢–≤–æ–π –Ω–æ–º–µ—Ä –ø—Ä–∏–¥–µ—Ç —Å–ª–µ–¥–æ–º.`;
        else if (event.type === 'speed_dating') gameSpec = `üíò <b>–°–≤–∏–¥–∞–Ω–∏—è:</b> 7-10 –º–∏–Ω –Ω–∞ –ø–∞—Ä—É. –û—Ç–º–µ—á–∞–π —Å–∏–º–ø–∞—Ç–∏–∏ —Å—Ä–∞–∑—É!`;

        await broadcastToEvent(event.id, `${rules}\n\n${gameSpec}\n\n–ñ–¥–µ–º —Ç–µ–±—è! ü•Ç`);

        // –†–∞–∑–¥–∞—á–∞ –Ω–æ–º–µ—Ä–æ–≤
       // --- –£–ú–ù–ê–Ø –†–ê–ó–î–ê–ß–ê –ù–û–ú–ï–†–û–í –ü–†–ò –†–ê–°–ö–†–´–¢–ò–ò (–ó–ê 3 –ß–ê–°–ê) ---
        const bks = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) 
        });

        if (event.type === 'speed_dating') {
            const men: any[] = [], women: any[] = [];
            
            // 1. –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ø–æ –ø–æ–ª—É
            for (const b of bks) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
                if (u?.gender === '–ú—É–∂—á–∏–Ω–∞') men.push(u);
                else if (u?.gender === '–ñ–µ–Ω—â–∏–Ω–∞') women.push(u);
            }

            // 2. –†–∞–∑–¥–∞–µ–º –ø–∞—Ä—ã (–ø–æ –º–µ–Ω—å—à–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ —Å–∏–¥–µ–ª –æ–¥–∏–Ω)
            const limit = Math.min(men.length, women.length);
            for (let i = 0; i < limit; i++) {
                const wNum = (i * 2) + 1; // 1, 3, 5...
                const mNum = (i * 2) + 2; // 2, 4, 6...

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ø–∞–º—è—Ç—å —Å–≤–∏–¥–∞–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º telegramId –∫–∞–∫ –∫–ª—é—á)
                SD.FAST_DATES_STATE.participants.set(women[i].telegramId, { id: women[i].telegramId, num: wNum, gender: '–ñ–µ–Ω—â–∏–Ω–∞', name: women[i].name });
                SD.FAST_DATES_STATE.participants.set(men[i].telegramId, { id: men[i].telegramId, num: mNum, gender: '–ú—É–∂—á–∏–Ω–∞', name: men[i].name });

                // –®–ª–µ–º –∫–∞–∂–¥–æ–º—É –µ–≥–æ –ª–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä
                bot.telegram.sendMessage(women[i].telegramId, `üíò <b>–¢–≤–æ–π –Ω–æ–º–µ—Ä –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${wNum}</b> (–°—Ç–æ–ª–∏–∫ ‚Ññ${i + 1})\n\n–ñ–¥–µ–º —Ç–µ–±—è!`).catch(()=>{});
                bot.telegram.sendMessage(men[i].telegramId, `üíò <b>–¢–≤–æ–π –Ω–æ–º–µ—Ä –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${mNum}</b> (–°—Ç–æ–ª–∏–∫ ‚Ññ${i + 1})\n\n–ñ–¥–µ–º —Ç–µ–±—è!`).catch(()=>{});
            }

            // 3. –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –ø–∞—Ä—ã
            if (men.length !== women.length) {
                const extra = Math.abs(men.length - women.length);
                bot.telegram.sendMessage(ADMIN_ID, `‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> –ù–∞ –∏–≥—Ä–µ "${event.type}" –¥–∏—Å–±–∞–ª–∞–Ω—Å: ${extra} —á–µ–ª. –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –ø–∞—Ä—ã –∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏.`);
            }

        } else if (event.type === 'stock_know') {
            // –î–ª—è Stock & Know –ø–æ–ª –Ω–µ –≤–∞–∂–µ–Ω, –ø—Ä–æ—Å—Ç–æ –¥–∞–µ–º –Ω–æ–º–µ—Ä–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É
            for (let i = 0; i < bks.length; i++) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, bks[i].userId) });
                if (u) {
                    const pNum = i + 1;
                    STOCK_STATE.participants.set(u.telegramId, { id: u.id, num: pNum, name: u.name || '–ò–≥—Ä–æ–∫' });
                    bot.telegram.sendMessage(u.telegramId, `üß† –¢–≤–æ–π –Ω–æ–º–µ—Ä –≤ Stock & Know: ${pNum}\n\n–ó–∞–ø–æ–º–Ω–∏ –µ–≥–æ –¥–ª—è —Å—Ç–∞–≤–æ–∫! üé∞`).catch(()=>{});
                }
            }
        }
      }

      // 3. –°–¢–ê–†–¢ –ò–ì–†–´ (–ü–†–ò–í–ï–¢–°–¢–í–ò–ï + –ö–ù–û–ü–ö–ê)
      // 3. –°–¢–ê–†–¢ –ò–ì–†–´ (–ü–†–ò–í–ï–¢–°–¢–í–ò–ï + –ö–ù–û–ü–ö–ê)
      if (minutesSinceStart >= 0 && minutesSinceStart <= 10 && !PROCESSED_AUTO_ACTIONS.has(`start_greet_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`start_greet_${event.id}`);
        const { title } = parseEventDesc(event.description);
        
        if (event.type === 'speed_dating') return; 

        let needsTopic = (event.type.includes('talk_toast'));
        let msg = `ü•Ç <b>–ò–≥—Ä–∞ "${title}" –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!</b>\n\n–†–∞–¥—ã –≤—Å–µ—Ö –≤–∏–¥–µ—Ç—å! –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥—Ä—É–≥ –¥—Ä—É–≥—É (–∏–º—è –∏ –≤–∞—à–µ —Ö–æ–±–±–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å).`;
        
        if (needsTopic) {
            msg += `\n\n‚è± –ß–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É —è –ø—Ä–∏—à–ª—é –ø–µ—Ä–≤—É—é —Ç–µ–º—É –∏ –≤—ã–±–µ—Ä—É —Ç–æ–≥–æ, –∫—Ç–æ –Ω–∞—á–Ω–µ—Ç. –ö–Ω–æ–ø–∫–∞ <b>"üé≤ –ù–æ–≤–∞—è —Ç–µ–º–∞"</b> —É–∂–µ –≤ –≤–∞—à–µ–º –º–µ–Ω—é! ‚ú®`;
        }

        const bks = await db.query.bookings.findMany({ where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) });
        for (const b of bks) {
          const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
          if (u) await bot.telegram.sendMessage(u.telegramId, msg, { parse_mode: 'HTML', ...getMainKeyboard(needsTopic) }).catch(()=>{});
        }

        // --- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–ï–†–í–ê–Ø –¢–ï–ú–ê (–ß–ï–†–ï–ó 60 –°–ï–ö–£–ù–î) ---
        if (needsTopic) {
          setTimeout(async () => {
            // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
            const currentBks = await db.query.bookings.findMany({ 
                where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) 
            });
            
            const playersNames: string[] = [];
            for (const b of currentBks) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
                if (u?.name) playersNames.push(u.name);
            }

            // 2. –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–Ω–µ—Ç
            const starter = playersNames.length > 0 
                ? playersNames[Math.floor(Math.random() * playersNames.length)] 
                : "—Ç–æ–≥–æ, –∫—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è —Å–∞–º—ã–º —Å–º–µ–ª—ã–º";

            const randomTopic = CONVERSATION_TOPICS[Math.floor(Math.random() * CONVERSATION_TOPICS.length)];
            
            const topicMsg = `üé≤ <b>–¢–µ–º–∞ ‚Ññ1 –¥–ª—è —Ä–∞–∑–æ–≥—Ä–µ–≤–∞:</b>\n\n${randomTopic}\n\nüéô <b>–ù–∞—á–∏–Ω–∞–µ—Ç —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ:</b> <u>${starter}</u>`;
            
            await broadcastToEvent(event.id, topicMsg);
          }, 60000); // –†–æ–≤–Ω–æ 1 –º–∏–Ω—É—Ç–∞ (60 000 –º—Å)
        }
      }

      // 4. –í–ò–ö–¢–û–†–ò–ù–ê (105 –ú–ò–ù) –ò –ó–ê–í–ï–†–®–ï–ù–ò–ï (135 –ú–ò–ù)
      if (minutesSinceStart >= 105 && event.type.includes('talk_toast') && !PROCESSED_AUTO_ACTIONS.has(`quiz_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`quiz_${event.id}`); await runAutoQuiz(event.id);
      }
      if (minutesSinceStart >= 135 && !PROCESSED_AUTO_ACTIONS.has(`close_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`close_${event.id}`); await autoCloseEvent(event.id);
      }
    }

    // 5. –û–ü–õ–ê–¢–ê (Pending)
    for (const [uId, data] of PENDING_PAYMENTS.entries()) {
      if (now.diff(data.time, 'minutes').minutes >= 30 && !data.notified) {
        const u = await db.query.users.findFirst({ where: eq(schema.users.id, parseInt(uId)) });
        if (u) {
          bot.telegram.sendMessage(u.telegramId, 
            `üîî <b>–û–π! –ú—ã —á—Ç–æ-—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏?</b>\n\n` +
            `–¢–≤–æ—ë –º–µ—Å—Ç–æ –Ω–∞ –∏–≥—Ä—É <b>${getGameName(event.type)}</b> –≤—Å—ë –µ—â—ë –∂–¥—ë—Ç —Ç–µ–±—è, –Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. ü•Ç\n\n` +
            `–ú–µ—Å—Ç–∞ –≤ –ê–ª–≥–æ—Ä–∏—Ç–º–µ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ, –∞ –º—ã –æ—á–µ–Ω—å —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –∑–∞ —Å—Ç–æ–ª–æ–º! –ù–∞–∂–º–∏ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ. ‚ú®`,
            { parse_mode: 'HTML' }
        ).catch(() => {});
        }
        PENDING_PAYMENTS.set(uId, { ...data, notified: true });
      }
      if (now.diff(data.time, 'minutes').minutes > 120) PENDING_PAYMENTS.delete(uId);
    }
  } catch (e) { console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞:", e); }
}, 60000);

// --- –§–£–ù–ö–¶–ò–ò –ê–í–¢–û–ü–ò–õ–û–¢–ê ---

async function runAutoQuiz(eventId: number) {
  const bks = await db.query.bookings.findMany({ where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true)) });
  if (bks.length < 2) return;
  await broadcastToEvent(eventId, `üîî <b>–í–ù–ò–ú–ê–ù–ò–ï! –í–∏–∫—Ç–æ—Ä–∏–Ω–∞!</b> –£–≥–∞–¥–∞–π—Ç–µ, —á–µ–π —ç—Ç–æ —Ñ–∞–∫—Ç –∏–∑ –∞–Ω–∫–µ—Ç—ã!`);
  await new Promise(r => setTimeout(r, 7000));
  const shuf = bks.sort(() => 0.5 - Math.random()).slice(0, 3);
  for (const b of shuf) {
    const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
    if (!u || !u.fact) continue;
    await broadcastToEvent(eventId, `‚ùì <b>–ß–ï–ô –≠–¢–û –§–ê–ö–¢?</b>\n\n¬´${u.fact}¬ª`);
    await new Promise(r => setTimeout(r, 30000));
    await broadcastToEvent(eventId, `üîì <b>–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢:</b> –≠—Ç–æ ‚Äî <b>${u.name}</b>! ‚ú®`);
    await new Promise(r => setTimeout(r, 7000));
  }
}

async function autoCloseEvent(eventId: number) {
  await db.update(schema.events).set({ isActive: false }).where(eq(schema.events.id, eventId));
  const bks = await db.query.bookings.findMany({ where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true)) });
  for (const b of bks) {
    const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
    if (u) {
      await db.update(schema.users).set({ gamesPlayed: (u.gamesPlayed || 0) + 1 }).where(eq(schema.users.id, u.id));
      bot.telegram.sendMessage(u.telegramId, 
        `‚ú® <b>–≠—Ç–æ –±—ã–ª –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤–µ—á–µ—Ä!</b>\n\n` +
        `–ù–∞–¥–µ–µ–º—Å—è, —Ç–µ–±–µ –±—ã–ª–æ —Ç–∞–∫ –∂–µ —Ç–µ–ø–ª–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ –∏ –Ω–∞–º. –í —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –±–∞–ª–ª –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –Ω–∞–ø–æ–º–Ω—é, —á—Ç–æ –∫–∞–∂–¥–∞—è 5-—è –≤—Å—Ç—Ä–µ—á–∞ —É –Ω–∞—Å –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è ü•Ç\n\n` +
        `–ë—É–¥–µ–º –æ—á–µ–Ω—å —Ä–∞–¥—ã —É–∑–Ω–∞—Ç—å —Ç–≤–æ–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–∞—Ä–æ–π —Å–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–∞–º –≤ <b>üÜò –ü–æ–º–æ—â—å</b>.\n\n` +
        `–ö—Å—Ç–∞—Ç–∏, –µ—Å–ª–∏ —É —Ç–µ–±—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π –≤–∏–¥–µ–æ-–æ—Ç–∑—ã–≤ (–∫—Ä—É–∂–æ—á–µ–∫ –∏–ª–∏ –æ—Ç–º–µ—Ç–∫–∞ –≤ —Å—Ç–æ—Ä–∏—Å), —Å –Ω–∞—Å –ø—Ä–∏—è—Ç–Ω—ã–π –±–æ–Ω—É—Å: <b>—Å–∫–∏–¥–∫–∞ -10 PLN</b> –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–≥—Ä—É üì∏\n\n` +
        `–î–æ –Ω–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏ –≤ –ê–ª–≥–æ—Ä–∏—Ç–º–µ!`, { parse_mode: 'HTML' }
);
    }
  }
}
// --- 7. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---

bot.start(async (ctx) => {
  let user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
  if (!user) {
    const startPayload = ctx.message.text.split(' ')[1]; 
    let referrerId = 0;
    if (startPayload?.startsWith('ref_')) referrerId = parseInt(startPayload.replace('ref_', ''));
    const [newUser] = await db.insert(schema.users).values({ telegramId: ctx.from.id, username: ctx.from.username, firstName: ctx.from.first_name, isAdmin: ctx.from.id === ADMIN_ID, invitedBy: referrerId || null }).returning();
    if (referrerId) { 
        await db.insert(schema.vouchers).values({ userId: newUser.id, status: 'approved_10' }); 
        await ctx.reply('üéÅ –¢–µ–±–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ 10 PLN –Ω–∞ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É –æ—Ç –¥—Ä—É–≥–∞!');
    }
  }
  return ctx.reply('üëã –ü—Ä–∏–≤–µ—Ç –≤ Allgorithm! –í—ã–±–∏—Ä–∞–π –∏–≥—Ä—É:', getMainKeyboard());
});

bot.hears('üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç', async (ctx) => {
  const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
  if (!user) return;

  const userVouchers = await db.query.vouchers.findMany({ 
    where: and(
        eq(schema.vouchers.userId, user.id), 
        or(eq(schema.vouchers.status, 'approved_10'), eq(schema.vouchers.status, 'approved_free'))
    ) 
  });

  const count10 = userVouchers.filter(v => v.status === 'approved_10').length;
  const countFree = userVouchers.filter(v => v.status === 'approved_free').length;

  // –í–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (–†–∞–∑–¥–µ–ª 7)
// –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å (–æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 5)
  const progress = (user.gamesPlayed || 0) % 5;
  const stars = 'üü©'.repeat(progress) + '‚¨ú'.repeat(5 - progress);

    let msg = `üë§ <b>–ò–º—è:</b> ${user.name || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'}\n` +
              `üé´ <b>–°–∫–∏–¥–∫–∏ (-10 PLN):</b> ${count10} —à—Ç.\n` +
              `üéÅ <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–≥—Ä—ã:</b> ${countFree} —à—Ç.\n\n` +
              `üèÜ <b>–ü—É—Ç—å –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∏–≥—Ä–µ:</b>\n` +
              `${stars} (${progress}/5)\n` +
              `<i>–°—ã–≥—Ä–∞–π –µ—â–µ ${5 - progress}, –∏ —Å–ª–µ–¥—É—é—â–∞—è –∑–∞ –Ω–∞—à —Å—á—ë—Ç!</i> ü•Ç\n\n` +
              `üìñ <b>–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è:</b> ${user.fact ? '‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–∞' : '‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞'}`;

  const buttons = [
    [Markup.button.callback(user.name ? '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É' : 'üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É', 'start_registration')],
    [Markup.button.callback(user.fact ? '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é' : 'üìù –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', 'start_edit_fact')],
    [Markup.button.callback('üì∏ –£ –º–µ–Ω—è –µ—Å—Ç—å –≤–∞—É—á–µ—Ä', 'upload_voucher')],
    [Markup.button.callback('üéÆ –ú–æ–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∏–≥—Ä—ã', 'my_games')],
    [Markup.button.callback('ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞', 'referral_info')]
  ];
  return ctx.replyWithHTML(msg, Markup.inlineKeyboard(buttons));
});

// –ò –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏:
bot.action('start_edit_fact', (ctx) => { ctx.deleteMessage(); ctx.scene.enter('EDIT_FACT_SCENE'); });

bot.action('referral_info', async (ctx) => {
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
    if (!user) return;
    const refLink = `https://t.me/${ctx.botInfo.username}?start=ref_${user.id}`;
    
    const msg = `ü§ù <b>–°–∫–∏–¥–∫–∞ –æ–±–æ–∏–º!</b>\n\n` +
                `‚Ä¢ –î—Ä—É–≥ –ø–æ–ª—É—á–∞–µ—Ç <b>-10 PLN</b> –Ω–∞ –ø–µ—Ä–≤—ã–π –±–∏–ª–µ—Ç.\n` +
                `‚Ä¢ –¢—ã –ø–æ–ª—É—á–∞–µ—à—å <b>-10 PLN</b> –ø–æ—Å–ª–µ –µ–≥–æ –ø–µ—Ä–≤–æ–π –∏–≥—Ä—ã!\n\n` +
                `–¢–≤–æ—è —Å—Å—ã–ª–∫–∞: <code>${refLink}</code>\n\n` +
                `<i>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥—É –ø—Ä—è–º–æ –≤ Telegram!</i> üëá`;

    const shareText = `–ü—Ä–∏–≤–µ—Ç! –ò–¥—É –Ω–∞ –∫—Ä—É—Ç—É—é –∏–≥—Ä—É –≤ –∫–ª—É–± "–ê–ª–≥–æ—Ä–∏—Ç–º", –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è! –ü–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –ø–æ–ª—É—á–∏—à—å -10 PLN –Ω–∞ –ø–µ—Ä–≤—ã–π –±–∏–ª–µ—Ç: ${refLink}`;

    await ctx.editMessageText(msg, { 
        parse_mode: 'HTML', 
        ...Markup.inlineKeyboard([
            [Markup.button.url('üöÄ –ü–µ—Ä–µ—Å–ª–∞—Ç—å –¥—Ä—É–≥—É', `https://t.me/share/url?url=${encodeURIComponent(shareText)}`)],
            [Markup.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', 'back_to_cabinet')]
        ]) 
    });
});

bot.action('back_to_cabinet', (ctx) => ctx.deleteMessage());

bot.hears('üéÆ –ò–≥—Ä—ã', (ctx) => {
  ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:', Markup.inlineKeyboard([
    [Markup.button.callback('Talk & Toast ü•Ç', 'game_talk')],
    [Markup.button.callback('Stock & Know üß†', 'game_stock')],
    [Markup.button.callback('–ë—ã—Å—Ç—Ä—ã–µ —Å–≤–∏–¥–∞–Ω–∏—è üíò', 'game_dating')]
  ]));
});

bot.hears('üé≤ –ù–æ–≤–∞—è —Ç–µ–º–∞', async (ctx) => {
  const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
  if (!user) return;

  const myBookings = await db.query.bookings.findMany({
    where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.paid, true))
  });

  let currentEvent = null;
  const nowWarsaw = DateTime.now().setZone('Europe/Warsaw');

  for (const b of myBookings) {
    const event = await db.query.events.findFirst({
      where: and(eq(schema.events.id, b.eventId), eq(schema.events.isActive, true))
    });
    if (event) {
      const start = DateTime.fromFormat(event.dateString, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
      const diffHours = nowWarsaw.diff(start, 'hours').hours;
      // –ö–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 4 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞
      if (diffHours >= 0 && diffHours <= 4) {
        currentEvent = event;
        break;
      }
    }
  }

  if (!currentEvent) return ctx.reply("‚ùå –ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã.");

  const randomTopic = CONVERSATION_TOPICS[Math.floor(Math.random() * CONVERSATION_TOPICS.length)];

  // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –°–í–ò–î–ê–ù–ò–ô ---
  if (currentEvent.type === 'speed_dating') {
    const round = SD.FAST_DATES_STATE.currentRound;
    const ps = Array.from(SD.FAST_DATES_STATE.participants.values());
    const me = ps.find(p => p.id === ctx.from.id);

    if (!me || ps.length === 0) return ctx.reply("‚ùå –û—à–∏–±–∫–∞: –£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–∞–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω –≤–≤–µ—Å—Ç–∏ /load_dating).");

    const women = ps.filter(p => p.gender.toLowerCase().includes('–∂–µ–Ω')).sort((a,b) => a.num - b.num);
    const men = ps.filter(p => p.gender.toLowerCase().includes('–º—É–∂')).sort((a,b) => a.num - b.num);
    
    let partner;
    if (me.gender === '–ñ–µ–Ω—â–∏–Ω–∞') {
      const i = women.findIndex(w => w.id === me.id);
      partner = men[(i + round - 1) % men.length];
    } else {
      const j = men.findIndex(m => m.id === me.id);
      const womanIndex = ((j - (round - 1)) % women.length + women.length) % women.length;
      partner = women[womanIndex];
    }

    if (partner) {
      const pairMsg = `üé≤ <b>–°–µ–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–æ–ª–∏–∫–∞:</b>\n\n${randomTopic}`;
      await bot.telegram.sendMessage(me.id, pairMsg, { parse_mode: 'HTML', ...getMainKeyboard(true) });
      await bot.telegram.sendMessage(partner.id, pairMsg, { parse_mode: 'HTML', ...getMainKeyboard(true) });
      return ctx.reply("‚úÖ –¢–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–µ–±–µ –∏ —Ç–≤–æ–µ–º—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É!");
    }
  } 
  // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –û–ë–´–ß–ù–´–• –ò–ì–† ---
  else {
    const starter = user.name || "–∫—Ç–æ-—Ç–æ –∏–∑ –≤–∞—Å";
    await broadcastToEvent(currentEvent.id, `üé≤ <b>–ù–æ–≤–∞—è —Ç–µ–º–∞ –¥–ª—è —Å—Ç–æ–ª–∞:</b>\n\n${randomTopic}\n\nüéô <b>–ù–∞—á–∏–Ω–∞–µ—Ç:</b> <u>${starter}</u>`);
    return ctx.reply("‚úÖ –¢–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º!", getMainKeyboard(true));
  }
});
// –ö–Ω–æ–ø–∫–∞ "üìú –ü—Ä–∞–≤–∏–ª–∞"
bot.hears('üìú –ü—Ä–∞–≤–∏–ª–∞', (ctx) => {
  const rulesText = `üìú <b>–ü—Ä–∞–≤–∏–ª–∞ –∫–ª—É–±–∞ Allgorithm</b>\n\n` +
    `üîª <b>–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:</b>\n` +
    `1. 18+: –°—Ç—Ä–æ–≥–æ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö. –í—Ä–∞—Ç—å –ø—Ä–æ –≤–æ–∑—Ä–∞—Å—Ç ‚Äî –≤–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.\n` +
    `2. –ß–µ—Å—Ç–Ω–∞—è –∏–≥—Ä–∞: –ë–µ–∑ –æ–±–º–∞–Ω–∞, –≥—É–≥–ª–∞ –∏ –º—É—Ö–ª–µ–∂–∞. –ú—ã –∑–¥–µ—Å—å –∑–∞ —á–∏–ª–æ–º!\n` +
    `3. –ö—É–ª—å—Ç—É—Ä–∞: –ú–∞—Ç, —Å–ø–∞–º –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è = –±–∞–Ω –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.\n` +
    `4. –û–ø–ª–∞—Ç–∞: –ù–µ—Ç –æ–ø–ª–∞—Ç—ã ‚Äî –Ω–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.(–Ω–µ—Ç—É —Ä—É—á–µ–∫ - –Ω–µ—Ç –∫–æ–Ω—Ñ–µ—Ç–∫–∏) –ü–ª–∞—Ç–µ–∂ ‚Äî –≤–∞—à –≤—Ö–æ–¥–Ω–æ–π –±–∏–ª–µ—Ç.\n` +
    `5. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è: –°–ª–æ–≤–æ –≤–µ–¥—É—â–µ–≥–æ ‚Äî –∑–∞–∫–æ–Ω. –ú–æ–∂–µ–º —É–¥–∞–ª–∏—Ç—å –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤.\n\n` +
    `üîª <b>–í–û–ó–í–†–ê–¢ –°–†–ï–î–°–¢–í:</b>\n` +
    `1. –ó–∞ 36 —á–∞—Å–æ–≤: –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç–µ –∑–∞ 36 —á–∞—Å–æ–≤ ‚Äî –≤–µ—Ä–Ω–µ–º –¥–µ–Ω—å–≥–∏.\n` +
    `2. –ú–µ–Ω–µ–µ 36 —á–∞—Å–æ–≤: –î–µ–Ω—å–≥–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è.\n` +
    `3. –û—Ç–º–µ–Ω–∞ –∏–≥—Ä—ã: –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–º –º—ã ‚Äî –≤–µ—Ä–Ω–µ–º –≤—Å–µ–º.\n\n` +
    `üîª <b>–ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø:</b>\n` +
    `1. –¢–∞–π–º–∏–Ω–≥: –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 10-15 –º–∏–Ω—É—Ç –¥–æ, —á—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å –µ–¥—É.\n` +
    `2. –ï–¥–∞ –∏ –ù–∞–ø–∏—Ç–∫–∏: –û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ.\n` +
    `3. –¢–∏—à–∏–Ω–∞: –ù–µ –±–æ–ª—Ç–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª.\n` +
    `4. –ë–µ–∑ —Å–æ–≤–µ—Ç–æ–≤: –ù–µ –ø–µ—Ä–µ–±–∏–≤–∞–π—Ç–µ –≤–µ–¥—É—â–∏—Ö. –í—Å–µ –∂–∞–ª–æ–±—ã –∏ —Å–æ–≤–µ—Ç—ã ‚Äî –≤ –∫–æ–Ω—Ü–µ –≤–µ—á–µ—Ä–∞.\n` +
    `5. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ—É–º–µ—Å—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥—É—à–Ω–æ—Ç—É –¥–æ–º–∞. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –∏–≥—Ä—ã.`;

  ctx.replyWithHTML(rulesText);
}); // Gemini —è —Ç–µ–±—è –ª—é–±–ª—é, —Ç—ã –ª—É—á—à–∏–π) –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–µ—Ä–¥–µ—á–∫–æ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞

// –ö–Ω–æ–ø–∫–∞ "üÜò –ü–æ–º–æ—â—å"
bot.hears('üÜò –ü–æ–º–æ—â—å', (ctx) => {
  (ctx.session as any).waitingForSupport = true; // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
  ctx.reply('–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä—è–º–æ —Å—é–¥–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è! üëá ¬´–ú—ã –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 15‚Äì30 –º–∏–Ω—É—Ç. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å—Ä–æ—á–Ω—ã–π ‚Äî –Ω–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å, –º—ã –≤—Å—ë –≤–∏–¥–∏–º!¬ª');
});

// --- 8. –õ–û–ì–ò–ö–ê –ò–ì–† ---

bot.action('game_talk', (ctx) => {
  const text = `ü•Ç <b>Talk & Toast</b>\n\n` +
    `<b>–ß—Ç–æ —ç—Ç–æ?</b>\n` +
    `–°—Ç–æ–∏–º–æ—Å—Ç—å: 50 z≈Ç\n` +
    `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2 —á–∞—Å–∞\n\n` +
    `–≠—Ç–æ –Ω–µ —Å–≤–∏–¥–∞–Ω–∏—è –∏ –Ω–µ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥ ‚Äî —ç—Ç–æ –ª—ë–≥–∫–∞—è, –¥—Ä—É–∂–µ—Å–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥—ë–Ω–Ω–æ ‚ú®\n\n` +
    `<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n` +
    `–í —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ <b>–Ω–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –≤–µ–¥—É—â–µ–≥–æ</b> ‚Äî –≤–µ—Å—å –≤–µ—á–µ—Ä –º–æ–¥–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞—à –±–æ—Ç. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –ø–∞—Ñ–æ—Å–∞.\n\n` +
    `–í –ø–µ—Ä–≤—ã–µ –º–∏–Ω—É—Ç—ã –≤—Å—Ç—Ä–µ—á–∏ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—à–ª–µ—Ç –í–∞–º –ø–µ—Ä–≤—É—é —Ç–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ, –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –≥–ª—É–±–æ–∫—É—é —Ç–µ–º—É –º–æ–∂–Ω–æ –Ω–∞–∂–∞–≤ –Ω–∞ –∫–ª–∞–≤–∏—à—É <b>¬´–Ω–æ–≤–∞—è —Ç–µ–º–∞¬ª</b> üé≤\n\n` +
    `<b>–ó–∞—á–µ–º —ç—Ç–æ?</b>\n` +
    `‚Ä¢ –í—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ä–æ—à–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–µ—á–µ—Ä –≤ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ üç∑\n` +
    `‚Ä¢ –ù–∞–π—Ç–∏ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π, –¥–µ–ª–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏ –¥–∞–∂–µ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω–∫—É ü§ù\n` +
    `‚Ä¢ –û—Ç–∫—Ä—ã—Ç—å –¥–ª—è —Å–µ–±—è –Ω–æ–≤—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–æ–±—ã—á–Ω—ã–µ –±–ª—é–¥–∞ üçù\n\n` +
    `<b>–ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –ø–æ–π—Ç–∏?</b>\n` +
    `‚Ä¢ –ù–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –ª—é–¥—å–º–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã –±—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å üåç\n` +
    `‚Ä¢ –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å ‚Äî –±–æ—Ç-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–¥–µ–ª–∞–µ—Ç –≤—Å—ë –∑–∞ –≤–∞—Å! üòé\n\n` +
    `üç≤ <b>–í–∞–∂–Ω–æ:</b> –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∏–≥—Ä—ã —Å–æ –∑–Ω–∞—á–∫–æ–º –∏ —Å–∫–∏–¥–∫–æ–π "üé•" –∏ —Å–∫–∏–¥–∫–æ–π -50% –ü–æ–∫—É–ø–∞—è –±–∏–ª–µ—Ç –Ω–∞ –∏–≥—Ä—É —Å–æ —Å—ä–µ–º–∫–æ–π, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö`;

  return ctx.editMessageText(text, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([
      [Markup.button.callback('üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'book_talk')], 
      [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]
    ]) 
  });
});

bot.action('game_stock', (ctx) => {
  const text = `üß† <b>Stock & Know</b>\n\n` +
    `<b>–ß—Ç–æ —ç—Ç–æ?</b>\n\n` 
    `–°—Ç–æ–∏–º–æ—Å—Ç—å: 50 z≈Ç\n` +
    `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2 —á–∞—Å–∞\n\n` +
    `–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞, –≥–¥–µ —Å—Ç–∞–≤—è—Ç –Ω–∞ –∑–Ω–∞–Ω–∏—è! üéì –ó–¥–µ—Å—å –≤–∞–∂–Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –±–∞–≥–∞–∂–∞ –∑–Ω–∞–Ω–∏–π, –Ω–æ –∏ —É–º–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ –¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫–∏. –≠—Ç–æ –æ—Å—Ç—Ä–æ—É–º–Ω–∞—è –±–∏—Ç–≤–∞, –≥–¥–µ —Å–ø–ª–µ—Ç–µ–Ω—ã –∏—Å–∫—É—Å—Å—Ç–≤–æ –±–ª–µ—Ñ–∞ –∏ —ç—Ä—É–¥–∏—Ü–∏—è üé≠\n\n` +
    `<b>–ó–∞—á–µ–º —ç—Ç–æ?</b>\n‚Ä¢ –®–∞–Ω—Å –Ω–∞–π—Ç–∏ –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ üëÄ\n‚Ä¢ –ù–µ–∑–∞–±—ã–≤–∞–µ–º—ã–µ —ç–º–æ—Ü–∏–∏ –æ—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π –∏–≥—Ä—ã üî•\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π, —É–¥–∞—á–∏ –∏ –æ—Å—Ç—Ä–æ—É–º–∏—è üçÄ\n‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—Ä—É–≥–æ–∑–æ—Ä–∞ üåç\n\n` +
    `<b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n–í –Ω–∞—á–∞–ª–µ —Ä–∞—É–Ω–¥–∞ –≤—Å–µ –¥–µ–ª–∞—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É üí∞. –í–µ–¥—É—â–∏–π –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –≤—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç–µ –æ—Ç–≤–µ—Ç (–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è!). –ó–∞—Ç–µ–º, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∑–∞—Ä—Ç–∞, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–≤—ã—à–∞—Ç—å —Å—Ç–∞–≤–∫–∏ (–¥–∞–∂–µ –≤–∞-–±–∞–Ω–∫!). –í–µ–¥—É—â–∏–π –¥–∞–µ—Ç 3 –ø–æ–¥—Å–∫–∞–∑–∫–∏ üí° ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ç–∞–≤–∫—É. –ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –±–ª–∏–∂–µ –≤—Å–µ—Ö –∫ –∏—Å—Ç–∏–Ω–µ!\n\n` +
    `‚è≥ <b>–í—Ä–µ–º—è:</b> 2 —á–∞—Å–∞\nüë• <b>–ò–≥—Ä–æ–∫–æ–≤:</b> –¥–æ 8\nüç≤ <b>–ú–µ–Ω—é:</b> –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∏–≥—Ä—ã —Å–æ –∑–Ω–∞—á–∫–æ–º –∏ —Å–∫–∏–¥–∫–æ–π "üé•" –∏ —Å–∫–∏–¥–∫–æ–π -50% –ü–æ–∫—É–ø–∞—è –±–∏–ª–µ—Ç –Ω–∞ –∏–≥—Ä—É —Å–æ —Å—ä–µ–º–∫–æ–π, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö`;
  return ctx.editMessageText(text, { parse_mode: 'HTML', ...Markup.inlineKeyboard([[Markup.button.callback('üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'book_stock')], [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]]) });
});

bot.action('game_dating', (ctx) => {
  const text = `üíò <b>–ë—ã—Å—Ç—Ä—ã–µ —Å–≤–∏–¥–∞–Ω–∏—è</b>\n\n` +
    `–°—Ç–æ–∏–º–æ—Å—Ç—å: 50 z≈Ç\n` +
    `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1 —á–∞—Å 15 –º–∏–Ω—É—Ç\n\n` +
    `<b>–ß—Ç–æ —ç—Ç–æ?</b>\nüó£Ô∏è 14 —á–µ–ª–æ–≤–µ–∫ (7–ñ + 7–ú), 7 —É—é—Ç–Ω—ã—Ö —Å—Ç–æ–ª–∏–∫–æ–≤ –∏ 10-–º–∏–Ω—É—Ç–Ω—ã–µ —Ä–∞—É–Ω–¥—ã. –ë–æ—Ç —Å–∞–º –≤—ã–¥–∞—Å—Ç –Ω–æ–º–µ—Ä–∞, –∑–∞–ø—É—Å—Ç–∏—Ç —Ç–∞–π–º–µ—Ä –∏ –ø–µ—Ä–µ—Ç–∞—Å—É–µ—Ç –ø–∞—Ä—ã üì≤. –¢–µ–±–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–∞—Ç—å —Å–∏–º–ø–∞—Ç–∏–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî –µ—Å–ª–∏ –º—ç—Ç—á, –±–æ—Ç –ø—Ä–∏—à–ª—ë—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã! ‚ú®\n\n` +
    `<b>–ó–∞—á–µ–º —ç—Ç–æ?</b>\n‚Ä¢ üöÄ <b>–°–µ–º—å —à–∞–Ω—Å–æ–≤</b> –Ω–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ –∑–∞ —á–∞—Å: –æ–¥–Ω–∞ –∏—Å–∫—Ä–∞ ‚Äî –∏ —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π —á–µ–ª–æ–≤–µ–∫!\n‚Ä¢ üí¨ <b>–ë–µ–∑ –Ω–µ–ª–æ–≤–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤</b> ‚Äî –±–æ—Ç —Å–∞–º –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é —Ç–µ–º—É –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.\n‚Ä¢ üéØ <b>–¢–æ–ª—å–∫–æ –º—ç—Ç—á–∏:</b> —É—Ö–æ–¥–∏—à—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —Ç–µ—Ö, –∫—Ç–æ —Ç–µ–±–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è.\n‚Ä¢ üõ°Ô∏è <b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ:</b> –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è ‚Äî –æ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç —Ç–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.\n\n` +
    `<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n‚ú® –ò—Å–ø—ã—Ç–∞–π—Ç–µ –∏—Å–∫—Ä—É —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞! –ú—É–∂—á–∏–Ω—ã –∏ –∂–µ–Ω—â–∏–Ω—ã —Å–∞–¥—è—Ç—Å—è –ø–æ –¥–≤–æ–µ –∑–∞ —Å—Ç–æ–ª–∏–∫–∏, –∞ –±–æ—Ç –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –∫–∞–∂–¥–æ–º—É —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä üé´. –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –ø–∞—Ä—ã –º–µ–Ω—è—é—Ç—Å—è üîÑ, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å–æ –≤—Å–µ–º–∏. \n\n–í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ—á–∞–π —Å–∏–º–ø–∞—Ç–∏–∏ –≤ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–µ ‚ù§Ô∏è. –ï—Å–ª–∏ —á—É–≤—Å—Ç–≤–∞ –≤–∑–∞–∏–º–Ω—ã, –±–æ—Ç —Å–æ–µ–¥–∏–Ω–∏—Ç –≤–∞—Å –ø–æ—Å–ª–µ –∏–≥—Ä–∞! –ì–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –Ω–æ–≤—ã–º –≤—Å—Ç—Ä–µ—á–∞–º –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º! ü•Ç\n\n`;
  
    
  return ctx.editMessageText(text, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([
      [Markup.button.callback('üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'book_dating')], 
      [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]
    ]) 
  });
});

bot.action('book_talk', async (ctx) => bookGame(ctx, 'talk_toast'));
bot.action('book_stock', async (ctx) => bookGame(ctx, 'stock_know'));
bot.action('book_dating', async (ctx) => bookGame(ctx, 'speed_dating'));

async function bookGame(ctx: any, type: string) {
  const events = await db.query.events.findMany({ 
    where: and(
      or(eq(schema.events.type, type), eq(schema.events.type, `${type}_review`)), 
      eq(schema.events.isActive, true)
    ) 
  });

  if (events.length === 0) return ctx.reply(`–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è!`);

  if (type === 'talk_toast') {
    const uniqueTitles = new Set<string>(); 
    events.forEach(e => uniqueTitles.add(parseEventDesc(e.description).title));
    const btns = Array.from(uniqueTitles).map(t => [Markup.button.callback(t, `cv_${TYPE_MAP[type]}_${encodeCat(t)}`)]);
    return ctx.editMessageText('–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ö–Ω–∏:', { parse_mode: 'HTML', ...Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô', 'back_to_games')]]) });
  }

  const buttons = events.map(e => {
    const isReview = e.type.includes('review');
    const label = isReview ? `üé• ${e.dateString} (-50% –ó–ê –û–ë–ó–û–†)` : `üìÖ ${e.dateString}`;
    return [Markup.button.callback(`${label} (${e.currentPlayers}/${e.maxPlayers})`, `pay_event_${e.id}`)];
  });

  ctx.editMessageText('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É:', Markup.inlineKeyboard([...buttons, [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]]));
}

bot.action(/cv_(.+)_(.+)/, async (ctx) => {
¬†const type = REV_TYPE_MAP[ctx.match[1]]; 
  const selectedTitle = decodeCat(ctx.match[2]);
  // –¢–µ–ø–µ—Ä—å –∏—â–µ—Ç –∏ –æ–±—ã—á–Ω—ã–µ, –∏ —Ä–µ–≤—å—é-–∏–≥—Ä—ã
  const events = await db.query.events.findMany({ 
    where: and(
      or(eq(schema.events.type, type), eq(schema.events.type, `${type}_review`)),
      eq(schema.events.isActive, true)
    ) 
  });
  const filtered = events.filter(e => parseEventDesc(e.description).title === selectedTitle);
  const btns = filtered.map(e => {
    const isReview = e.type.includes('review');
    const label = isReview ? `üé• ${e.dateString} (-50%)` : `üìÖ ${e.dateString}`;
    return [Markup.button.callback(`${label} (${e.currentPlayers}/${e.maxPlayers})`, `pay_event_${e.id}`)];
  });
¬† return ctx.editMessageText(
¬† ¬† `üçΩ <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${selectedTitle}</b>\n\n` +
¬† ¬† `–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –ù–∏–∂–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è —ç—Ç–æ–π –∫—É—Ö–Ω–∏. –í—ã–±–∏—Ä–∞–π —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. üëá\n\n` +
¬† ¬† `‚ö†Ô∏è <i>–ù–∞–ø–æ–º–∏–Ω–∞–µ–º: –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞ –≤—Ö–æ–¥–∏—Ç —É—á–∞—Å—Ç–∏–µ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è. –ó–∞–∫–∞–∑—ã –ø–æ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –º–µ—Å—Ç–µ.</i>`,¬†
¬† ¬† {¬†
¬† ¬† ¬† parse_mode: 'HTML',¬†
¬† ¬† ¬† ...Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É', 'book_talk')]])¬†
¬† ¬† }
¬† );
}); // <--- –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–¥–µ—Å—å// <-- –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

bot.action('back_to_games', (ctx) => { ctx.deleteMessage(); ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:', Markup.inlineKeyboard([[Markup.button.callback('Talk & Toast ü•Ç', 'game_talk')], [Markup.button.callback('Stock & Know üß†', 'game_stock')], [Markup.button.callback('Fast Dates üíò', 'game_dating')]])); });

bot.action('my_games', async (ctx) => {
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
    if (!user) return;
    const myBookings = await db.select({ bid: schema.bookings.id, d: schema.events.dateString }).from(schema.bookings).innerJoin(schema.events, eq(schema.bookings.eventId, schema.events.id)).where(and(eq(schema.bookings.userId, user.id), eq(schema.bookings.paid, true), eq(schema.events.isActive, true)));
    if (myBookings.length === 0) return ctx.reply('üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.');
    for (const b of myBookings) {
        await ctx.reply(`üóì <b>${b.d}</b>`, { parse_mode: 'HTML', ...Markup.inlineKeyboard([[Markup.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å', `conf_canc_${b.bid}`)]]) });
    }
});

bot.action(/conf_canc_(\d+)/, async (ctx) => {
    const bookingId = parseInt(ctx.match[1]);
    ctx.editMessageReplyMarkup({ inline_keyboard: [[Markup.button.callback('üî• –î–ê, –û–¢–ú–ï–ù–ò–¢–¨', `exec_canc_${bookingId}`)], [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'my_games')]] });
});

bot.action(/exec_canc_(\d+)/, async (ctx) => {
    const bookingId = parseInt(ctx.match[1]);
    
    // 1. –ù–∞—Ö–æ–¥–∏–º –±—Ä–æ–Ω—å
    const booking = await db.query.bookings.findFirst({ where: eq(schema.bookings.id, bookingId) });
    if (!booking) return;

    // 2. –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä—É
    const event = await db.query.events.findFirst({ where: eq(schema.events.id, booking.eventId) });
    if (!event) return;

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (36 —á–∞—Å–æ–≤)
    const eventDate = DateTime.fromFormat(event.dateString, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
    if (eventDate.diffNow('hours').hours < 36) {
        return ctx.reply('‚ö†Ô∏è –ü–æ–∑–¥–Ω–æ–≤–∞—Ç–æ –¥–ª—è –æ—Ç–º–µ–Ω—ã. –°–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º, –≤–æ–∑–≤—Ä–∞—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –º–µ–Ω–µ–µ —á–µ–º –∑–∞ 36 —á–∞—Å–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ "–ü–æ–º–æ—â—å", –µ—Å–ª–∏ –µ—Å—Ç—å –≤–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞.');
    }
    
    // 4. –ë–ï–ó–û–ü–ê–°–ù–´–ô –í–û–ó–í–†–ê–¢ –í–ê–£–ß–ï–†–ê
    // –ò—â–µ–º –≤–∞—É—á–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ 'used' –ò–ú–ï–ù–ù–û –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã (eventId)
    // –ü–æ–ª–µ usedInEventId –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—É vouchers
    const usedVoucher = await db.query.vouchers.findFirst({ 
        where: and(
            eq(schema.vouchers.userId, booking.userId), 
            eq(schema.vouchers.status, 'used'),
            eq(schema.vouchers.usedInEventId, booking.eventId) // –ù–∞—Ö–æ–¥–∏–º –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç, —á—Ç–æ —Ç—Ä–∞—Ç–∏–ª–∏ —Ç—É—Ç
        ) 
    });

    if (usedVoucher) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –±—ã–ª–∞ —ç—Ç–æ —Å–∫–∏–¥–∫–∞ –∏–ª–∏ —Ñ—Ä–∏-–±–∏–ª–µ—Ç
        await db.update(schema.vouchers)
            .set({ 
                status: usedVoucher.photoFileId ? 'approved_free' : 'approved_10',
                usedInEventId: null // –û—á–∏—â–∞–µ–º —Å–≤—è–∑—å —Å –∏–≥—Ä–æ–π
            })
            .where(eq(schema.vouchers.id, usedVoucher.id));
    }
    
    // 5. –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã
    await db.delete(schema.bookings).where(eq(schema.bookings.id, bookingId));

    // 6. –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
    await db.update(schema.events)
        .set({ currentPlayers: Math.max(0, (event.currentPlayers || 0) - 1) })
        .where(eq(schema.events.id, event.id));

    await ctx.editMessageText('‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤–∞—É—á–µ—Ä, –æ–Ω –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –≤–∞—à –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.');

    // 7. –ú–ê–ì–ò–Ø –û–ß–ï–†–ï–î–ò: –°—Ä–∞–∑—É –∑–æ–≤–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ Waitlist
    await notifyNextInWaitlist(event.id, event.type, event.dateString);
});

bot.command('quiet_address', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    
    // –§–æ—Ä–º–∞—Ç: /quiet_address [ID_–ò–≥—Ä—ã] [–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å]
    const parts = ctx.message.text.split(' ');
    if (parts.length < 3) return ctx.reply('‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /quiet_address [ID] [–ê–¥—Ä–µ—Å]');

    const eventId = parseInt(parts[1]);
    const newAddress = parts.slice(2).join(' ');

    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å
        const { title } = parseEventDesc(event.description);
        const newDescription = `${title} ### ${newAddress}`;

        // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É. –ù–ò–ö–ê–ö–ò–• —Ä–∞—Å—Å—ã–ª–æ–∫.
        await db.update(schema.events)
            .set({ description: newDescription })
            .where(eq(schema.events.id, eventId));

        await ctx.reply(`ü§´ –¢—Å—Å... –ê–¥—Ä–µ—Å –∏–≥—Ä—ã ‚Ññ${eventId} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${newAddress}. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–± —ç—Ç–æ–º —É–∑–Ω–∞—é—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø–ª–∞–Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ 3 —á–∞—Å–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞!`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ —Ç–∏—Ö–æ–π —Å–º–µ–Ω—ã –∞–¥—Ä–µ—Å–∞.');
    }
});

// --- 9. –û–ü–õ–ê–¢–ê (–ü–û–õ–ù–ê–Ø) ---

// --- 9. –û–ü–õ–ê–¢–ê (–ü–û–õ–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) ---

bot.action(/pay_event_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (!user?.name) {
        return ctx.scene.enter('REGISTER_SCENE', { returnToEvent: eid });
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if (user.strangeStory === 'BANNED') {
        return ctx.reply('‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –Ω–∞—Ä—É—à–∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –∫–ª—É–±–∞ Allgorithm –∏ –¥–æ—Å—Ç—É–ø –∫ –∏–≥—Ä–∞–º –¥–ª—è –≤–∞—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ü–æ–º–æ—â—å.');
    }

    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eid) });
        if (!event) return;

        // --- –ë–õ–û–ö –ì–ï–ù–î–ï–†–ù–û–ì–û –ö–û–ù–¢–†–û–õ–Ø –î–õ–Ø SPEED DATING ---
        // –í–Ω—É—Ç—Ä–∏ bot.action(/pay_event_(\d+)/, ...)
        if (event.type === 'speed_dating') {
            const bookings = await db.query.bookings.findMany({ 
                where: and(eq(schema.bookings.eventId, eid), eq(schema.bookings.paid, true)) 
            });

            let menCount = 0;
            let womenCount = 0;

            for (const b of bookings) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
        // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ –∏—â–µ–º –∫–æ—Ä–µ–Ω—å
                const g = (u?.gender || '').toLowerCase();
        
                if (g.includes('–º—É–∂')) menCount++; // –ü–æ–π–º–µ—Ç: –ú—É–∂—á–∏–Ω–∞, –ú—É–∂—Å–∫–æ–π, –ú—É–∂–∏–∫, –ú—É–∂
                else if (g.includes('–∂–µ–Ω')) womenCount++; // –ü–æ–π–º–µ—Ç: –ñ–µ–Ω—â–∏–Ω–∞, –ñ–µ–Ω—Å–∫–∏–π, –ñ–µ–Ω
            }

            const limitPerGender = Math.floor(event.maxPlayers / 2);
            const userG = (user.gender || '').toLowerCase();


            // –í–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –¥–ª—è speed_dating:
            if (userG.includes('–º—É–∂') && menCount >= limitPerGender) {
                return ctx.reply(`‚ùå –ú–µ—Å—Ç–∞ –¥–ª—è –º—É–∂—á–∏–Ω –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.`, 
                    Markup.inlineKeyboard([[Markup.button.callback('‚è≥ –í—Å—Ç–∞—Ç—å –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è', `waitlist_add_${eid}`)]]));
            }
            if (userG.includes('–∂–µ–Ω') && womenCount >= limitPerGender) {
                return ctx.reply(`‚ùå –ú–µ—Å—Ç–∞ –¥–ª—è –¥–µ–≤—É—à–µ–∫ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.`, 
                    Markup.inlineKeyboard([[Markup.button.callback('‚è≥ –í—Å—Ç–∞—Ç—å –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è', `waitlist_add_${eid}`)]]));
            }
        }
    


          
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ –Ω–∞–º–µ—Ä–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç–∏—Ç—å
        await bot.telegram.sendMessage(ADMIN_ID, `‚ö†Ô∏è –Æ–∑–µ—Ä ${user.name} (@${ctx.from!.username}) –Ω–∞–∂–∞–ª ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª –Ω–∞ –∏–≥—Ä—É ‚Ññ${eid}.`).catch(()=>{});

        // 3. –ö–∞–∂–¥–∞—è 5-—è –∏–≥—Ä–∞ –ë–ï–°–ü–õ–ê–¢–ù–û
        const activeBookings = await db.query.bookings.findMany({
          where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.paid, true))
            });

// –°—á–∏—Ç–∞–µ–º: —Å–∫–æ–ª—å–∫–æ —Å—ã–≥—Ä–∞–Ω–æ + –Ω–∞ —Å–∫–æ–ª—å–∫–æ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω
        const totalIntents = (user.gamesPlayed || 0) + activeBookings.length;

          if ((totalIntents + 1) % 5 === 0) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–µ–∫—É—â–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
    // (–õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Å—É–º–º–∞ + 1 –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 5, –∑–Ω–∞—á–∏—Ç –∏–º–µ–Ω–Ω–æ –≠–¢–ê –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π)
        await db.insert(schema.bookings).values({ userId: user.id, eventId: eid, paid: true });
        await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eid));
            
            return ctx.replyWithHTML(
                `üéÅ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –≠—Ç–æ —Ç–≤–æ—è 5-—è –∏–≥—Ä–∞, –æ–Ω–∞ –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø!</b>\n\n` +
                `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n` +
                `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞.\n` +
                `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
                `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n` +
                `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. –î–æ –≤—Å—Ç—Ä–µ—á–∏! üéâ`
            );
        }

        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞—É—á–µ—Ä–æ–≤
        const activeVoucher = await db.query.vouchers.findFirst({ 
            where: and(eq(schema.vouchers.userId, user.id), or(eq(schema.vouchers.status, 'approved_10'), eq(schema.vouchers.status, 'approved_free'))) 
        });

          if (activeVoucher?.status === 'approved_free') {
            await db.insert(schema.bookings).values({ userId: user.id, eventId: eid, paid: true });
            await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eid));
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú—ã –ø–æ–º–µ—á–∞–µ–º, —á—Ç–æ —ç—Ç–æ—Ç –≤–∞—É—á–µ—Ä –ø—Ä–∏–≤—è–∑–∞–Ω –∏–º–µ–Ω–Ω–æ –∫ –≠–¢–û–ô –∏–≥—Ä–µ (eid)
            await db.update(schema.vouchers)
                .set({ status: 'used', usedInEventId: eid }) // –î–æ–±–∞–≤—å —ç—Ç–æ –ø–æ–ª–µ –≤ –ë–î
                .where(eq(schema.vouchers.id, activeVoucher.id));
            
            return ctx.replyWithHTML(
                `üé´ <b>–û–ø–ª–∞—á–µ–Ω–æ FREE –≤–∞—É—á–µ—Ä–æ–º! –¢—ã –≤ –∏–≥—Ä–µ!</b>\n\n` +
                `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n` +
                `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞.\n` +
                `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
                `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n` +
                `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. –î–æ –≤—Å—Ç—Ä–µ—á–∏! üòé`
            );
        }

        // 5. –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Stripe
        const sessionMetadata: any = { telegramId: ctx.from!.id.toString(), eventId: eid.toString() };
        let discounts = [];
        
        if (activeVoucher?.status === 'approved_10') {
            discounts = [{ coupon: STRIPE_COUPON_ID }];
            sessionMetadata.voucherId = activeVoucher.id.toString(); // –ü—Ä–∏–≤–µ—Ç, –•–∞–Ω–Ω–∞ Gemini! ‚ù§Ô∏è
        }

        const stripeSession = await stripe.checkout.sessions.create({
            payment_method_types: ['card', 'blik', 'revolut_pay'],
            line_items: [{ price: GAME_PRICES[event.type], quantity: 1 }],
            metadata: sessionMetadata,
            discounts: discounts,
            mode: 'payment',
            locale: 'ru',
            success_url: `https://t.me/${ctx.botInfo.username}`,
            cancel_url: `https://t.me/${ctx.botInfo.username}`,
        });

        // 1. –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É –∏–≥—Ä—ã
        let finalPrice = event.type.includes('review') ? 25 : 50;

// 2. –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞—É—á–µ—Ä –Ω–∞ -10 PLN, –≤—ã—á–∏—Ç–∞–µ–º –µ–≥–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä)
        if (activeVoucher?.status === 'approved_10' && !event.type.includes('review')) {
            finalPrice = 40;
        }

// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ü–∏—Ñ—Ä–æ–π
        await ctx.reply(
            `–ö –æ–ø–ª–∞—Ç–µ: ${finalPrice} PLN, —Å–∫–æ—Ä–µ–µ –Ω–∞–∂–∏–º–∞–π –æ–ø–ª–∞—Ç–∏—Ç—å, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤–æ–∏—Ö! ü•Ç`, 
            Markup.inlineKeyboard([
                [Markup.button.url('üí∏ –û–ø–ª–∞—Ç–∏—Ç—å (Apple/Google Pay, BLIK...)', stripeSession.url!)], 
                [Markup.button.callback('‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª', `confirm_pay_${eid}`)]
          ])
        );

    } catch (e) { 
        console.error(e); 
        ctx.reply('–û—à–∏–±–∫–∞ Stripe. –ü—Ä–æ–≤–µ—Ä—å –≤–∞–ª—é—Ç—É –≤ Dashboard!'); 
    }
    
    PENDING_PAYMENTS.set(`${user.id}`, { time: DateTime.now(), notified: false });
});

bot.action(/waitlist_add_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
    
    if (!user) return;

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –æ–Ω —É–∂–µ –∏ —Ç–∞–∫ –≤ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –≤ –∏–≥—Ä–µ?
    const existing = await db.query.bookings.findFirst({
        where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, eid))
    });

    if (existing) {
        return ctx.answerCbQuery('–¢—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ —ç—Ç—É –∏–≥—Ä—É –∏–ª–∏ —É–∂–µ —Å—Ç–æ–∏—à—å –≤ –æ—á–µ—Ä–µ–¥–∏! ‚è≥', { show_alert: true });
    }

    // 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ –≤ –±–∞–∑—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º paid: false
    // –î–ª—è –Ω–∞—Å —ç—Ç–æ —Ç–µ–ø–µ—Ä—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∑–Ω–∞–∫ "–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è"
    await db.insert(schema.bookings).values({
        userId: user.id,
        eventId: eid,
        paid: false
    });

    await ctx.answerCbQuery('–£—Å–ø–µ—à–Ω–æ! –¢—ã –≤ –æ—á–µ—Ä–µ–¥–∏ ü•Ç');
    await ctx.editMessageText(
        `‚úÖ <b>–¢—ã –≤ –ª–∏—Å—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è!</b>\n\n` +
        `–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∫—Ç–æ-—Ç–æ –æ—Ç–º–µ–Ω–∏—Ç —Å–≤–æ—é –∑–∞–ø–∏—Å—å, —è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏—à–ª—é —Ç–µ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ë—É–¥—å –Ω–∞ —Å–≤—è–∑–∏! ‚ú®`,
        { parse_mode: 'HTML' }
    );
});

bot.action(/confirm_pay_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    try {
        const sessions = await stripe.checkout.sessions.list({ limit: 100 });
        const paid = sessions.data.find(s => s.metadata?.telegramId === ctx.from!.id.toString() && s.metadata?.eventId === eid.toString() && s.payment_status === 'paid');
        
        if (!paid) return ctx.reply('üîç –û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫.');
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
        if (!user) return;

        // –ü–†–û–í–ï–†–ö–ê –ù–ê –î–£–ë–õ–¨
        const existing = await db.query.bookings.findFirst({ 
            where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, eid)) 
        });

        if (existing) {
            return ctx.editMessageText('‚úÖ –í—ã —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤! –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥–µ—Ç –∑–∞ 3 —á–∞—Å–∞.');
        }

        PENDING_PAYMENTS.delete(`${user.id}`);
        await db.insert(schema.bookings).values({ userId: user.id, eventId: eid, paid: true });

        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eid) });
        if (event) {
            // –ü—Ä–∏–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
            await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eid));
        }
        
        await ctx.editMessageText(
            `üéâ <b>–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –¢—ã –≤ –∏–≥—Ä–µ!</b>\n\n` +
            `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–∫–æ—Ä–æ—Ç–∫–æ):</b>\n` +
            `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞. –ü–æ–∑–∂–µ —Å—É–º–º–∞ ¬´—Å–≥–æ—Ä–∞–µ—Ç¬ª.\n` +
            `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
            `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n` +
            `ü§´ <b>–ö—Å—Ç–∞—Ç–∏!</b> –î–ª—è –Ω–∞—à–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –Ω–∞–º –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏ –≤ üë§ <b>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</b> -> <b>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</b> –∏ –Ω–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∑–∞–±–∞–≤–Ω—ã–π –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ñ–∞–∫—Ç –æ —Å–µ–±–µ. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–µ—á–µ—Ä –≤ —Ä–∞–∑—ã –∫—Ä—É—á–µ! ‚ú®\n\n` +
            `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.\n\n` +
            `–î–æ –≤—Å—Ç—Ä–µ—á–∏! üòé`, 
            { parse_mode: 'HTML' }
        );
    } catch (e) { ctx.reply('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.'); }
});
  
// --- 10. –í–ê–£–ß–ï–†–´ ---

// --- 10. –í–ê–£–ß–ï–†–´ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) ---

bot.action('upload_voucher', (ctx) => { 
    ctx.reply('üì∏ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –≤–∞—É—á–µ—Ä–∞ –ø—Ä—è–º–æ —Å—é–¥–∞, –∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä–∏—Ç –µ–≥–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç.'); 
    (ctx.session as any).waitingForVoucher = true; 
});

bot.on('photo', async (ctx, next) => {
    if (!(ctx.session as any)?.waitingForVoucher) return next();
    
    const photo = ctx.message.photo[ctx.message.photo.length - 1];
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
    
    if (user) {
        const [v] = await db.insert(schema.vouchers).values({ 
            userId: user.id, 
            photoFileId: photo.file_id, 
            status: 'pending' 
        }).returning();

        ctx.reply('‚úÖ –í–∞—É—á–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.'); 
        (ctx.session as any).waitingForVoucher = false;

        await bot.telegram.sendPhoto(ADMIN_ID, photo.file_id, {
            caption: `üéü <b>–ù–æ–≤—ã–π –≤–∞—É—á–µ—Ä</b>\n–û—Ç: ${user.name}\nID: <code>${user.telegramId}</code>`,
            parse_mode: 'HTML',
            ...Markup.inlineKeyboard([
                [Markup.button.callback('üí∞ -10 PLN', `v_set_10_${v.id}`), Markup.button.callback('üéÅ FREE', `v_set_free_${v.id}`)],
                [Markup.button.callback('‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å', `v_set_reject_${v.id}`)]
            ])
        });
    }
});
  
bot.action(/v_set_(10|free|reject)_(\d+)/, async (ctx) => {
    const action = ctx.match[1];
    const vId = parseInt(ctx.match[2]);
    let status = '';
    let userMsg = '';

    if (action === '10') { 
        status = 'approved_10'; 
        userMsg = 'üéâ –¢–≤–æ–π –≤–∞—É—á–µ—Ä –æ–¥–æ–±—Ä–µ–Ω! –°–∫–∏–¥–∫–∞ -10 PLN –Ω–∞—á–∏—Å–ª–µ–Ω–∞. –°–∫–æ—Ä–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞–π—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö —ç–º–æ—Ü–∏–π! ü•Ç'; 
    }
    else if (action === 'free') { 
        status = 'approved_free'; 
        userMsg = 'üî• –¢–≤–æ–π –≤–∞—É—á–µ—Ä –æ–¥–æ–±—Ä–µ–Ω! –°–ª–µ–¥—É—é—â–∞—è –∏–≥—Ä–∞ –¥–ª—è —Ç–µ–±—è –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø! –°–∫–æ—Ä–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞–π—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö —ç–º–æ—Ü–∏–π! ü•Ç'; 
    }
    else if (action === 'reject') { 
        status = 'rejected'; 
        userMsg = '‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç–≤–æ–π –≤–∞—É—á–µ—Ä –æ—Ç–∫–ª–æ–Ω–µ–Ω. –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞, –Ω–∞–ø–∏—à–∏ –≤ üÜò –ü–æ–º–æ—â—å.'; 
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ
    await db.update(schema.vouchers).set({ status }).where(eq(schema.vouchers.id, vId));
    
    // –ò—â–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤–∞—É—á–µ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const v = await db.query.vouchers.findFirst({ where: eq(schema.vouchers.id, vId) });
    if (v?.userId) {
        const u = await db.query.users.findFirst({ where: eq(schema.users.id, v.userId) });
        if (u) {
            await bot.telegram.sendMessage(u.telegramId, userMsg).catch(() => {});
        }
    }
    
    // –ö—Ä–∞—Å–∏–≤–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É –∞–¥–º–∏–Ω–∞
    const finalLabel = action === 'reject' ? '‚ùå –û–¢–ö–õ–û–ù–ï–ù' : `‚úÖ –û–î–û–ë–†–ï–ù (${action})`;
    await ctx.editMessageCaption(`<b>–°—Ç–∞—Ç—É—Å: ${finalLabel}</b>`, { parse_mode: 'HTML' });
});
// --- 11. –ê–î–ú–ò–ù–ö–ê (–ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –û–®–ò–ë–û–ö) ---

// --- –ì–õ–ê–í–ù–´–ô –ü–£–õ–¨–¢ ---
bot.command('panel', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    return ctx.replyWithHTML(`üöÄ <b>–ê–¥–º–∏–Ω-–ø—É–ª—å—Ç Allgorithm 2.0</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:`, 
        Markup.inlineKeyboard([
            [Markup.button.callback('üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–∞–º–∏', 'admin_events_menu')],
            [Markup.button.callback('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞', 'admin_stats_menu')],
            [Markup.button.callback('üßº –¢–µ—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', 'admin_db_menu')],
            [Markup.button.callback('üì¢ –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞', 'admin_global_broadcast')]
        ]));
});

// --- –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ì–†–ê–ú–ò (–ó–î–ï–°–¨ –í–°–ï –¢–í–û–ò –ö–ù–û–ü–ö–ò!) ---
bot.action('admin_events_menu', (ctx) => {
    ctx.editMessageText(`üéÆ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–∞–º–∏ –∏ –ü—É–ª—å—Ç—ã</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É', 'admin_add_event')],
            [Markup.button.callback('üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∏–≥—Ä–µ (–î–∞—Ç–∞)', 'admin_msg_event')], // –¢–í–û–Ø –†–ê–°–°–´–õ–ö–ê
            [Markup.button.callback('üíò –ü–£–õ–¨–¢ Speed Dating', 'admin_fd_panel')],     // –¢–í–û–ô –ü–£–õ–¨–¢ –°–í–ò–î–ê–ù–ò–ô
            [Markup.button.callback('üß† –ü–£–õ–¨–¢ Stock & Know', 'admin_stock_list')],   // –¢–í–û–ô –ü–£–õ–¨–¢ –°–¢–û–ö–ê
            [Markup.button.callback('üìã –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π', 'admin_bookings')],
            [Markup.button.callback('üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É', 'admin_close_event')],
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'admin_back_main')]
        ])
    });
});

// --- 2. –ú–ï–ù–Æ –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---
bot.action('admin_stats_menu', (ctx) => {
    ctx.editMessageText(`üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('üìà –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å (Status)', 'admin_trigger_status')],
            [Markup.button.callback('üîé –ò–Ω—Å–ø–µ–∫—Ü–∏—è –∏–≥—Ä—ã (Inspect)', 'admin_bookings')], // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', 'admin_back_main')]
        ])
    });
});

// --- 3. –ú–ï–ù–Æ –¢–ï–•. –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø ---
bot.action('admin_db_menu', (ctx) => {
    ctx.editMessageText(`üßº <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('‚ú® –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—ã', 'admin_trigger_normalize')],
            [Markup.button.callback('üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—á–µ—Ç—á–∏–∫–∏', 'admin_trigger_recount')],
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', 'admin_back_main')]
        ])
    });
});

// –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
bot.action('admin_back_main', (ctx) => {
    ctx.editMessageText(`üöÄ <b>–ê–¥–º–∏–Ω-–ø—É–ª—å—Ç Allgorithm 2.0</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–∞–º–∏', 'admin_events_menu')],
            [Markup.button.callback('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞', 'admin_stats_menu')],
            [Markup.button.callback('üßº –¢–µ—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–ë–∞–∑–∞)', 'admin_db_menu')],
            [Markup.button.callback('üì¢ –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞', 'admin_global_broadcast')]
        ])
    });
});


// –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç—É—Å–∞
// –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä—è–º–æ –≤ –ø—É–ª—å—Ç
bot.action('admin_trigger_status', async (ctx) => {
    await ctx.answerCbQuery();
    // –ú—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É status (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é)
    ctx.reply('–í—ã–∑—ã–≤–∞—é –æ—Ç—á–µ—Ç... –∏—Å–ø–æ–ª—å–∑—É–π /status –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.');
});

// –ó–∞–ø—É—Å–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ –ø—É–ª—å—Ç–∞
bot.action('admin_trigger_normalize', async (ctx) => {
    await ctx.answerCbQuery();
    ctx.reply('–ó–∞–ø—É—Å–∫–∞—é –æ—á–∏—Å—Ç–∫—É... –∏—Å–ø–æ–ª—å–∑—É–π /normalize.');
});

bot.action('admin_global_broadcast', (ctx) => {
  ctx.reply('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞:');
  (ctx.session as any).waitingForGlobalBroadcast = true;
});

// –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏
bot.action('admin_add_event', (ctx) => ctx.scene.enter('ADD_EVENT_SCENE'));
bot.action('admin_msg_event', (ctx) => ctx.scene.enter('MSG_EVENT_SCENE'));



// --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞ ---

bot.command('recount', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    
    for (const event of events) {
        const realBookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) 
        });
        
        // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const uniqueUserIds = new Set(realBookings.map(b => b.userId));
        await db.update(schema.events)
            .set({ currentPlayers: uniqueUserIds.size })
            .where(eq(schema.events.id, event.id));
    }
    ctx.reply('‚ú® –°—á—ë—Ç—á–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –æ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π.');
});

bot.command('list_ids', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    try {
        const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
        if (events.length === 0) return ctx.reply('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä.');
        let msg = `üÜî <b>–°–ø–∏—Å–æ–∫ ID –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä:</b>\n\n`;
        events.forEach(e => {
            msg += `üîπ ID: <code>${e.id}</code> | ${e.dateString} | ${e.type}\n`;
        });
        await ctx.replyWithHTML(msg);
    } catch (e) { ctx.reply('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID.'); }
});

bot.command('book', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /book [ID_–Æ–∑–µ—Ä–∞] [ID_–ò–≥—Ä—ã]');

    const targetTgId = parseInt(parts[1]);
    const eventId = parseInt(parts[2]);

    try {
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, targetTgId) });
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });

        if (!user || !event) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –Æ–∑–µ—Ä –∏–ª–∏ –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ.');

        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        await db.insert(schema.bookings).values({ userId: user.id, eventId: event.id, paid: true });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ
        await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eventId));

        await ctx.reply(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∏–≥—Ä—É ‚Ññ${eventId}!`);
        await bot.telegram.sendMessage(targetTgId, 'üéâ –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–∞—à—É –∑–∞–ø–∏—Å—å –Ω–∞ –∏–≥—Ä—É! –ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏ –ø—Ä–∏–¥—ë—Ç –∑–∞ 3 —á–∞—Å–∞ –¥–æ –∏–≤–µ–Ω—Ç–∞. –î–æ –≤—Å—Ç—Ä–µ—á–∏! ‚ú®');
    } catch (e) {
        ctx.reply('‚ùå –û—à–∏–±–∫–∞: –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ —ç—Ç—É –∏–≥—Ä—É.');
    }
});

bot.command('reschedule', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    // –§–æ—Ä–º–∞—Ç: /reschedule 12 25.01.2026 19:00
    if (parts.length < 4) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /reschedule [ID_–ò–≥—Ä—ã] [–î–î.–ú–ú.–ì–ì–ì–ì] [–ß–ß:–ú–ú]');

    const eventId = parseInt(parts[1]);
    const newDateStr = `${parts[2]} ${parts[3]}`;

    try {
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –Ω–æ–≤–æ–π –¥–∞—Ç—ã
        const checkDate = DateTime.fromFormat(newDateStr, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
        if (!checkDate.isValid) {
            return ctx.reply('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã! –ù—É–∂–Ω–æ: –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä 20.01.2026 18:30)');
        }

        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –ò–≥—Ä–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // 2. –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ –±–∞–∑–µ
        await db.update(schema.events).set({ dateString: newDateStr }).where(eq(schema.events.id, eventId));

        // 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –†–ê–°–°–´–õ–ö–ê –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
        const rescheduleMsg = `‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï! –ò–ó–ú–ï–ù–ï–ù–ò–ï –í –†–ê–°–ü–ò–°–ê–ù–ò–ò!</b>\n\n` +
            `–ò–≥—Ä–∞ "${event.type}" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è:\n` +
            `üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞: <b>${newDateStr}</b>\n\n` +
            `–í—Å–µ –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏ –∏ –æ–ø–ª–∞—Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã. –ñ–¥–µ–º –≤–∞—Å! ü•Ç`;

        await broadcastToEvent(eventId, rescheduleMsg);

        await ctx.reply(`‚úÖ –ò–≥—Ä–∞ ‚Ññ${eventId} –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ${newDateStr}. –í—Å–µ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏.');
    }
});

bot.command('load_dating', (ctx) => SD.loadDatingCommand(ctx, bot));

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –∫—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ "–º–æ–∑–≥–∞—Ö" –±–æ—Ç–∞
// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –∫—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ "–º–æ–∑–≥–∞—Ö" –±–æ—Ç–∞
bot.command('check_nums', async (ctx) => {
  if (ctx.from.id !== ADMIN_ID) return;

  const ps = Array.from(SD.FAST_DATES_STATE.participants.values());
  const eventId = SD.FAST_DATES_STATE.eventId;
  const round = SD.FAST_DATES_STATE.currentRound;

  if (ps.length === 0) {
    return ctx.reply("‚ùå <b>–í –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞ –ø—É—Å—Ç–æ!</b>\n–£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π /load_dating [ID]", { parse_mode: 'HTML' });
  }

  // üî• –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–∏–ª–∏ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫
  let report = `üìä <b>–ò–ù–°–ü–ï–ö–¶–ò–Ø –ü–ê–ú–Ø–¢–ò:</b>\n`;
  report += `ID –ò–≥—Ä—ã: <b>${eventId}</b>\n`;
  report += `–¢–µ–∫—É—â–∏–π –†–∞—É–Ω–¥: <b>${round}</b>\n`;
  report += `–í—Å–µ–≥–æ –≤ –ø–∞–º—è—Ç–∏: <b>${ps.length} —á–µ–ª.</b>\n\n`;

  ps.sort((a, b) => a.num - b.num).forEach(p => {
    report += `<b>‚Ññ${p.num}</b> ‚Äî ${p.name} (@${p.username || '–Ω–µ—Ç'}) [${p.gender === '–ú—É–∂—á–∏–Ω–∞' ? '–ú' : '–ñ'}]\n`;
  });

  await ctx.reply(report, { parse_mode: 'HTML' });
});

// --- 11. –ö–û–ú–ê–ù–î–ê: –û–¢–ú–ï–ù–ê –° –í–´–î–ê–ß–ï–ô –í–ê–£–ß–ï–†–ê (–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è) ---
bot.command('cancel_with_voucher', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    // –§–æ—Ä–º–∞—Ç: /cancel_with_voucher [TG_ID_–£—á–∞—Å—Ç–Ω–∏–∫–∞] [ID_–ò–≥—Ä—ã]
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /cancel_with_voucher [TG_ID] [ID_–ò–≥—Ä—ã]');

    const targetTgId = parseInt(parts[1]);
    const eventId = parseInt(parts[2]);

    try {
        // 1. –ò—â–µ–º —é–∑–µ—Ä–∞ –∏ –∏–≥—Ä—É
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, targetTgId) });
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!user || !event) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –Æ–∑–µ—Ä –∏–ª–∏ –∏–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');

        // 2. –ò—â–µ–º –∑–∞–ø–∏—Å—å –Ω–∞ –∏–≥—Ä—É
        const booking = await db.query.bookings.findFirst({ 
            where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, event.id)) 
        });
        if (!booking) return ctx.reply('‚ùå –ó–∞–ø–∏—Å—å –Ω–∞ —ç—Ç—É –∏–≥—Ä—É –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // 3. –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã bookings
        await db.delete(schema.bookings).where(eq(schema.bookings.id, booking.id));

        // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º 1 —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ –∏–≥—Ä–µ
        await db.update(schema.events)
            .set({ currentPlayers: Math.max(0, (event.currentPlayers || 0) - 1) })
            .where(eq(schema.events.id, event.id));

        // 5. –ù–∞—á–∏—Å–ª—è–µ–º FREE –≤–∞—É—á–µ—Ä (–¥–ª—è –±—É–¥—É—â–∏—Ö –æ–ø–ª–∞—Ç)
        await db.insert(schema.vouchers).values({
            userId: user.id,
            status: 'approved_free',
            photoFileId: 'MANUAL' 
        });

        // 6. –£–≤–µ–¥–æ–º–ª—è–µ–º —á–µ–ª–æ–≤–µ–∫–∞ –æ–± –æ—Ç–º–µ–Ω–µ –∏ –ø–æ–¥–∞—Ä–∫–µ
        const userNotice = `üö´ <b>–í–∞—à–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –∏–≥—Ä—É –æ—Ç–º–µ–Ω–µ–Ω–∞</b>\n\n` +
            `–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–∏–ª —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã "${event.type}".\n\n` +
            `üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω –≤–∞—É—á–µ—Ä –Ω–∞ <b>–ë–ï–°–ü–õ–ê–¢–ù–£–Æ –ò–ì–†–£</b>. –û–Ω —É–∂–µ –∂–¥–µ—Ç —Ç–µ–±—è –≤ –õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ!`;
        await bot.telegram.sendMessage(targetTgId, userNotice, { parse_mode: 'HTML' }).catch(()=>{});

        await ctx.reply(`‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ ${user.name} —É–¥–∞–ª–µ–Ω. –ú–µ—Å—Ç–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ, —é–∑–µ—Ä—É –≤—ã–¥–∞–Ω FREE –≤–∞—É—á–µ—Ä.`);

        // --- –ú–ê–ì–ò–Ø –û–ß–ï–†–ï–î–ò: –ò—â–µ–º, –∫–æ–º—É –æ—Ç–¥–∞—Ç—å –º–µ—Å—Ç–æ (–í–ù–£–¢–†–ò try) ---
        const nextInLine = await db.query.bookings.findFirst({
            where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, false)),
            orderBy: [asc(schema.bookings.id)] 
        });

        if (nextInLine) {
            const candidate = await db.query.users.findFirst({ where: eq(schema.users.id, nextInLine.userId) });
            if (candidate) {
                await bot.telegram.sendMessage(candidate.telegramId, 
                    `üî• <b>–•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏!</b>\n\n–ù–∞ –∏–≥—Ä—É "${event.type}" (${event.dateString}) –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å –º–µ—Å—Ç–æ! ü•Ç\n\n–°–∫–æ—Ä–µ–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ "–ò–≥—Ä—ã", —á—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –µ–≥–æ!`, 
                    { parse_mode: 'HTML' }).catch(()=>{});
            }
        }

    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Ç–º–µ–Ω—ã —Å –≤–∞—É—á–µ—Ä–æ–º.');
    }
});

bot.command('kick', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /kick [TG_ID] [ID_–ò–≥—Ä—ã]');
    const targetTgId = parseInt(parts[1]);
    const eventId = parseInt(parts[2]);
    try {
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, targetTgId) });
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        const booking = await db.query.bookings.findFirst({ where: and(eq(schema.bookings.userId, user!.id), eq(schema.bookings.eventId, eventId)) });
        if (booking) {
            await db.delete(schema.bookings).where(eq(schema.bookings.id, booking.id));
            await db.update(schema.events).set({ currentPlayers: Math.max(0, (event!.currentPlayers || 0) - 1) }).where(eq(schema.events.id, eventId));
            await ctx.reply(`‚úÖ –£–¥–∞–ª–µ–Ω.`);
            await notifyNextInWaitlist(eventId, event!.type, event!.dateString);
        }
    } catch (e) { 
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞'); 
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø–∏—Å–∏" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä
bot.action('admin_bookings', async (ctx) => {
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    if (events.length === 0) return ctx.reply('–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä –Ω–µ—Ç.');
    
    const btns = events.map(e => [Markup.button.callback(`${e.dateString} | ${e.type}`, `view_ev_bks_${e.id}`)]);
    ctx.editMessageText('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', Markup.inlineKeyboard(btns));
});

// 3. –ü—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –í–°–ï–•)
bot.action(/view_ev_bks_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    const bookings = await db.query.bookings.findMany({ where: eq(schema.bookings.eventId, eid) });
    if (bookings.length === 0) return ctx.reply('–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.');

    let msg = `üìã <b>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∏–≥—Ä—É:</b>\n\n`;
    const seenUsers = new Set(); // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥—É–±–ª–µ–π –≤ —Å–ø–∏—Å–∫–µ

    for (const b of bookings) {
        if (seenUsers.has(b.userId)) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ –≤—ã–≤–µ–ª–∏ —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
        seenUsers.add(b.userId);

        const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
        const status = b.paid ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚è≥ –ñ–¥–µ—Ç –æ–ø–ª–∞—Ç—ã';
        msg += `‚Ä¢ ${u?.name || '–ê–Ω–æ–Ω–∏–º'} (@${u?.username || '–Ω–µ—Ç'}) \n   ID: <code>${u?.telegramId}</code> ‚Äî <b>${status}</b>\n\n`;
    }
    ctx.replyWithHTML(msg);
});

bot.command('inspect', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 2) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /inspect [ID_–ò–≥—Ä—ã]');

    const eventId = parseInt(parts[1]);
    const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
    if (!event) return ctx.reply('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

    const bookings = await db.query.bookings.findMany({ where: eq(schema.bookings.eventId, eventId) });
    
    let report = `üîé <b>–ò–ù–°–ü–ï–ö–¶–ò–Ø –ò–ì–†–´ ‚Ññ${eventId}</b> (${event.type})\n`;
    report += `–õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª: <b>${event.maxPlayers / 2}</b>\n\n`;

    let realMen = 0;
    let realWomen = 0;

    for (const [index, b] of bookings.entries()) {
        const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
        const gender = u?.gender || '‚ö†Ô∏è NULL';
        const paidStatus = b.paid ? '‚úÖ' : '‚è≥';
        
        if (gender === '–ú—É–∂—á–∏–Ω–∞' && b.paid) realMen++;
        if (gender === '–ñ–µ–Ω—â–∏–Ω–∞' && b.paid) realWomen++;

        report += `${index + 1}. ${paidStatus} <b>${u?.name || '–ê–Ω–æ–Ω–∏–º'}</b>\n`;
        report += `   ID: <code>${u?.id}</code> | TG: <code>${u?.telegramId}</code>\n`;
        report += `   –ü–û–õ: ¬´<b>${gender}</b>¬ª\n\n`;
    }

    report += `üìä <b>–ò–¢–û–ì–û –û–ü–õ–ê–ß–ï–ù–û:</b>\n`;
    report += `üï∫ –ú—É–∂—á–∏–Ω: ${realMen}\n`;
    report += `üíÉ –ñ–µ–Ω—â–∏–Ω: ${realWomen}`;

    await ctx.replyWithHTML(report);
});

bot.command('set_limit', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    // –§–æ—Ä–º–∞—Ç: /set_limit [ID_–ò–≥—Ä—ã] [–ù–æ–≤–æ–µ_–ß–∏—Å–ª–æ]
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /set_limit [ID_–ò–≥—Ä—ã] [–ù–æ–≤–æ–µ_–ö–æ–ª_–≤–æ_–ú–µ—Å—Ç]');

    const eventId = parseInt(parts[1]);
    const newMax = parseInt(parts[2]);

    if (isNaN(eventId) || isNaN(newMax)) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏ —á–∏—Å–ª–∞.');

    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç –≤ –±–∞–∑–µ
        await db.update(schema.events)
            .set({ maxPlayers: newMax })
            .where(eq(schema.events.id, eventId));

        const limitPerGender = newMax / 2;
        
        await ctx.replyWithHTML(
            `‚úÖ <b>–õ–∏–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω!</b>\n\n` +
            `–ò–≥—Ä–∞ ‚Ññ${eventId} (${event.type})\n` +
            `–ù–æ–≤–æ–µ –æ–±—â–µ–µ –∫–æ–ª-–≤–æ –º–µ—Å—Ç: <b>${newMax}</b>\n` +
            `–õ–∏–º–∏—Ç –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ–ª: <b>${limitPerGender}</b>\n\n` +
            `<i>–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å –º–µ—Å—Ç–∞ –∏—Å—Ö–æ–¥—è –∏–∑ —ç—Ç–∏—Ö —Ü–∏—Ñ—Ä.</i>`
        );
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞.');
    }
});

bot.command('normalize', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    
    try {
        const users = await db.query.users.findMany();
        let count = 0;

        for (const u of users) {
            const g = (u.gender || '').toLowerCase();
            let newGender = u.gender;

            // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –µ—Å—Ç—å "–º—É–∂", –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "–ú—É–∂—á–∏–Ω–∞"
            if (g.includes('–º—É–∂')) newGender = '–ú—É–∂—á–∏–Ω–∞';
            // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –µ—Å—Ç—å "–∂–µ–Ω", –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "–ñ–µ–Ω—â–∏–Ω–∞"
            else if (g.includes('–∂–µ–Ω')) newGender = '–ñ–µ–Ω—â–∏–Ω–∞';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (newGender !== u.gender) {
                await db.update(schema.users)
                    .set({ gender: newGender })
                    .where(eq(schema.users.id, u.id));
                count++;
            }
        }
        await ctx.reply(`‚ú® –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è —É–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${count}. –¢–µ–ø–µ—Ä—å –≤—Å–µ –≤ –±–∞–∑–µ ‚Äî –ª–∏–±–æ "–ú—É–∂—á–∏–Ω–∞", –ª–∏–±–æ "–ñ–µ–Ω—â–∏–Ω–∞".`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á–∏—Å—Ç–∫–µ –±–∞–∑—ã.');
    }
});

bot.command('status', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    
    const activeEvents = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    if (activeEvents.length === 0) return ctx.reply('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä.');

    let report = `üìä <b>–û–¢–ß–ï–¢ –ü–û –í–°–ï–ú –ò–ì–†–ê–ú:</b>\n\n`;

    for (const ev of activeEvents) {
        const bookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, ev.id), eq(schema.bookings.paid, true)) 
        });

        let m = 0, w = 0;
        for (const b of bookings) {
            const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
            if (u?.gender === '–ú—É–∂—á–∏–Ω–∞') m++;
            if (u?.gender === '–ñ–µ–Ω—â–∏–Ω–∞') w++;
        }

        report += `üîπ <b>${ev.dateString} | ${ev.type}</b>\n`;
        report += `   –°–≤–æ–±–æ–¥–Ω–æ: ${ev.maxPlayers - bookings.length} –∏–∑ ${ev.maxPlayers}\n`;
        report += `   –ë–∞–ª–∞–Ω—Å: üï∫ ${m} | üíÉ ${w}\n`;
        report += `   ID –¥–ª—è –∫–æ–º–∞–Ω–¥: <code>${ev.id}</code>\n\n`;
    }

    await ctx.replyWithHTML(report);
});

// 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Speed Dating –∏ Stock
bot.action('admin_fd_panel', (ctx) => SD.getAdminFDCPanel(ctx));

bot.action('admin_stock_list', (ctx) => {
    const btns = STOCK_QUESTIONS.map((q, i) => [Markup.button.callback(`–í–æ–ø—Ä–æ—Å ‚Ññ${i+1}`, `sk_pick_${i}`)]);
    ctx.editMessageText('üß† –í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:', Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'admin_back_to_panel')]]));
});

bot.action('admin_close_event', async (ctx) => {
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    const btns = events.map(e => [Markup.button.callback(`üõë –ó–∞–∫—Ä—ã—Ç—å: ${e.dateString}`, `exec_close_${e.id}`)]);
    ctx.editMessageText('–ö–∞–∫—É—é –∏–≥—Ä—É –∑–∞–≤–µ—Ä—à–∏—Ç—å?', Markup.inlineKeyboard(btns));
});

bot.action(/exec_close_(\d+)/, async (ctx) => {
    await autoCloseEvent(parseInt(ctx.match[1]));
    ctx.reply('‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã!');
});

bot.action('admin_back_to_panel', (ctx) => {
    ctx.deleteMessage();
    return ctx.reply('–í–æ–∑–≤—Ä–∞—Ç –≤ –ø–∞–Ω–µ–ª—å...', Markup.inlineKeyboard([[Markup.button.callback('–û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å', 'panel')]]));
});

bot.command('assign_stock', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 2) return ctx.reply('‚ùå –û—à–∏–±–∫–∞! –ò—Å–ø–æ–ª—å–∑—É–π: /assign_stock [ID_–ò–≥—Ä—ã]');

    const eventId = parseInt(parts[1]);
    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –ò–≥—Ä–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        const bookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true)) 
        });

        if (bookings.length === 0) return ctx.reply('‚ùå –ù–∞ —ç—Ç—É –∏–≥—Ä—É –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.');

        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –Ω–æ–≤—ã–π ID –∏–≥—Ä—ã
        STOCK_STATE.participants.clear();
        STOCK_STATE.playerAnswers.clear();
        STOCK_STATE.currentEventId = eventId; // <--- –§–∏–∫—Å–∏—Ä—É–µ–º –∏–≥—Ä—É

        let count = 0;
        for (let i = 0; i < bookings.length; i++) {
            const user = await db.query.users.findFirst({ where: eq(schema.users.id, bookings[i].userId) });
            if (user) {
                const playerNum = i + 1;
                STOCK_STATE.participants.set(user.telegramId, { 
                    id: user.id, 
                    num: playerNum, 
                    name: user.name || user.firstName || '–ò–≥—Ä–æ–∫' 
                });

                // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫—É (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, –∏ –¥–ª—è Review)
                await bot.telegram.sendMessage(user.telegramId, 
                    `üß† <b>–¢–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –Ω–æ–º–µ—Ä –≤ Stock & Know: ${playerNum}</b>\n\n` +
                    `–ó–∞–ø–æ–º–Ω–∏ –µ–≥–æ! –¢–µ–ø–µ—Ä—å —Ç–≤–æ–∏ —Å—Ç–∞–≤–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É –Ω–æ–º–µ—Ä—É. –£–¥–∞—á–∏! üí∞üé∞`,
                    { parse_mode: 'HTML' }
                ).catch(() => {});
                count++;
            }
        }

        await ctx.reply(`‚úÖ –ù–æ–º–µ—Ä–∞ —Ä–∞–∑–¥–∞–Ω—ã –¥–ª—è –∏–≥—Ä—ã ‚Ññ${eventId} (${event.type})!\n–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${count}\n\n–¢–µ–ø–µ—Ä—å –≤–æ–ø—Ä–æ—Å—ã –≤ –ø—É–ª—å—Ç–µ –±—É–¥—É—Ç —É–ª–µ—Ç–∞—Ç—å –∏–º–µ–Ω–Ω–æ –∏–º.`, { parse_mode: 'HTML' });
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–¥–∞—á–µ –Ω–æ–º–µ—Ä–æ–≤.');
    }
});
bot.command('players', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    if (STOCK_STATE.participants.size === 0) return ctx.reply('–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –ø—É—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π /assign_stock [ID]');

    let msg = `üìã <b>–¢–µ–∫—É—â–∏–µ –∏–≥—Ä–æ–∫–∏ Stock & Know:</b>\n\n`;
    const sorted = Array.from(STOCK_STATE.participants.values()).sort((a, b) => a.num - b.num);
    
    for (const p of sorted) {
        msg += `üîπ ‚Ññ${p.num} ‚Äî ${p.name} (ID: <code>${p.id}</code>)\n`;
    }
    
    await ctx.replyWithHTML(msg);
});

bot.action(/sk_win_(\d+)_(\d+)/, async (ctx) => {
  const pNum = ctx.match[1];
  const eventId = parseInt(ctx.match[2]);
  
  try {
    // 1. –û–±—ä—è–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    const winAnnounce = `üéä <b>–†–ê–£–ù–î –ó–ê–í–ï–†–®–ï–ù!</b> üéä\n\nüèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞ ‚Äî <b>–ò–≥—Ä–æ–∫ ‚Ññ${pNum}</b>! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! ‚ú®üìà`;
    await broadcastToEvent(eventId, winAnnounce);
    
    // 2. –û—á–∏—â–∞–µ–º —Å—Ç–∞–≤–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    STOCK_STATE.playerAnswers.clear();
    
    await ctx.answerCbQuery(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å ‚Ññ${pNum} –æ–±—ä—è–≤–ª–µ–Ω!`);

    // 3. –û–ë–ù–û–í–õ–Ø–ï–ú –¢–ï–ö–°–¢ –£ –ê–î–ú–ò–ù–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º editMessageText)
    await ctx.editMessageText(`‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞ –≤—ã–±—Ä–∞–Ω: <b>–ò–≥—Ä–æ–∫ ‚Ññ${pNum}</b>`, { parse_mode: 'HTML' });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:", e);
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø—Ä–æ—Å—Ç–æ —à–ª–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await ctx.reply(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞: ‚Ññ${pNum}`);
  }
});

// --- –õ–û–ì–ò–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò –ú–≠–¢–ß–ï–ô ---

// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–í–ò–î–ê–ù–ò–Ø–ú–ò (–≤ index.ts) ---

bot.action('fd_start_game', async (ctx) => {
    const ps = Array.from(SD.FAST_DATES_STATE.participants.values());
    // –£–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –±–∞–∑–µ –æ—à–∏–±–∫–∞, –º—ã –ø–æ–π–º–µ–º –∫—Ç–æ –µ—Å—Ç—å –∫—Ç–æ
    const women = ps.filter(p => p.gender.toLowerCase().includes('–∂–µ–Ω')).sort((a,b) => a.num - b.num);
    const men = ps.filter(p => p.gender.toLowerCase().includes('–º—É–∂')).sort((a,b) => a.num - b.num);

    if (women.length === 0 || men.length === 0) return ctx.reply("‚ùå –û—à–∏–±–∫–∞: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");

    SD.FAST_DATES_STATE.currentRound = 1;
    const topic = CONVERSATION_TOPICS[Math.floor(Math.random() * CONVERSATION_TOPICS.length)];

    for (let i = 0; i < women.length; i++) {
        const tableNum = i + 1;
        const woman = women[i];
        const man = men[i];

        // –°–æ–æ–±—â–µ–Ω–∏–µ –ñ–ï–ù–©–ò–ù–ï (–ù–µ—á–µ—Ç–Ω—ã–µ: 1, 3, 5...)
        const msgW = `üöÄ <b>–†–ê–£–ù–î ‚Ññ1</b>\n\n` +
                    `–ó–∞–π–º–∏—Ç–µ –º–µ—Å—Ç–æ –∑–∞ <b>—Å—Ç–æ–ª–∏–∫–æ–º ‚Ññ${tableNum}</b>.\n` +
                    `–ö –≤–∞–º –ø–æ–¥—Å–∞–∂–∏–≤–∞–µ—Ç—Å—è: <b>–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${man.num}</b>\n\n` +
                    `<b>–¢–µ–º–∞:</b> ${topic}\n` +
                    `<i>–ù–∞—á–∏–Ω–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏—Ü–∞ ‚Ññ${woman.num}!</i>`;

        // –°–æ–æ–±—â–µ–Ω–∏–µ –ú–£–ñ–ß–ò–ù–ï (–ß–µ—Ç–Ω—ã–µ: 2, 4, 6...)
        const msgM = `üöÄ <b>–†–ê–£–ù–î ‚Ññ1</b>\n\n` +
                    `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–π–¥–∏—Ç–µ –∑–∞ <b>—Å—Ç–æ–ª–∏–∫ ‚Ññ${tableNum}</b>.\n` +
                    `–í–∞—Å –∂–¥—ë—Ç: <b>–£—á–∞—Å—Ç–Ω–∏—Ü–∞ ‚Ññ${woman.num}</b>\n\n` +
                    `<b>–¢–µ–º–∞:</b> ${topic}\n` +
                    `<i>–ù–∞—á–∏–Ω–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏—Ü–∞ ‚Ññ${woman.num}!</i>`;

        await bot.telegram.sendMessage(woman.id, msgW, { parse_mode: 'HTML', ...getMainKeyboard(true) }).catch(()=>{});
        await bot.telegram.sendMessage(man.id, msgM, { parse_mode: 'HTML', ...getMainKeyboard(true) }).catch(()=>{});
    }
    await ctx.editMessageText("üì¢ –†–∞—É–Ω–¥ ‚Ññ1 –∑–∞–ø—É—â–µ–Ω! –ö–Ω–æ–ø–∫–∏ —Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.");
});

bot.action('fd_next_round', async (ctx) => {
    const ps = Array.from(SD.FAST_DATES_STATE.participants.values());
    const women = ps.filter(p => p.gender.toLowerCase().includes('–∂–µ–Ω')).sort((a,b) => a.num - b.num);
    const men = ps.filter(p => p.gender.toLowerCase().includes('–º—É–∂')).sort((a,b) => a.num - b.num);

    SD.FAST_DATES_STATE.currentRound++;
    const round = SD.FAST_DATES_STATE.currentRound;

    if (round > women.length) {
        return ctx.editMessageText("üèÅ <b>–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å!</b>", { parse_mode: 'HTML' });
    }

    const topic = CONVERSATION_TOPICS[Math.floor(Math.random() * CONVERSATION_TOPICS.length)];

    for (let i = 0; i < women.length; i++) {
        const tableNum = i + 1;
        const woman = women[i];
        const man = men[(i + round - 1) % men.length];

        // –¢–ï–ö–°–¢ –î–õ–Ø –ñ–ï–ù–©–ò–ù–´ (–û–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è)
        const msgW = `üîÑ <b>–†–ê–£–ù–î ‚Ññ${round}</b>\n\n` +
                    `–û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –∑–∞ <b>—Å—Ç–æ–ª–∏–∫–æ–º ‚Ññ${tableNum}</b>.\n` +
                    `–ö –≤–∞–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç: <b>–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${man.num}</b>\n\n` +
                    `<b>–¢–µ–º–∞:</b> ${topic}\n` +
                    `<i>–ù–∞—á–∏–Ω–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏—Ü–∞ ‚Ññ${woman.num}!</i>`;

        // –¢–ï–ö–°–¢ –î–õ–Ø –ú–£–ñ–ß–ò–ù–´ (–û–Ω –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç)
        const msgM = `üîÑ <b>–†–ê–£–ù–î ‚Ññ${round}</b>\n\n` +
                    `–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ <b>—Å—Ç–æ–ª–∏–∫—É ‚Ññ${tableNum}</b>.\n` +
                    `–¢–∞–º –≤–∞—Å –∂–¥—ë—Ç: <b>–£—á–∞—Å—Ç–Ω–∏—Ü–∞ ‚Ññ${woman.num}</b>\n\n` +
                    `<b>–¢–µ–º–∞:</b> ${topic}\n` +
                    `<i>–ù–∞—á–∏–Ω–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏—Ü–∞ ‚Ññ${woman.num}!</i>`;

        await bot.telegram.sendMessage(woman.id, msgW, { parse_mode: 'HTML', ...getMainKeyboard(true) }).catch(()=>{});
        await bot.telegram.sendMessage(man.id, msgM, { parse_mode: 'HTML', ...getMainKeyboard(true) }).catch(()=>{});
    }
    await ctx.reply(`üì¢ –ó–∞–ø—É—â–µ–Ω —Ä–∞—É–Ω–¥ ‚Ññ${round}!`);
});

bot.action('admin_stats', async (ctx) => {
  const allUsers = await db.query.users.findMany();
  const allPaidBookings = await db.query.bookings.findMany({ where: eq(schema.bookings.paid, true) });
  const totalRevenue = allPaidBookings.length * 50; // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é –≤—ã—Ä—É—á–∫—É

  const statsMsg = `üìä <b>–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–õ–£–ë–ê</b>\n\n` +
    `üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ: <b>${allUsers.length}</b>\n` +
    `üéü –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–Ω–æ –±–∏–ª–µ—Ç–æ–≤: <b>${allPaidBookings.length}</b>\n` +
    `üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: <b>${totalRevenue} PLN</b>`;

  await ctx.editMessageText(statsMsg, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([[Markup.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', 'admin_back_to_panel')]]) 
  });
});

bot.action(/fd_edit_(\d+)/, (ctx) => SD.editParticipantLikes(ctx));

bot.action(/fd_tog_(\d+)_(\d+)/, (ctx) => SD.toggleParticipantLike(ctx));

bot.action('fd_calc_matches', (ctx) => SD.calculateMatches(ctx, bot));

// --- –í–û–ó–í–†–ê–¢ –§–£–ù–ö–¶–ò–ô –ü–£–õ–¨–¢–ê ---
// --- –ü–£–õ–¨–¢–´ (FD –ò STOCK) ---
bot.action('fd_input_start', ctx => { 
  const btns = Array.from(SD.FAST_DATES_STATE.participants.values()).sort((a,b)=>a.num-b.num).map(p => [Markup.button.callback(`‚Ññ${p.num} (${p.gender[0]})`, `fd_edit_${p.id}`)]); 
  ctx.editMessageText('–ß—å—é –∞–Ω–∫–µ—Ç—É –≤–≤–æ–¥–∏–º?', Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô', 'admin_fd_panel')]])); 
});

bot.action(/sk_pick_(\d+)/, (ctx) => {
  STOCK_STATE.currentQuestionIndex = parseInt(ctx.match[1]); STOCK_STATE.playerAnswers.clear();
  ctx.editMessageText(`–í–æ–ø—Ä–æ—Å –≤—ã–±—Ä–∞–Ω.`, Markup.inlineKeyboard([[Markup.button.callback('üöÄ –û–¢–ü–†–ê–í–ò–¢–¨', 'stock_send_phase_0')]]));
});

bot.action(/stock_send_phase_(\d+)/, async (ctx) => {
  const phase = parseInt(ctx.match[1]);
  const q = STOCK_QUESTIONS[STOCK_STATE.currentQuestionIndex];
  
  // –ë–µ—Ä–µ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID
  const eventId = STOCK_STATE.currentEventId; 

  if (!eventId) {
    return ctx.reply('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–≥—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /assign_stock [ID]');
  }

  let msg = "";
  if (phase === 0) msg = `‚ùì <b>–í–û–ü–†–û–°:</b>\n${q.question}`;
  else if (phase <= 3) msg = `üí° <b>–ü–û–î–°–ö–ê–ó–ö–ê ‚Ññ${phase}:</b>\n${q.hints[phase-1]}`;
  else msg = `üèÅ <b>–û–¢–í–ï–¢: ${q.answer}</b>\n\n${q.fact}`;

  // –®–ª–µ–º —Å—Ç—Ä–æ–≥–æ –ø–æ –∞–¥—Ä–µ—Å—É
  await broadcastToEvent(eventId, msg);

  // –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  if (phase === 4) {
    let resultsMsg = `üìä <b>–†–ï–ó–£–õ–¨–¢–ê–¢–´ (–ò–≥—Ä–∞ ‚Ññ${eventId}):</b>\n–û—Ç–≤–µ—Ç: <b>${q.answer}</b>\n\n`;
    const winnerBtns = [];
    const correctVal = parseInt(q.answer);

    for (const [tgId, bet] of STOCK_STATE.playerAnswers.entries()) {
      const p = STOCK_STATE.participants.get(tgId);
      if (p) {
        const diff = Math.abs(correctVal - bet);
        resultsMsg += `‚Ññ${p.num} (${p.name}): <b>${bet}</b> (—Ä–∞–∑–Ω–∏—Ü–∞: ${diff})\n`;
        winnerBtns.push([Markup.button.callback(`üèÜ –ü–æ–±–µ–¥–∞ ‚Ññ${p.num}`, `sk_win_${p.num}_${eventId}`)]);
      }
    }
    await bot.telegram.sendMessage(ADMIN_ID, resultsMsg, { parse_mode: 'HTML', ...Markup.inlineKeyboard(winnerBtns) });
  }

  const buttons = [];
  if (phase < 4) {
    buttons.push([Markup.button.callback(phase === 3 ? '‚úÖ –ü–û–ö–ê–ó–ê–¢–¨ –û–¢–í–ï–¢' : `üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ ${phase+1}`, `stock_send_phase_${phase+1}`)]);
  } else {
    buttons.push([Markup.button.callback('‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å', 'admin_stock_list')]);
  }
  
  await ctx.editMessageText(`–§–∞–∑–∞ ${phase} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–≥—Ä–æ–∫–∞–º ‚Ññ${eventId}.`, Markup.inlineKeyboard(buttons));
});

// --- 12. –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô ---

bot.on('message', async (ctx, next) => {
    const userId = ctx.from?.id;
    const sess = ctx.session as any;
    const text = (ctx.message as any).text;
    if (!userId || !text) return next();

    // –†–∞—Å—Å—ã–ª–∫–∞
    if (sess?.waitingForBroadcast && userId === ADMIN_ID) {
        const users = await db.query.users.findMany();
        for (const u of users) { try { await ctx.telegram.copyMessage(u.telegramId, ctx.chat!.id, ctx.message.message_id); } catch(e) {} }
        sess.waitingForBroadcast = false;
        return ctx.reply(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!`);
    }
    if (sess?.waitingForGlobalBroadcast && userId === ADMIN_ID) {
    const allUsers = await db.query.users.findMany();
    let count = 0;
    for (const u of allUsers) {
        try {
            await ctx.telegram.sendMessage(u.telegramId, `üì¢ <b>–û–±—ä—è–≤–ª–µ–Ω–∏–µ –ê–ª–≥–æ—Ä–∏—Ç–º–∞:</b>\n\n${text}`, { parse_mode: 'HTML' });
            count++;
        } catch (e) { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–∏—Ö –±–æ—Ç–∞ */ }
    }
    sess.waitingForGlobalBroadcast = false;
    return ctx.reply(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${count} —á–µ–ª.`);
}

    // –°—Ç–∞–≤–∫–∏ Stock & Know
    // –°—Ç–∞–≤–∫–∏ Stock & Know
    if (STOCK_STATE.currentQuestionIndex !== -1 && !isNaN(parseInt(text)) && !text.startsWith('/')) {
        const player = STOCK_STATE.participants.get(userId);
        
        if (player) {
            if (!STOCK_STATE.playerAnswers.has(userId)) {
                STOCK_STATE.playerAnswers.set(userId, parseInt(text));
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –∏–≥—Ä–æ–∫–∞
                await ctx.reply(`‚úÖ –ò–≥—Ä–æ–∫ ‚Ññ${player.num}, —Ç–≤–æ—è —Å—Ç–∞–≤–∫–∞ ${text} –ø—Ä–∏–Ω—è—Ç–∞! üé∞`);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç–µ–±—è (–∞–¥–º–∏–Ω–∞), —á—Ç–æ–±—ã —Ç—ã –≤–∏–¥–µ–ª–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å
                await bot.telegram.sendMessage(ADMIN_ID, `üìà –°—Ç–∞–≤–∫–∞ –æ—Ç –ò–≥—Ä–æ–∫–∞ ‚Ññ${player.num} (${player.name}): <b>${text}</b>`).catch(()=>{});
                return;
            } else {
                return ctx.reply(`‚ö†Ô∏è –ò–≥—Ä–æ–∫ ‚Ññ${player.num}, —Ç—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ!`);
            }
        } else {
            // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç —Ü–∏—Ñ—Ä—ã, –Ω–æ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤
            return ctx.reply(`‚ùå –¢—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã Stock & Know.`);
        }
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞
    if (sess?.waitingForSupport) {
        const adminMsg = `üÜò <b>–í–û–ü–†–û–° –í –ü–û–î–î–ï–†–ñ–ö–£</b>\n\n–û—Ç: ${ctx.from.first_name} (@${ctx.from.username || '–Ω–µ—Ç'})\nID: <code>${ctx.from.id}</code>\n\n–¢–µ–∫—Å—Ç: ${text}\n\n<code>/reply ${ctx.from.id} </code>`;
        await ctx.telegram.sendMessage(ADMIN_ID, adminMsg, { parse_mode: 'HTML' });
        ctx.reply('‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        sess.waitingForSupport = false;
        return;
    }
    return next();
});

bot.command('reply', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const p = ctx.message.text.split(' ');
    if (p.length < 3) return ctx.reply('–§–æ—Ä–º–∞—Ç: /reply ID —Ç–µ–∫—Å—Ç');
    bot.telegram.sendMessage(p[1], `üëÆ‚Äç‚ôÇÔ∏è <b>–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞:</b>\n\n${p.slice(2).join(' ')}`, { parse_mode: 'HTML' }).catch(()=>{});
});



// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–∞
bot.action('start_registration', (ctx) => { ctx.deleteMessage(); ctx.scene.enter('REGISTER_SCENE'); });

// --- –í–û–ó–í–†–ê–©–ê–ï–ú –ü–†–û–ü–ê–í–®–ò–ï –ö–û–ú–ê–ù–î–´ (30+ –°–¢–†–û–ö) ---



// --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ü–ò–°–¨ –ü–û–°–õ–ï –û–ü–õ–ê–¢–´ (WEBHOOK) ---
async function handleSuccessfulPayment(session: any) {
  const { telegramId, eventId, voucherId } = session.metadata;
  const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, parseInt(telegramId)) });
  const event = await db.query.events.findFirst({ where: eq(schema.events.id, parseInt(eventId)) });
  
  if (!user || !event) return;

  // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–æ–π "–Ø –æ–ø–ª–∞—Ç–∏–ª", –≤—ã—Ö–æ–¥–∏–º –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–±–∞–≤–ª—è–µ–º!
  const existing = await db.query.bookings.findFirst({ 
    where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, event.id)) 
  });
  if (existing) return; 

  await db.insert(schema.bookings).values({ userId: user.id, eventId: event.id, paid: true });
  await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, event.id));

  // 4. –ì–∞—Å–∏–º –≤–∞—É—á–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
  if (voucherId) await db.update(schema.vouchers).set({ status: 'used' }).where(eq(schema.vouchers.id, parseInt(voucherId)));

  // 5. –ë–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–∞–ª—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if (user.invitedBy) {
    const inviter = await db.query.users.findFirst({ where: eq(schema.users.id, user.invitedBy) });
    if (inviter) {
      await db.insert(schema.vouchers).values({ userId: inviter.id, status: 'approved_10' });
      bot.telegram.sendMessage(inviter.telegramId, `üéâ –¢–≤–æ–π –¥—Ä—É–≥ –æ–ø–ª–∞—Ç–∏–ª –∏–≥—Ä—É! –¢–µ–±–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ -10 PLN!`).catch(() => {});
      await db.update(schema.users).set({ invitedBy: null }).where(eq(schema.users.id, user.id));
    }
  }

// 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
 // 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
  // 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
  // 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
  let messageText = `üéâ <b>–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –¢—ã –≤ –∏–≥—Ä–µ!</b>\n\n` +
                    `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–∫–æ—Ä–æ—Ç–∫–æ):</b>\n` +
                    `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞. –ü–æ–∑–∂–µ —Å—É–º–º–∞ ¬´—Å–≥–æ—Ä–∞–µ—Ç¬ª.\n` +
                    `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
                    `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n`;

// –ü—Ä–æ—Å–∏–º –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ Talk & Toast
  if (event.type.includes('talk_toast')) {
      messageText += `ü§´ <b>–ö—Å—Ç–∞—Ç–∏!</b> –î–ª—è –Ω–∞—à–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –Ω–∞–º –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏ –≤ üë§ <b>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</b> -> <b>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</b> –∏ –Ω–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∑–∞–±–∞–≤–Ω—ã–π –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ñ–∞–∫—Ç –æ —Å–µ–±–µ. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–µ—á–µ—Ä –≤ —Ä–∞–∑—ã –∫—Ä—É—á–µ! ‚ú®\n\n`;
  }

  messageText += `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.\n\n–î–æ –≤—Å—Ç—Ä–µ—á–∏! üòé`;

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  await bot.telegram.sendMessage(user.telegramId, messageText, { parse_mode: 'HTML' }).catch(() => {});
// –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∏–≥—Ä—ã, –∞ –ü–û–¢–û–ú –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
  // 7. –£–¥–∞–ª—è–µ–º –∏–∑ –±—Ä–æ—à–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã
  PENDING_PAYMENTS.delete(`${user.id}`);
}

// --- –ó–ê–©–ò–¢–ù–´–ô –©–ò–¢ –û–¢ –û–®–ò–ë–û–ö (—á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–∞–¥–∞–ª) ---
bot.catch((err: any, ctx) => {
¬† const errorDescription = err.description || err.message || "";
¬† if (errorDescription.includes("message is not modified")) {
¬† ¬† return; // –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ç–æ—Ç –∂–µ
¬† }
¬† console.error(`–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ (${ctx.updateType}):`, err);
});

// --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
const app = express();

// –°–¢–†–û–ì–û –ü–ï–†–ï–î express.json()
app.post('/stripe-webhook', express.raw({ type: 'application/json' }), async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let stripeEvent;
  try {
    stripeEvent = stripe.webhooks.constructEvent(req.body, sig!, process.env.STRIPE_WEBHOOK_SECRET!);
  } catch (err: any) { 
    return res.status(400).send(`Webhook Error: ${err.message}`); 
  }

  if (stripeEvent.type === 'checkout.session.completed') {
    await handleSuccessfulPayment(stripeEvent.data.object);
  }
  res.json({ received: true });
});;

app.use(express.json());
app.use(bot.webhookCallback('/telegraf-webhook'));

const PORT = process.env.PORT || 3000;
const WEBHOOK_URL = process.env.TELEGRAM_WEBHOOK_URL;

app.listen(PORT, async () => {
¬† ¬† console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –ê–ª–≥–æ—Ä–∏—Ç–º–∞ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
¬† ¬† if (WEBHOOK_URL) {
        await bot.telegram.setWebhook(`${WEBHOOK_URL}/telegraf-webhook`);
        console.log(`üì° –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${WEBHOOK_URL}`);
    }
});

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
