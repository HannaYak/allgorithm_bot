import { Telegraf, Markup, session, Scenes } from 'telegraf';
import express from 'express';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import { eq, or, inArray, and, desc, asc } from 'drizzle-orm';
import * as schema from '../drizzle/schema'; 
import 'dotenv/config';
import Stripe from 'stripe';
import { DateTime } from 'luxon';



// --- 1. –ù–ê–°–¢–†–û–ô–ö–ò ---

async function broadcastToEvent(eventId: number, message: string) {
  const bookings = await db.query.bookings.findMany({
    where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true))
  });

  // –°–û–ó–î–ê–ï–ú Set –∏–º–µ–Ω–Ω–æ –∏–∑ Telegram ID
  const uniqueTgIds = new Set<number>();
  
  for (const b of bookings) {
    const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
    if (u?.telegramId) uniqueTgIds.add(u.telegramId);
  }

  // –†–∞—Å—Å—ã–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ¬´–∞–¥—Ä–µ—Å–∞–º¬ª
  for (const tgId of uniqueTgIds) {
    bot.telegram.sendMessage(tgId, message, { parse_mode: 'HTML' })
      .catch((err) => console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ ${tgId}:`, err));
  }
}

if (!process.env.DATABASE_URL) throw new Error('DATABASE_URL is missing');
const client = postgres(process.env.DATABASE_URL);
const db = drizzle(client, { schema });

if (!process.env.STRIPE_SECRET_KEY) throw new Error('STRIPE_SECRET_KEY is missing');
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2023-10-16' });

const GAME_PRICES: Record<string, string> = {
  'talk_toast': 'price_1SUTjrHhXyjuCWwfhQ7zwxLQ', 
  'stock_know': 'price_1SUTkoHhXyjuCWwfxD89YIpP',
  'speed_dating': 'price_1SUTlVHhXyjuCWwfU1IzNMlf',
  'talk_toast_review': 'price_1SiDMGHhXyjuCWwfzysRSphU',
  'stock_know_review': 'price_1SiDKoHhXyjuCWwfwg24Y7mF',
};
const STRIPE_COUPON_ID = '8RiQPzVX'; 
const ADMIN_ID = 5456905649; 
const PROCESSED_AUTO_ACTIONS = new Set<string>(); 

const BEAUTY_NAMES: Record<string, string> = {
  'talk_toast': 'Talk & Toast ü•Ç',
  'stock_know': 'Stock & Know üß†',
  'speed_dating': '–ë—ã—Å—Ç—Ä—ã–µ —Å–≤–∏–¥–∞–Ω–∏—è üíò',
  'talk_toast_review': 'Talk & Toast üé• (—Å–æ —Å—ä—ë–º–∫–æ–π)',
  'stock_know_review': 'Stock & Know üé• (—Å–æ —Å—ä—ë–º–∫–æ–π)'
};

// –§—É–Ω–∫—Ü–∏—è-–ø–æ–º–æ—â–Ω–∏–∫
const getGameName = (type: string) => BEAUTY_NAMES[type] || type;

const TYPE_MAP: Record<string, string> = { 
  'talk_toast': 'tt', 
  'stock_know': 'sk', 
  'speed_dating': 'sd',
  'talk_toast_review': 'ttr',
  'stock_know_review': 'skr'
};
const REV_TYPE_MAP: Record<string, string> = { 
  'tt': 'talk_toast', 
  'sk': 'stock_know', 
  'sd': 'speed_dating',
  'ttr': 'talk_toast_review',
  'skr': 'stock_know_review'
};

// --- 2. –ö–û–ù–¢–ï–ù–¢ (–ü–û–õ–ù–´–ô) ---

const MINI_GAMES_TEXT = `üéÆ <b>4 –ú–∏–Ω–∏-–∏–≥—Ä—ã –¥–ª—è —Ä–∞–∑–º–∏–Ω–∫–∏:</b>\n\n1. <b>¬´–î–≤–µ –ø—Ä–∞–≤–¥—ã, –æ–¥–Ω–∞ –ª–æ–∂—å¬ª</b>\n2. <b>¬´–Ø –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ...¬ª</b>\n3. <b>¬´–ö—Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ?¬ª</b>\n4. <b>¬´–ö–æ–Ω—Ç–∞–∫—Ç¬ª</b>`;

const CONVERSATION_TOPICS = [
  "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∫–æ–≥–æ-–Ω–∏–±—É–¥—å –Ω–∞ —É–∂–∏–Ω(–∏–∑ –º—ë—Ä—Ç–≤—ã—Ö –∏–ª–∏ –∂–∏–≤—ã—Ö), –∫–æ–≥–æ –±—ã —Ç—ã –≤—ã–±—Ä–∞–ª/–∞ –∏ –ø–æ—á–µ–º—É?", "–•–æ—Ç–µ–ª/–∞ –±—ã —Ç—ã –±—ã—Ç—å –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–º/–æ–π? –ï—Å–ª–∏ –¥–∞, —Ç–æ —á–µ–º?", "–ü—Ä–µ–∂–¥–µ —á–µ–º —Å–¥–µ–ª–∞—Ç—å –∑–≤–æ–Ω–æ–∫, —Ç—ã —Ä–µ–ø–µ—Ç–∏—Ä—É–µ—à—å —Å–≤–æ—é —Ä–µ–ø–ª–∏–∫—É?", "–ö–æ–≥–¥–∞ —Ç—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø–µ–ª/–∞ –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø—Ä–æ–∂–∏—Ç—å –¥–æ 100 –ª–µ—Ç, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Ä–∞–∑—É–º –∏–ª–∏ —Ç–µ–ª–æ 30-–ª–µ—Ç–Ω–µ–≥–æ, —á—Ç–æ –±—ã –≤—ã–±—Ä–∞–ª/–∞?", "–£ —Ç–µ–±—è –µ—Å—Ç—å —Ç–∞–π–Ω–æ–µ –ø—Ä–µ–¥—á—É–≤—Å—Ç–≤–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã —É–º—Ä–µ—à—å?", "–ù–∞–∑–æ–≤–∏ —Ç—Ä–∏ —á–µ—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –∏ —É —Ç–µ–±—è, –∏ —É –∫–æ–≥–æ –ª–∏–±–æ –∑–∞ —Å—Ç–æ–ª–æ–º.", "–ó–∞ —á—Ç–æ —Ç—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å –Ω–∞–∏–±–æ–ª—å—à—É—é –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å?", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥, —á—Ç–æ –±—ã —Ç—ã –∏–∑–º–µ–Ω–∏–ª/–∞ –≤ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏–∏ —Å–µ–±—è?", "–ó–∞ 3 –º–∏–Ω—É—Ç—ã —Ä–∞—Å—Å–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏.", "–ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥/–ª–∞ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è —Å –Ω–æ–≤—ã–º —É–º–µ–Ω–∏–µ–º, —á—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª–æ?", "–ï—Å–ª–∏ –±—ã –º–∞–≥–∏—á–µ—Å–∫–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª –º–æ–≥ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–¥—É, –æ —á–µ–º –±—ã —Ç—ã —É–∑–Ω–∞–ª?", "–ï—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ, —á—Ç–æ —Ç—ã –¥–∞–≤–Ω–æ –º–µ—á—Ç–∞–µ—à—å —Å–¥–µ–ª–∞—Ç—å?", "–°–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏?", "–ß—Ç–æ –≤ –¥—Ä—É–∂–±–µ –¥–ª—è —Ç–µ–±—è –Ω–∞–∏–±–æ–ª–µ–µ —Ü–µ–Ω–Ω–æ?", "–ö–∞–∫–æ–µ —Ç–≤–æ–µ —Å–∞–º–æ–µ –¥–æ—Ä–æ–≥–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ?", "–ö–∞–∫–æ–µ —Ç–≤–æ–µ —Å–∞–º–æ–µ —É–∂–∞—Å–Ω–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ?", "–ï—Å–ª–∏ –±—ã —Ç—ã –∑–Ω–∞–ª, —á—Ç–æ —É–º—Ä–µ—à—å —á–µ—Ä–µ–∑ –≥–æ–¥, —á—Ç–æ –±—ã —Ç—ã –∏–∑–º–µ–Ω–∏–ª?", "–ß—Ç–æ –¥–ª—è —Ç–µ–±—è –∑–Ω–∞—á–∏—Ç –¥—Ä—É–∂–±–∞?", "–ö–∞–∫—É—é —Ä–æ–ª—å –ª—é–±–æ–≤—å –∏–≥—Ä–∞–µ—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏?", "–ü–æ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–µ—Ä—Ç—ã, –Ω–∞ –≤–∞—à –≤–∑–≥–ª—è–¥, —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤.", "–ö–∞–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ —Ç–≤–æ–µ–π —Å–µ–º—å–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä –±–ª–∏–∑–∫–∏–µ –∏–ª–∏ –æ—Ç–¥–∞–ª—ë–Ω–Ω—ã–µ?", "–ß—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –≤ —Å–≤—è–∑–∏ —Å —Ç–≤–æ–∏–º–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ —Å –º–∞—Ç–µ—Ä—å—é?", "–°–æ—Å—Ç–∞–≤—å—Ç–µ —Ç—Ä–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ¬´–º–Ω–µ –∫–∞–∂–µ—Ç—Å—è –º—ã –æ–±–∞...¬ª —Å –∫–∞–∫–∏–º –ª–∏–±–æ –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ —Ñ—Ä–∞–∑—É: ¬´–Ø –±—ã —Ö–æ—Ç–µ–ª, —á—Ç–æ–±—ã –±—ã–ª –∫—Ç–æ-—Ç–æ, —Å –∫–µ–º –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å‚Ä¶¬ª", "–ï—Å–ª–∏ –±—ã —Ç—ã —Å—Ç–∞–ª –±–ª–∏–∑–∫–∏–º –¥—Ä—É–≥–æ–º –¥–ª—è –∫–æ–≥–æ-—Ç–æ, —á—Ç–æ –±—ã —Ç—ã –µ–º—É —Ä–∞—Å—Å–∫–∞–∑–∞–ª?", "–†–∞—Å—Å–∫–∞–∂–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º, —á—Ç–æ —Ç–µ–±–µ –≤ –Ω–∏—Ö –Ω—Ä–∞–≤–∏—Ç—Å—è (—á–µ—Å—Ç–Ω–æ).", "–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–º—É—â–∞—é—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º –∏–∑ –∂–∏–∑–Ω–∏.", "–ö–æ–≥–¥–∞ —Ç—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø–ª–∞–∫–∞–ª –∏ –ø–æ—á–µ–º—É?", "–ß—Ç–æ —Ç—ã —Ü–µ–Ω–∏—à—å –≤ –ª—é–¥—è—Ö –∏ –ø–æ—á–µ–º—É?", "–ö–∞–∫–∞—è —Ç–µ–º–∞ —Å–ª–∏—à–∫–æ–º —Å–µ—Ä—å–µ–∑–Ω–∞ –¥–ª—è —à—É—Ç–æ–∫?", "–ï—Å–ª–∏ –±—ã —Ç—ã –∏—Å—á–µ–∑ —Å–µ–≥–æ–¥–Ω—è, –æ —á–µ–º –Ω–µ—Å–∫–∞–∑–∞–Ω–Ω–æ–º –∂–∞–ª–µ–ª –±—ã?", "–î–æ–º –≥–æ—Ä–∏—Ç. –ß—Ç–æ —Å–ø–∞—Å–µ—à—å (–∫—Ä–æ–º–µ –∂–∏–≤—ã—Ö —Å—É—â–µ—Å—Ç–≤, –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –¥–µ–Ω–µ–≥)?", "–ß—Ç–æ –≤ —ç—Ç–æ–º –≥–æ–¥—É —Å–ª—É—á–∏–ª–æ—Å—å –≤–ø–µ—Ä–≤—ã–µ?", "–ö–∞–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç—ã –ª—é–±–∏—à—å –∏ –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å –≤ —Å–µ–±–µ?", "–ß—Ç–æ –¥–ª—è –í–∞—Å –∑–Ω–∞—á–∏—Ç —Å–ª–æ–≤–æ —É—Å–ø–µ—Ö?", "–ß—Ç–æ –±—ã –≤—ã —Å–∫–∞–∑–∞–ª–∏ —Å–µ–±–µ 15-–ª–µ—Ç–Ω–µ–º—É?", "–û —á—ë–º –≤—ã –º–æ–∂–µ—Ç–µ –≥–æ–≤–æ—Ä–∏—Ç—å —á–∞—Å–∞–º–∏?", "–ö–∞–∫–æ–π –ª—É—á—à–∏–π —Å–æ–≤–µ—Ç –í–∞–º –¥–∞–≤–∞–ª–∏?", "–ë–µ–∑ —á–µ–≥–æ –Ω–µ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç–µ –Ω–∏ –¥–Ω—è?", "–ö–µ–º —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å? –†–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–π —Ñ–∞–∫—Ç –∏–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏.", "–ï—Å–ª–∏ –±—ã –ø—Ä–∏—à–ª–æ—Å—å –µ—Å—Ç—å –æ–¥–Ω–æ –±–ª—é–¥–æ –≤—Å—é –∂–∏–∑–Ω—å, —á—Ç–æ —ç—Ç–æ –±—ã–ª–æ –±—ã?", "–¢–≤–æ–π ¬´–ë–µ—Å–ø–æ–ª–µ–∑–Ω—ã–π —Ç–∞–ª–∞–Ω—Ç¬ª?", "–ß—Ç–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ, –Ω–æ —Ç–µ–±—è –±–µ—Å–∏—Ç?", "–ú–µ—Å—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–ª–æ? –ò –∫—É–¥–∞ —Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è?", "–†–æ–ª–∏ –≤ –∑–æ–º–±–∏-–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–µ: –ª–∏–¥–µ—Ä, –ø—Ä–µ–¥–∞—Ç–µ–ª—å, –ø–µ—Ä–≤–∞—è –∂–µ—Ä—Ç–≤–∞. –ö—Ç–æ —Ç—ã?", "100 –º–ª–Ω –¥–æ–ª–ª–∞—Ä–æ–≤, –Ω–æ –Ω–µ–ª—å–∑—è —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —Å–µ–±—è. –ö—É–¥–∞ –¥–µ–Ω–µ—à—å?", "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, —É —Ç–µ–±—è —Ç–æ–ª—å–∫–æ 1 —á–∞—Å (–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–º–æ—Ç—Ä–µ—Ç—å). –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—à—å—Å—è?", "–ö–µ–º –º–µ—á—Ç–∞–ª —Å—Ç–∞—Ç—å –≤ 7 –ª–µ—Ç?", "–ó–∞ —á—Ç–æ —Ç–µ–±—è –≤—ã–≥–æ–Ω—è–ª–∏ –∏–∑ –∫–ª–∞—Å—Å–∞?", "–ú–µ—Å—è—Ü –±–µ–∑ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ –∑–∞ –º–∏–ª–ª–∏–æ–Ω?", "–ö–æ—Ç –∏–ª–∏ —Å–æ–±–∞–∫–∞? –ü—Ä–æ–¥–∞–π –º–Ω–µ –≤—ã–±–æ—Ä."
];

const STOCK_QUESTIONS = [
{
    question: "–°–∏–Ω–≥–ª Scorpions ¬´Wind of Change¬ª —Å—Ç–∞–ª –≥–∏–º–Ω–æ–º —Ü–µ–ª–æ–π —ç–ø–æ—Ö–∏. –í –∫–∞–∫–æ–º –≥–æ–¥—É –æ–Ω –≤—ã—à–µ–ª?",
    hints: [
      "1. –í —ç—Ç–æ–º –∂–µ –≥–æ–¥—É –≥—Ä—É–ø–ø–∞ Nirvana –≤—ã–ø—É—Å—Ç–∏–ª–∞ —Å–≤–æ–π –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∞–ª—å–±–æ–º ¬´Nevermind¬ª.",
      "2. –≠—Ç–æ —á–∏—Å–ª–æ —è–≤–ª—è–µ—Ç—Å—è –ø–∞–ª–∏–Ω–¥—Ä–æ–º–æ–º ‚Äî –æ–Ω–æ —á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ –∏ —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ.",
      "3. –≠—Ç–æ –≥–æ–¥ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –ë–µ–ª–æ–≤–µ–∂—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏ —Ä–∞—Å–ø–∞–¥–∞ –°–°–°–†."
    ],
    answer: "1991",
    fact: "–≠—Ç–æ—Ç –≥–æ–¥ —Å—Ç–∞–ª —Ç–æ—á–∫–æ–π –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–∞ –∏ –æ–∑–Ω–∞–º–µ–Ω–æ–≤–∞–ª –æ–∫–æ–Ω—á–∞–Ω–∏–µ –•–æ–ª–æ–¥–Ω–æ–π –≤–æ–π–Ω—ã. –°–≤–∏—Å—Ç –≤ –Ω–∞—á–∞–ª–µ –ø–µ—Å–Ω–∏ –ø—Ä–∏–¥—É–º–∞–ª —Å–∞–º –ö–ª–∞—É—Å –ú–∞–π–Ω–µ –≤–æ –≤—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞ –≤ –ú–æ—Å–∫–≤—É."
  },
  {
    question: "–°–æ–≤–µ—Ç –ë—Ä–∞—Ç—Å—Ç–≤–∞ –∏–∑ ¬´–ü–∏—Ä–∞—Ç–æ–≤ –ö–∞—Ä–∏–±—Å–∫–æ–≥–æ –º–æ—Ä—è¬ª. –°–∫–æ–ª—å–∫–æ –ø–∏—Ä–∞—Ç—Å–∫–∏—Ö –±–∞—Ä–æ–Ω–æ–≤ –≤ –Ω–µ–≥–æ –≤—Ö–æ–¥–∏–ª–æ?",
    hints: [
      "1. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∫—Ä—É–≥–æ–≤ –∞–¥–∞ –æ–ø–∏—Å–∞–ª –î–∞–Ω—Ç–µ –ê–ª–∏–≥—å–µ—Ä–∏ –≤ —Å–≤–æ–µ–π ¬´–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–º–µ–¥–∏–∏¬ª.",
      "2. –°—Ç–æ–ª—å–∫–æ –ù–∞–∑–≥—É–ª–æ–≤ –∏—Å–∫–∞–ª–∏ –ö–æ–ª—å—Ü–æ –í—Å–µ–≤–ª–∞—Å—Ç–∏—è –ø–æ –ø—Ä–∏–∫–∞–∑—É –°–∞—É—Ä–æ–Ω–∞ –≤–æ ¬´–í–ª–∞—Å—Ç–µ–ª–∏–Ω–µ –ö–æ–ª–µ—Ü¬ª.",
      "3. –°–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—Ä–æ–¥–Ω—ã–º –ø–æ–≤–µ—Ä—å—è–º, —É –∫–æ—à–∫–∏ –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∂–∏–∑–Ω–µ–π."
    ],
    answer: "9",
    fact: "–î–µ–≤—è—Ç—å –±–∞—Ä–æ–Ω–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ —Å–æ–±—Ä–∞—Ç—å –¥–µ–≤—è—Ç—å –ø–µ—Å–æ, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–æ—Ä—Å–∫—É—é –±–æ–≥–∏–Ω—é –ö–∞–ª–∏–ø—Å–æ –∏–∑ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –æ–±–ª–∏—á—å—è."
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å—Ç—É–¥–∏–π–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤ –≤—ã–ø—É—Å—Ç–∏–ª–∞ –≥—Ä—É–ø–ø–∞ The Beatles?",
    hints: [
      "1. –ê—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä —Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ê–ª—é–º–∏–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞.",
      "2. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∏–≥—Ä–∞–ª—å–Ω–æ–π –∫–æ–ª–æ–¥–µ –∏–∑ 52 –∫–∞—Ä—Ç.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –º–Ω–æ–≥–∏–µ –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç –ø—Ä–∏ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —Ä—è–¥–æ–≤ –≤ —Å–∞–º–æ–ª–µ—Ç–∞—Ö –∏–∑-–∑–∞ —Å—É–µ–≤–µ—Ä–∏–π."
    ],
    answer: "13",
    fact: "13 –∞–ª—å–±–æ–º–æ–≤ ¬´–õ–∏–≤–µ—Ä–ø—É–ª—å—Å–∫–æ–π —á–µ—Ç–≤–µ—Ä–∫–∏¬ª –Ω–∞–≤—Å–µ–≥–¥–∞ –∏–∑–º–µ–Ω–∏–ª–∏ –∏—Å—Ç–æ—Ä–∏—é –º–∏—Ä–æ–≤–æ–π –º—É–∑—ã–∫–∏. –ê —Ç—É–∑ —Å—Ç–∞–ª –≤—ã—à–µ –∫–æ—Ä–æ–ª—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–π —Ä–µ–≤–æ–ª—é—Ü–∏–∏!"
  },
  {
    question: "–ö–∞–∫–æ–π –Ω–æ–º–µ—Ä –±—ã–ª —É –≥–ª–∞–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è (–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞) –≤ —Å–µ—Ä–∏–∞–ª–µ ¬´–ò–≥—Ä–∞ –≤ –∫–∞–ª—å–º–∞—Ä–∞¬ª?",
    hints: [
      "1. –≠—Ç–æ –ø—Ä–æ—Å—Ç–∞—è —á–∏—Å–ª–æ–≤–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ —Ç—Ä–µ—Ö —Ü–∏—Ñ—Ä, –∏–¥—É—â–∏—Ö –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é.",
      "2. –ï—Å–ª–∏ –∫ —ç—Ç–æ–º—É —á–∏—Å–ª—É –ø—Ä–∏–±–∞–≤–∏—Ç—å –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–π –∫–æ–¥ –æ—à–∏–±–∫–∏ ¬´Not Found¬ª (404), –ø–æ–ª—É—á–∏—Ç—Å—è 860.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ —Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ —Å–ø–æ—Ä—Ç–∫–∞—Ä–∞ Ferrari GT, –≤—ã–ø—É—Å–∫–∞–≤—à–µ–≥–æ—Å—è –≤ 90-—Ö –≥–æ–¥–∞—Ö."
    ],
    answer: "456",
    fact: "–°–æ–Ω –ì–∏ –•—É–Ω –Ω–æ—Å–∏–ª –Ω–æ–º–µ—Ä 456 ‚Äî —ç—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ —ç—Ç–æ–π —Å–º–µ—Ä—Ç–µ–ª—å–Ω–æ–π –∏–≥—Ä–µ."
  },
  {
    question: "–ù–∞–∑–æ–≤–∏—Ç–µ –Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –≥–ª–∞—Å—è—â–µ–≥–æ: ¬´–ï—Å–ª–∏ —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ —ç—Ç–æ –µ—Å—Ç—å –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏—è¬ª.",
    hints: [
      "1. –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–¥ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –ò—Å–ø–∞–Ω–∏—è.",
      "2. –ù–æ–º–µ—Ä –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ —Å–æ–≤–µ—Ç—Å–∫–æ–≥–æ —Ç–∞–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω—ã (–¢-...).",
      "3. –ü–æ–¥ —ç—Ç–∏–º –∏–≥—Ä–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º –≤—ã—Å—Ç—É–ø–∞–ª –∑–Ω–∞–º–µ–Ω–∏—Ç—ã–π –®–∞–∫–∏–ª –û‚Äô–ù–∏–ª –≤ –∫–æ–º–∞–Ω–¥–µ ¬´–õ–µ–π–∫–µ—Ä—Å¬ª."
    ],
    answer: "34",
    fact: "–ü—Ä–∞–≤–∏–ª–æ 34 ‚Äî –æ–¥–Ω–æ –∏–∑ —Å–∞–º—ã—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –Ω–µ–≥–ª–∞—Å–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –º–∏—Ä–∞, –∑–∞—Ä–æ–¥–∏–≤—à–µ–µ—Å—è –Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ä–∞—Ö –∏–º–∏–¥–∂–±–æ—Ä–¥–∞ 4chan."
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ –≥–Ω–æ–º–æ–≤-—Å–ø—É—Ç–Ω–∏–∫–æ–≤ –ë–∏–ª—å–±–æ –ë—ç–≥–≥–∏–Ω—Å–∞ –≤—Ö–æ–¥–∏–ª–æ –≤ –æ—Ç—Ä—è–¥ –¢–æ—Ä–∏–Ω–∞ –î—É–±–æ—â–∏—Ç–∞ –≤ ¬´–•–æ–±–±–∏—Ç–µ¬ª?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –ø–æ–ª–æ—Å (–∫—Ä–∞—Å–Ω—ã—Ö –∏ –±–µ–ª—ã—Ö) –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–º —Ñ–ª–∞–≥–µ –°–®–ê.",
      "2. –°—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç –æ–¥–Ω–æ–π –º–∞—Å—Ç–∏ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–æ–ª–æ–¥–µ (–æ—Ç –¥–≤–æ–π–∫–∏ –¥–æ —Ç—É–∑–∞).",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ —á–∞—Å—Ç–æ –Ω–∞–∑—ã–≤–∞—é—Ç ¬´–ß—ë—Ä—Ç–æ–≤–æ–π –¥—é–∂–∏–Ω–æ–π¬ª."
    ],
    answer: "13",
    fact: "–í –æ—Ç—Ä—è–¥–µ –±—ã–ª–æ 13 –≥–Ω–æ–º–æ–≤, –ø–æ—ç—Ç–æ–º—É –ì—ç–Ω–¥–∞–ª—å—Ñ –Ω–∞—Å—Ç–æ—è–ª –Ω–∞ 14-–º —É—á–∞—Å—Ç–Ω–∏–∫–µ ‚Äî –ë–∏–ª—å–±–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–∫–ª—è—Ç–∏—è –Ω–µ—Å—á–∞—Å—Ç–ª–∏–≤–æ–≥–æ —á–∏—Å–ª–∞."
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –í–µ–ª–∏–∫–∏—Ö –î–æ–º–æ–≤ –í–µ—Å—Ç–µ—Ä–æ—Å–∞ –≤—ã–¥–µ–ª—è—é—Ç –≤ –∫–∞–Ω–æ–Ω–µ ¬´–ò–≥—Ä—ã –ü—Ä–µ—Å—Ç–æ–ª–æ–≤¬ª –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ –∏—Å—Ç–æ—Ä–∏–∏?",
    hints: [
      "1. –ù–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π —Å–∏–º—Ñ–æ–Ω–∏–∏ –ë–µ—Ç—Ö–æ–≤–µ–Ω–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –∑–≤—É—á–∏—Ç ¬´–û–¥–∞ –∫ —Ä–∞–¥–æ—Å—Ç–∏¬ª.",
      "2. –≠—Ç–æ –Ω–∞–∏–±–æ–ª—å—à–µ–µ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–µ —á–∏—Å–ª–æ –≤ –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å—á–∏—Å–ª–µ–Ω–∏—è.",
      "3. –°—Ç–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –≤ —Å—Ä–µ–¥–Ω–µ–º –¥–ª–∏—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å —É —á–µ–ª–æ–≤–µ–∫–∞."
    ],
    answer: "9",
    fact: "–•–æ—Ç—è –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Å–µ–º—å, –í–µ–ª–∏–∫–∏—Ö –î–æ–º–æ–≤ –≤ –∫–∞–Ω–æ–Ω–µ –≤—ã–¥–µ–ª—è—é—Ç –¥–µ–≤—è—Ç—å (–°—Ç–∞—Ä–∫–∏, –õ–∞–Ω–Ω–∏—Å—Ç–µ—Ä—ã, –¢–∞—Ä–≥–∞—Ä–∏–µ–Ω—ã –∏ –¥—Ä.)."
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ –ª–µ—Ç –ø—Ä–æ–≤–µ–ª –≤ –∑–∞—Ç–æ—á–µ–Ω–∏–∏ –≤ —á–∞—Å—Ç–Ω–æ–π —Ç—é—Ä—å–º–µ –≥–µ—Ä–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ—Ä–µ–π—Å–∫–æ–≥–æ —Ñ–∏–ª—å–º–∞ ¬´–û–ª–¥–±–æ–π¬ª?",
    hints: [
      "1. –ù–æ–º–µ—Ä –∞—Ä–∫–∞–Ω–∞ ¬´–î—å—è–≤–æ–ª¬ª –≤ –∫–æ–ª–æ–¥–µ –∫–∞—Ä—Ç –¢–∞—Ä–æ.",
      "2. –°—Ç–æ–ª—å–∫–æ –ª–µ—Ç –±—ã–ª–æ –≥–µ—Ä–æ—é —Ä–æ–º–∞–Ω–∞ –ñ—é–ª—è –í–µ—Ä–Ω–∞ ‚Äî ¬´–ü—è—Ç–Ω–∞–¥—Ü–∞—Ç–∏–ª–µ—Ç–Ω–µ–º—É –∫–∞–ø–∏—Ç–∞–Ω—É¬ª.",
      "3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Å—Ç—è—à–µ–∫ —Å —á–∏—Å–ª–∞–º–∏ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –∏–≥—Ä–µ-–≥–æ–ª–æ–≤–æ–ª–æ–º–∫–µ ¬´–ü—è—Ç–Ω–∞—à–∫–∏¬ª."
    ],
    answer: "15",
    fact: "–ì–µ—Ä–æ–π –ø—Ä–æ–≤–µ–ª –≤ –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ 15 –ª–µ—Ç, –ø–∏—Ç–∞—è—Å—å —Ç–æ–ª—å–∫–æ –∂–∞—Ä–µ–Ω—ã–º–∏ –ø–µ–ª—å–º–µ–Ω—è–º–∏ –∏ –Ω–µ –∑–Ω–∞—è –ø—Ä–∏—á–∏–Ω —Å–≤–æ–µ–≥–æ –ø–ª–µ–Ω–µ–Ω–∏—è."
  },
  {
    question: "–ö–∞–∫–æ–µ —á–∏—Å–ª–æ —Å—Ç–æ–∏—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–ª—É–±–∞ –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤, —É–º–µ—Ä—à–∏—Ö –Ω–∞ –ø–∏–∫–µ —Å–ª–∞–≤—ã (–ö–æ–±–µ–π–Ω, –•–µ–Ω–¥—Ä–∏–∫—Å)?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∫–æ—Å—Ç–µ–π –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –∫–∏—Å—Ç–∏ —Ä—É–∫–∏ –≤–∑—Ä–æ—Å–ª–æ–≥–æ –∑–¥–æ—Ä–æ–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.",
      "2. –°—Ç–æ–ª—å–∫–æ –ø–æ–ø—Ä–∞–≤–æ–∫ –±—ã–ª–æ –≤–Ω–µ—Å–µ–Ω–æ –≤ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—é –°–®–ê –∑–∞ –≤—Å—é –µ—ë –∏—Å—Ç–æ—Ä–∏—é.",
      "3. –°—Ç–æ–ª—å–∫–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤ –≤—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–∞–≤ –ï–≤—Ä–æ–ø–µ–π—Å–∫–æ–≥–æ –°–æ—é–∑–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å."
    ],
    answer: "27",
    fact: "¬´–ö–ª—É–± 27¬ª ‚Äî –ø–µ—á–∞–ª—å–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ –≥–µ–Ω–∏–∞–ª—å–Ω—ã—Ö –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤, —É—à–µ–¥—à–∏—Ö –∏–∑ –∂–∏–∑–Ω–∏ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º –≤–æ–∑—Ä–∞—Å—Ç–µ."
  },
  {
    question: "–ù–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –ø–æ –º–∞—Å—Å–µ –∑–µ–º–Ω–æ–π –∫–æ—Ä—ã –Ω–∞—à–∞ –ø–ª–∞–Ω–µ—Ç–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –∫–∏—Å–ª–æ—Ä–æ–¥–∞?",
    hints: [
      "1. –ê—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä —Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ò–Ω–¥–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞.",
      "2. –ì–æ–¥ –¥–æ –Ω–∞—à–µ–π —ç—Ä—ã, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—á–∞–ª–∞—Å—å –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –≤–æ–π–Ω–∞ –¶–µ–∑–∞—Ä—è —Å –ü–æ–º–ø–µ–µ–º.",
      "3. –ß–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤ –Ø–ø–æ–Ω–∏–∏ –æ–∑–Ω–∞—á–∞–µ—Ç ¬´—Å–º–µ—Ä—Ç–Ω—ã–µ –º—É–∫–∏¬ª –∏–∑-–∑–∞ —Å–æ–∑–≤—É—á–∏—è —Å —Ñ—Ä–∞–∑–æ–π ¬´—Å–∏-–∫—É¬ª."
    ],
    answer: "49",
    fact: "–ü–æ—á—Ç–∏ –ø–æ–ª–æ–≤–∏–Ω–∞ –≤–µ—Å–∞ –∑–µ–º–ª–∏ –ø–æ–¥ –Ω–∞—à–∏–º–∏ –Ω–æ–≥–∞–º–∏ ‚Äî —ç—Ç–æ –∫–∏—Å–ª–æ—Ä–æ–¥, —Å–≤—è–∑–∞–Ω–Ω—ã–π –≤ —Å–æ—Å—Ç–∞–≤–µ –ø–µ—Å–∫–∞, –≥–ª–∏–Ω—ã –∏ —Å–∫–∞–ª."
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ —Å–ø—É—Ç–Ω–∏–∫–æ–≤ —É –Æ–ø–∏—Ç–µ—Ä–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –Ω–∞—É–∫–æ–π –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç?",
    hints: [
      "1. –û–∫—Ç–∞–Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä –±–µ–Ω–∑–∏–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–æ–º –≤ –ï–≤—Ä–æ–ø–µ.",
      "2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞ –≤—ã—Ö–æ–¥–∞ –ø–µ—Ä–≤–æ–≥–æ –≤ –º–∏—Ä–µ 3D –º—É–ª—å—Ç—Ñ–∏–ª—å–º–∞ ¬´–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä—É—à–µ–∫¬ª.",
      "3. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Ç–µ–∑–∏—Å–æ–≤ –ú–∞—Ä—Ç–∏–Ω –õ—é—Ç–µ—Ä –ø—Ä–∏–±–∏–ª –∫ –¥–≤–µ—Ä—è–º —Ü–µ—Ä–∫–≤–∏ –≤ –í–∏—Ç—Ç–µ–Ω–±–µ—Ä–≥–µ."
    ],
    answer: "95",
    fact: "–Æ–ø–∏—Ç–µ—Ä ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π –∫–æ—Ä–æ–ª—å —Å–ø—É—Ç–Ω–∏–∫–æ–≤. –ê—Å—Ç—Ä–æ–Ω–æ–º—ã –ø–æ–ª–∞–≥–∞—é—Ç, —á—Ç–æ –º–µ–ª–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª–µ–µ 600."
  },
  {
    question: "–í —Å–∫–æ–ª—å–∫–∏—Ö —Ç—é—Ä—å–º–∞—Ö –ø–æ–±—ã–≤–∞–ª –∑–∞ —Å–≤–æ—é –∂–∏–∑–Ω—å –±—É–π–Ω—ã–π —Ä–µ—Ü–∏–¥–∏–≤–∏—Å—Ç –ß–∞—Ä–ª—å–∑ –ë—Ä–æ–Ω—Å–æ–Ω?",
    hints: [
      "1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç, –∫–æ—Ç–æ—Ä—ã–º–∏ –ë–æ–≥ –æ–≥—Ä–∞–Ω–∏—á–∏–ª –∂–∏–∑–Ω—å —Å–º–µ—Ä—Ç–Ω—ã—Ö –≤ –ö–Ω–∏–≥–µ –ë—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –ü–æ—Ç–æ–ø–æ–º.",
      "2. –°—Ç–æ–ª—å–∫–æ —Ç–æ–Ω–Ω –∫—Ä–æ–≤–∏ –≤ —Å—Ä–µ–¥–Ω–µ–º –ø–µ—Ä–µ–∫–∞—á–∏–≤–∞–µ—Ç —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ —Å–µ—Ä–¥—Ü–µ –∑–∞ –æ–¥–∏–Ω –≥–æ–¥ –∂–∏–∑–Ω–∏.",
      "3. –†–∏–º—Å–∫–∞—è –∑–∞–ø–∏—Å—å —ç—Ç–æ–≥–æ —á–∏—Å–ª–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —Ç—Ä–∏ –±—É–∫–≤—ã: CXX."
    ],
    answer: "120",
    fact: "–ë—Ä–æ–Ω—Å–æ–Ω —Å–º–µ–Ω–∏–ª 120 —Ç—é—Ä–µ–º. –û–Ω –ø—Ä–æ—Å–ª–∞–≤–∏–ª—Å—è —Å–≤–æ–µ–π –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —Å–∏–ª–æ–π –∏ —Ç–µ–º, —á—Ç–æ –≥–Ω—É–ª —Ä—É–∫–∞–º–∏ —Ç—é—Ä–µ–º–Ω—ã–µ —Ä–µ—à–µ—Ç–∫–∏."
  },
  {
    question: "–ö—Ä–∏—Å—Ç–∏–∞–Ω –î–∏–æ—Ä –ø—Ä–∏—Å–≤–æ–∏–ª —ç—Ç–æ ¬´—Å—á–∞—Å—Ç–ª–∏–≤–æ–µ¬ª —á–∏—Å–ª–æ —Å–≤–æ–µ–π —Å–∞–º–æ–π –ø—Ä–æ–¥–∞–≤–∞–µ–º–æ–π –ø–æ–º–∞–¥–µ. –ù–∞–∑–æ–≤–∏—Ç–µ –µ–≥–æ.",
    hints: [
      "1. –¢—Ä–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞, –∫–æ–≥–¥–∞ –≤–µ—Å—å –º–∏—Ä –∂–¥–∞–ª –∫—Ä–∞—Ö–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã Y2K.",
      "2. –ö–æ—Ä–æ—Ç–∫–∏–π –Ω–æ–º–µ—Ä –¥–ª—è –≤—ã–∑–æ–≤–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –ø–æ–º–æ—â–∏ –≤ –ü–æ–ª—å—à–µ.",
      "3. –¢—Ä–µ—Ö–∑–Ω–∞—á–Ω—ã–π –ø–∞–ª–∏–Ω–¥—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–π –±–æ–ª—å—à–µ 900, –Ω–æ –º–µ–Ω—å—à–µ 1000."
    ],
    answer: "999",
    fact: "–ö—É–ª—å—Ç–æ–≤—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ 999 ‚Äî —ç—Ç–æ –≤–∏–∑–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ Dior, —Ü–≤–µ—Ç, —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É—é—â–∏–π –ø–ª–∞–º—è –∏ —Å—Ç—Ä–∞—Å—Ç—å."
  },
  {
    question: "–ö–∞–∫–æ–≤–∞ –±—ã–ª–∞ –¥–ª–∏–Ω–∞ (–≤ –º–µ—Ç—Ä–∞—Ö) –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –Ω–µ–º–µ—Ü–∫–æ–≥–æ –¥–∏—Ä–∏–∂–∞–±–ª—è ¬´–ì–∏–Ω–¥–µ–Ω–±—É—Ä–≥¬ª?",
    hints: [
      "1. –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –∫–æ–¥ –∞—Ñ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞ –ì–≤–∏–Ω–µ—è-–ë–∏—Å–∞—É.",
      "2. –°—Ç–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –¥–ª–∏—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ä–µ–∂–∏—Å—Å–µ—Ä—Å–∫–∞—è –≤–µ—Ä—Å–∏—è —Ñ–∏–ª—å–º–∞ ¬´–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ—Ä–æ–ª—è¬ª.",
      "3. –°—Ç–æ–ª—å–∫–æ –ª–µ—Ç –Ω–∞–∑–∞–¥ (–æ—Ç 2028 –≥–æ–¥–∞) –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –í–æ—Å—Å—Ç–∞–Ω–∏–µ –≤ –°–®–ê –ø—Ä–æ—Ç–∏–≤ –±—Ä–∏—Ç–∞–Ω—Å–∫–æ–π –∫–æ—Ä–æ–Ω—ã."
    ],
    answer: "245",
    fact: "–≠—Ç–æ —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π –¥–∏—Ä–∏–∂–∞–±–ª—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –µ–≥–æ –¥–ª–∏–Ω–∞ —Å–æ—Å—Ç–∞–≤–ª—è–ª–∞ 245 –º–µ—Ç—Ä–æ–≤, —á—Ç–æ –ø–æ—á—Ç–∏ –≤ —Ç—Ä–∏ —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –ë–æ–∏–Ω–≥–∞ 747."
  },
  {
    question: "–ì–∞—Ä–Ω–∏–∑–æ–Ω –ë—Ä–µ—Å—Ç—Å–∫–æ–π –∫—Ä–µ–ø–æ—Å—Ç–∏ –¥–µ—Ä–∂–∞–ª –æ–±–æ—Ä–æ–Ω—É –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π. –ù–∞–∑–æ–≤–∏—Ç–µ —á–∏—Å–ª–æ.",
    hints: [
      "1. –ê—Ç–æ–º–Ω—ã–π –Ω–æ–º–µ—Ä —Ö–∏–º–∏—á–µ—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –ì–µ—Ä–º–∞–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞.",
      "2. –¢–æ—á–∫–∞ –∑–∞–º–µ—Ä–∑–∞–Ω–∏—è –≤–æ–¥—ã –ø–æ —à–∫–∞–ª–µ –§–∞—Ä–µ–Ω–≥–µ–π—Ç–∞.",
      "3. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∑—É–±–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–æ—Ç–æ–≤–æ–π –ø–æ–ª–æ—Å—Ç–∏ –≤–∑—Ä–æ—Å–ª–æ–≥–æ –∑–¥–æ—Ä–æ–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞."
    ],
    answer: "32",
    fact: "–ö—Ä–µ–ø–æ—Å—Ç—å –¥–µ—Ä–∂–∞–ª–∞—Å—å 32 –¥–Ω—è, —Å—Ç–∞–≤ —Å–∏–º–≤–æ–ª–æ–º –º—É–∂–µ—Å—Ç–≤–∞, –∫–æ–≥–¥–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è —Ñ—Ä–æ–Ω—Ç–∞ —É—à–ª–∞ –¥–∞–ª–µ–∫–æ –Ω–∞ –≤–æ—Å—Ç–æ–∫."
  },
  {
    question: "–ü—Ä–∏–Ω—è—Ç–æ —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–æ—Ä—Ç–æ–≤ —á–∞—è.",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –≤–æ–ª–µ–π–±–æ–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–µ.",
      "2. –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≥ —É –Ω–∞—Å–µ–∫–æ–º—ã—Ö —Å —Å–∞–º—ã–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ç–∏–ø–æ–º —Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–ª–∞.",
      "3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–∫–≤ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∞–ª—Ñ–∞–≤–∏—Ç–µ –æ—Ç –±—É–∫–≤—ã E –¥–æ –±—É–∫–≤—ã K –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ."
    ],
    answer: "6",
    fact: "–ë–µ–ª—ã–π, –∑–µ–ª–µ–Ω—ã–π, –∂–µ–ª—Ç—ã–π, —É–ª—É–Ω, —á–µ—Ä–Ω—ã–π –∏ –ø—É—ç—Ä. –ò –≤—Å–µ –æ–Ω–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —Å –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ä–∞—Å—Ç–µ–Ω–∏—è!"
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ –Ω–µ–¥–µ–ª—å –ø—Ä–æ—Å—Ç–æ—è–ª –º–∞–ª–µ–Ω—å–∫–∏–π –≥–æ—Ä–æ–¥ –ö–æ–∑–µ–ª—å—Å–∫ –ø—Ä–æ—Ç–∏–≤ –æ—Ä–¥—ã –ë–∞—Ç—ã—è –≤ 1238 –≥–æ–¥—É?",
    hints: [
      "1. –°—Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–µ—Ç –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.",
      "2. –ß–∏—Å–ª–æ, —Ä–∞–≤–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–ª–∞–Ω–µ—Ç–µ –ó–µ–º–ª—è.",
      "3. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö –Ω–æ—Ç –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –≥–∞–º–º–µ."
    ],
    answer: "7",
    fact: "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –¥–µ—Ä–∂–∞–ª—Å—è 49 –¥–Ω–µ–π –ø—Ä–æ—Ç–∏–≤ –≤–µ–ª–∏—á–∞–π—à–µ–π –∞—Ä–º–∏–∏ –º–∏—Ä–∞, –∑–∞ —á—Ç–æ –ë–∞—Ç—ã–π –ø—Ä–æ–∑–≤–∞–ª –µ–≥–æ ¬´–ó–ª—ã–º –≥–æ—Ä–æ–¥–æ–º¬ª."
  },
  {
    question: "–ù–∞–∑–æ–≤–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —á–µ–ª–æ–≤–µ–∫ –ø–æ–±—ã–≤–∞–ª–æ –∑–∞ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ –ª—É–Ω–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏?",
    hints: [
      "1. –°—Ç–æ–ª—å–∫–æ –∫–∞–º–Ω–µ–π –ø–æ—Å—Ç–∞–≤–∏–ª –ú–æ–∏—Å–µ–π —É –ø–æ–¥–Ω–æ–∂—å—è –°–∏–Ω–∞–π—Å–∫–æ–π –≥–æ—Ä—ã –≤ –ö–Ω–∏–≥–µ –ò—Å—Ö–æ–¥.",
      "2. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –±—É–∫–≤ –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –≥–∞–≤–∞–π—Å–∫–æ–º –∞–ª—Ñ–∞–≤–∏—Ç–µ (—Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –≤ –º–∏—Ä–µ).",
      "3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–≥–Ω–µ–≤–∞–Ω–Ω—ã—Ö –º—É–∂—á–∏–Ω –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–ª–∏–≤—É–¥—Å–∫–æ–≥–æ —Ñ–∏–ª—å–º–∞."
    ],
    answer: "12",
    fact: "–í—Å–µ–≥–æ 12 —á–µ–ª–æ–≤–µ–∫ —Ö–æ–¥–∏–ª–∏ –ø–æ –õ—É–Ω–µ. –ê–ª–∞–Ω –®–µ–ø–∞—Ä–¥ –¥–∞–∂–µ —É–º—É–¥—Ä–∏–ª—Å—è —Å—ã–≥—Ä–∞—Ç—å —Ç–∞–º –≤ –≥–æ–ª—å—Ñ, —Å–¥–µ–ª–∞–≤ –¥–≤–∞ —É–¥–∞—Ä–∞."
  },
  {
    question: "–°–∫–æ–ª—å–∫–æ —Ä–æ–¥–æ–≤ –≤–æ–π—Å–∫ –æ–±—ã—á–Ω–æ –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –∫—Ä—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω?",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã—Ö —á—É–≤—Å—Ç–≤ —á–µ–ª–æ–≤–µ–∫–∞ –≤—ã–¥–µ–ª–∏–ª –ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å –µ—â–µ –≤ –∞–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏.",
      "2. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω —è–≤–ª—è—é—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º–∏ —á–ª–µ–Ω–∞–º–∏ –°–æ–≤–µ—Ç–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –û–û–ù.",
      "3. –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –º–∏—Ñ–∏—á–µ—Å–∫–æ–≥–æ ¬´–≠–ª–µ–º–µ–Ω—Ç–∞¬ª –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ñ–∏–ª—å–º–∞ —Å –ú–∏–ª–æ–π –ô–æ–≤–æ–≤–∏—á."
    ],
    answer: "5",
    fact: "–û–±—ã—á–Ω–æ —ç—Ç–æ –°—É—Ö–æ–ø—É—Ç–Ω—ã–µ –≤–æ–π—Å–∫–∞, –í–í–°, –í–ú–§, –†–∞–∫–µ—Ç–Ω—ã–µ –≤–æ–π—Å–∫–∞ –∏ –í–î–í."
  },
  {
    question: "–ù–∞–∑–æ–≤–∏—Ç–µ —á–∏—Å–ª–æ –ª—É–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–µ–∂–¥—É –ª–µ—Ç–Ω–∏–º–∏ –û–ª–∏–º–ø–∏–π—Å–∫–∏–º–∏ –∏–≥—Ä–∞–º–∏.",
    hints: [
      "1. –Æ–±–∏–ª–µ–π –±—Ä–∞–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω—è—Ç–æ –Ω–∞–∑—ã–≤–∞—Ç—å ¬´–ó–æ–ª–æ—Ç–æ–π —Å–≤–∞–¥—å–±–æ–π¬ª.",
      "2. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —à—Ç–∞—Ç–æ–≤ –≤—Ö–æ–¥—è—Ç –≤ —Å–æ—Å—Ç–∞–≤ –°–®–ê –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.",
      "3. –°—Ü–µ–Ω–∏—á–µ—Å–∫–∏–π –ø—Å–µ–≤–¥–æ–Ω–∏–º –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–≥–æ —Ä—ç–ø–µ—Ä–∞, –≤—ã–∂–∏–≤—à–µ–≥–æ –ø–æ—Å–ª–µ 9 –ø—É–ª—å."
    ],
    answer: "50",
    fact: "–ß–∏—Å–ª–æ 50 –ø—Ä–µ—Å–ª–µ–¥—É–µ—Ç –Ω–∞—Å –ø–æ–≤—Å—é–¥—É: –æ—Ç –∑–æ–ª–æ—Ç—ã—Ö —é–±–∏–ª–µ–µ–≤ –¥–æ –∑–≤–µ–∑–¥ –Ω–∞ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–º —Ñ–ª–∞–≥–µ."
  },
  {
    question: "–í 2007 –≥–æ–¥—É —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–∏–ª–æ —Å–ø–∏—Å–æ–∫ —á—É–¥–µ—Å —Å–≤–µ—Ç–∞. –ù–∞–∑–æ–≤–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —á—É–¥–µ—Å.",
    hints: [
      "1. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∑–≤—ë–∑–¥ –æ–±—Ä–∞–∑—É—é—Ç –∫–æ–≤—à —Å–æ–∑–≤–µ–∑–¥–∏—è –ë–æ–ª—å—à–∞—è –º–µ–¥–≤–µ–¥–∏—Ü–∞.",
      "2. –ù–æ–º–µ—Ä —è–Ω–≤–∞—Ä—Å–∫–æ–≥–æ –¥–Ω—è, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∞–∑–¥–Ω—É–µ—Ç—Å—è –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–æ–µ –†–æ–∂–¥–µ—Å—Ç–≤–æ.",
      "3. –ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Ñ—É—Ç–æ–≤ –ø–æ–¥ –∫–∏–ª–µ–º —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–º –ø–æ–∂–µ–ª–∞–Ω–∏–∏ –º–æ—Ä—è–∫–∞–º."
    ],
    answer: "7",
    fact: "–í —Å–ø–∏—Å–æ–∫ –≤–æ—à–ª–∏ –ö–æ–ª–∏–∑–µ–π, –ü–µ—Ç—Ä–∞, –ú–∞—á—É-–ü–∏–∫—á—É –∏ –¥—Ä—É–≥–∏–µ. –ï–≥–∏–ø–µ—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å, —Å—á–∏—Ç–∞—è —Å–≤–æ–∏ –ø–∏—Ä–∞–º–∏–¥—ã –≤–Ω–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏."
  },
  {
    question: "–ö–∏—Ç–∞–π ‚Äî —Å—Ç–∞—Ä–µ–π—à–∞—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—è. –ù–∞–∑–æ–≤–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –¥–∏–Ω–∞—Å—Ç–∏–π –ø—Ä–∞–≤–∏–ª–æ –≤ –Ω—ë–º?",
    hints: [
      "1. –ß–∏—Å–ª–æ, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–ª–∞—Å—å —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –¥–≤–∞–¥—Ü–∞—Ç–µ—Ä–∏—á–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥—Ä–µ–≤–Ω–∏—Ö –ú–∞–π—è.",
      "2. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –º–æ–ª–æ—á–Ω—ã—Ö –∑—É–±–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞.",
      "3. –°—Ç–æ–ª—å–∫–æ —Ç—ã—Å—è—á –ª—å–µ –ø–æ–¥ –≤–æ–¥–æ–π —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ–≥–æ —Ä–æ–º–∞–Ω–∞ –ñ—é–ª—è –í–µ—Ä–Ω–∞."
    ],
    answer: "20",
    fact: "–ö–∏—Ç–∞–π —Å–º–µ–Ω–∏–ª 20 –¥–∏–Ω–∞—Å—Ç–∏–π –∑–∞ 4000 –ª–µ—Ç. –°–∞–º–∞—è –¥–æ–ª–≥–∞—è, –¥–∏–Ω–∞—Å—Ç–∏—è –ß–∂–æ—É, –ø—Ä–∞–≤–∏–ª–∞ –æ–∫–æ–ª–æ 800 –ª–µ—Ç."
  },
  {
    question: "–ù–∞–∑–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–Ω–∞–º–µ–Ω–∏—Ç–æ–≥–æ —Å–∞–º–æ–ª—ë—Ç–∞ ¬´–°–≤–µ—Ä—Ö–∫—Ä–µ–ø–æ—Å—Ç—å¬ª, —Å–±—Ä–æ—Å–∏–≤—à–µ–≥–æ –∞—Ç–æ–º–Ω—ã–µ –±–æ–º–±—ã –Ω–∞ –Ø–ø–æ–Ω–∏—é.",
    hints: [
      "1. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –ó–µ–º–ª–∏ –¥–æ –ü–ª—É—Ç–æ–Ω–∞ –≤ –∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö –ø—Ä–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º —Å–±–ª–∏–∂–µ–Ω–∏–∏.",
      "2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞ –Ω–∞—á–∞–ª–∞ –í–µ–ª–∏–∫–æ–π –¥–µ–ø—Ä–µ—Å—Å–∏–∏ –≤ –°–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã—Ö –®—Ç–∞—Ç–∞—Ö.",
      "3. –°—Ç–æ–ª—å–∫–æ –¥–Ω–µ–π —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ —Ñ–µ–≤—Ä–∞–ª—å –≤ –≤–∏—Å–æ–∫–æ—Å–Ω—ã–π –≥–æ–¥."
    ],
    answer: "29",
    fact: "Boeing B-29 Superfortress. –ï–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–∏–ª–∞ –¥–æ—Ä–æ–∂–µ –≤—Å–µ–≥–æ –∞—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî —Ü–µ–ª—ã—Ö 3 –º–∏–ª–ª–∏–∞—Ä–¥–∞ –¥–æ–ª–ª–∞—Ä–æ–≤!"
  },
  {
    question: "–°–æ–≥–ª–∞—Å–Ω–æ –≤–∞–≤–∏–ª–æ–Ω—Å–∫–æ–º—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é –æ –º–∏—Ä–µ, –æ–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–º–µ–Ω–Ω–æ –∏–∑ —Ç–∞–∫–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Å—Ç–µ–π. –ù–∞–∑–æ–≤–∏—Ç–µ —á–∏—Å–ª–æ:",
    hints: [
      "1. –ß–µ—Ä–µ–∑ —Å—Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–∏—Ü –ø—Ä–æ—Ö–æ–¥–∏–ª–∞ –ø—Ä–µ—Å–ª–æ–≤—É—Ç–∞—è ¬´–û—Å—å –∑–ª–∞¬ª.",
      "2. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∫—Ä—É–∂–µ–∫ –ø–∏–≤–∞ –∑–∞–∫–∞–∑–∞–ª –≥–µ—Ä–æ–π –≤ —Ñ–∏–ª—å–º–µ ¬´–ë–µ—Å—Å–ª–∞–≤–Ω—ã–µ —É–±–ª—é–¥–∫–∏¬ª, –∏–∑-–∑–∞ —á–µ–≥–æ –±—ã–ª —Ä–∞—Å–∫—Ä—ã—Ç.",
      "3. –°—Ç–æ–ª—å–∫–æ –∏–º–ø–µ—Ä–∏–π —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–æ –≤ —Ç—Ä—ë—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –†–µ—á–∏ –ü–æ—Å–ø–æ–ª–∏—Ç–æ–π."
    ],
    answer: "3",
    fact: "–î–ª—è –¥—Ä–µ–≤–Ω–∏—Ö –≤–∞–≤–∏–ª–æ–Ω—è–Ω —á–∏—Å–ª–æ 3 –±—ã–ª–æ —Å–∞–∫—Ä–∞–ª—å–Ω—ã–º –∏ –æ–ø—Ä–µ–¥–µ–ª—è–ª–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—Å–µ–π –í—Å–µ–ª–µ–Ω–Ω–æ–π."
  },
  {
    question: "–ù–∞–∑–æ–≤–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Å–ª–∞–≤—è–Ω—Å–∫–∏—Ö –Ω–∞—Ä–æ–¥–æ–≤ –≤—ã–¥–µ–ª—è—é—Ç –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —ç—Ç–Ω–æ–ª–æ–≥–∏–∏?",
    hints: [
      "1. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ –∏ –∫—Ä–µ–ø–æ—Å—Ç–µ–π —É–¥–æ—Å—Ç–æ–µ–Ω—ã –ø–æ—á–µ—Ç–Ω–æ–≥–æ –∑–≤–∞–Ω–∏—è ¬´–ì–µ—Ä–æ–π¬ª.",
      "2. –†–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –ª—É–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∑–∞ –æ–¥–∏–Ω –ø–æ–ª–Ω—ã–π –∑–µ–º–Ω–æ–π –≥–æ–¥.",
      "3. –≠—Ç–æ —á–∏—Å–ª–æ —Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ö–æ—Ä—Ä–æ—Ä–∞ –ø—Ä–æ –î–∂–µ–π—Å–æ–Ω–∞ –í—É—Ä—Ö–∏–∑–∞ ‚Äî –º–∞–Ω—å—è–∫–∞ –≤ —Ö–æ–∫–∫–µ–π–Ω–æ–π –º–∞—Å–∫–µ."
    ],
    answer: "13",
    fact: "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: —ç—Ç–∏ 13 –Ω–∞—Ä–æ–¥–æ–≤ –æ–±—Ä–∞–∑—É—é—Ç —Å–∞–º—É—é –±–æ–ª—å—à—É—é –ø–æ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ —è–∑—ã–∫–æ–≤—É—é –≥—Ä—É–ø–ø—É –≤–æ –≤—Å–µ–π –ï–≤—Ä–æ–ø–µ."
  },
  { 
    question: "–ö–∞–∫—É—é —Ü–µ–Ω—É –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –Ω–∞–∑—ã–≤–∞—é—Ç –∑–∞ —É—Å–ª—É–≥–∏ –≤ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ–º –º–µ–º–µ Gachimuchi?", 
    hints: ["1. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏–¥–µ–∞–ª—å–Ω–æ–π –ø–∞—Ä—Ç–∏–∏ –≤ –±–æ—É–ª–∏–Ω–≥.", "2. –†–∏–º—Å–∫–∞—è –∑–∞–ø–∏—Å—å —ç—Ç–æ–≥–æ —á–∏—Å–ª–∞: CCC.", "3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞—Ä—Ç–∞–Ω—Ü–µ–≤ —Ü–∞—Ä—è –õ–µ–æ–Ω–∏–¥–∞."], 
    answer: "300", 
    fact: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ ¬´Three hundred bucks¬ª —Å—Ç–∞–ª–∏ –æ–¥–Ω–∏–º –∏–∑ —Å–∞–º—ã—Ö —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö –º–µ–º–æ–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞." 
  },
  { 
    question: "–ë–õ–ò–¶: –ö–∞–∫–æ–≤–∞ —Å–∫–æ—Ä–æ—Å—Ç—å —ç—è–∫—É–ª—è—Ç–∞ –≤ –∫–º/—á –ø—Ä–∏ –µ–≥–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –∏–∑–≤–µ—Ä–∂–µ–Ω–∏–∏?", 
    hints: ["1. –°—É–º–º–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –ú–∞–π–∫–ª–∞ –î–∂–æ—Ä–¥–∞–Ω–∞ –∏ —á–∏—Å–ª–∞ 22.", "2. –î–≤–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –û–û–ù.", "3. –ì—Ä–∞–¥—É—Å–Ω–∞—è –º–µ—Ä–∞ –ø–æ–ª–æ–≤–∏–Ω—ã –ø—Ä—è–º–æ–≥–æ —É–≥–ª–∞."], 
    answer: "45", 
    fact: "–≠—Ç–æ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–∫—Ç –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –±–∏–æ–ª–æ–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ —Ü–∏—Ç–∏—Ä—É—é—Ç –≤ –Ω–∞—É—á-–ø–æ–ø–µ." 
  }
];

// --- 3. HELPERS ---
const encodeCat = (str: string) => Buffer.from(str).toString('base64').replace(/=/g, '');
const decodeCat = (str: string) => Buffer.from(str, 'base64').toString('utf-8');

const parseEventDesc = (desc: string | null) => {
  if (!desc) return { title: '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', address: '–£—Ç–æ—á–Ω—è–µ—Ç—Å—è' };
  const parts = desc.split('###');
  return { title: parts[0].trim(), address: parts[1] ? parts[1].trim() : '–°–µ–∫—Ä–µ—Ç–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è –æ—Ç–∫—Ä–æ–µ–∫—Ç—Å—è –∑–∞ 3 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ üîí' };
};

async function notifyNextInWaitlist(eventId: number, eventType: string, dateString: string) {
    const nextInLine = await db.query.bookings.findFirst({
        where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, false)),
        orderBy: [asc(schema.bookings.id)]
    });

    if (nextInLine) {
        const candidate = await db.query.users.findFirst({ where: eq(schema.users.id, nextInLine.userId) });
        if (candidate) {
            await bot.telegram.sendMessage(candidate.telegramId, 
                `üî• <b>–•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏!</b>\n\n–ù–∞ –∏–≥—Ä—É "${eventType}" (${dateString}) –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å –º–µ—Å—Ç–æ! ü•Ç\n\n–°–∫–æ—Ä–µ–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ "–ò–≥—Ä—ã", —á—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –µ–≥–æ!`, 
                { parse_mode: 'HTML' }).catch(() => {});
        }
    }
}



// --- 4. STATE ---

const PENDING_PAYMENTS = new Map<string, { time: DateTime, notified: boolean }>();

const FAST_DATES_STATE = {
  eventId: 0,
  currentRound: 1, // –¢–µ–∫—É—â–∏–π —Ä–∞—É–Ω–¥
  participants: new Map<number, any>(), // –¢—É—Ç —Ö—Ä–∞–Ω–∏–º –≤—Å–µ—Ö –ø–æ Telegram ID
  votes: new Map<number, number[]>()
};;

const STOCK_STATE = {
  isActive: false,
  currentEventId: 0, // <--- –°—é–¥–∞ –±–æ—Ç –∑–∞–ø–æ–º–Ω–∏—Ç ID –∏–≥—Ä—ã –ø–æ—Å–ª–µ —Ç–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
  currentQuestionIndex: -1,
  currentPhase: 0,
  playerAnswers: new Map<number, number>(), // userId -> –æ—Ç–≤–µ—Ç
  participants: new Map<number, { id: number, num: number, name: string }>() // userId -> –∏–Ω—Ñ–æ
};

const TALK_STATE = { currentFact: '', currentUser: '', isActive: false };

// --- 5. –ë–û–¢ –ò –°–¶–ï–ù–´ ---
const bot = new Telegraf<any>(process.env.TELEGRAM_BOT_TOKEN || '');

// 1. –ú–∞—Å—Ç–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
const registerWizard = new Scenes.WizardScene(
  'REGISTER_SCENE',
  // --- –®–ê–ì 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∑–∞–ø—Ä–æ—Å –ò–º–µ–Ω–∏ ---
  async (ctx) => {
    await ctx.replyWithHTML(
      `üëã <b>–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!</b>\n\n` +
      `–ù—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ —Ç–µ–±—è –≤ –±–∞–∑—É –ê–ª–≥–æ—Ä–∏—Ç–º–∞, –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–π–¥–∏ –∞–Ω–∫–µ—Ç—É –∏–∑ 3-—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–≤—Å–µ–≥–æ 30 —Å–µ–∫—É–Ω–¥). ` +
      `–ü–æ—Å–ª–µ –∞–Ω–∫–µ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –≤ "–ò–≥—Ä—ã" –∏ –ø–æ–∫—É–ø–∞–π –±–∏–ª–µ—Ç –±–µ–∑ –ø–æ–º–µ—Ö!\n\n` +
      `<b>1. –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? (–ø–∏—à–∏ –ø—Ä—è–º —Å—é–¥–∞ —Å–≤–æ—ë –∏–º—è)</b>`
    );
    return ctx.wizard.next();
  },

  // --- –®–ê–ì 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ –∑–∞–ø—Ä–æ—Å –í–æ–∑—Ä–∞—Å—Ç–∞ ---
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    (ctx.wizard.state as any).name = ctx.message.text;
    await ctx.reply('2. –°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ø–æ–ª–Ω—ã—Ö –ª–µ—Ç? (–í–≤–µ–¥–∏ —á–∏—Å–ª–æ)');
    return ctx.wizard.next();
  },

  // --- –®–ê–ì 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –∑–∞–ø—Ä–æ—Å –ü–æ–ª–∞ ---
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const age = parseInt(ctx.message.text);
    if (isNaN(age)) {
      return ctx.reply('‚ùå –û—à–∏–±–∫–∞! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤–æ–∑—Ä–∞—Å—Ç —Ü–∏—Ñ—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25):');
    }
    (ctx.wizard.state as any).age = age.toString();
    await ctx.reply(
      '3. –¢–≤–æ–π –ø–æ–ª (–¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –ø–∞—Ä –Ω–∞ –∏–≥—Ä–∞—Ö):',
      Markup.keyboard([['–ú—É–∂—á–∏–Ω–∞', '–ñ–µ–Ω—â–∏–Ω–∞']]).oneTime().resize()
    );
    return ctx.wizard.next();
  },

  // --- –®–ê–ì 4: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∞, –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –∏ –†–µ–¥–∏—Ä–µ–∫—Ç ---
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const input = ctx.message.text.toLowerCase();

    // –ú–ê–ì–ò–Ø –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò: –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –ª—é–±–æ–π –≤–≤–æ–¥ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç
    let normalizedGender = '';
    if (input.includes('–º—É–∂')) normalizedGender = '–ú—É–∂—á–∏–Ω–∞';
    else if (input.includes('–∂–µ–Ω')) normalizedGender = '–ñ–µ–Ω—â–∏–Ω–∞';

    // –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –ø–æ–Ω—è–ª, —á—Ç–æ –≤–≤–µ–ª–∏
    if (!normalizedGender) {
      return ctx.reply(
        '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –ø–æ–ª –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ üëá',
        Markup.keyboard([['–ú—É–∂—á–∏–Ω–∞', '–ñ–µ–Ω—â–∏–Ω–∞']]).oneTime().resize()
      );
    }

    const data = ctx.wizard.state as any;

    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
    await db.update(schema.users).set({
      name: data.name,
      birthDate: data.age,
      gender: normalizedGender // –ó–¥–µ—Å—å –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –ª–∏–±–æ "–ú—É–∂—á–∏–Ω–∞", –ª–∏–±–æ "–ñ–µ–Ω—â–∏–Ω–∞"
    }).where(eq(schema.users.telegramId, ctx.from!.id));

    await ctx.reply(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú—ã –∑–∞–ø–∏—Å–∞–ª–∏: ${normalizedGender}`);

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–µ—Ä–Ω—É—Ç—å —é–∑–µ—Ä–∞ –∫ –æ–ø–ª–∞—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–≥—Ä—ã
    const eventId = data.returnToEvent;

    if (eventId) {
      await ctx.reply('üöÄ –í–æ–∑–≤—Ä–∞—â–∞—é —Ç–µ–±—è –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –∏–≥—Ä—ã...');
      const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
      if (event) {//gemini –Ω–∞–ø–∏—à–∏ –º–Ω–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —á—Ç–æ —Ç—ã –ª—é–±–∏—à—å –∏ —è–±–ª–æ–∫–∏ 
        await ctx.reply(
          `–í—ã –≤—ã–±—Ä–∞–ª–∏: ${event.type} (${event.dateString})\n–ö –æ–ø–ª–∞—Ç–µ: 50 PLN`,
          Markup.inlineKeyboard([[Markup.button.callback('üí∏ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', `pay_event_${eventId}`)]])
        );
        return ctx.scene.leave();
      }
    }

    // 3. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω—è–ª –∞–Ω–∫–µ—Ç—É –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞ ‚Äî –æ–±—ã—á–Ω—ã–π –≤—ã—Ö–æ–¥ –≤ –º–µ–Ω—é
    await ctx.reply('–¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –ª—é–±—ã–µ –∏–≥—Ä—ã –∫–ª—É–±–∞!', getMainKeyboard());
    return ctx.scene.leave();
  }
);

const editFactWizard = new Scenes.WizardScene(
  'EDIT_FACT_SCENE',
  async (ctx) => {
    await ctx.replyWithHTML(
      `ü§´ <b>–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã</b>\n\n` +
      `–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –Ω–µ–æ–±—ã—á–Ω—ã–π –∏–ª–∏ –∑–∞–±–∞–≤–Ω—ã–π —Ñ–∞–∫—Ç –æ —Å–µ–±–µ. \n\n` +
      `<i>–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´—è –±–æ—é—Å—å –±–∞–±–æ—á–µ–∫¬ª, ¬´–æ–¥–Ω–∞–∂–¥—ã —è –≤—ã–∏–≥—Ä–∞–ª –≤ –ª–æ—Ç–µ—Ä–µ—é¬ª –∏–ª–∏ ¬´—è —É–º–µ—é –∏–≥—Ä–∞—Ç—å –Ω–∞ –ª–æ–∂–∫–∞—Ö¬ª. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ —É–≥–∞–¥—ã–≤–∞–ª–∏, —á–µ–π —ç—Ç–æ —Ñ–∞–∫—Ç!</i> üëá`
    );
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const fact = ctx.message.text;

    await db.update(schema.users)
      .set({ fact: fact })
      .where(eq(schema.users.telegramId, ctx.from!.id));

    await ctx.reply('‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –¢–µ–ø–µ—Ä—å —Ç—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –≤ –ø—É–ª–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞—à–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã. ‚ú®', getMainKeyboard());
    return ctx.scene.leave();
  }
);


  
const addEventWizard = new Scenes.WizardScene(
  'ADD_EVENT_SCENE',
  async (ctx) => {
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –∏–≥—Ä—ã (talk_toast, stock_know, speed_dating):');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    (ctx.wizard.state as any).type = ctx.message.text;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 15.01.2026 19:00):');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const dateStr = ctx.message.text;
    const checkDate = DateTime.fromFormat(dateStr, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
    if (!checkDate.isValid) return ctx.reply("‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞! –í–≤–µ–¥–∏: 15.01.2026 19:00");
    (ctx.wizard.state as any).date = dateStr;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ù–∞–∑–≤–∞–Ω–∏–µ ### –ê–¥—Ä–µ—Å');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    (ctx.wizard.state as any).desc = ctx.message.text;
    await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –º–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:');
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return;
    const state = ctx.wizard.state as any;
    const max = parseInt(ctx.message.text);
    if (isNaN(max)) return ctx.reply('–û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.');
    await db.insert(schema.events).values({
      type: state.type,
      dateString: state.date,
      description: state.desc,
      maxPlayers: max,
      isActive: true
    });
    await ctx.reply('‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
    return ctx.scene.leave();
  }
);


const msgEventWizard = new Scenes.WizardScene(
  'MSG_EVENT_SCENE',
  async (ctx) => {
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    if (events.length === 0) {
      await ctx.reply('–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä –ø–æ–∫–∞ –Ω–µ—Ç.');
      return ctx.scene.leave();
    }
    const btns = events.map(e => [Markup.button.callback(`${e.dateString} | ${e.type}`, `select_msg_ev_${e.id}`)]);
    await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:', Markup.inlineKeyboard(btns));
    return ctx.wizard.next();
  },
  async (ctx) => {
    if (ctx.callbackQuery && 'data' in ctx.callbackQuery) {
      const data = ctx.callbackQuery.data;
      if (data.startsWith('select_msg_ev_')) {
        const eid = parseInt(data.replace('select_msg_ev_', ''));
        (ctx.wizard.state as any).selectedEventId = eid;
        await ctx.answerCbQuery();
        await ctx.editMessageText('‚úÖ –ò–≥—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞. –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –¢–ï–ö–°–¢ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:');
        return ctx.wizard.next();
      }
    }
    return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É –∫–Ω–æ–ø–∫–æ–π.');
  },
  async (ctx) => {
    if (!ctx.message || !('text' in ctx.message)) return ctx.reply('–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.');
    const eventId = (ctx.wizard.state as any).selectedEventId;
    await broadcastToEvent(eventId, `üì¢ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤:</b>\n\n${(ctx.message as any).text}`);
    await ctx.reply('‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
    return ctx.scene.leave();
  }
);

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
const stage = new Scenes.Stage<any>([registerWizard, addEventWizard, msgEventWizard, editFactWizard]);
bot.use(session()); 
bot.use(stage.middleware());

// –ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
function getMainKeyboard(showTopicButton = false) {
    const buttons = [
        ['üéÆ –ò–≥—Ä—ã', 'üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç'],
        ['üÜò –ü–æ–º–æ—â—å', 'üìú –ü—Ä–∞–≤–∏–ª–∞']
    ];
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–ª–∞–≥ true
    if (showTopicButton) {
        buttons.unshift(['üé≤ –ù–æ–≤–∞—è —Ç–µ–º–∞']);
    }
    return Markup.keyboard(buttons).resize();
}

// --- 6. –ê–í–¢–û–ü–ò–õ–û–¢ (–ß–ò–°–¢–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –î–£–ë–õ–ï–ô) ---
setInterval(async () => {
  try {
    const now = DateTime.now().setZone('Europe/Warsaw'); 
    const activeEvents = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    
    for (const event of activeEvents) {
      const start = DateTime.fromFormat(event.dateString, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
      if (!start.isValid) continue;

      const diffHours = start.diff(now, 'hours').hours;
      const minutesSinceStart = now.diff(start, 'minutes').minutes;

      // 1. –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø (3 –î–ù–Ø –ò –£–¢–†–û)
      if (diffHours >= 71.5 && diffHours <= 72.5 && !PROCESSED_AUTO_ACTIONS.has(`remind_3d_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`remind_3d_${event.id}`);
        await broadcastToEvent(event.id, `üìÖ <b>–î–æ –≤—Å—Ç—Ä–µ—á–∏ –æ—Å—Ç–∞–ª–æ—Å—å 3 –¥–Ω—è!</b>\n\n–ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –∏–≥—Ä–µ "${event.type}". –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –±—É–¥–µ—Ç üî•. ‚ú®`);
      }
      if (now.hasSame(start, 'day') && now.hour === 10 && !PROCESSED_AUTO_ACTIONS.has(`morning_rem_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`morning_rem_${event.id}`);
        await broadcastToEvent(event.id, `‚òÄÔ∏è <b>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –¢–æ—Ç —Å–∞–º—ã–π –¥–µ–Ω—å!</b>\n\n–ñ–¥–µ–º —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è –Ω–∞ "${event.type}"! ‚ú®`);
      }

      // 2. –†–ê–°–ö–†–´–¢–ò–ï –ê–î–†–ï–°–ê (–ó–ê 3 –ß–ê–°–ê)
      if (diffHours >= 2.5 && diffHours <= 3.5 && !PROCESSED_AUTO_ACTIONS.has(`reveal_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`reveal_${event.id}`);
        const { address } = parseEventDesc(event.description);
        
        const rules = `üìç <b>–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏: ${address}</b>\n\n` +
          `1Ô∏è‚É£ <b>–ü—Ä–∏—Ö–æ–¥–∏ –∑–∞ 10‚Äì15 –º–∏–Ω—É—Ç:</b> –£—Å–ø–µ–µ—à—å —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑ –∏ —Å–Ω—è—Ç—å –∫—É—Ä—Ç–∫—É.\n` +
          `2Ô∏è‚É£ <b>–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å—Ç–æ–ª:</b> –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û —Å—Ç–æ–ª–∏–∫ –Ω–∞ –∏–º—è <b>"–ê–õ–ì–û–†–ò–¢–ú"</b>, –Ω–∏—á–µ–≥–æ –±–æ–ª–µ–µ.\n` +
          `3Ô∏è‚É£ <b>–ï—Å–ª–∏ —Ç—ã –ø–µ—Ä–≤—ã–π:</b> –ù–µ –±–µ—Å–ø–æ–∫–æ–π—Å—è, —Å–∞–¥–∏—Å—å, –∫–æ–º–ø–∞–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç, —Å—Ç–æ–∏—Ç –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å. ‚ú®\n` +
          `4Ô∏è‚É£ <b>–ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏:</b> –û–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –º–µ—Å—Ç–µ. üç≤\n` +
          `5Ô∏è‚É£ <b>–ó–∞—Ä—è–¥–∫–∞:</b> –ó–∞—Ä—è–¥–∏ —Ç–µ–ª–µ—Ñ–æ–Ω! –ë–æ—Ç ‚Äî —Ç–≤–æ–π –≤–µ–¥—É—â–∏–π –∏ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞—à –≤–µ—á–µ—Ä. üîã`;

        let gameSpec = "";
        if (event.type === 'talk_toast') gameSpec = `ü•Ç <b>Talk & Toast:</b> –¢–µ–±—è –∂–¥—É—Ç –≥–ª—É–±–æ–∫–∏–µ —Ç–µ–º—ã –∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω–∞!`;
        else if (event.type === 'stock_know') gameSpec = `üß† <b>Stock & Know:</b> –ë–∏—Ç–≤–∞ –∑–∞ –±–∞–Ω–∫! –¢–≤–æ–π –Ω–æ–º–µ—Ä –ø—Ä–∏–¥–µ—Ç —Å–ª–µ–¥–æ–º.`;
        else if (event.type === 'speed_dating') gameSpec = `üíò <b>–°–≤–∏–¥–∞–Ω–∏—è:</b> 7-10 –º–∏–Ω –Ω–∞ –ø–∞—Ä—É. –û—Ç–º–µ—á–∞–π —Å–∏–º–ø–∞—Ç–∏–∏ —Å—Ä–∞–∑—É!`;

        await broadcastToEvent(event.id, `${rules}\n\n${gameSpec}\n\n–ñ–¥–µ–º —Ç–µ–±—è! ü•Ç`);

        // –†–∞–∑–¥–∞—á–∞ –Ω–æ–º–µ—Ä–æ–≤
       // --- –£–ú–ù–ê–Ø –†–ê–ó–î–ê–ß–ê –ù–û–ú–ï–†–û–í –ü–†–ò –†–ê–°–ö–†–´–¢–ò–ò (–ó–ê 3 –ß–ê–°–ê) ---
        const bks = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) 
        });

        if (event.type === 'speed_dating') {
            const men: any[] = [], women: any[] = [];
            
            // 1. –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ø–æ –ø–æ–ª—É
            for (const b of bks) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
                if (u?.gender === '–ú—É–∂—á–∏–Ω–∞') men.push(u);
                else if (u?.gender === '–ñ–µ–Ω—â–∏–Ω–∞') women.push(u);
            }

            // 2. –†–∞–∑–¥–∞–µ–º –ø–∞—Ä—ã (–ø–æ –º–µ–Ω—å—à–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ —Å–∏–¥–µ–ª –æ–¥–∏–Ω)
            const limit = Math.min(men.length, women.length);
            for (let i = 0; i < limit; i++) {
                const wNum = (i * 2) + 1; // 1, 3, 5...
                const mNum = (i * 2) + 2; // 2, 4, 6...

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ø–∞–º—è—Ç—å —Å–≤–∏–¥–∞–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º telegramId –∫–∞–∫ –∫–ª—é—á)
                FAST_DATES_STATE.participants.set(women[i].telegramId, { id: women[i].telegramId, num: wNum, gender: '–ñ–µ–Ω—â–∏–Ω–∞', name: women[i].name });
                FAST_DATES_STATE.participants.set(men[i].telegramId, { id: men[i].telegramId, num: mNum, gender: '–ú—É–∂—á–∏–Ω–∞', name: men[i].name });

                // –®–ª–µ–º –∫–∞–∂–¥–æ–º—É –µ–≥–æ –ª–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä
                bot.telegram.sendMessage(women[i].telegramId, `üíò <b>–¢–≤–æ–π –Ω–æ–º–µ—Ä –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${wNum}</b> (–°—Ç–æ–ª–∏–∫ ‚Ññ${i + 1})\n\n–ñ–¥–µ–º —Ç–µ–±—è!`).catch(()=>{});
                bot.telegram.sendMessage(men[i].telegramId, `üíò <b>–¢–≤–æ–π –Ω–æ–º–µ—Ä –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${mNum}</b> (–°—Ç–æ–ª–∏–∫ ‚Ññ${i + 1})\n\n–ñ–¥–µ–º —Ç–µ–±—è!`).catch(()=>{});
            }

            // 3. –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –ø–∞—Ä—ã
            if (men.length !== women.length) {
                const extra = Math.abs(men.length - women.length);
                bot.telegram.sendMessage(ADMIN_ID, `‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> –ù–∞ –∏–≥—Ä–µ "${event.type}" –¥–∏—Å–±–∞–ª–∞–Ω—Å: ${extra} —á–µ–ª. –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –ø–∞—Ä—ã –∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏.`);
            }

        } else if (event.type === 'stock_know') {
            // –î–ª—è Stock & Know –ø–æ–ª –Ω–µ –≤–∞–∂–µ–Ω, –ø—Ä–æ—Å—Ç–æ –¥–∞–µ–º –Ω–æ–º–µ—Ä–∞ –ø–æ –ø–æ—Ä—è–¥–∫—É
            for (let i = 0; i < bks.length; i++) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, bks[i].userId) });
                if (u) {
                    const pNum = i + 1;
                    STOCK_STATE.participants.set(u.telegramId, { id: u.id, num: pNum, name: u.name || '–ò–≥—Ä–æ–∫' });
                    bot.telegram.sendMessage(u.telegramId, `üß† –¢–≤–æ–π –Ω–æ–º–µ—Ä –≤ Stock & Know: ${pNum}\n\n–ó–∞–ø–æ–º–Ω–∏ –µ–≥–æ –¥–ª—è —Å—Ç–∞–≤–æ–∫! üé∞`).catch(()=>{});
                }
            }
        }
      }

      // 3. –°–¢–ê–†–¢ –ò–ì–†–´ (–ü–†–ò–í–ï–¢–°–¢–í–ò–ï + –ö–ù–û–ü–ö–ê)
      // 3. –°–¢–ê–†–¢ –ò–ì–†–´ (–ü–†–ò–í–ï–¢–°–¢–í–ò–ï + –ö–ù–û–ü–ö–ê)
      if (minutesSinceStart >= 0 && minutesSinceStart <= 10 && !PROCESSED_AUTO_ACTIONS.has(`start_greet_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`start_greet_${event.id}`);
        const { title } = parseEventDesc(event.description);
        
        let needsTopic = (event.type.includes('talk_toast') || event.type === 'speed_dating');
        let msg = `ü•Ç <b>–ò–≥—Ä–∞ "${title}" –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!</b>\n\n–†–∞–¥—ã –≤—Å–µ—Ö –≤–∏–¥–µ—Ç—å! –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥—Ä—É–≥ –¥—Ä—É–≥—É (–∏–º—è –∏ –≤–∞—à–µ —Ö–æ–±–±–∏ –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å).`;
        
        if (needsTopic) {
            msg += `\n\n‚è± –ß–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É —è –ø—Ä–∏—à–ª—é –ø–µ—Ä–≤—É—é —Ç–µ–º—É –∏ –≤—ã–±–µ—Ä—É —Ç–æ–≥–æ, –∫—Ç–æ –Ω–∞—á–Ω–µ—Ç. –ö–Ω–æ–ø–∫–∞ <b>"üé≤ –ù–æ–≤–∞—è —Ç–µ–º–∞"</b> —É–∂–µ –≤ –≤–∞—à–µ–º –º–µ–Ω—é! ‚ú®`;
        }

        const bks = await db.query.bookings.findMany({ where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) });
        for (const b of bks) {
          const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
          if (u) await bot.telegram.sendMessage(u.telegramId, msg, { parse_mode: 'HTML', ...getMainKeyboard(needsTopic) }).catch(()=>{});
        }

        // --- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–ï–†–í–ê–Ø –¢–ï–ú–ê (–ß–ï–†–ï–ó 60 –°–ï–ö–£–ù–î) ---
        if (needsTopic) {
          setTimeout(async () => {
            // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
            const currentBks = await db.query.bookings.findMany({ 
                where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) 
            });
            
            const playersNames: string[] = [];
            for (const b of currentBks) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
                if (u?.name) playersNames.push(u.name);
            }

            // 2. –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–Ω–µ—Ç
            const starter = playersNames.length > 0 
                ? playersNames[Math.floor(Math.random() * playersNames.length)] 
                : "—Ç–æ–≥–æ, –∫—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è —Å–∞–º—ã–º —Å–º–µ–ª—ã–º";

            const randomTopic = CONVERSATION_TOPICS[Math.floor(Math.random() * CONVERSATION_TOPICS.length)];
            
            const topicMsg = `üé≤ <b>–¢–µ–º–∞ ‚Ññ1 –¥–ª—è —Ä–∞–∑–æ–≥—Ä–µ–≤–∞:</b>\n\n${randomTopic}\n\nüéô <b>–ù–∞—á–∏–Ω–∞–µ—Ç —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ:</b> <u>${starter}</u>`;
            
            await broadcastToEvent(event.id, topicMsg);
          }, 60000); // –†–æ–≤–Ω–æ 1 –º–∏–Ω—É—Ç–∞ (60 000 –º—Å)
        }
      }

      // 4. –í–ò–ö–¢–û–†–ò–ù–ê (105 –ú–ò–ù) –ò –ó–ê–í–ï–†–®–ï–ù–ò–ï (135 –ú–ò–ù)
      if (minutesSinceStart >= 105 && event.type.includes('talk_toast') && !PROCESSED_AUTO_ACTIONS.has(`quiz_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`quiz_${event.id}`); await runAutoQuiz(event.id);
      }
      if (minutesSinceStart >= 135 && !PROCESSED_AUTO_ACTIONS.has(`close_${event.id}`)) {
        PROCESSED_AUTO_ACTIONS.add(`close_${event.id}`); await autoCloseEvent(event.id);
      }
    }

    // 5. –û–ü–õ–ê–¢–ê (Pending)
    for (const [uId, data] of PENDING_PAYMENTS.entries()) {
      if (now.diff(data.time, 'minutes').minutes >= 30 && !data.notified) {
        const u = await db.query.users.findFirst({ where: eq(schema.users.id, parseInt(uId)) });
        if (u) {
          bot.telegram.sendMessage(u.telegramId, 
            `üîî <b>–û–π! –ú—ã —á—Ç–æ-—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏?</b>\n\n` +
            `–¢–≤–æ—ë –º–µ—Å—Ç–æ –Ω–∞ –∏–≥—Ä—É <b>${getGameName(event.type)}</b> –≤—Å—ë –µ—â—ë –∂–¥—ë—Ç —Ç–µ–±—è, –Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. ü•Ç\n\n` +
            `–ú–µ—Å—Ç–∞ –≤ –ê–ª–≥–æ—Ä–∏—Ç–º–µ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ, –∞ –º—ã –æ—á–µ–Ω—å —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –∑–∞ —Å—Ç–æ–ª–æ–º! –ù–∞–∂–º–∏ ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–∞—Å—Ç–∏–µ. ‚ú®`,
            { parse_mode: 'HTML' }
        ).catch(() => {});
        }
        PENDING_PAYMENTS.set(uId, { ...data, notified: true });
      }
      if (now.diff(data.time, 'minutes').minutes > 120) PENDING_PAYMENTS.delete(uId);
    }
  } catch (e) { console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞:", e); }
}, 60000);

// --- –§–£–ù–ö–¶–ò–ò –ê–í–¢–û–ü–ò–õ–û–¢–ê ---

async function runAutoQuiz(eventId: number) {
  const bks = await db.query.bookings.findMany({ where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true)) });
  if (bks.length < 2) return;
  await broadcastToEvent(eventId, `üîî <b>–í–ù–ò–ú–ê–ù–ò–ï! –í–∏–∫—Ç–æ—Ä–∏–Ω–∞!</b> –£–≥–∞–¥–∞–π—Ç–µ, —á–µ–π —ç—Ç–æ —Ñ–∞–∫—Ç –∏–∑ –∞–Ω–∫–µ—Ç—ã!`);
  await new Promise(r => setTimeout(r, 7000));
  const shuf = bks.sort(() => 0.5 - Math.random()).slice(0, 3);
  for (const b of shuf) {
    const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
    if (!u || !u.fact) continue;
    await broadcastToEvent(eventId, `‚ùì <b>–ß–ï–ô –≠–¢–û –§–ê–ö–¢?</b>\n\n¬´${u.fact}¬ª`);
    await new Promise(r => setTimeout(r, 30000));
    await broadcastToEvent(eventId, `üîì <b>–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢:</b> –≠—Ç–æ ‚Äî <b>${u.name}</b>! ‚ú®`);
    await new Promise(r => setTimeout(r, 7000));
  }
}

async function autoCloseEvent(eventId: number) {
  await db.update(schema.events).set({ isActive: false }).where(eq(schema.events.id, eventId));
  const bks = await db.query.bookings.findMany({ where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true)) });
  for (const b of bks) {
    const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
    if (u) {
      await db.update(schema.users).set({ gamesPlayed: (u.gamesPlayed || 0) + 1 }).where(eq(schema.users.id, u.id));
      bot.telegram.sendMessage(u.telegramId, 
        `‚ú® <b>–≠—Ç–æ –±—ã–ª –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤–µ—á–µ—Ä!</b>\n\n` +
        `–ù–∞–¥–µ–µ–º—Å—è, —Ç–µ–±–µ –±—ã–ª–æ —Ç–∞–∫ –∂–µ —Ç–µ–ø–ª–æ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ –∏ –Ω–∞–º. –í —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –±–∞–ª–ª –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –Ω–∞–ø–æ–º–Ω—é, —á—Ç–æ –∫–∞–∂–¥–∞—è 5-—è –≤—Å—Ç—Ä–µ—á–∞ —É –Ω–∞—Å –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è ü•Ç\n\n` +
        `–ë—É–¥–µ–º –æ—á–µ–Ω—å —Ä–∞–¥—ã —É–∑–Ω–∞—Ç—å —Ç–≤–æ–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–∞—Ä–æ–π —Å–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–∞–º –≤ <b>üÜò –ü–æ–º–æ—â—å</b>.\n\n` +
        `–ö—Å—Ç–∞—Ç–∏, –µ—Å–ª–∏ —É —Ç–µ–±—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π –≤–∏–¥–µ–æ-–æ—Ç–∑—ã–≤ (–∫—Ä—É–∂–æ—á–µ–∫ –∏–ª–∏ –æ—Ç–º–µ—Ç–∫–∞ –≤ —Å—Ç–æ—Ä–∏—Å), —Å –Ω–∞—Å –ø—Ä–∏—è—Ç–Ω—ã–π –±–æ–Ω—É—Å: <b>—Å–∫–∏–¥–∫–∞ -10 PLN</b> –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–≥—Ä—É üì∏\n\n` +
        `–î–æ –Ω–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏ –≤ –ê–ª–≥–æ—Ä–∏—Ç–º–µ!`, { parse_mode: 'HTML' }
);
    }
  }
}
// --- 7. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---

bot.start(async (ctx) => {
  let user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
  if (!user) {
    const startPayload = ctx.message.text.split(' ')[1]; 
    let referrerId = 0;
    if (startPayload?.startsWith('ref_')) referrerId = parseInt(startPayload.replace('ref_', ''));
    const [newUser] = await db.insert(schema.users).values({ telegramId: ctx.from.id, username: ctx.from.username, firstName: ctx.from.first_name, isAdmin: ctx.from.id === ADMIN_ID, invitedBy: referrerId || null }).returning();
    if (referrerId) { 
        await db.insert(schema.vouchers).values({ userId: newUser.id, status: 'approved_10' }); 
        await ctx.reply('üéÅ –¢–µ–±–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ 10 PLN –Ω–∞ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É –æ—Ç –¥—Ä—É–≥–∞!');
    }
  }
  return ctx.reply('üëã –ü—Ä–∏–≤–µ—Ç –≤ Allgorithm! –í—ã–±–∏—Ä–∞–π –∏–≥—Ä—É:', getMainKeyboard());
});

bot.hears('üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç', async (ctx) => {
  const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
  if (!user) return;

  const userVouchers = await db.query.vouchers.findMany({ 
    where: and(
        eq(schema.vouchers.userId, user.id), 
        or(eq(schema.vouchers.status, 'approved_10'), eq(schema.vouchers.status, 'approved_free'))
    ) 
  });

  const count10 = userVouchers.filter(v => v.status === 'approved_10').length;
  const countFree = userVouchers.filter(v => v.status === 'approved_free').length;

  // –í–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (–†–∞–∑–¥–µ–ª 7)
// –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å (–æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 5)
  const progress = (user.gamesPlayed || 0) % 5;
  const stars = 'üü©'.repeat(progress) + '‚¨ú'.repeat(5 - progress);

    let msg = `üë§ <b>–ò–º—è:</b> ${user.name || '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'}\n` +
              `üé´ <b>–°–∫–∏–¥–∫–∏ (-10 PLN):</b> ${count10} —à—Ç.\n` +
              `üéÅ <b>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–≥—Ä—ã:</b> ${countFree} —à—Ç.\n\n` +
              `üèÜ <b>–ü—É—Ç—å –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∏–≥—Ä–µ:</b>\n` +
              `${stars} (${progress}/5)\n` +
              `<i>–°—ã–≥—Ä–∞–π –µ—â–µ ${5 - progress}, –∏ —Å–ª–µ–¥—É—é—â–∞—è –∑–∞ –Ω–∞—à —Å—á—ë—Ç!</i> ü•Ç\n\n` +
              `üìñ <b>–¢–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è:</b> ${user.fact ? '‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–∞' : '‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞'}`;

  const buttons = [
    [Markup.button.callback(user.name ? '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É' : 'üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É', 'start_registration')],
    [Markup.button.callback(user.fact ? '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é' : 'üìù –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', 'start_edit_fact')],
    [Markup.button.callback('üì∏ –£ –º–µ–Ω—è –µ—Å—Ç—å –≤–∞—É—á–µ—Ä', 'upload_voucher')],
    [Markup.button.callback('üéÆ –ú–æ–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∏–≥—Ä—ã', 'my_games')],
    [Markup.button.callback('ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞', 'referral_info')]
  ];
  return ctx.replyWithHTML(msg, Markup.inlineKeyboard(buttons));
});

// –ò –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏:
bot.action('start_edit_fact', (ctx) => { ctx.deleteMessage(); ctx.scene.enter('EDIT_FACT_SCENE'); });

bot.action('referral_info', async (ctx) => {
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
    if (!user) return;
    const refLink = `https://t.me/${ctx.botInfo.username}?start=ref_${user.id}`;
    
    const msg = `ü§ù <b>–°–∫–∏–¥–∫–∞ –æ–±–æ–∏–º!</b>\n\n` +
                `‚Ä¢ –î—Ä—É–≥ –ø–æ–ª—É—á–∞–µ—Ç <b>-10 PLN</b> –Ω–∞ –ø–µ—Ä–≤—ã–π –±–∏–ª–µ—Ç.\n` +
                `‚Ä¢ –¢—ã –ø–æ–ª—É—á–∞–µ—à—å <b>-10 PLN</b> –ø–æ—Å–ª–µ –µ–≥–æ –ø–µ—Ä–≤–æ–π –∏–≥—Ä—ã!\n\n` +
                `–¢–≤–æ—è —Å—Å—ã–ª–∫–∞: <code>${refLink}</code>\n\n` +
                `<i>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥—É –ø—Ä—è–º–æ –≤ Telegram!</i> üëá`;

    const shareText = `–ü—Ä–∏–≤–µ—Ç! –ò–¥—É –Ω–∞ –∫—Ä—É—Ç—É—é –∏–≥—Ä—É –≤ –∫–ª—É–± "–ê–ª–≥–æ—Ä–∏—Ç–º", –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è! –ü–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –ø–æ–ª—É—á–∏—à—å -10 PLN –Ω–∞ –ø–µ—Ä–≤—ã–π –±–∏–ª–µ—Ç: ${refLink}`;

    await ctx.editMessageText(msg, { 
        parse_mode: 'HTML', 
        ...Markup.inlineKeyboard([
            [Markup.button.url('üöÄ –ü–µ—Ä–µ—Å–ª–∞—Ç—å –¥—Ä—É–≥—É', `https://t.me/share/url?url=${encodeURIComponent(shareText)}`)],
            [Markup.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', 'back_to_cabinet')]
        ]) 
    });
});

bot.action('back_to_cabinet', (ctx) => ctx.deleteMessage());

bot.hears('üéÆ –ò–≥—Ä—ã', (ctx) => {
  ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:', Markup.inlineKeyboard([
    [Markup.button.callback('Talk & Toast ü•Ç', 'game_talk')],
    [Markup.button.callback('Stock & Know üß†', 'game_stock')],
    [Markup.button.callback('–ë—ã—Å—Ç—Ä—ã–µ —Å–≤–∏–¥–∞–Ω–∏—è üíò', 'game_dating')]
  ]));
});

bot.hears('üé≤ –ù–æ–≤–∞—è —Ç–µ–º–∞', async (ctx) => {
  const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
  if (!user) return;

  const myBookings = await db.query.bookings.findMany({
    where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.paid, true))
  });

  let currentEvent = null;
  const nowWarsaw = DateTime.now().setZone('Europe/Warsaw');

  for (const b of myBookings) {
    const event = await db.query.events.findFirst({
      where: and(
        eq(schema.events.id, b.eventId),
        eq(schema.events.isActive, true)
      )
    });
    if (event) {
      const start = DateTime.fromFormat(event.dateString, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
      const diffHours = nowWarsaw.diff(start, 'hours').hours;
      // –ö–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 4 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞
      if (diffHours >= 0 && diffHours <= 4) {
        currentEvent = event;
        break;
      }
    }
  }

  if (!currentEvent) {
    return ctx.reply("‚ùå –ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã.", getMainKeyboard(false));
  }

  const randomTopic = CONVERSATION_TOPICS[Math.floor(Math.random() * CONVERSATION_TOPICS.length)];

  // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –°–í–ò–î–ê–ù–ò–ô (–¢–û–õ–¨–ö–û –î–õ–Ø –ü–ê–†–´) ---
  if (currentEvent.type === 'speed_dating') {
    const round = FAST_DATES_STATE.currentRound;
    const ps = Array.from(FAST_DATES_STATE.participants.values());
    
    const women = ps.filter(p => p.gender === '–ñ–µ–Ω—â–∏–Ω–∞').sort((a,b) => a.num - b.num);
    const men = ps.filter(p => p.gender === '–ú—É–∂—á–∏–Ω–∞').sort((a,b) => a.num - b.num);
    
    if (women.length === 0 || men.length === 0) return ctx.reply("–û—à–∏–±–∫–∞: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");

    const me = ps.find(p => p.id === ctx.from.id);
    if (!me) return ctx.reply("‚ùå –¢—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ç–µ–∫—É—â–µ–π —Ä–æ—Ç–∞—Ü–∏–∏.");

    let partner;
    const N = women.length;

    if (me.gender === '–ñ–µ–Ω—â–∏–Ω–∞') {
      const i = women.findIndex(w => w.id === me.id);
      const manIndex = (i + round - 1) % men.length;
      partner = men[manIndex];
    } else {
      const j = men.findIndex(m => m.id === me.id);
      const womanIndex = ((j - (round - 1)) % N + N) % N;
      partner = women[womanIndex];
    }

    if (partner) {
      const pairMsg = `üé≤ <b>–°–µ–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–æ–ª–∏–∫–∞:</b>\n\n${randomTopic}`;
      await bot.telegram.sendMessage(me.id, pairMsg, { parse_mode: 'HTML' });
      await bot.telegram.sendMessage(partner.id, pairMsg, { parse_mode: 'HTML' });
      return ctx.reply("‚úÖ –¢–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–µ–±–µ –∏ —Ç–≤–æ–µ–º—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É!");
    }

  // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –û–ë–´–ß–ù–û–ì–û –£–ñ–ò–ù–ê (–î–õ–Ø –í–°–ï–•) ---
  } else {
    const bksForTopic = await db.query.bookings.findMany({ 
      where: and(eq(schema.bookings.eventId, currentEvent.id), eq(schema.bookings.paid, true)) 
    });
    
    const players: string[] = [];
    for (const b of bksForTopic) {
      const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
      if (u?.name) players.push(u.name);
    }

    const starter = players.length > 0 ? players[Math.floor(Math.random() * players.length)] : "–∫—Ç–æ-—Ç–æ –∏–∑ –≤–∞—Å";
    await broadcastToEvent(currentEvent.id, `üé≤ <b>–ù–æ–≤–∞—è —Ç–µ–º–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Å—Ç–æ–ª–∞:</b>\n\n${randomTopic}\n\nüéô <b>–ù–∞—á–∏–Ω–∞–µ—Ç:</b> <u>${starter}</u>`);
    return ctx.reply("‚úÖ –¢–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º!");
  }
});

// –ö–Ω–æ–ø–∫–∞ "üìú –ü—Ä–∞–≤–∏–ª–∞"
bot.hears('üìú –ü—Ä–∞–≤–∏–ª–∞', (ctx) => {
  const rulesText = `üìú <b>–ü—Ä–∞–≤–∏–ª–∞ –∫–ª—É–±–∞ Allgorithm</b>\n\n` +
    `üîª <b>–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:</b>\n` +
    `1. 18+: –°—Ç—Ä–æ–≥–æ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏—Ö. –í—Ä–∞—Ç—å –ø—Ä–æ –≤–æ–∑—Ä–∞—Å—Ç ‚Äî –≤–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.\n` +
    `2. –ß–µ—Å—Ç–Ω–∞—è –∏–≥—Ä–∞: –ë–µ–∑ –æ–±–º–∞–Ω–∞, –≥—É–≥–ª–∞ –∏ –º—É—Ö–ª–µ–∂–∞. –ú—ã –∑–¥–µ—Å—å –∑–∞ —á–∏–ª–æ–º!\n` +
    `3. –ö—É–ª—å—Ç—É—Ä–∞: –ú–∞—Ç, —Å–ø–∞–º –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è = –±–∞–Ω –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.\n` +
    `4. –û–ø–ª–∞—Ç–∞: –ù–µ—Ç –æ–ø–ª–∞—Ç—ã ‚Äî –Ω–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.(–Ω–µ—Ç—É —Ä—É—á–µ–∫ - –Ω–µ—Ç –∫–æ–Ω—Ñ–µ—Ç–∫–∏) –ü–ª–∞—Ç–µ–∂ ‚Äî –≤–∞—à –≤—Ö–æ–¥–Ω–æ–π –±–∏–ª–µ—Ç.\n` +
    `5. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è: –°–ª–æ–≤–æ –≤–µ–¥—É—â–µ–≥–æ ‚Äî –∑–∞–∫–æ–Ω. –ú–æ–∂–µ–º —É–¥–∞–ª–∏—Ç—å –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤.\n\n` +
    `üîª <b>–í–û–ó–í–†–ê–¢ –°–†–ï–î–°–¢–í:</b>\n` +
    `1. –ó–∞ 36 —á–∞—Å–æ–≤: –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç–µ –∑–∞ 36 —á–∞—Å–æ–≤ ‚Äî –≤–µ—Ä–Ω–µ–º –¥–µ–Ω—å–≥–∏.\n` +
    `2. –ú–µ–Ω–µ–µ 36 —á–∞—Å–æ–≤: –î–µ–Ω—å–≥–∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è.\n` +
    `3. –û—Ç–º–µ–Ω–∞ –∏–≥—Ä—ã: –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–∏–º –º—ã ‚Äî –≤–µ—Ä–Ω–µ–º –≤—Å–µ–º.\n\n` +
    `üîª <b>–ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø:</b>\n` +
    `1. –¢–∞–π–º–∏–Ω–≥: –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 10-15 –º–∏–Ω—É—Ç –¥–æ, —á—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å –µ–¥—É.\n` +
    `2. –ï–¥–∞ –∏ –ù–∞–ø–∏—Ç–∫–∏: –û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ.\n` +
    `3. –¢–∏—à–∏–Ω–∞: –ù–µ –±–æ–ª—Ç–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª.\n` +
    `4. –ë–µ–∑ —Å–æ–≤–µ—Ç–æ–≤: –ù–µ –ø–µ—Ä–µ–±–∏–≤–∞–π—Ç–µ –≤–µ–¥—É—â–∏—Ö. –í—Å–µ –∂–∞–ª–æ–±—ã –∏ —Å–æ–≤–µ—Ç—ã ‚Äî –≤ –∫–æ–Ω—Ü–µ –≤–µ—á–µ—Ä–∞.\n` +
    `5. –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ—É–º–µ—Å—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥—É—à–Ω–æ—Ç—É –¥–æ–º–∞. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –∏–≥—Ä—ã.`;

  ctx.replyWithHTML(rulesText);
}); // Gemini —è —Ç–µ–±—è –ª—é–±–ª—é, —Ç—ã –ª—É—á—à–∏–π) –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–µ—Ä–¥–µ—á–∫–æ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞

// –ö–Ω–æ–ø–∫–∞ "üÜò –ü–æ–º–æ—â—å"
bot.hears('üÜò –ü–æ–º–æ—â—å', (ctx) => {
  (ctx.session as any).waitingForSupport = true; // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
  ctx.reply('–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä—è–º–æ —Å—é–¥–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è! üëá ¬´–ú—ã –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 15‚Äì30 –º–∏–Ω—É—Ç. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å—Ä–æ—á–Ω—ã–π ‚Äî –Ω–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å, –º—ã –≤—Å—ë –≤–∏–¥–∏–º!¬ª');
});

// --- 8. –õ–û–ì–ò–ö–ê –ò–ì–† ---

bot.action('game_talk', (ctx) => {
  const text = `ü•Ç <b>Talk & Toast</b>\n\n` +
    `<b>–ß—Ç–æ —ç—Ç–æ?</b>\n` +
    `–≠—Ç–æ –Ω–µ —Å–≤–∏–¥–∞–Ω–∏—è –∏ –Ω–µ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥ ‚Äî —ç—Ç–æ –ª—ë–≥–∫–∞—è, –¥—Ä—É–∂–µ—Å–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –≥–¥–µ –∫–∞–∂–¥—ã–π —á—É–≤—Å—Ç–≤—É–µ—Ç —Å–µ–±—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∏ –Ω–µ–ø—Ä–∏–Ω—É–∂–¥—ë–Ω–Ω–æ ‚ú®\n\n` +
    `<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n` +
    `–í —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ <b>–Ω–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –≤–µ–¥—É—â–µ–≥–æ</b> ‚Äî –≤–µ—Å—å –≤–µ—á–µ—Ä –º–æ–¥–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞—à –±–æ—Ç. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –ø–∞—Ñ–æ—Å–∞.\n\n` +
    `–í –ø–µ—Ä–≤—ã–µ –º–∏–Ω—É—Ç—ã –≤—Å—Ç—Ä–µ—á–∏ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—à–ª–µ—Ç –í–∞–º –ø–µ—Ä–≤—É—é —Ç–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ, –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –≥–ª—É–±–æ–∫—É—é —Ç–µ–º—É –º–æ–∂–Ω–æ –Ω–∞–∂–∞–≤ –Ω–∞ –∫–ª–∞–≤–∏—à—É <b>¬´–Ω–æ–≤–∞—è —Ç–µ–º–∞¬ª</b> üé≤\n\n` +
    `<b>–ó–∞—á–µ–º —ç—Ç–æ?</b>\n` +
    `‚Ä¢ –í—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ä–æ—à–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–µ—á–µ—Ä –≤ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ üç∑\n` +
    `‚Ä¢ –ù–∞–π—Ç–∏ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π, –¥–µ–ª–æ–≤—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏ –¥–∞–∂–µ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω–∫—É ü§ù\n` +
    `‚Ä¢ –û—Ç–∫—Ä—ã—Ç—å –¥–ª—è —Å–µ–±—è –Ω–æ–≤—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–æ–±—ã—á–Ω—ã–µ –±–ª—é–¥–∞ üçù\n\n` +
    `<b>–ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –ø–æ–π—Ç–∏?</b>\n` +
    `‚Ä¢ –ù–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –ª—é–¥—å–º–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã –±—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å üåç\n` +
    `‚Ä¢ –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å ‚Äî –±–æ—Ç-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–¥–µ–ª–∞–µ—Ç –≤—Å—ë –∑–∞ –≤–∞—Å! üòé\n\n` +
    `üç≤ <b>–í–∞–∂–Ω–æ:</b> –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∏–≥—Ä—ã —Å–æ –∑–Ω–∞—á–∫–æ–º –∏ —Å–∫–∏–¥–∫–æ–π "üé•" –∏ —Å–∫–∏–¥–∫–æ–π -50% –ü–æ–∫—É–ø–∞—è –±–∏–ª–µ—Ç –Ω–∞ –∏–≥—Ä—É —Å–æ —Å—ä–µ–º–∫–æ–π, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö`;

  return ctx.editMessageText(text, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([
      [Markup.button.callback('üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'book_talk')], 
      [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]
    ]) 
  });
});

bot.action('game_stock', (ctx) => {
  const text = `üß† <b>Stock & Know</b>\n\n` +
    `<b>–ß—Ç–æ —ç—Ç–æ?</b>\n–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞, –≥–¥–µ —Å—Ç–∞–≤—è—Ç –Ω–∞ –∑–Ω–∞–Ω–∏—è! üéì –ó–¥–µ—Å—å –≤–∞–∂–Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –±–∞–≥–∞–∂–∞ –∑–Ω–∞–Ω–∏–π, –Ω–æ –∏ —É–º–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ –¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫–∏. –≠—Ç–æ –æ—Å—Ç—Ä–æ—É–º–Ω–∞—è –±–∏—Ç–≤–∞, –≥–¥–µ —Å–ø–ª–µ—Ç–µ–Ω—ã –∏—Å–∫—É—Å—Å—Ç–≤–æ –±–ª–µ—Ñ–∞ –∏ —ç—Ä—É–¥–∏—Ü–∏—è üé≠\n\n` +
    `<b>–ó–∞—á–µ–º —ç—Ç–æ?</b>\n‚Ä¢ –®–∞–Ω—Å –Ω–∞–π—Ç–∏ –Ω–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤ üëÄ\n‚Ä¢ –ù–µ–∑–∞–±—ã–≤–∞–µ–º—ã–µ —ç–º–æ—Ü–∏–∏ –æ—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π –∏–≥—Ä—ã üî•\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π, —É–¥–∞—á–∏ –∏ –æ—Å—Ç—Ä–æ—É–º–∏—è üçÄ\n‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—Ä—É–≥–æ–∑–æ—Ä–∞ üåç\n\n` +
    `<b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n–í –Ω–∞—á–∞–ª–µ —Ä–∞—É–Ω–¥–∞ –≤—Å–µ –¥–µ–ª–∞—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É üí∞. –í–µ–¥—É—â–∏–π –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –≤—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç–µ –æ—Ç–≤–µ—Ç (–º–µ–Ω—è—Ç—å –Ω–µ–ª—å–∑—è!). –ó–∞—Ç–µ–º, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∑–∞—Ä—Ç–∞, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–≤—ã—à–∞—Ç—å —Å—Ç–∞–≤–∫–∏ (–¥–∞–∂–µ –≤–∞-–±–∞–Ω–∫!). –í–µ–¥—É—â–∏–π –¥–∞–µ—Ç 3 –ø–æ–¥—Å–∫–∞–∑–∫–∏ üí° ‚Äî –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ç–∞–≤–∫—É. –ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –±–ª–∏–∂–µ –≤—Å–µ—Ö –∫ –∏—Å—Ç–∏–Ω–µ!\n\n` +
    `‚è≥ <b>–í—Ä–µ–º—è:</b> 2 —á–∞—Å–∞\nüë• <b>–ò–≥—Ä–æ–∫–æ–≤:</b> –¥–æ 8\nüç≤ <b>–ú–µ–Ω—é:</b> –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∏–≥—Ä—ã —Å–æ –∑–Ω–∞—á–∫–æ–º –∏ —Å–∫–∏–¥–∫–æ–π "üé•" –∏ —Å–∫–∏–¥–∫–æ–π -50% –ü–æ–∫—É–ø–∞—è –±–∏–ª–µ—Ç –Ω–∞ –∏–≥—Ä—É —Å–æ —Å—ä–µ–º–∫–æ–π, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö`;
  return ctx.editMessageText(text, { parse_mode: 'HTML', ...Markup.inlineKeyboard([[Markup.button.callback('üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'book_stock')], [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]]) });
});

bot.action('game_dating', (ctx) => {
  const text = `üíò <b>–ë—ã—Å—Ç—Ä—ã–µ —Å–≤–∏–¥–∞–Ω–∏—è</b>\n\n` +
    `<b>–ß—Ç–æ —ç—Ç–æ?</b>\nüó£Ô∏è 14 —á–µ–ª–æ–≤–µ–∫ (7–ñ + 7–ú), 7 —É—é—Ç–Ω—ã—Ö —Å—Ç–æ–ª–∏–∫–æ–≤ –∏ 10-–º–∏–Ω—É—Ç–Ω—ã–µ —Ä–∞—É–Ω–¥—ã. –ë–æ—Ç —Å–∞–º –≤—ã–¥–∞—Å—Ç –Ω–æ–º–µ—Ä–∞, –∑–∞–ø—É—Å—Ç–∏—Ç —Ç–∞–π–º–µ—Ä –∏ –ø–µ—Ä–µ—Ç–∞—Å—É–µ—Ç –ø–∞—Ä—ã üì≤. –¢–µ–±–µ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–∞—Ç—å —Å–∏–º–ø–∞—Ç–∏–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî –µ—Å–ª–∏ –º—ç—Ç—á, –±–æ—Ç –ø—Ä–∏—à–ª—ë—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã! ‚ú®\n\n` +
    `<b>–ó–∞—á–µ–º —ç—Ç–æ?</b>\n‚Ä¢ üöÄ <b>–°–µ–º—å —à–∞–Ω—Å–æ–≤</b> –Ω–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ –∑–∞ —á–∞—Å: –æ–¥–Ω–∞ –∏—Å–∫—Ä–∞ ‚Äî –∏ —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π —á–µ–ª–æ–≤–µ–∫!\n‚Ä¢ üí¨ <b>–ë–µ–∑ –Ω–µ–ª–æ–≤–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤</b> ‚Äî –±–æ—Ç —Å–∞–º –ø–æ–¥—Å–∫–∞–∂–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é —Ç–µ–º—É –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.\n‚Ä¢ üéØ <b>–¢–æ–ª—å–∫–æ –º—ç—Ç—á–∏:</b> —É—Ö–æ–¥–∏—à—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ —Ç–µ—Ö, –∫—Ç–æ —Ç–µ–±–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è.\n‚Ä¢ üõ°Ô∏è <b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ:</b> –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è ‚Äî –æ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç —Ç–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç.\n\n` +
    `<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n‚ú® –ò—Å–ø—ã—Ç–∞–π—Ç–µ –∏—Å–∫—Ä—É —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞! –ú—É–∂—á–∏–Ω—ã –∏ –∂–µ–Ω—â–∏–Ω—ã —Å–∞–¥—è—Ç—Å—è –ø–æ –¥–≤–æ–µ –∑–∞ —Å—Ç–æ–ª–∏–∫–∏, –∞ –±–æ—Ç –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –∫–∞–∂–¥–æ–º—É —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä üé´. –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –ø–∞—Ä—ã –º–µ–Ω—è—é—Ç—Å—è üîÑ, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å–æ –≤—Å–µ–º–∏. \n\n–í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ—á–∞–π —Å–∏–º–ø–∞—Ç–∏–∏ –≤ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–µ ‚ù§Ô∏è. –ï—Å–ª–∏ —á—É–≤—Å—Ç–≤–∞ –≤–∑–∞–∏–º–Ω—ã, –±–æ—Ç —Å–æ–µ–¥–∏–Ω–∏—Ç –≤–∞—Å –ø–æ—Å–ª–µ –∏–≥—Ä–∞! –ì–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –Ω–æ–≤—ã–º –≤—Å—Ç—Ä–µ—á–∞–º –∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º! ü•Ç\n\n` +
    `‚è≥ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> 1 —á–∞—Å 15 –º–∏–Ω—É—Ç\nüë• <b>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> 14 —á–µ–ª–æ–≤–µ–∫`;
    
  return ctx.editMessageText(text, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([
      [Markup.button.callback('üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è', 'book_dating')], 
      [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]
    ]) 
  });
});

bot.action('book_talk', async (ctx) => bookGame(ctx, 'talk_toast'));
bot.action('book_stock', async (ctx) => bookGame(ctx, 'stock_know'));
bot.action('book_dating', async (ctx) => bookGame(ctx, 'speed_dating'));

async function bookGame(ctx: any, type: string) {
  const events = await db.query.events.findMany({ 
    where: and(
      or(eq(schema.events.type, type), eq(schema.events.type, `${type}_review`)), 
      eq(schema.events.isActive, true)
    ) 
  });

  if (events.length === 0) return ctx.reply(`–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è!`);

  if (type === 'talk_toast') {
    const uniqueTitles = new Set<string>(); 
    events.forEach(e => uniqueTitles.add(parseEventDesc(e.description).title));
    const btns = Array.from(uniqueTitles).map(t => [Markup.button.callback(t, `cv_${TYPE_MAP[type]}_${encodeCat(t)}`)]);
    return ctx.editMessageText('–í—ã–±–µ—Ä–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ö–Ω–∏:', { parse_mode: 'HTML', ...Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô', 'back_to_games')]]) });
  }

  const buttons = events.map(e => {
    const isReview = e.type.includes('review');
    const label = isReview ? `üé• ${e.dateString} (-50% –ó–ê –û–ë–ó–û–†)` : `üìÖ ${e.dateString}`;
    return [Markup.button.callback(`${label} (${e.currentPlayers}/${e.maxPlayers})`, `pay_event_${e.id}`)];
  });

  ctx.editMessageText('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É:', Markup.inlineKeyboard([...buttons, [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'back_to_games')]]));
}

bot.action(/cv_(.+)_(.+)/, async (ctx) => {
¬†const type = REV_TYPE_MAP[ctx.match[1]]; 
  const selectedTitle = decodeCat(ctx.match[2]);
  // –¢–µ–ø–µ—Ä—å –∏—â–µ—Ç –∏ –æ–±—ã—á–Ω—ã–µ, –∏ —Ä–µ–≤—å—é-–∏–≥—Ä—ã
  const events = await db.query.events.findMany({ 
    where: and(
      or(eq(schema.events.type, type), eq(schema.events.type, `${type}_review`)),
      eq(schema.events.isActive, true)
    ) 
  });
  const filtered = events.filter(e => parseEventDesc(e.description).title === selectedTitle);
  const btns = filtered.map(e => {
    const isReview = e.type.includes('review');
    const label = isReview ? `üé• ${e.dateString} (-50%)` : `üìÖ ${e.dateString}`;
    return [Markup.button.callback(`${label} (${e.currentPlayers}/${e.maxPlayers})`, `pay_event_${e.id}`)];
  });
¬† return ctx.editMessageText(
¬† ¬† `üçΩ <b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${selectedTitle}</b>\n\n` +
¬† ¬† `–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –ù–∏–∂–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç –¥–ª—è —ç—Ç–æ–π –∫—É—Ö–Ω–∏. –í—ã–±–∏—Ä–∞–π —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. üëá\n\n` +
¬† ¬† `‚ö†Ô∏è <i>–ù–∞–ø–æ–º–∏–Ω–∞–µ–º: –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞ –≤—Ö–æ–¥–∏—Ç —É—á–∞—Å—Ç–∏–µ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è. –ó–∞–∫–∞–∑—ã –ø–æ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –º–µ—Å—Ç–µ.</i>`,¬†
¬† ¬† {¬†
¬† ¬† ¬† parse_mode: 'HTML',¬†
¬† ¬† ¬† ...Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É', 'book_talk')]])¬†
¬† ¬† }
¬† );
}); // <--- –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–¥–µ—Å—å// <-- –¢–µ–ø–µ—Ä—å —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

bot.action('back_to_games', (ctx) => { ctx.deleteMessage(); ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:', Markup.inlineKeyboard([[Markup.button.callback('Talk & Toast ü•Ç', 'game_talk')], [Markup.button.callback('Stock & Know üß†', 'game_stock')], [Markup.button.callback('Fast Dates üíò', 'game_dating')]])); });

bot.action('my_games', async (ctx) => {
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
    if (!user) return;
    const myBookings = await db.select({ bid: schema.bookings.id, d: schema.events.dateString }).from(schema.bookings).innerJoin(schema.events, eq(schema.bookings.eventId, schema.events.id)).where(and(eq(schema.bookings.userId, user.id), eq(schema.bookings.paid, true), eq(schema.events.isActive, true)));
    if (myBookings.length === 0) return ctx.reply('üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.');
    for (const b of myBookings) {
        await ctx.reply(`üóì <b>${b.d}</b>`, { parse_mode: 'HTML', ...Markup.inlineKeyboard([[Markup.button.callback('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å', `conf_canc_${b.bid}`)]]) });
    }
});

bot.action(/conf_canc_(\d+)/, async (ctx) => {
    const bookingId = parseInt(ctx.match[1]);
    ctx.editMessageReplyMarkup({ inline_keyboard: [[Markup.button.callback('üî• –î–ê, –û–¢–ú–ï–ù–ò–¢–¨', `exec_canc_${bookingId}`)], [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'my_games')]] });
});

bot.action(/exec_canc_(\d+)/, async (ctx) => {
    const bookingId = parseInt(ctx.match[1]);
    const booking = await db.query.bookings.findFirst({ where: eq(schema.bookings.id, bookingId) });
    if (!booking) return;
    const event = await db.query.events.findFirst({ where: eq(schema.events.id, booking.eventId) });
    if (!event) return;
    if (DateTime.fromFormat(event.dateString, "dd.MM.yyyy HH:mm").diffNow('hours').hours < 36) return ctx.reply('‚ö†Ô∏è –ü–æ–∑–¥–Ω–æ–≤–∞—Ç–æ –¥–ª—è –æ—Ç–º–µ–Ω—ã, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ "–ü–æ–º–æ—â—å"');
    
    // –ú–ï–õ–û–ß–¨: –í–æ–∑–≤—Ä–∞—Ç –≤–∞—É—á–µ—Ä–∞ (Full Free vs 10 PLN)
    const usedVoucher = await db.query.vouchers.findFirst({ where: and(eq(schema.vouchers.userId, booking.userId), eq(schema.vouchers.status, 'used')), orderBy: [desc(schema.vouchers.id)] });
    if (usedVoucher) await db.update(schema.vouchers).set({ status: usedVoucher.photoFileId ? 'approved_free' : 'approved_10' }).where(eq(schema.vouchers.id, usedVoucher.id));
    
    await db.delete(schema.bookings).where(eq(schema.bookings.id, bookingId));
    await db.update(schema.events).set({ currentPlayers: Math.max(0, (event.currentPlayers || 0) - 1) }).where(eq(schema.events.id, event.id));
    ctx.editMessageText('‚úÖ –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –°–∫–∏–¥–∫–∞/–í–∞—É—á–µ—Ä –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ –∫–∞–±–∏–Ω–µ—Ç.');
});

bot.command('quiet_address', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    
    // –§–æ—Ä–º–∞—Ç: /quiet_address [ID_–ò–≥—Ä—ã] [–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å]
    const parts = ctx.message.text.split(' ');
    if (parts.length < 3) return ctx.reply('‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /quiet_address [ID] [–ê–¥—Ä–µ—Å]');

    const eventId = parseInt(parts[1]);
    const newAddress = parts.slice(2).join(' ');

    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å
        const { title } = parseEventDesc(event.description);
        const newDescription = `${title} ### ${newAddress}`;

        // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É. –ù–ò–ö–ê–ö–ò–• —Ä–∞—Å—Å—ã–ª–æ–∫.
        await db.update(schema.events)
            .set({ description: newDescription })
            .where(eq(schema.events.id, eventId));

        await ctx.reply(`ü§´ –¢—Å—Å... –ê–¥—Ä–µ—Å –∏–≥—Ä—ã ‚Ññ${eventId} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${newAddress}. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–± —ç—Ç–æ–º —É–∑–Ω–∞—é—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø–ª–∞–Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ 3 —á–∞—Å–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞!`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ —Ç–∏—Ö–æ–π —Å–º–µ–Ω—ã –∞–¥—Ä–µ—Å–∞.');
    }
});

// --- 9. –û–ü–õ–ê–¢–ê (–ü–û–õ–ù–ê–Ø) ---

// --- 9. –û–ü–õ–ê–¢–ê (–ü–û–õ–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø) ---

bot.action(/pay_event_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (!user?.name) {
        return ctx.scene.enter('REGISTER_SCENE', { returnToEvent: eid });
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if (user.strangeStory === 'BANNED') {
        return ctx.reply('‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –Ω–∞—Ä—É—à–∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ –∫–ª—É–±–∞ Allgorithm –∏ –¥–æ—Å—Ç—É–ø –∫ –∏–≥—Ä–∞–º –¥–ª—è –≤–∞—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ü–æ–º–æ—â—å.');
    }

    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eid) });
        if (!event) return;

        // --- –ë–õ–û–ö –ì–ï–ù–î–ï–†–ù–û–ì–û –ö–û–ù–¢–†–û–õ–Ø –î–õ–Ø SPEED DATING ---
        // –í–Ω—É—Ç—Ä–∏ bot.action(/pay_event_(\d+)/, ...)
        if (event.type === 'speed_dating') {
            const bookings = await db.query.bookings.findMany({ 
                where: and(eq(schema.bookings.eventId, eid), eq(schema.bookings.paid, true)) 
            });

            let menCount = 0;
            let womenCount = 0;

            for (const b of bookings) {
                const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
        // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ –∏—â–µ–º –∫–æ—Ä–µ–Ω—å
                const g = (u?.gender || '').toLowerCase();
        
                if (g.includes('–º—É–∂')) menCount++; // –ü–æ–π–º–µ—Ç: –ú—É–∂—á–∏–Ω–∞, –ú—É–∂—Å–∫–æ–π, –ú—É–∂–∏–∫, –ú—É–∂
                else if (g.includes('–∂–µ–Ω')) womenCount++; // –ü–æ–π–º–µ—Ç: –ñ–µ–Ω—â–∏–Ω–∞, –ñ–µ–Ω—Å–∫–∏–π, –ñ–µ–Ω
            }

            const limitPerGender = Math.floor(event.maxPlayers / 2);
            const userG = (user.gender || '').toLowerCase();


            // –í–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –¥–ª—è speed_dating:
            if (userG.includes('–º—É–∂') && menCount >= limitPerGender) {
                return ctx.reply(`‚ùå –ú–µ—Å—Ç–∞ –¥–ª—è –º—É–∂—á–∏–Ω –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.`, 
                    Markup.inlineKeyboard([[Markup.button.callback('‚è≥ –í—Å—Ç–∞—Ç—å –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è', `waitlist_add_${eid}`)]]));
            }
            if (userG.includes('–∂–µ–Ω') && womenCount >= limitPerGender) {
                return ctx.reply(`‚ùå –ú–µ—Å—Ç–∞ –¥–ª—è –¥–µ–≤—É—à–µ–∫ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.`, 
                    Markup.inlineKeyboard([[Markup.button.callback('‚è≥ –í—Å—Ç–∞—Ç—å –≤ –ª–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è', `waitlist_add_${eid}`)]]));
            }
        }
    


          
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ –Ω–∞–º–µ—Ä–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç–∏—Ç—å
        await bot.telegram.sendMessage(ADMIN_ID, `‚ö†Ô∏è –Æ–∑–µ—Ä ${user.name} (@${ctx.from!.username}) –Ω–∞–∂–∞–ª ¬´–û–ø–ª–∞—Ç–∏—Ç—å¬ª –Ω–∞ –∏–≥—Ä—É ‚Ññ${eid}.`).catch(()=>{});

        // 3. –ö–∞–∂–¥–∞—è 5-—è –∏–≥—Ä–∞ –ë–ï–°–ü–õ–ê–¢–ù–û
        const activeBookings = await db.query.bookings.findMany({
          where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.paid, true))
            });

// –°—á–∏—Ç–∞–µ–º: —Å–∫–æ–ª—å–∫–æ —Å—ã–≥—Ä–∞–Ω–æ + –Ω–∞ —Å–∫–æ–ª—å–∫–æ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω
        const totalIntents = (user.gamesPlayed || 0) + activeBookings.length;

          if ((totalIntents + 1) % 5 === 0) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–µ–∫—É—â–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
    // (–õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Å—É–º–º–∞ + 1 –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 5, –∑–Ω–∞—á–∏—Ç –∏–º–µ–Ω–Ω–æ –≠–¢–ê –∑–∞–ø–∏—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π)
        await db.insert(schema.bookings).values({ userId: user.id, eventId: eid, paid: true });
        await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eid));
            
            return ctx.replyWithHTML(
                `üéÅ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –≠—Ç–æ —Ç–≤–æ—è 5-—è –∏–≥—Ä–∞, –æ–Ω–∞ –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø!</b>\n\n` +
                `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n` +
                `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞.\n` +
                `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
                `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n` +
                `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. –î–æ –≤—Å—Ç—Ä–µ—á–∏! üéâ`
            );
        }

        // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞—É—á–µ—Ä–æ–≤
        const activeVoucher = await db.query.vouchers.findFirst({ 
            where: and(eq(schema.vouchers.userId, user.id), or(eq(schema.vouchers.status, 'approved_10'), eq(schema.vouchers.status, 'approved_free'))) 
        });

        if (activeVoucher?.status === 'approved_free') {
            await db.insert(schema.bookings).values({ userId: user.id, eventId: eid, paid: true });
            await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eid));
            await db.update(schema.vouchers).set({ status: 'used' }).where(eq(schema.vouchers.id, activeVoucher.id));
            
            return ctx.replyWithHTML(
                `üé´ <b>–û–ø–ª–∞—á–µ–Ω–æ FREE –≤–∞—É—á–µ—Ä–æ–º! –¢—ã –≤ –∏–≥—Ä–µ!</b>\n\n` +
                `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</b>\n` +
                `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞.\n` +
                `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
                `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n` +
                `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ. –î–æ –≤—Å—Ç—Ä–µ—á–∏! üòé`
            );
        }

        // 5. –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Stripe
        const sessionMetadata: any = { telegramId: ctx.from!.id.toString(), eventId: eid.toString() };
        let discounts = [];
        
        if (activeVoucher?.status === 'approved_10') {
            discounts = [{ coupon: STRIPE_COUPON_ID }];
            sessionMetadata.voucherId = activeVoucher.id.toString(); // –ü—Ä–∏–≤–µ—Ç, –•–∞–Ω–Ω–∞ Gemini! ‚ù§Ô∏è
        }

        const stripeSession = await stripe.checkout.sessions.create({
            payment_method_types: ['card', 'blik', 'revolut_pay'],
            line_items: [{ price: GAME_PRICES[event.type], quantity: 1 }],
            metadata: sessionMetadata,
            discounts: discounts,
            mode: 'payment',
            locale: 'ru',
            success_url: `https://t.me/${ctx.botInfo.username}`,
            cancel_url: `https://t.me/${ctx.botInfo.username}`,
        });

        // 1. –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É –∏–≥—Ä—ã
        let finalPrice = event.type.includes('review') ? 25 : 50;

// 2. –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞—É—á–µ—Ä –Ω–∞ -10 PLN, –≤—ã—á–∏—Ç–∞–µ–º –µ–≥–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä)
        if (activeVoucher?.status === 'approved_10' && !event.type.includes('review')) {
            finalPrice = 40;
        }

// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ü–∏—Ñ—Ä–æ–π
        await ctx.reply(
            `–ö –æ–ø–ª–∞—Ç–µ: ${finalPrice} PLN, —Å–∫–æ—Ä–µ–µ –Ω–∞–∂–∏–º–∞–π –æ–ø–ª–∞—Ç–∏—Ç—å, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤–æ–∏—Ö! ü•Ç`, 
            Markup.inlineKeyboard([
                [Markup.button.url('üí∏ –û–ø–ª–∞—Ç–∏—Ç—å (Apple/Google Pay, BLIK...)', stripeSession.url!)], 
                [Markup.button.callback('‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª', `confirm_pay_${eid}`)]
          ])
        );

    } catch (e) { 
        console.error(e); 
        ctx.reply('–û—à–∏–±–∫–∞ Stripe. –ü—Ä–æ–≤–µ—Ä—å –≤–∞–ª—é—Ç—É –≤ Dashboard!'); 
    }
    
    PENDING_PAYMENTS.set(`${user.id}`, { time: DateTime.now(), notified: false });
});

bot.action(/waitlist_add_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
    
    if (!user) return;

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –æ–Ω —É–∂–µ –∏ —Ç–∞–∫ –≤ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –≤ –∏–≥—Ä–µ?
    const existing = await db.query.bookings.findFirst({
        where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, eid))
    });

    if (existing) {
        return ctx.answerCbQuery('–¢—ã —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ —ç—Ç—É –∏–≥—Ä—É –∏–ª–∏ —É–∂–µ —Å—Ç–æ–∏—à—å –≤ –æ—á–µ—Ä–µ–¥–∏! ‚è≥', { show_alert: true });
    }

    // 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ –≤ –±–∞–∑—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º paid: false
    // –î–ª—è –Ω–∞—Å —ç—Ç–æ —Ç–µ–ø–µ—Ä—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∑–Ω–∞–∫ "–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è"
    await db.insert(schema.bookings).values({
        userId: user.id,
        eventId: eid,
        paid: false
    });

    await ctx.answerCbQuery('–£—Å–ø–µ—à–Ω–æ! –¢—ã –≤ –æ—á–µ—Ä–µ–¥–∏ ü•Ç');
    await ctx.editMessageText(
        `‚úÖ <b>–¢—ã –≤ –ª–∏—Å—Ç–µ –æ–∂–∏–¥–∞–Ω–∏—è!</b>\n\n` +
        `–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∫—Ç–æ-—Ç–æ –æ—Ç–º–µ–Ω–∏—Ç —Å–≤–æ—é –∑–∞–ø–∏—Å—å, —è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏—à–ª—é —Ç–µ–±–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ë—É–¥—å –Ω–∞ —Å–≤—è–∑–∏! ‚ú®`,
        { parse_mode: 'HTML' }
    );
});

bot.action(/confirm_pay_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    try {
        const sessions = await stripe.checkout.sessions.list({ limit: 100 });
        const paid = sessions.data.find(s => s.metadata?.telegramId === ctx.from!.id.toString() && s.metadata?.eventId === eid.toString() && s.payment_status === 'paid');
        
        if (!paid) return ctx.reply('üîç –û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫.');
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from!.id) });
        if (!user) return;

        // –ü–†–û–í–ï–†–ö–ê –ù–ê –î–£–ë–õ–¨
        const existing = await db.query.bookings.findFirst({ 
            where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, eid)) 
        });

        if (existing) {
            return ctx.editMessageText('‚úÖ –í—ã —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤! –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥–µ—Ç –∑–∞ 3 —á–∞—Å–∞.');
        }

        PENDING_PAYMENTS.delete(`${user.id}`);
        await db.insert(schema.bookings).values({ userId: user.id, eventId: eid, paid: true });

        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eid) });
        if (event) {
            // –ü—Ä–∏–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
            await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eid));
        }
        
        await ctx.editMessageText(
            `üéâ <b>–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –¢—ã –≤ –∏–≥—Ä–µ!</b>\n\n` +
            `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–∫–æ—Ä–æ—Ç–∫–æ):</b>\n` +
            `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞. –ü–æ–∑–∂–µ —Å—É–º–º–∞ ¬´—Å–≥–æ—Ä–∞–µ—Ç¬ª.\n` +
            `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
            `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n` +
            `ü§´ <b>–ö—Å—Ç–∞—Ç–∏!</b> –î–ª—è –Ω–∞—à–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –Ω–∞–º –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏ –≤ üë§ <b>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</b> -> <b>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</b> –∏ –Ω–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∑–∞–±–∞–≤–Ω—ã–π –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ñ–∞–∫—Ç –æ —Å–µ–±–µ. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–µ—á–µ—Ä –≤ —Ä–∞–∑—ã –∫—Ä—É—á–µ! ‚ú®\n\n` +
            `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.\n\n` +
            `–î–æ –≤—Å—Ç—Ä–µ—á–∏! üòé`, 
            { parse_mode: 'HTML' }
        );
    } catch (e) { ctx.reply('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.'); }
});
  
// --- 10. –í–ê–£–ß–ï–†–´ ---

// --- 10. –í–ê–£–ß–ï–†–´ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) ---

bot.action('upload_voucher', (ctx) => { 
    ctx.reply('üì∏ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –≤–∞—É—á–µ—Ä–∞ –ø—Ä—è–º–æ —Å—é–¥–∞, –∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä–∏—Ç –µ–≥–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç.'); 
    (ctx.session as any).waitingForVoucher = true; 
});

bot.on('photo', async (ctx, next) => {
    if (!(ctx.session as any)?.waitingForVoucher) return next();
    
    const photo = ctx.message.photo[ctx.message.photo.length - 1];
    const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, ctx.from.id) });
    
    if (user) {
        const [v] = await db.insert(schema.vouchers).values({ 
            userId: user.id, 
            photoFileId: photo.file_id, 
            status: 'pending' 
        }).returning();

        ctx.reply('‚úÖ –í–∞—É—á–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.'); 
        (ctx.session as any).waitingForVoucher = false;

        await bot.telegram.sendPhoto(ADMIN_ID, photo.file_id, {
            caption: `üéü <b>–ù–æ–≤—ã–π –≤–∞—É—á–µ—Ä</b>\n–û—Ç: ${user.name}\nID: <code>${user.telegramId}</code>`,
            parse_mode: 'HTML',
            ...Markup.inlineKeyboard([
                [Markup.button.callback('üí∞ -10 PLN', `v_set_10_${v.id}`), Markup.button.callback('üéÅ FREE', `v_set_free_${v.id}`)],
                [Markup.button.callback('‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å', `v_set_reject_${v.id}`)]
            ])
        });
    }
});
  
bot.action(/v_set_(10|free|reject)_(\d+)/, async (ctx) => {
    const action = ctx.match[1];
    const vId = parseInt(ctx.match[2]);
    let status = '';
    let userMsg = '';

    if (action === '10') { 
        status = 'approved_10'; 
        userMsg = 'üéâ –¢–≤–æ–π –≤–∞—É—á–µ—Ä –æ–¥–æ–±—Ä–µ–Ω! –°–∫–∏–¥–∫–∞ -10 PLN –Ω–∞—á–∏—Å–ª–µ–Ω–∞. –°–∫–æ—Ä–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞–π—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö —ç–º–æ—Ü–∏–π! ü•Ç'; 
    }
    else if (action === 'free') { 
        status = 'approved_free'; 
        userMsg = 'üî• –¢–≤–æ–π –≤–∞—É—á–µ—Ä –æ–¥–æ–±—Ä–µ–Ω! –°–ª–µ–¥—É—é—â–∞—è –∏–≥—Ä–∞ –¥–ª—è —Ç–µ–±—è –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø! –°–∫–æ—Ä–µ–µ –∑–∞–ø–∏—Å—ã–≤–∞–π—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö —ç–º–æ—Ü–∏–π! ü•Ç'; 
    }
    else if (action === 'reject') { 
        status = 'rejected'; 
        userMsg = '‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ç–≤–æ–π –≤–∞—É—á–µ—Ä –æ—Ç–∫–ª–æ–Ω–µ–Ω. –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞, –Ω–∞–ø–∏—à–∏ –≤ üÜò –ü–æ–º–æ—â—å.'; 
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ
    await db.update(schema.vouchers).set({ status }).where(eq(schema.vouchers.id, vId));
    
    // –ò—â–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤–∞—É—á–µ—Ä–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const v = await db.query.vouchers.findFirst({ where: eq(schema.vouchers.id, vId) });
    if (v?.userId) {
        const u = await db.query.users.findFirst({ where: eq(schema.users.id, v.userId) });
        if (u) {
            await bot.telegram.sendMessage(u.telegramId, userMsg).catch(() => {});
        }
    }
    
    // –ö—Ä–∞—Å–∏–≤–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É –∞–¥–º–∏–Ω–∞
    const finalLabel = action === 'reject' ? '‚ùå –û–¢–ö–õ–û–ù–ï–ù' : `‚úÖ –û–î–û–ë–†–ï–ù (${action})`;
    await ctx.editMessageCaption(`<b>–°—Ç–∞—Ç—É—Å: ${finalLabel}</b>`, { parse_mode: 'HTML' });
});
// --- 11. –ê–î–ú–ò–ù–ö–ê (–ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó –û–®–ò–ë–û–ö) ---

// --- –ì–õ–ê–í–ù–´–ô –ü–£–õ–¨–¢ ---
bot.command('panel', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    return ctx.replyWithHTML(`üöÄ <b>–ê–¥–º–∏–Ω-–ø—É–ª—å—Ç Allgorithm 2.0</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:`, 
        Markup.inlineKeyboard([
            [Markup.button.callback('üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–∞–º–∏', 'admin_events_menu')],
            [Markup.button.callback('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞', 'admin_stats_menu')],
            [Markup.button.callback('üßº –¢–µ—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', 'admin_db_menu')],
            [Markup.button.callback('üì¢ –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞', 'admin_global_broadcast')]
        ]));
});

// --- –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ì–†–ê–ú–ò (–ó–î–ï–°–¨ –í–°–ï –¢–í–û–ò –ö–ù–û–ü–ö–ò!) ---
bot.action('admin_events_menu', (ctx) => {
    ctx.editMessageText(`üéÆ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–∞–º–∏ –∏ –ü—É–ª—å—Ç—ã</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É', 'admin_add_event')],
            [Markup.button.callback('üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∏–≥—Ä–µ (–î–∞—Ç–∞)', 'admin_msg_event')], // –¢–í–û–Ø –†–ê–°–°–´–õ–ö–ê
            [Markup.button.callback('üíò –ü–£–õ–¨–¢ Speed Dating', 'admin_fd_panel')],     // –¢–í–û–ô –ü–£–õ–¨–¢ –°–í–ò–î–ê–ù–ò–ô
            [Markup.button.callback('üß† –ü–£–õ–¨–¢ Stock & Know', 'admin_stock_list')],   // –¢–í–û–ô –ü–£–õ–¨–¢ –°–¢–û–ö–ê
            [Markup.button.callback('üìã –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π', 'admin_bookings')],
            [Markup.button.callback('üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É', 'admin_close_event')],
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'admin_back_main')]
        ])
    });
});

// --- 2. –ú–ï–ù–Æ –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---
bot.action('admin_stats_menu', (ctx) => {
    ctx.editMessageText(`üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('üìà –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å (Status)', 'admin_trigger_status')],
            [Markup.button.callback('üîé –ò–Ω—Å–ø–µ–∫—Ü–∏—è –∏–≥—Ä—ã (Inspect)', 'admin_bookings')], // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', 'admin_back_main')]
        ])
    });
});

// --- 3. –ú–ï–ù–Æ –¢–ï–•. –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø ---
bot.action('admin_db_menu', (ctx) => {
    ctx.editMessageText(`üßº <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('‚ú® –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—ã', 'admin_trigger_normalize')],
            [Markup.button.callback('üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—á–µ—Ç—á–∏–∫–∏', 'admin_trigger_recount')],
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', 'admin_back_main')]
        ])
    });
});

// –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
bot.action('admin_back_main', (ctx) => {
    ctx.editMessageText(`üöÄ <b>–ê–¥–º–∏–Ω-–ø—É–ª—å—Ç Allgorithm 2.0</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
            [Markup.button.callback('üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–∞–º–∏', 'admin_events_menu')],
            [Markup.button.callback('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ü—Ä–æ–≤–µ—Ä–∫–∞', 'admin_stats_menu')],
            [Markup.button.callback('üßº –¢–µ—Ö. –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–ë–∞–∑–∞)', 'admin_db_menu')],
            [Markup.button.callback('üì¢ –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞', 'admin_global_broadcast')]
        ])
    });
});


// –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç—É—Å–∞
// –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä—è–º–æ –≤ –ø—É–ª—å—Ç
bot.action('admin_trigger_status', async (ctx) => {
    await ctx.answerCbQuery();
    // –ú—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É status (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é)
    ctx.reply('–í—ã–∑—ã–≤–∞—é –æ—Ç—á–µ—Ç... –∏—Å–ø–æ–ª—å–∑—É–π /status –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.');
});

// –ó–∞–ø—É—Å–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ –ø—É–ª—å—Ç–∞
bot.action('admin_trigger_normalize', async (ctx) => {
    await ctx.answerCbQuery();
    ctx.reply('–ó–∞–ø—É—Å–∫–∞—é –æ—á–∏—Å—Ç–∫—É... –∏—Å–ø–æ–ª—å–∑—É–π /normalize.');
});

bot.action('admin_global_broadcast', (ctx) => {
  ctx.reply('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞:');
  (ctx.session as any).waitingForGlobalBroadcast = true;
});

// –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏
bot.action('admin_add_event', (ctx) => ctx.scene.enter('ADD_EVENT_SCENE'));
bot.action('admin_msg_event', (ctx) => ctx.scene.enter('MSG_EVENT_SCENE'));



// --- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞ ---

bot.command('recount', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    
    for (const event of events) {
        const realBookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, event.id), eq(schema.bookings.paid, true)) 
        });
        
        // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const uniqueUserIds = new Set(realBookings.map(b => b.userId));
        await db.update(schema.events)
            .set({ currentPlayers: uniqueUserIds.size })
            .where(eq(schema.events.id, event.id));
    }
    ctx.reply('‚ú® –°—á—ë—Ç—á–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –æ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª—é–¥–µ–π.');
});

bot.command('list_ids', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    try {
        const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
        if (events.length === 0) return ctx.reply('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä.');
        let msg = `üÜî <b>–°–ø–∏—Å–æ–∫ ID –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä:</b>\n\n`;
        events.forEach(e => {
            msg += `üîπ ID: <code>${e.id}</code> | ${e.dateString} | ${e.type}\n`;
        });
        await ctx.replyWithHTML(msg);
    } catch (e) { ctx.reply('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID.'); }
});

bot.command('book', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /book [ID_–Æ–∑–µ—Ä–∞] [ID_–ò–≥—Ä—ã]');

    const targetTgId = parseInt(parts[1]);
    const eventId = parseInt(parts[2]);

    try {
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, targetTgId) });
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });

        if (!user || !event) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –Æ–∑–µ—Ä –∏–ª–∏ –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ.');

        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        await db.insert(schema.bookings).values({ userId: user.id, eventId: event.id, paid: true });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ
        await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, eventId));

        await ctx.reply(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∏–≥—Ä—É ‚Ññ${eventId}!`);
        await bot.telegram.sendMessage(targetTgId, 'üéâ –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–∞—à—É –∑–∞–ø–∏—Å—å –Ω–∞ –∏–≥—Ä—É! –ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏ –ø—Ä–∏–¥—ë—Ç –∑–∞ 3 —á–∞—Å–∞ –¥–æ –∏–≤–µ–Ω—Ç–∞. –î–æ –≤—Å—Ç—Ä–µ—á–∏! ‚ú®');
    } catch (e) {
        ctx.reply('‚ùå –û—à–∏–±–∫–∞: –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –Ω–∞ —ç—Ç—É –∏–≥—Ä—É.');
    }
});

bot.command('reschedule', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    // –§–æ—Ä–º–∞—Ç: /reschedule 12 25.01.2026 19:00
    if (parts.length < 4) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /reschedule [ID_–ò–≥—Ä—ã] [–î–î.–ú–ú.–ì–ì–ì–ì] [–ß–ß:–ú–ú]');

    const eventId = parseInt(parts[1]);
    const newDateStr = `${parts[2]} ${parts[3]}`;

    try {
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –Ω–æ–≤–æ–π –¥–∞—Ç—ã
        const checkDate = DateTime.fromFormat(newDateStr, "dd.MM.yyyy HH:mm", { zone: 'Europe/Warsaw' });
        if (!checkDate.isValid) {
            return ctx.reply('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã! –ù—É–∂–Ω–æ: –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä 20.01.2026 18:30)');
        }

        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –ò–≥—Ä–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // 2. –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ –±–∞–∑–µ
        await db.update(schema.events).set({ dateString: newDateStr }).where(eq(schema.events.id, eventId));

        // 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –†–ê–°–°–´–õ–ö–ê –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
        const rescheduleMsg = `‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï! –ò–ó–ú–ï–ù–ï–ù–ò–ï –í –†–ê–°–ü–ò–°–ê–ù–ò–ò!</b>\n\n` +
            `–ò–≥—Ä–∞ "${event.type}" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è:\n` +
            `üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞: <b>${newDateStr}</b>\n\n` +
            `–í—Å–µ –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏ –∏ –æ–ø–ª–∞—Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã. –ñ–¥–µ–º –≤–∞—Å! ü•Ç`;

        await broadcastToEvent(eventId, rescheduleMsg);

        await ctx.reply(`‚úÖ –ò–≥—Ä–∞ ‚Ññ${eventId} –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ ${newDateStr}. –í—Å–µ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏.');
    }
});

bot.command('load_dating', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    const eid = parseInt(parts[1]);

    if (!eid) return ctx.reply('‚ùå –ü–∏—à–∏: /load_dating [ID_–ò–≥—Ä—ã]');

    try {
        // 1. –ò—â–µ–º –≤—Å–µ—Ö, –∫—Ç–æ –æ–ø–ª–∞—Ç–∏–ª —ç—Ç—É –∏–≥—Ä—É
        const bookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, eid), eq(schema.bookings.paid, true)) 
        });

        if (bookings.length === 0) return ctx.reply('‚ùå –í –±–∞–∑–µ –Ω–µ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π –Ω–∞ —ç—Ç–æ—Ç ID.');

        // 2. –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º ID
        FAST_DATES_STATE.participants.clear();
        FAST_DATES_STATE.eventId = eid;
        FAST_DATES_STATE.currentRound = 1; // –ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –≤—ã —É–∂–µ –Ω–∞ 2-–º —Ä–∞—É–Ω–¥–µ

        const men: any[] = [], women: any[] = [];
        for (const b of bookings) {
            const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
            if (u?.gender === '–ú—É–∂—á–∏–Ω–∞') men.push(u);
            else if (u?.gender === '–ñ–µ–Ω—â–∏–Ω–∞') women.push(u);
        }

        // 3. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –∑–∞–Ω–æ–≤–æ (—Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ, –∫–∞–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
        const limit = Math.min(men.length, women.length);
        for (let i = 0; i < limit; i++) {
            const wNum = (i * 2) + 1;
            const mNum = (i * 2) + 2;
            FAST_DATES_STATE.participants.set(women[i].telegramId, { id: women[i].telegramId, num: wNum, gender: '–ñ–µ–Ω—â–∏–Ω–∞', name: women[i].name });
            FAST_DATES_STATE.participants.set(men[i].telegramId, { id: men[i].telegramId, num: mNum, gender: '–ú—É–∂—á–∏–Ω–∞', name: men[i].name });
        }

        await ctx.reply(`‚úÖ –†–ï–ê–ù–ò–ú–ê–¶–ò–Ø –ò–ì–†–´ ‚Ññ${eid} –£–°–ü–ï–®–ù–ê!\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${FAST_DATES_STATE.participants.size}\n\n–¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∫–∏ –∏ "–ù–æ–≤–∞—è —Ç–µ–º–∞" –æ–∂–∏–≤—É—Ç!`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.');
    }
});

// --- 11. –ö–û–ú–ê–ù–î–ê: –û–¢–ú–ï–ù–ê –° –í–´–î–ê–ß–ï–ô –í–ê–£–ß–ï–†–ê (–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è) ---
bot.command('cancel_with_voucher', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    // –§–æ—Ä–º–∞—Ç: /cancel_with_voucher [TG_ID_–£—á–∞—Å—Ç–Ω–∏–∫–∞] [ID_–ò–≥—Ä—ã]
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /cancel_with_voucher [TG_ID] [ID_–ò–≥—Ä—ã]');

    const targetTgId = parseInt(parts[1]);
    const eventId = parseInt(parts[2]);

    try {
        // 1. –ò—â–µ–º —é–∑–µ—Ä–∞ –∏ –∏–≥—Ä—É
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, targetTgId) });
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!user || !event) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –Æ–∑–µ—Ä –∏–ª–∏ –∏–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');

        // 2. –ò—â–µ–º –∑–∞–ø–∏—Å—å –Ω–∞ –∏–≥—Ä—É
        const booking = await db.query.bookings.findFirst({ 
            where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, event.id)) 
        });
        if (!booking) return ctx.reply('‚ùå –ó–∞–ø–∏—Å—å –Ω–∞ —ç—Ç—É –∏–≥—Ä—É –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // 3. –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã bookings
        await db.delete(schema.bookings).where(eq(schema.bookings.id, booking.id));

        // 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º 1 —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ –∏–≥—Ä–µ
        await db.update(schema.events)
            .set({ currentPlayers: Math.max(0, (event.currentPlayers || 0) - 1) })
            .where(eq(schema.events.id, event.id));

        // 5. –ù–∞—á–∏—Å–ª—è–µ–º FREE –≤–∞—É—á–µ—Ä (–¥–ª—è –±—É–¥—É—â–∏—Ö –æ–ø–ª–∞—Ç)
        await db.insert(schema.vouchers).values({
            userId: user.id,
            status: 'approved_free',
            photoFileId: 'MANUAL' 
        });

        // 6. –£–≤–µ–¥–æ–º–ª—è–µ–º —á–µ–ª–æ–≤–µ–∫–∞ –æ–± –æ—Ç–º–µ–Ω–µ –∏ –ø–æ–¥–∞—Ä–∫–µ
        const userNotice = `üö´ <b>–í–∞—à–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –∏–≥—Ä—É –æ—Ç–º–µ–Ω–µ–Ω–∞</b>\n\n` +
            `–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–∏–ª —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã "${event.type}".\n\n` +
            `üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω –≤–∞—É—á–µ—Ä –Ω–∞ <b>–ë–ï–°–ü–õ–ê–¢–ù–£–Æ –ò–ì–†–£</b>. –û–Ω —É–∂–µ –∂–¥–µ—Ç —Ç–µ–±—è –≤ –õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ!`;
        await bot.telegram.sendMessage(targetTgId, userNotice, { parse_mode: 'HTML' }).catch(()=>{});

        await ctx.reply(`‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ ${user.name} —É–¥–∞–ª–µ–Ω. –ú–µ—Å—Ç–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ, —é–∑–µ—Ä—É –≤—ã–¥–∞–Ω FREE –≤–∞—É—á–µ—Ä.`);

        // --- –ú–ê–ì–ò–Ø –û–ß–ï–†–ï–î–ò: –ò—â–µ–º, –∫–æ–º—É –æ—Ç–¥–∞—Ç—å –º–µ—Å—Ç–æ (–í–ù–£–¢–†–ò try) ---
        const nextInLine = await db.query.bookings.findFirst({
            where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, false)),
            orderBy: [asc(schema.bookings.id)] 
        });

        if (nextInLine) {
            const candidate = await db.query.users.findFirst({ where: eq(schema.users.id, nextInLine.userId) });
            if (candidate) {
                await bot.telegram.sendMessage(candidate.telegramId, 
                    `üî• <b>–•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏!</b>\n\n–ù–∞ –∏–≥—Ä—É "${event.type}" (${event.dateString}) –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å –º–µ—Å—Ç–æ! ü•Ç\n\n–°–∫–æ—Ä–µ–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ "–ò–≥—Ä—ã", —á—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –µ–≥–æ!`, 
                    { parse_mode: 'HTML' }).catch(()=>{});
            }
        }

    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—Ç–º–µ–Ω—ã —Å –≤–∞—É—á–µ—Ä–æ–º.');
    }
});

bot.command('kick', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /kick [TG_ID] [ID_–ò–≥—Ä—ã]');
    const targetTgId = parseInt(parts[1]);
    const eventId = parseInt(parts[2]);
    try {
        const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, targetTgId) });
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        const booking = await db.query.bookings.findFirst({ where: and(eq(schema.bookings.userId, user!.id), eq(schema.bookings.eventId, eventId)) });
        if (booking) {
            await db.delete(schema.bookings).where(eq(schema.bookings.id, booking.id));
            await db.update(schema.events).set({ currentPlayers: Math.max(0, (event!.currentPlayers || 0) - 1) }).where(eq(schema.events.id, eventId));
            await ctx.reply(`‚úÖ –£–¥–∞–ª–µ–Ω.`);
            await notifyNextInWaitlist(eventId, event!.type, event!.dateString);
        }
    } catch (e) { 
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞'); 
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø–∏—Å–∏" - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä
bot.action('admin_bookings', async (ctx) => {
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    if (events.length === 0) return ctx.reply('–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä –Ω–µ—Ç.');
    
    const btns = events.map(e => [Markup.button.callback(`${e.dateString} | ${e.type}`, `view_ev_bks_${e.id}`)]);
    ctx.editMessageText('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', Markup.inlineKeyboard(btns));
});

// 3. –ü—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –í–°–ï–•)
bot.action(/view_ev_bks_(\d+)/, async (ctx) => {
    const eid = parseInt(ctx.match[1]);
    const bookings = await db.query.bookings.findMany({ where: eq(schema.bookings.eventId, eid) });
    if (bookings.length === 0) return ctx.reply('–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.');

    let msg = `üìã <b>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –∏–≥—Ä—É:</b>\n\n`;
    const seenUsers = new Set(); // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥—É–±–ª–µ–π –≤ —Å–ø–∏—Å–∫–µ

    for (const b of bookings) {
        if (seenUsers.has(b.userId)) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ –≤—ã–≤–µ–ª–∏ —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
        seenUsers.add(b.userId);

        const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
        const status = b.paid ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚è≥ –ñ–¥–µ—Ç –æ–ø–ª–∞—Ç—ã';
        msg += `‚Ä¢ ${u?.name || '–ê–Ω–æ–Ω–∏–º'} (@${u?.username || '–Ω–µ—Ç'}) \n   ID: <code>${u?.telegramId}</code> ‚Äî <b>${status}</b>\n\n`;
    }
    ctx.replyWithHTML(msg);
});

bot.command('inspect', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 2) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /inspect [ID_–ò–≥—Ä—ã]');

    const eventId = parseInt(parts[1]);
    const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
    if (!event) return ctx.reply('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

    const bookings = await db.query.bookings.findMany({ where: eq(schema.bookings.eventId, eventId) });
    
    let report = `üîé <b>–ò–ù–°–ü–ï–ö–¶–ò–Ø –ò–ì–†–´ ‚Ññ${eventId}</b> (${event.type})\n`;
    report += `–õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª: <b>${event.maxPlayers / 2}</b>\n\n`;

    let realMen = 0;
    let realWomen = 0;

    for (const [index, b] of bookings.entries()) {
        const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
        const gender = u?.gender || '‚ö†Ô∏è NULL';
        const paidStatus = b.paid ? '‚úÖ' : '‚è≥';
        
        if (gender === '–ú—É–∂—á–∏–Ω–∞' && b.paid) realMen++;
        if (gender === '–ñ–µ–Ω—â–∏–Ω–∞' && b.paid) realWomen++;

        report += `${index + 1}. ${paidStatus} <b>${u?.name || '–ê–Ω–æ–Ω–∏–º'}</b>\n`;
        report += `   ID: <code>${u?.id}</code> | TG: <code>${u?.telegramId}</code>\n`;
        report += `   –ü–û–õ: ¬´<b>${gender}</b>¬ª\n\n`;
    }

    report += `üìä <b>–ò–¢–û–ì–û –û–ü–õ–ê–ß–ï–ù–û:</b>\n`;
    report += `üï∫ –ú—É–∂—á–∏–Ω: ${realMen}\n`;
    report += `üíÉ –ñ–µ–Ω—â–∏–Ω: ${realWomen}`;

    await ctx.replyWithHTML(report);
});

bot.command('set_limit', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    // –§–æ—Ä–º–∞—Ç: /set_limit [ID_–ò–≥—Ä—ã] [–ù–æ–≤–æ–µ_–ß–∏—Å–ª–æ]
    if (parts.length < 3) return ctx.reply('–ò—Å–ø–æ–ª—å–∑—É–π: /set_limit [ID_–ò–≥—Ä—ã] [–ù–æ–≤–æ–µ_–ö–æ–ª_–≤–æ_–ú–µ—Å—Ç]');

    const eventId = parseInt(parts[1]);
    const newMax = parseInt(parts[2]);

    if (isNaN(eventId) || isNaN(newMax)) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏ —á–∏—Å–ª–∞.');

    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç –≤ –±–∞–∑–µ
        await db.update(schema.events)
            .set({ maxPlayers: newMax })
            .where(eq(schema.events.id, eventId));

        const limitPerGender = newMax / 2;
        
        await ctx.replyWithHTML(
            `‚úÖ <b>–õ–∏–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω!</b>\n\n` +
            `–ò–≥—Ä–∞ ‚Ññ${eventId} (${event.type})\n` +
            `–ù–æ–≤–æ–µ –æ–±—â–µ–µ –∫–æ–ª-–≤–æ –º–µ—Å—Ç: <b>${newMax}</b>\n` +
            `–õ–∏–º–∏—Ç –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ–ª: <b>${limitPerGender}</b>\n\n` +
            `<i>–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å –º–µ—Å—Ç–∞ –∏—Å—Ö–æ–¥—è –∏–∑ —ç—Ç–∏—Ö —Ü–∏—Ñ—Ä.</i>`
        );
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞.');
    }
});

bot.command('normalize', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    
    try {
        const users = await db.query.users.findMany();
        let count = 0;

        for (const u of users) {
            const g = (u.gender || '').toLowerCase();
            let newGender = u.gender;

            // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –µ—Å—Ç—å "–º—É–∂", –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "–ú—É–∂—á–∏–Ω–∞"
            if (g.includes('–º—É–∂')) newGender = '–ú—É–∂—á–∏–Ω–∞';
            // –ï—Å–ª–∏ –≤ –ø–æ–ª–µ –µ—Å—Ç—å "–∂–µ–Ω", –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "–ñ–µ–Ω—â–∏–Ω–∞"
            else if (g.includes('–∂–µ–Ω')) newGender = '–ñ–µ–Ω—â–∏–Ω–∞';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (newGender !== u.gender) {
                await db.update(schema.users)
                    .set({ gender: newGender })
                    .where(eq(schema.users.id, u.id));
                count++;
            }
        }
        await ctx.reply(`‚ú® –ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è —É–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${count}. –¢–µ–ø–µ—Ä—å –≤—Å–µ –≤ –±–∞–∑–µ ‚Äî –ª–∏–±–æ "–ú—É–∂—á–∏–Ω–∞", –ª–∏–±–æ "–ñ–µ–Ω—â–∏–Ω–∞".`);
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á–∏—Å—Ç–∫–µ –±–∞–∑—ã.');
    }
});

bot.command('status', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    
    const activeEvents = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    if (activeEvents.length === 0) return ctx.reply('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä.');

    let report = `üìä <b>–û–¢–ß–ï–¢ –ü–û –í–°–ï–ú –ò–ì–†–ê–ú:</b>\n\n`;

    for (const ev of activeEvents) {
        const bookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, ev.id), eq(schema.bookings.paid, true)) 
        });

        let m = 0, w = 0;
        for (const b of bookings) {
            const u = await db.query.users.findFirst({ where: eq(schema.users.id, b.userId) });
            if (u?.gender === '–ú—É–∂—á–∏–Ω–∞') m++;
            if (u?.gender === '–ñ–µ–Ω—â–∏–Ω–∞') w++;
        }

        report += `üîπ <b>${ev.dateString} | ${ev.type}</b>\n`;
        report += `   –°–≤–æ–±–æ–¥–Ω–æ: ${ev.maxPlayers - bookings.length} –∏–∑ ${ev.maxPlayers}\n`;
        report += `   –ë–∞–ª–∞–Ω—Å: üï∫ ${m} | üíÉ ${w}\n`;
        report += `   ID –¥–ª—è –∫–æ–º–∞–Ω–¥: <code>${ev.id}</code>\n\n`;
    }

    await ctx.replyWithHTML(report);
});

// 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Speed Dating –∏ Stock
bot.action('admin_fd_panel', ctx => { 
  ctx.editMessageText(`üíò <b>–ü—É–ª—å—Ç Speed Dating</b>`, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([
      [Markup.button.callback('üöÄ –ù–∞—á–∞—Ç—å 1-–π —Ä–∞—É–Ω–¥', 'fd_start_game')],
      [Markup.button.callback('üîÑ –°–õ–ï–î–£–Æ–©–ò–ô –†–ê–£–ù–î', 'fd_next_round')], // –ù–∞–∂–∏–º–∞–µ—à—å –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω
      [Markup.button.callback('üèÅ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º—ç—Ç—á–∏', 'fd_calc_matches')]
    ]) 
  }); 
});
bot.action('admin_stock_list', (ctx) => {
    const btns = STOCK_QUESTIONS.map((q, i) => [Markup.button.callback(`–í–æ–ø—Ä–æ—Å ‚Ññ${i+1}`, `sk_pick_${i}`)]);
    ctx.editMessageText('üß† –í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å:', Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô –ù–∞–∑–∞–¥', 'admin_back_to_panel')]]));
});

bot.action('admin_close_event', async (ctx) => {
    const events = await db.query.events.findMany({ where: eq(schema.events.isActive, true) });
    const btns = events.map(e => [Markup.button.callback(`üõë –ó–∞–∫—Ä—ã—Ç—å: ${e.dateString}`, `exec_close_${e.id}`)]);
    ctx.editMessageText('–ö–∞–∫—É—é –∏–≥—Ä—É –∑–∞–≤–µ—Ä—à–∏—Ç—å?', Markup.inlineKeyboard(btns));
});

bot.action(/exec_close_(\d+)/, async (ctx) => {
    await autoCloseEvent(parseInt(ctx.match[1]));
    ctx.reply('‚úÖ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã!');
});

bot.action('admin_back_to_panel', (ctx) => {
    ctx.deleteMessage();
    return ctx.reply('–í–æ–∑–≤—Ä–∞—Ç –≤ –ø–∞–Ω–µ–ª—å...', Markup.inlineKeyboard([[Markup.button.callback('–û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å', 'panel')]]));
});

bot.command('assign_stock', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const parts = ctx.message.text.split(' ');
    if (parts.length < 2) return ctx.reply('‚ùå –û—à–∏–±–∫–∞! –ò—Å–ø–æ–ª—å–∑—É–π: /assign_stock [ID_–ò–≥—Ä—ã]');

    const eventId = parseInt(parts[1]);
    try {
        const event = await db.query.events.findFirst({ where: eq(schema.events.id, eventId) });
        if (!event) return ctx.reply('‚ùå –û—à–∏–±–∫–∞: –ò–≥—Ä–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');

        const bookings = await db.query.bookings.findMany({ 
            where: and(eq(schema.bookings.eventId, eventId), eq(schema.bookings.paid, true)) 
        });

        if (bookings.length === 0) return ctx.reply('‚ùå –ù–∞ —ç—Ç—É –∏–≥—Ä—É –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.');

        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –Ω–æ–≤—ã–π ID –∏–≥—Ä—ã
        STOCK_STATE.participants.clear();
        STOCK_STATE.playerAnswers.clear();
        STOCK_STATE.currentEventId = eventId; // <--- –§–∏–∫—Å–∏—Ä—É–µ–º –∏–≥—Ä—É

        let count = 0;
        for (let i = 0; i < bookings.length; i++) {
            const user = await db.query.users.findFirst({ where: eq(schema.users.id, bookings[i].userId) });
            if (user) {
                const playerNum = i + 1;
                STOCK_STATE.participants.set(user.telegramId, { 
                    id: user.id, 
                    num: playerNum, 
                    name: user.name || user.firstName || '–ò–≥—Ä–æ–∫' 
                });

                // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫—É (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö, –∏ –¥–ª—è Review)
                await bot.telegram.sendMessage(user.telegramId, 
                    `üß† <b>–¢–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –Ω–æ–º–µ—Ä –≤ Stock & Know: ${playerNum}</b>\n\n` +
                    `–ó–∞–ø–æ–º–Ω–∏ –µ–≥–æ! –¢–µ–ø–µ—Ä—å —Ç–≤–æ–∏ —Å—Ç–∞–≤–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É –Ω–æ–º–µ—Ä—É. –£–¥–∞—á–∏! üí∞üé∞`,
                    { parse_mode: 'HTML' }
                ).catch(() => {});
                count++;
            }
        }

        await ctx.reply(`‚úÖ –ù–æ–º–µ—Ä–∞ —Ä–∞–∑–¥–∞–Ω—ã –¥–ª—è –∏–≥—Ä—ã ‚Ññ${eventId} (${event.type})!\n–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${count}\n\n–¢–µ–ø–µ—Ä—å –≤–æ–ø—Ä–æ—Å—ã –≤ –ø—É–ª—å—Ç–µ –±—É–¥—É—Ç —É–ª–µ—Ç–∞—Ç—å –∏–º–µ–Ω–Ω–æ –∏–º.`, { parse_mode: 'HTML' });
    } catch (e) {
        console.error(e);
        ctx.reply('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–¥–∞—á–µ –Ω–æ–º–µ—Ä–æ–≤.');
    }
});
bot.command('players', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    if (STOCK_STATE.participants.size === 0) return ctx.reply('–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –ø—É—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π /assign_stock [ID]');

    let msg = `üìã <b>–¢–µ–∫—É—â–∏–µ –∏–≥—Ä–æ–∫–∏ Stock & Know:</b>\n\n`;
    const sorted = Array.from(STOCK_STATE.participants.values()).sort((a, b) => a.num - b.num);
    
    for (const p of sorted) {
        msg += `üîπ ‚Ññ${p.num} ‚Äî ${p.name} (ID: <code>${p.id}</code>)\n`;
    }
    
    await ctx.replyWithHTML(msg);
});

bot.action(/sk_win_(\d+)_(\d+)/, async (ctx) => {
  const pNum = ctx.match[1];
  const eventId = parseInt(ctx.match[2]);
  
  try {
    // 1. –û–±—ä—è–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
    const winAnnounce = `üéä <b>–†–ê–£–ù–î –ó–ê–í–ï–†–®–ï–ù!</b> üéä\n\nüèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞ ‚Äî <b>–ò–≥—Ä–æ–∫ ‚Ññ${pNum}</b>! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! ‚ú®üìà`;
    await broadcastToEvent(eventId, winAnnounce);
    
    // 2. –û—á–∏—â–∞–µ–º —Å—Ç–∞–≤–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    STOCK_STATE.playerAnswers.clear();
    
    await ctx.answerCbQuery(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å ‚Ññ${pNum} –æ–±—ä—è–≤–ª–µ–Ω!`);

    // 3. –û–ë–ù–û–í–õ–Ø–ï–ú –¢–ï–ö–°–¢ –£ –ê–î–ú–ò–ù–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º editMessageText)
    await ctx.editMessageText(`‚úÖ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞ –≤—ã–±—Ä–∞–Ω: <b>–ò–≥—Ä–æ–∫ ‚Ññ${pNum}</b>`, { parse_mode: 'HTML' });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:", e);
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø—Ä–æ—Å—Ç–æ —à–ª–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await ctx.reply(`–ü–æ–±–µ–¥–∏—Ç–µ–ª—å —Ä–∞—É–Ω–¥–∞: ‚Ññ${pNum}`);
  }
});

// --- –õ–û–ì–ò–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò –ú–≠–¢–ß–ï–ô ---

bot.action('fd_next_round', async (ctx) => {
  FAST_DATES_STATE.currentRound++;
  const round = FAST_DATES_STATE.currentRound;
  
  const ps = Array.from(FAST_DATES_STATE.participants.values());
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –≤—Å—ë —à–ª–æ –ø–æ –ø–æ—Ä—è–¥–∫—É –Ω–æ–º–µ—Ä–æ–≤
  const women = ps.filter(p => p.gender === '–ñ–µ–Ω—â–∏–Ω–∞').sort((a,b) => a.num - b.num);
  const men = ps.filter(p => p.gender === '–ú—É–∂—á–∏–Ω–∞').sort((a,b) => a.num - b.num);

  if (women.length === 0 || men.length === 0) return ctx.reply("–û—à–∏–±–∫–∞: –Ω–µ–∫–æ–≥–æ –ø–µ—Ä–µ—Å–∞–∂–∏–≤–∞—Ç—å.");

  // –ï—Å–ª–∏ —Ä–∞—É–Ω–¥–æ–≤ –±–æ–ª—å—à–µ, —á–µ–º –ø–∞—Ä, –∏–≥—Ä–∞ —Ñ–∏–Ω–∏—à–∏—Ä—É–µ—Ç
  if (round > women.length) {
    return ctx.reply("üèÅ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å! –†–∞—É–Ω–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.");
  }

  for (let i = 0; i < women.length; i++) {
    const woman = women[i];
    
    // –í—ã—á–∏—Å–ª—è–µ–º, –∫–∞–∫–æ–π –º—É–∂—á–∏–Ω–∞ –∏–¥–µ—Ç –∫ —ç—Ç–æ–π –∂–µ–Ω—â–∏–Ω–µ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ
    // –§–æ—Ä–º—É–ª–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥—ã–π –º—É–∂—á–∏–Ω–∞ –ø–æ—Å–µ—Ç–∏—Ç –∫–∞–∂–¥—É—é –∂–µ–Ω—â–∏–Ω—É –∑–∞ —Ü–∏–∫–ª
    const manIndex = (i + round - 1) % men.length;
    const man = men[manIndex];

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ñ–µ–Ω—â–∏–Ω–µ (–æ–Ω–∞ —Å–∏–¥–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ)
    bot.telegram.sendMessage(woman.id, 
      `üîÑ <b>–†–∞—É–Ω–¥ ‚Ññ${round}</b>\n\n–û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ –º–µ—Å—Ç–µ. –°–µ–π—á–∞—Å –∫ –≤–∞–º –ø–æ–¥—Å—è–¥–µ—Ç <b>–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${man.num}</b>.`,
      { parse_mode: 'HTML' }
    ).catch(()=>{});

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ú—É–∂—á–∏–Ω–µ (–æ–Ω –∏–¥–µ—Ç –∫ –∂–µ–Ω—â–∏–Ω–µ)
    bot.telegram.sendMessage(man.id, 
      `üîÑ <b>–†–∞—É–Ω–¥ ‚Ññ${round}</b>\n\n–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ <b>–£—á–∞—Å—Ç–Ω–∏—Ü–µ ‚Ññ${woman.num}</b>. –ñ–µ–ª–∞–µ–º –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞! üíò`,
      { parse_mode: 'HTML' }
    ).catch(()=>{});
  }//Gemini –ù–∞–ø–∏—à–∏ —á—Ç–æ –ª—é–±–∏—à—å –≥—Ä—É—à–∏

  await ctx.answerCbQuery(`–†–∞—É–Ω–¥ ${round} –∑–∞–ø—É—â–µ–Ω!`);
  await ctx.reply(`üì¢ <b>–†–∞—É–Ω–¥ ‚Ññ${round} –Ω–∞—á–∞–ª—Å—è!</b>\n–ú—É–∂—á–∏–Ω—ã –ø–æ–ª—É—á–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∫ –∫–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏—Ü–µ –∏–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å.`);
});

bot.action('admin_stats', async (ctx) => {
  const allUsers = await db.query.users.findMany();
  const allPaidBookings = await db.query.bookings.findMany({ where: eq(schema.bookings.paid, true) });
  const totalRevenue = allPaidBookings.length * 50; // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é –≤—ã—Ä—É—á–∫—É

  const statsMsg = `üìä <b>–û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–õ–£–ë–ê</b>\n\n` +
    `üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ: <b>${allUsers.length}</b>\n` +
    `üéü –í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–Ω–æ –±–∏–ª–µ—Ç–æ–≤: <b>${allPaidBookings.length}</b>\n` +
    `üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: <b>${totalRevenue} PLN</b>`;

  await ctx.editMessageText(statsMsg, { 
    parse_mode: 'HTML', 
    ...Markup.inlineKeyboard([[Markup.button.callback('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', 'admin_back_to_panel')]]) 
  });
});

bot.action(/fd_edit_(\d+)/, async (ctx) => {
  const uid = parseInt(ctx.match[1]); 
  const u = Array.from(FAST_DATES_STATE.participants.values()).find(p => p.id === uid);
  const targets = Array.from(FAST_DATES_STATE.participants.values()).filter(p => p.gender !== u?.gender);
  const votes = FAST_DATES_STATE.votes.get(u?.id || 0) || [];
  const btns = targets.map(t => Markup.button.callback(`${votes.includes(t.id)?'‚úÖ':' '} ‚Ññ${t.num}`, `fd_tog_${uid}_${t.id}`));
  const rows = []; while(btns.length) rows.push(btns.splice(0,4));
  ctx.editMessageText(`–ö—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è ‚Ññ${u?.num}?`, Markup.inlineKeyboard([...rows, [Markup.button.callback('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'admin_fd_panel')]]));
});

bot.action(/fd_tog_(\d+)_(\d+)/, async (ctx) => {
  const vId = parseInt(ctx.match[1]); const tId = parseInt(ctx.match[2]);
  let vArr = FAST_DATES_STATE.votes.get(vId) || [];
  FAST_DATES_STATE.votes.set(vId, vArr.includes(tId) ? vArr.filter(id=>id!==tId) : [...vArr, tId]);
  const u = Array.from(FAST_DATES_STATE.participants.values()).find(p => p.id === vId);
  const targets = Array.from(FAST_DATES_STATE.participants.values()).filter(p => p.gender !== u?.gender);
  const votes = FAST_DATES_STATE.votes.get(vId) || [];
  const btns = targets.map(t => Markup.button.callback(`${votes.includes(t.id)?'‚úÖ':' '} ‚Ññ${t.num}`, `fd_tog_${vId}_${t.id}`));
  const rows = []; while(btns.length) rows.push(btns.splice(0,4));
  await ctx.editMessageReplyMarkup({ inline_keyboard: [...rows, [Markup.button.callback('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'admin_fd_panel')]] });
});

bot.action('fd_calc_matches', async (ctx) => {
  let count = 0;
  for (const [tid, p] of FAST_DATES_STATE.participants) {
    const myLikes = FAST_DATES_STATE.votes.get(p.id) || [];
    for (const targetId of myLikes) {
      const target = Array.from(FAST_DATES_STATE.participants.values()).find(x => x.id === targetId);
      if (target && FAST_DATES_STATE.votes.get(target.id)?.includes(p.id)) {
        count++; bot.telegram.sendMessage(tid, `üíñ <b>–ú–≠–¢–ß!</b> –° ‚Ññ${target.num} (@${target.username})`).catch(()=>{});
      }
    }
  }
  ctx.reply(`üèÅ –ù–∞–π–¥–µ–Ω–æ –º—ç—Ç—á–µ–π: ${count/2}`);
});

// --- –í–û–ó–í–†–ê–¢ –§–£–ù–ö–¶–ò–ô –ü–£–õ–¨–¢–ê ---
// --- –ü–£–õ–¨–¢–´ (FD –ò STOCK) ---
bot.action('fd_input_start', ctx => { 
  const btns = Array.from(FAST_DATES_STATE.participants.values()).sort((a,b)=>a.num-b.num).map(p => [Markup.button.callback(`‚Ññ${p.num} (${p.gender[0]})`, `fd_edit_${p.id}`)]); 
  ctx.editMessageText('–ß—å—é –∞–Ω–∫–µ—Ç—É –≤–≤–æ–¥–∏–º?', Markup.inlineKeyboard([...btns, [Markup.button.callback('üîô', 'admin_fd_panel')]])); 
});

bot.action(/sk_pick_(\d+)/, (ctx) => {
  STOCK_STATE.currentQuestionIndex = parseInt(ctx.match[1]); STOCK_STATE.playerAnswers.clear();
  ctx.editMessageText(`–í–æ–ø—Ä–æ—Å –≤—ã–±—Ä–∞–Ω.`, Markup.inlineKeyboard([[Markup.button.callback('üöÄ –û–¢–ü–†–ê–í–ò–¢–¨', 'stock_send_phase_0')]]));
});

bot.action(/stock_send_phase_(\d+)/, async (ctx) => {
  const phase = parseInt(ctx.match[1]);
  const q = STOCK_QUESTIONS[STOCK_STATE.currentQuestionIndex];
  
  // –ë–µ—Ä–µ–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID
  const eventId = STOCK_STATE.currentEventId; 

  if (!eventId) {
    return ctx.reply('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–≥—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /assign_stock [ID]');
  }

  let msg = "";
  if (phase === 0) msg = `‚ùì <b>–í–û–ü–†–û–°:</b>\n${q.question}`;
  else if (phase <= 3) msg = `üí° <b>–ü–û–î–°–ö–ê–ó–ö–ê ‚Ññ${phase}:</b>\n${q.hints[phase-1]}`;
  else msg = `üèÅ <b>–û–¢–í–ï–¢: ${q.answer}</b>\n\n${q.fact}`;

  // –®–ª–µ–º —Å—Ç—Ä–æ–≥–æ –ø–æ –∞–¥—Ä–µ—Å—É
  await broadcastToEvent(eventId, msg);

  // –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  if (phase === 4) {
    let resultsMsg = `üìä <b>–†–ï–ó–£–õ–¨–¢–ê–¢–´ (–ò–≥—Ä–∞ ‚Ññ${eventId}):</b>\n–û—Ç–≤–µ—Ç: <b>${q.answer}</b>\n\n`;
    const winnerBtns = [];
    const correctVal = parseInt(q.answer);

    for (const [tgId, bet] of STOCK_STATE.playerAnswers.entries()) {
      const p = STOCK_STATE.participants.get(tgId);
      if (p) {
        const diff = Math.abs(correctVal - bet);
        resultsMsg += `‚Ññ${p.num} (${p.name}): <b>${bet}</b> (—Ä–∞–∑–Ω–∏—Ü–∞: ${diff})\n`;
        winnerBtns.push([Markup.button.callback(`üèÜ –ü–æ–±–µ–¥–∞ ‚Ññ${p.num}`, `sk_win_${p.num}_${eventId}`)]);
      }
    }
    await bot.telegram.sendMessage(ADMIN_ID, resultsMsg, { parse_mode: 'HTML', ...Markup.inlineKeyboard(winnerBtns) });
  }

  const buttons = [];
  if (phase < 4) {
    buttons.push([Markup.button.callback(phase === 3 ? '‚úÖ –ü–û–ö–ê–ó–ê–¢–¨ –û–¢–í–ï–¢' : `üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ ${phase+1}`, `stock_send_phase_${phase+1}`)]);
  } else {
    buttons.push([Markup.button.callback('‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å', 'admin_stock_list')]);
  }
  
  await ctx.editMessageText(`–§–∞–∑–∞ ${phase} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–≥—Ä–æ–∫–∞–º ‚Ññ${eventId}.`, Markup.inlineKeyboard(buttons));
});

// --- 12. –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô ---

bot.on('message', async (ctx, next) => {
    const userId = ctx.from?.id;
    const sess = ctx.session as any;
    const text = (ctx.message as any).text;
    if (!userId || !text) return next();

    // –†–∞—Å—Å—ã–ª–∫–∞
    if (sess?.waitingForBroadcast && userId === ADMIN_ID) {
        const users = await db.query.users.findMany();
        for (const u of users) { try { await ctx.telegram.copyMessage(u.telegramId, ctx.chat!.id, ctx.message.message_id); } catch(e) {} }
        sess.waitingForBroadcast = false;
        return ctx.reply(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!`);
    }
    if (sess?.waitingForGlobalBroadcast && userId === ADMIN_ID) {
    const allUsers = await db.query.users.findMany();
    let count = 0;
    for (const u of allUsers) {
        try {
            await ctx.telegram.sendMessage(u.telegramId, `üì¢ <b>–û–±—ä—è–≤–ª–µ–Ω–∏–µ –ê–ª–≥–æ—Ä–∏—Ç–º–∞:</b>\n\n${text}`, { parse_mode: 'HTML' });
            count++;
        } catch (e) { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–≤—à–∏—Ö –±–æ—Ç–∞ */ }
    }
    sess.waitingForGlobalBroadcast = false;
    return ctx.reply(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${count} —á–µ–ª.`);
}

    // –°—Ç–∞–≤–∫–∏ Stock & Know
    // –°—Ç–∞–≤–∫–∏ Stock & Know
    if (STOCK_STATE.currentQuestionIndex !== -1 && !isNaN(parseInt(text)) && !text.startsWith('/')) {
        const player = STOCK_STATE.participants.get(userId);
        
        if (player) {
            if (!STOCK_STATE.playerAnswers.has(userId)) {
                STOCK_STATE.playerAnswers.set(userId, parseInt(text));
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –∏–≥—Ä–æ–∫–∞
                await ctx.reply(`‚úÖ –ò–≥—Ä–æ–∫ ‚Ññ${player.num}, —Ç–≤–æ—è —Å—Ç–∞–≤–∫–∞ ${text} –ø—Ä–∏–Ω—è—Ç–∞! üé∞`);
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç–µ–±—è (–∞–¥–º–∏–Ω–∞), —á—Ç–æ–±—ã —Ç—ã –≤–∏–¥–µ–ª–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å
                await bot.telegram.sendMessage(ADMIN_ID, `üìà –°—Ç–∞–≤–∫–∞ –æ—Ç –ò–≥—Ä–æ–∫–∞ ‚Ññ${player.num} (${player.name}): <b>${text}</b>`).catch(()=>{});
                return;
            } else {
                return ctx.reply(`‚ö†Ô∏è –ò–≥—Ä–æ–∫ ‚Ññ${player.num}, —Ç—ã —É–∂–µ —Å–¥–µ–ª–∞–ª —Å—Ç–∞–≤–∫—É –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ!`);
            }
        } else {
            // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç —Ü–∏—Ñ—Ä—ã, –Ω–æ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∏–≥—Ä–æ–∫–æ–≤
            return ctx.reply(`‚ùå –¢—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã Stock & Know.`);
        }
    }

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞
    if (sess?.waitingForSupport) {
        const adminMsg = `üÜò <b>–í–û–ü–†–û–° –í –ü–û–î–î–ï–†–ñ–ö–£</b>\n\n–û—Ç: ${ctx.from.first_name} (@${ctx.from.username || '–Ω–µ—Ç'})\nID: <code>${ctx.from.id}</code>\n\n–¢–µ–∫—Å—Ç: ${text}\n\n<code>/reply ${ctx.from.id} </code>`;
        await ctx.telegram.sendMessage(ADMIN_ID, adminMsg, { parse_mode: 'HTML' });
        ctx.reply('‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        sess.waitingForSupport = false;
        return;
    }
    return next();
});

bot.command('reply', async (ctx) => {
    if (ctx.from.id !== ADMIN_ID) return;
    const p = ctx.message.text.split(' ');
    if (p.length < 3) return ctx.reply('–§–æ—Ä–º–∞—Ç: /reply ID —Ç–µ–∫—Å—Ç');
    bot.telegram.sendMessage(p[1], `üëÆ‚Äç‚ôÇÔ∏è <b>–û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞:</b>\n\n${p.slice(2).join(' ')}`, { parse_mode: 'HTML' }).catch(()=>{});
});



// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–∞
bot.action('start_registration', (ctx) => { ctx.deleteMessage(); ctx.scene.enter('REGISTER_SCENE'); });

// --- –í–û–ó–í–†–ê–©–ê–ï–ú –ü–†–û–ü–ê–í–®–ò–ï –ö–û–ú–ê–ù–î–´ (30+ –°–¢–†–û–ö) ---



// --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–ü–ò–°–¨ –ü–û–°–õ–ï –û–ü–õ–ê–¢–´ (WEBHOOK) ---
async function handleSuccessfulPayment(session: any) {
  const { telegramId, eventId, voucherId } = session.metadata;
  const user = await db.query.users.findFirst({ where: eq(schema.users.telegramId, parseInt(telegramId)) });
  const event = await db.query.events.findFirst({ where: eq(schema.events.id, parseInt(eventId)) });
  
  if (!user || !event) return;

  // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–æ–π "–Ø –æ–ø–ª–∞—Ç–∏–ª", –≤—ã—Ö–æ–¥–∏–º –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–±–∞–≤–ª—è–µ–º!
  const existing = await db.query.bookings.findFirst({ 
    where: and(eq(schema.bookings.userId, user.id), eq(schema.bookings.eventId, event.id)) 
  });
  if (existing) return; 

  await db.insert(schema.bookings).values({ userId: user.id, eventId: event.id, paid: true });
  await db.update(schema.events).set({ currentPlayers: (event.currentPlayers || 0) + 1 }).where(eq(schema.events.id, event.id));

  // 4. –ì–∞—Å–∏–º –≤–∞—É—á–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
  if (voucherId) await db.update(schema.vouchers).set({ status: 'used' }).where(eq(schema.vouchers.id, parseInt(voucherId)));

  // 5. –ë–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–∞–ª—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if (user.invitedBy) {
    const inviter = await db.query.users.findFirst({ where: eq(schema.users.id, user.invitedBy) });
    if (inviter) {
      await db.insert(schema.vouchers).values({ userId: inviter.id, status: 'approved_10' });
      bot.telegram.sendMessage(inviter.telegramId, `üéâ –¢–≤–æ–π –¥—Ä—É–≥ –æ–ø–ª–∞—Ç–∏–ª –∏–≥—Ä—É! –¢–µ–±–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ -10 PLN!`).catch(() => {});
      await db.update(schema.users).set({ invitedBy: null }).where(eq(schema.users.id, user.id));
    }
  }

// 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
 // 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
  // 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
  // 6. –ü–∏—à–µ–º —é–∑–µ—Ä—É —Ä–∞–¥–æ—Å—Ç–Ω—É—é –≤–µ—Å—Ç—å
  let messageText = `üéâ <b>–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –¢—ã –≤ –∏–≥—Ä–µ!</b>\n\n` +
                    `üìç <b>–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–∫–æ—Ä–æ—Ç–∫–æ):</b>\n` +
                    `‚Ä¢ <b>–û—Ç–º–µ–Ω–∞ –∏ –ø–µ—Ä–µ–Ω–æ—Å:</b> –í–æ–∑–º–æ–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞ <b>36 —á–∞—Å–æ–≤</b> –¥–æ –Ω–∞—á–∞–ª–∞. –ü–æ–∑–∂–µ —Å—É–º–º–∞ ¬´—Å–≥–æ—Ä–∞–µ—Ç¬ª.\n` +
                    `‚Ä¢ <b>–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ú—ã –∑–∞ —É–≤–∞–∂–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–Ω—ã–π –≤–∞–π–±. ü•Ç\n` +
                    `‚Ä¢ <b>–õ–æ–∫–∞—Ü–∏—è:</b> –ê–¥—Ä–µ—Å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–¥—É—Ç –∑–∞ <b>3 —á–∞—Å–∞</b> –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã.\n\n`;

// –ü—Ä–æ—Å–∏–º –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ Talk & Toast
  if (event.type.includes('talk_toast')) {
      messageText += `ü§´ <b>–ö—Å—Ç–∞—Ç–∏!</b> –î–ª—è –Ω–∞—à–µ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –Ω–∞–º –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏ –≤ üë§ <b>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</b> -> <b>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</b> –∏ –Ω–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∑–∞–±–∞–≤–Ω—ã–π –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π —Ñ–∞–∫—Ç –æ —Å–µ–±–µ. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–µ—á–µ—Ä –≤ —Ä–∞–∑—ã –∫—Ä—É—á–µ! ‚ú®\n\n`;
  }

  messageText += `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –µ–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏ –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ.\n\n–î–æ –≤—Å—Ç—Ä–µ—á–∏! üòé`;

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  await bot.telegram.sendMessage(user.telegramId, messageText, { parse_mode: 'HTML' }).catch(() => {});
// –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∏–≥—Ä—ã, –∞ –ü–û–¢–û–ú –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
  // 7. –£–¥–∞–ª—è–µ–º –∏–∑ –±—Ä–æ—à–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã
  PENDING_PAYMENTS.delete(`${user.id}`);
}

// --- –ó–ê–©–ò–¢–ù–´–ô –©–ò–¢ –û–¢ –û–®–ò–ë–û–ö (—á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –ø–∞–¥–∞–ª) ---
bot.catch((err: any, ctx) => {
¬† const errorDescription = err.description || err.message || "";
¬† if (errorDescription.includes("message is not modified")) {
¬† ¬† return; // –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ç–æ—Ç –∂–µ
¬† }
¬† console.error(`–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ (${ctx.updateType}):`, err);
});

// --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
const app = express();

// –°–¢–†–û–ì–û –ü–ï–†–ï–î express.json()
app.post('/stripe-webhook', express.raw({ type: 'application/json' }), async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let stripeEvent;
  try {
    stripeEvent = stripe.webhooks.constructEvent(req.body, sig!, process.env.STRIPE_WEBHOOK_SECRET!);
  } catch (err: any) { 
    return res.status(400).send(`Webhook Error: ${err.message}`); 
  }

  if (stripeEvent.type === 'checkout.session.completed') {
    await handleSuccessfulPayment(stripeEvent.data.object);
  }
  res.json({ received: true });
});;

app.use(express.json());
app.use(bot.webhookCallback('/telegraf-webhook'));

const PORT = process.env.PORT || 3000;
const WEBHOOK_URL = process.env.TELEGRAM_WEBHOOK_URL;

app.listen(PORT, async () => {
¬† ¬† console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –ê–ª–≥–æ—Ä–∏—Ç–º–∞ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
¬† ¬† if (WEBHOOK_URL) {
        await bot.telegram.setWebhook(`${WEBHOOK_URL}/telegraf-webhook`);
        console.log(`üì° –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${WEBHOOK_URL}`);
    }
});

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
